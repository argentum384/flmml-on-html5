"use strict";var FlMMLonHTML5=function(){function t(t){i||(i=document.createElement("div"),document.body.appendChild(i));var e=document.createElement("div");e.appendChild(document.createTextNode(t)),i.appendChild(e);var n=i.getElementsByTagName("div");n.length>10&&i.removeChild(i.firstChild)}function e(t,e){for(var n in e)t[n]=e[n];return t}function n(t){t||(t="FlMMLonHTML5"===n.name?"flmmlworker-raw.js":"flmmlworker.js");var e=this.worker=new Worker(t);e.addEventListener("message",this.onMessage.bind(this)),this.onAudioProcessBinded=this.onAudioProcess.bind(this),this.warnings="",this.totalTimeStr="00:00",this.bufferReady=!1,this.volume=100,this.events={},e.postMessage({type:r,sampleRate:n.audioCtx.sampleRate,bufferSize:s}),this.setInfoInterval(125)}var i,s=8192,r=1,o=2,a=3,c=4,u=5,h=6,f=7,l=8,d=9,g=10,m=11,p=12,v=new Float32Array(s);return e(n.prototype,{onMessage:function(n){var i=n.data,s=i.type;switch(s){case u:this.buffer=i.buffer,this.bufferReady=!0;break;case h:e(this,i.info),this.oncompilecomplete&&this.oncompilecomplete(),this.trigger("compilecomplete");break;case f:this.onbuffering&&this.onbuffering(i),this.trigger("buffering",i);break;case l:this.oncomplete&&this.oncomplete(),this.trigger("complete");break;case d:e(this,i.info),this.onsyncinfo&&this.onsyncinfo(),this.trigger("syncinfo");break;case g:this.playSound();break;case m:this.stopSound(i.isFlushBuf),this.worker.postMessage({type:m});break;case p:t(i.str)}},playSound:function(){if(!(this.gain||this.scrProc||this.oscDmy)){var t=n.audioCtx,e=this.gain=t.createGain();e.gain.value=this.volume/127,e.connect(t.destination),this.scrProc=t.createScriptProcessor(s,1,2),this.scrProc.addEventListener("audioprocess",this.onAudioProcessBinded),this.scrProc.connect(this.gain),this.oscDmy=t.createOscillator(),this.oscDmy.connect(this.scrProc),this.oscDmy.start(0)}},stopSound:function(t){t&&(this.bufferReady=!1),(this.gain||this.scrProc||this.oscDmy)&&(this.scrProc.removeEventListener("audioprocess",this.onAudioProcessBinded),this.gain&&(this.gain.disconnect(),this.gain=null),this.scrProc&&(this.scrProc.disconnect(),this.scrProc=null),this.oscDmy&&(this.oscDmy.disconnect(),this.oscDmy=null))},onAudioProcess:function(t){var e=t.outputBuffer;this.bufferReady?(e.getChannelData(0).set(this.buffer[0]),e.getChannelData(1).set(this.buffer[1]),this.bufferReady=!1,this.worker.postMessage({type:u,retBuf:this.buffer},[this.buffer[0].buffer,this.buffer[1].buffer])):(e.getChannelData(0).set(v),e.getChannelData(1).set(v),this.worker.postMessage({type:u,retBuf:null}))},trigger:function(t,n){var i=this.events[t];if(i){var s={};e(s,n);for(var r=0,o=i.length;o>r;r++)i[r]&&i[r].call(this,s)}},play:function(t){this.worker.postMessage({type:o,mml:t})},stop:function(){this.worker.postMessage({type:a})},pause:function(){this.worker.postMessage({type:c})},setMasterVolume:function(t){this.volume=t,this.gain&&(this.gain.gain.value=this.volume/127)},isPlaying:function(){return this._isPlaying},isPaused:function(){return this._isPaused},getWarnings:function(){return this.warnings},getTotalMSec:function(){return 0|this.totalMSec},getTotalTimeStr:function(){return this.totalTimeStr},getNowMSec:function(){return 0|this.nowMSec},getNowTimeStr:function(){return this.nowTimeStr},getVoiceCount:function(){return this.voiceCount},getMetaTitle:function(){return this.metMetaTitle},getMetaComment:function(){return this.metMetaComment},getMetaArtist:function(){return this.metMetaArtist},getMetaCoding:function(){return this.metaCoding},setInfoInterval:function(t){this.worker.postMessage({type:d,interval:t})},syncInfo:function(){this.worker.postMessage({type:d,interval:null})},addEventListener:function(t,e){var n=this.events[t];n||(n=this.events[t]=[]);for(var i=n.length;i--;)if(n[i]===e)return!1;return n.push(e),!0},removeEventListener:function(t,e){var n=this.events[t];if(!n)return!1;for(var i=n.length;i--;)if(n[i]===e)return n.splice(i,1),!0;return!1},release:function(){this.stopSound(),this.worker.terminate()}}),n}();!function(){var t=window.AudioContext||window.webkitAudioContext;FlMMLonHTML5.audioCtx=new t}(),document.addEventListener("DOMContentLoaded",function(){addEventListener("touchend",function t(e){var n=FlMMLonHTML5.audioCtx,i=n.createBufferSource();i.connect(n.destination),i.start(0),removeEventListener("touchend",t)})});