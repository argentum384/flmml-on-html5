"use strict";var FlMMLonHTML5=function(){function t(t,e){return M.postMessage({id:++S,interval:e}),w[S]=t,S}function e(t){M.postMessage({id:t})}function i(t){r||(r=document.createElement("div"),document.body.appendChild(r));var e=document.createElement("div");e.appendChild(document.createTextNode(t)),r.appendChild(e);var i=r.getElementsByTagName("div");i.length>10&&r.removeChild(r.firstChild)}function n(t,e){for(var i in e)t[i]=e[i];return t}function s(t){t||(t="FlMMLonHTML5"===s.name?"flmmlworker-raw.js":"flmmlworker.js");var e=this.worker=new Worker(t);if(e.addEventListener("message",this.onMessage.bind(this)),!s.audioCtx){var i=window.AudioContext||window.webkitAudioContext;s.audioCtx=new i}var n=s.audioCtx;this.bufSec=a/n.sampleRate,this.warnings="",this.totalTimeStr="00:00",this.ringBuf=n.createBuffer(2,2*a,n.sampleRate),this.bufferReady=!1,this.volume=100,this.events={},e.postMessage({type:o,sampleRate:n.sampleRate,bufferSize:a}),this.setInfoInterval(125),addEventListener("touchstart",this.onTouchStart)}var r,a=8192,o=1,u=2,h=3,f=4,c=5,l=6,g=7,d=8,p=9,m=10,v=11,b=12,y=new Float32Array(2*a),M=new Worker(URL.createObjectURL(new Blob(["\r\nfunction n(n){postMessage(n)}var a={};onmessage=function(t){var e=t.data,i=e.id,s=e.interval;s?a[i]=setInterval(n.bind(this,i),s):clearInterval(a[i])}\r\n"],{type:"text/javascript"}))),S=0,w={};return M.onmessage=function(t){w[t.data]&&w[t.data]()},n(s.prototype,{onMessage:function(t){var e=t.data,s=e.type;switch(s){case c:this.buffer=e.buffer,this.bufferReady=!0;break;case l:n(this,e.info),this.oncompilecomplete&&this.oncompilecomplete(),this.trigger("compilecomplete");break;case g:this.onbuffering&&this.onbuffering(e),this.trigger("buffering",e);break;case d:this.oncomplete&&this.oncomplete(),this.trigger("complete");break;case p:n(this,e.info),this.onsyncinfo&&this.onsyncinfo(),this.trigger("syncinfo");break;case m:this.playSound();break;case v:this.stopSound(e.isFlushBuf),this.worker.postMessage({type:v});break;case b:i(e.str)}},playSound:function(){if(!this.gain&&!this.bufSrc){var i=s.audioCtx,n=this.ringBuf,r=this.gain=i.createGain();r.gain.value=this.volume/127,r.connect(i.destination);var a=this.bufSrc=i.createBufferSource();a.buffer=n,a.loop=!0,a.connect(r),n.getChannelData(0).set(y),n.getChannelData(1).set(y),a.start(0),this.startSec=i.currentTime,this.playSide=-1,this.handleRingBuf(),this.tIDRing&&e(this.tIDRing),this.tIDRing=t(this.handleRingBuf.bind(this),1e3*this.bufSec/4|0)}},stopSound:function(t){t&&(this.bufferReady=!1),this.gain&&(this.gain.disconnect(),this.gain=null),this.bufSrc&&(this.bufSrc.disconnect(),this.bufSrc=null,this.tIDRing&&(e(this.tIDRing),this.tIDRing=0))},onTouchStart:function C(t){var e=s.audioCtx,i=e.createBufferSource();i.connect(e.destination),i.start(0),removeEventListener("touchstart",C)},handleRingBuf:function(){var t=this.playSide,e=((s.audioCtx.currentTime-this.startSec)/this.bufSec|0)%2;if(t!==e){this.playSide=e;var i=this.ringBuf,n=a*(1-e);this.bufferReady?(i.getChannelData(0).set(this.buffer[0],n),i.getChannelData(1).set(this.buffer[1],n),this.bufferReady=!1,this.worker.postMessage({type:c,retBuf:this.buffer},[this.buffer[0].buffer,this.buffer[1].buffer])):(i.getChannelData(0).set(y.subarray(0,a),n),i.getChannelData(1).set(y.subarray(0,a),n),this.worker.postMessage({type:c,retBuf:null}))}},trigger:function(t,e){var i=this.events[t];if(i){var s={};n(s,e);for(var r=0,a=i.length;a>r;r++)i[r]&&i[r].call(this,s)}},play:function(t){this.worker.postMessage({type:u,mml:t})},stop:function(){this.worker.postMessage({type:h})},pause:function(){this.worker.postMessage({type:f})},setMasterVolume:function(t){this.volume=t,this.gain&&(this.gain.gain.value=this.volume/127)},isPlaying:function(){return this._isPlaying},isPaused:function(){return this._isPaused},getWarnings:function(){return this.warnings},getTotalMSec:function(){return 0|this.totalMSec},getTotalTimeStr:function(){return this.totalTimeStr},getNowMSec:function(){return 0|this.nowMSec},getNowTimeStr:function(){return this.nowTimeStr},getVoiceCount:function(){return this.voiceCount},getMetaTitle:function(){return this.metMetaTitle},getMetaComment:function(){return this.metMetaComment},getMetaArtist:function(){return this.metMetaArtist},getMetaCoding:function(){return this.metaCoding},setInfoInterval:function(t){this.worker.postMessage({type:p,interval:t})},syncInfo:function(){this.worker.postMessage({type:p,interval:null})},addEventListener:function(t,e){var i=this.events[t];i||(i=this.events[t]=[]);for(var n=i.length;n--;)if(i[n]===e)return!1;return i.push(e),!0},removeEventListener:function(t,e){var i=this.events[t];if(!i)return!1;for(var n=i.length;n--;)if(i[n]===e)return i.splice(n,1),!0;return!1},release:function(){this.stopSound(),this.worker.terminate()}}),s}();