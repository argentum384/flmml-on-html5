"use strict";var FlMMLonHTML5=function(){function t(t){var e,i,s,o=arguments.length;for(e=1;o>e;e++)for(s in i=arguments[e])t[s]=i[s];return t}function e(t){this.worker=new Worker(t?t:"FlMMLonHTML5"===e.name?"flmmlworker-raw.js":"flmmlworker.js"),this.worker.addEventListener("message",this.onMessage.bind(this));var i=window.AudioContext||window.webkitAudioContext;this.audioCtx=new i,this.warnings="",this.totalTimeStr="00:00",this.bufferReady=!1,this.volume=100,this.events={},this.worker.postMessage({type:s,sampleRate:this.audioCtx.sampleRate}),this.setInfoInterval(125)}var i=8192,s=1,o=2,n=3,r=4,a=5,h=6,c=7,u=8,f=9,p=10,l=11,g=new Float32Array(i);return e.prototype.onMessage=function(e){var i=e.data,s=i.type;if(s)switch(s){case a:this.buffer=i.buffer,this.bufferReady=!0;break;case h:t(this,e.data.info),this.oncompilecomplete&&this.oncompilecomplete(),this.trigger("compilecomplete");break;case c:this.onbuffering&&this.onbuffering(i),this.trigger("buffering",i);break;case u:this.oncomplete&&this.oncomplete(),this.trigger("complete");break;case f:t(this,i.info),this.onsyncinfo&&this.onsyncinfo(),this.trigger("syncinfo");break;case p:this.playSound();break;case l:this.stopSound(i.isFlushBuf),this.worker.postMessage({type:l})}},e.prototype.playSound=function(){this.gain||this.scrProc||this.oscDmy||(this.gain=this.audioCtx.createGain(),this.gain.gain.value=this.volume/127,this.gain.connect(this.audioCtx.destination),this.scrProc=this.audioCtx.createScriptProcessor(i),this.onAudioProcessBinded=this.onAudioProcess.bind(this),this.scrProc.addEventListener("audioprocess",this.onAudioProcessBinded),this.scrProc.connect(this.gain),this.oscDmy=this.audioCtx.createOscillator(),this.oscDmy.connect(this.scrProc),this.oscDmy.start(0))},e.prototype.stopSound=function(t){t&&(this.bufferReady=!1),(this.gain||this.scrProc||this.oscDmy)&&(this.scrProc.removeEventListener("audioprocess",this.onAudioProcessBinded),this.gain&&(this.gain.disconnect(),this.gain=null),this.scrProc&&(this.scrProc.disconnect(),this.scrProc=null),this.oscDmy&&(this.oscDmy.disconnect(),this.oscDmy=null))},e.prototype.onAudioProcess=function(t){var e=t.outputBuffer;this.bufferReady?(e.getChannelData(0).set(this.buffer[0]),e.getChannelData(1).set(this.buffer[1]),this.bufferReady=!1,this.worker.postMessage({type:a,retBuf:this.buffer},[this.buffer[0].buffer,this.buffer[1].buffer])):(e.getChannelData(0).set(g),e.getChannelData(1).set(g),this.worker.postMessage({type:a}))},e.prototype.onInfoTimer=function(){this._isPlaying&&this.syncInfo()},e.prototype.trigger=function(e,i){var s=this.events[e];if(s){var o={};t(o,i);for(var n=0,r=s.length;r>n;n++)s[n].call(this,o)}},e.prototype.play=function(t){this.isPlayedOnce||(this.audioCtx.createBufferSource().start(0),this.isPlayedOnce=!0),this.worker.postMessage({type:o,mml:t})},e.prototype.stop=function(){this.worker.postMessage({type:n})},e.prototype.pause=function(){this.worker.postMessage({type:r})},e.prototype.setMasterVolume=function(t){this.volume=t,this.gain&&(this.gain.gain.value=this.volume/127)},e.prototype.isPlaying=function(){return this._isPlaying},e.prototype.isPaused=function(){return this._isPaused},e.prototype.getWarnings=function(){return this.warnings},e.prototype.getTotalMSec=function(){return this.totalMSec},e.prototype.getTotalTimeStr=function(){return this.totalTimeStr},e.prototype.getNowMSec=function(){return this.nowMSec},e.prototype.getNowTimeStr=function(){return this.nowTimeStr},e.prototype.getVoiceCount=function(){return this.voiceCount},e.prototype.getMetaTitle=function(){return this.metMetaTitle},e.prototype.getMetaComment=function(){return this.metMetaComment},e.prototype.getMetaArtist=function(){return this.metMetaArtist},e.prototype.getMetaCoding=function(){return this.metaCoding},e.prototype.setInfoInterval=function(t){clearInterval(this.infoTimer),t&&(this.infoTimer=setInterval(this.onInfoTimer.bind(this),t))},e.prototype.syncInfo=function(){this.worker.postMessage({type:f})},e.prototype.addEventListener=function(t,e){var i=this.events[t];i||(i=this.events[t]=[]);for(var s=i.length;s--;)if(i[s]===e)return!1;return i.push(e),!0},e.prototype.removeEventListener=function(t,e){var i=this.events[t];if(!i)return!1;for(var s=i.length;s--;)if(i[s]===e)return i.splice(s,1),!0;return!1},e}();