"use strict";var FlMMLonHTML5=function(){function t(t){s||(s=document.createElement("div"),document.body.appendChild(s));var e=document.createElement("div");e.appendChild(document.createTextNode(t)),s.appendChild(e);var i=s.getElementsByTagName("div");i.length>10&&s.removeChild(s.firstChild)}function e(t,e){for(var i in e)t[i]=e[i];return t}function i(t){t||(t="FlMMLonHTML5"===i.name?"flmmlworker-raw.js":"flmmlworker.js");var e=this.worker=new Worker(t);if(e.addEventListener("message",this.onMessage.bind(this)),!i.audioCtx){var s=window.AudioContext||window.webkitAudioContext;i.audioCtx=new s}var o=i.audioCtx;this.onAudioProcessBinded=this.onAudioProcess.bind(this),this.warnings="",this.totalTimeStr="00:00",this.bufferReady=!1,this.volume=100,this.events={},e.postMessage({type:r,sampleRate:o.sampleRate,bufferSize:n}),this.setInfoInterval(125),addEventListener("touchstart",this.onTouchStart)}var s,n=8192,r=1,o=2,a=3,c=4,u=5,h=6,f=7,l=8,d=9,g=10,m=11,p=12,v=new Float32Array(n);return e(i.prototype,{onMessage:function(i){var s=i.data,n=s.type;switch(n){case u:this.buffer=s.buffer,this.bufferReady=!0;break;case h:e(this,s.info),this.oncompilecomplete&&this.oncompilecomplete(),this.trigger("compilecomplete");break;case f:this.onbuffering&&this.onbuffering(s),this.trigger("buffering",s);break;case l:this.oncomplete&&this.oncomplete(),this.trigger("complete");break;case d:e(this,s.info),this.onsyncinfo&&this.onsyncinfo(),this.trigger("syncinfo");break;case g:this.playSound();break;case m:this.stopSound(s.isFlushBuf),this.worker.postMessage({type:m});break;case p:t(s.str)}},playSound:function(){if(!(this.gain||this.scrProc||this.oscDmy)){var t=i.audioCtx,e=(this.ringBuf,this.gain=t.createGain());e.gain.value=this.volume/127,e.connect(t.destination),this.scrProc=t.createScriptProcessor(n,1,2),this.scrProc.addEventListener("audioprocess",this.onAudioProcessBinded),this.scrProc.connect(this.gain),this.oscDmy=t.createOscillator(),this.oscDmy.connect(this.scrProc),this.oscDmy.start(0)}},stopSound:function(t){t&&(this.bufferReady=!1),(this.gain||this.scrProc||this.oscDmy)&&(this.scrProc.removeEventListener("audioprocess",this.onAudioProcessBinded),this.gain&&(this.gain.disconnect(),this.gain=null),this.scrProc&&(this.scrProc.disconnect(),this.scrProc=null),this.oscDmy&&(this.oscDmy.disconnect(),this.oscDmy=null))},onTouchStart:function y(t){var e=i.audioCtx,s=e.createBufferSource();s.connect(e.destination),s.start(0),removeEventListener("touchstart",y)},onAudioProcess:function(t){var e=t.outputBuffer;this.bufferReady?(e.getChannelData(0).set(this.buffer[0]),e.getChannelData(1).set(this.buffer[1]),this.bufferReady=!1,this.worker.postMessage({type:u,retBuf:this.buffer},[this.buffer[0].buffer,this.buffer[1].buffer])):(e.getChannelData(0).set(v),e.getChannelData(1).set(v),this.worker.postMessage({type:u,retBuf:null}))},trigger:function(t,i){var s=this.events[t];if(s){var n={};e(n,i);for(var r=0,o=s.length;o>r;r++)s[r]&&s[r].call(this,n)}},play:function(t){this.worker.postMessage({type:o,mml:t})},stop:function(){this.worker.postMessage({type:a})},pause:function(){this.worker.postMessage({type:c})},setMasterVolume:function(t){this.volume=t,this.gain&&(this.gain.gain.value=this.volume/127)},isPlaying:function(){return this._isPlaying},isPaused:function(){return this._isPaused},getWarnings:function(){return this.warnings},getTotalMSec:function(){return 0|this.totalMSec},getTotalTimeStr:function(){return this.totalTimeStr},getNowMSec:function(){return 0|this.nowMSec},getNowTimeStr:function(){return this.nowTimeStr},getVoiceCount:function(){return this.voiceCount},getMetaTitle:function(){return this.metMetaTitle},getMetaComment:function(){return this.metMetaComment},getMetaArtist:function(){return this.metMetaArtist},getMetaCoding:function(){return this.metaCoding},setInfoInterval:function(t){this.worker.postMessage({type:d,interval:t})},syncInfo:function(){this.worker.postMessage({type:d,interval:null})},addEventListener:function(t,e){var i=this.events[t];i||(i=this.events[t]=[]);for(var s=i.length;s--;)if(i[s]===e)return!1;return i.push(e),!0},removeEventListener:function(t,e){var i=this.events[t];if(!i)return!1;for(var s=i.length;s--;)if(i[s]===e)return i.splice(s,1),!0;return!1},release:function(){this.stopSound(),this.worker.terminate()}}),i}();