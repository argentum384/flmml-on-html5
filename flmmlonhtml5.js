"use strict";var FlMMLonHTML5=function(t){function e(t){s||(s=document.createElement("div"),document.body.appendChild(s));var e=document.createElement("div");e.appendChild(document.createTextNode(t)),s.appendChild(e);var i=s.getElementsByTagName("div");i.length>10&&s.removeChild(s.firstChild)}function i(t){var e,i,o,s=arguments.length;for(e=1;s>e;e++)for(o in i=arguments[e])t[o]=i[o];return t}function o(e){this.worker=new Worker(e?e:"FlMMLonHTML5"===o.name?"flmmlworker-raw.js":"flmmlworker.js"),this.worker.addEventListener("message",this.onMessage.bind(this));var i=t.AudioContext||t.webkitAudioContext,s=this.audioCtx=new i;t.addEventListener("touchstart",this.onTouchStartBinded=this.onTouchStart.bind(this)),this.warnings="",this.totalTimeStr="00:00",this.bufferReady=!1,this.volume=100,this.events={},this.worker.postMessage({type:r,sampleRate:s.sampleRate}),this.setInfoInterval(125)}var s,n=8192,r=1,a=2,c=3,h=4,u=5,p=6,f=7,d=8,l=9,g=10,m=11,y=12,v=new Float32Array(n);return o.prototype.onMessage=function(t){var o=t.data,s=o.type;if(s)switch(s){case u:this.buffer=o.buffer,this.bufferReady=!0;break;case p:i(this,t.data.info),this.oncompilecomplete&&this.oncompilecomplete(),this.trigger("compilecomplete");break;case f:this.onbuffering&&this.onbuffering(o),this.trigger("buffering",o);break;case d:this.oncomplete&&this.oncomplete(),this.trigger("complete");break;case l:i(this,o.info),this.onsyncinfo&&this.onsyncinfo(),this.trigger("syncinfo");break;case g:this.playSound();break;case m:this.stopSound(o.isFlushBuf),this.worker.postMessage({type:m});break;case y:e(o.str)}},o.prototype.playSound=function(){if(!(this.gain||this.scrProc||this.oscDmy)){var t=this.audioCtx;this.gain=t.createGain(),this.gain.gain.value=this.volume/127,this.gain.connect(t.destination),this.scrProc=t.createScriptProcessor(n,1,2),this.onAudioProcessBinded=this.onAudioProcess.bind(this),this.scrProc.addEventListener("audioprocess",this.onAudioProcessBinded),this.scrProc.connect(this.gain),this.oscDmy=t.createOscillator(),this.oscDmy.connect(this.scrProc),this.oscDmy.start(0)}},o.prototype.stopSound=function(t){t&&(this.bufferReady=!1),(this.gain||this.scrProc||this.oscDmy)&&(this.scrProc.removeEventListener("audioprocess",this.onAudioProcessBinded),this.gain&&(this.gain.disconnect(),this.gain=null),this.scrProc&&(this.scrProc.disconnect(),this.scrProc=null),this.oscDmy&&(this.oscDmy.disconnect(),this.oscDmy=null))},o.prototype.onTouchStart=function(e){var i=this.audioCtx,o=i.createBufferSource();o.connect(i.destination),o.start(0),t.removeEventListener("touchstart",this.onTouchStartBinded)},o.prototype.onAudioProcess=function(t){var e=t.outputBuffer;this.bufferReady?(e.getChannelData(0).set(this.buffer[0]),e.getChannelData(1).set(this.buffer[1]),this.bufferReady=!1,this.worker.postMessage({type:u,retBuf:this.buffer},[this.buffer[0].buffer,this.buffer[1].buffer])):(e.getChannelData(0).set(v),e.getChannelData(1).set(v),this.worker.postMessage({type:u}))},o.prototype.trigger=function(t,e){var o=this.events[t];if(o){var s={};i(s,e);for(var n=0,r=o.length;r>n;n++)o[n].call(this,s)}},o.prototype.play=function(t){this.worker.postMessage({type:a,mml:t})},o.prototype.stop=function(){this.worker.postMessage({type:c})},o.prototype.pause=function(){this.worker.postMessage({type:h})},o.prototype.setMasterVolume=function(t){this.volume=t,this.gain&&(this.gain.gain.value=this.volume/127)},o.prototype.isPlaying=function(){return this._isPlaying},o.prototype.isPaused=function(){return this._isPaused},o.prototype.getWarnings=function(){return this.warnings},o.prototype.getTotalMSec=function(){return 0|this.totalMSec},o.prototype.getTotalTimeStr=function(){return this.totalTimeStr},o.prototype.getNowMSec=function(){return 0|this.nowMSec},o.prototype.getNowTimeStr=function(){return this.nowTimeStr},o.prototype.getVoiceCount=function(){return this.voiceCount},o.prototype.getMetaTitle=function(){return this.metMetaTitle},o.prototype.getMetaComment=function(){return this.metMetaComment},o.prototype.getMetaArtist=function(){return this.metMetaArtist},o.prototype.getMetaCoding=function(){return this.metaCoding},o.prototype.setInfoInterval=function(t){this.worker.postMessage({type:l,interval:t})},o.prototype.syncInfo=function(){this.worker.postMessage({type:l})},o.prototype.addEventListener=function(t,e){var i=this.events[t];i||(i=this.events[t]=[]);for(var o=i.length;o--;)if(i[o]===e)return!1;return i.push(e),!0},o.prototype.removeEventListener=function(t,e){var i=this.events[t];if(!i)return!1;for(var o=i.length;o--;)if(i[o]===e)return i.splice(o,1),!0;return!1},o.prototype.release=function(){this.tIDSendTime&&clearInterval(this.tIDSendTime),this.worker.terminate()},o}(window);