var FlMMLWorker;!function(t){var e;!function(t){var e=function(){function t(){}return t.EOT=0,t.NOP=1,t.NOTE_ON=2,t.NOTE_OFF=3,t.TEMPO=4,t.VOLUME=5,t.NOTE=6,t.FORM=7,t.ENVELOPE1_ATK=8,t.ENVELOPE1_ADD=9,t.ENVELOPE1_REL=10,t.NOISE_FREQ=11,t.PWM=12,t.PAN=13,t.FORMANT=14,t.DETUNE=15,t.LFO_FMSF=16,t.LFO_DPWD=17,t.LFO_DLTM=18,t.LFO_TARGET=19,t.LPF_SWTAMT=20,t.LPF_FRQRES=21,t.CLOSE=22,t.VOL_MODE=23,t.ENVELOPE2_ATK=24,t.ENVELOPE2_ADD=25,t.ENVELOPE2_REL=26,t.INPUT=27,t.OUTPUT=28,t.EXPRESSION=29,t.RINGMODULATE=30,t.SYNC=31,t.PORTAMENTO=32,t.MIDIPORT=33,t.MIDIPORTRATE=34,t.BASENOTE=35,t.POLY=36,t.SOUND_OFF=37,t.RESET_ALL=38,t.HW_LFO=39,t}();t.MStatus=e}(e=t.flmml||(t.flmml={}))}(FlMMLWorker||(FlMMLWorker={}));var FlMMLWorker;!function(t){var e;!function(t){var e=function(){function e(e){this.TEMPO_SCALE=100,this.set(t.MStatus.NOP,0,0),this.setTick(e)}return e.prototype.set=function(t,e,s){this.m_status=t,this.m_data0=e,this.m_data1=s},e.prototype.setEOT=function(){this.set(t.MStatus.EOT,0,0)},e.prototype.setNoteOn=function(e,s){this.set(t.MStatus.NOTE_ON,e,s)},e.prototype.setNoteOff=function(e,s){this.set(t.MStatus.NOTE_OFF,e,s)},e.prototype.setTempo=function(e){this.set(t.MStatus.TEMPO,e*this.TEMPO_SCALE,0)},e.prototype.setVolume=function(e){this.set(t.MStatus.VOLUME,e,0)},e.prototype.setNote=function(e){this.set(t.MStatus.NOTE,e,0)},e.prototype.setForm=function(e,s){this.set(t.MStatus.FORM,e,s)},e.prototype.setEnvelope1Atk=function(e){this.set(t.MStatus.ENVELOPE1_ATK,e,0)},e.prototype.setEnvelope1Point=function(e,s){this.set(t.MStatus.ENVELOPE1_ADD,e,s)},e.prototype.setEnvelope1Rel=function(e){this.set(t.MStatus.ENVELOPE1_REL,e,0)},e.prototype.setEnvelope2Atk=function(e){this.set(t.MStatus.ENVELOPE2_ATK,e,0)},e.prototype.setEnvelope2Point=function(e,s){this.set(t.MStatus.ENVELOPE2_ADD,e,s)},e.prototype.setEnvelope2Rel=function(e){this.set(t.MStatus.ENVELOPE2_REL,e,0)},e.prototype.setNoiseFreq=function(e){this.set(t.MStatus.NOISE_FREQ,e,0)},e.prototype.setPWM=function(e){this.set(t.MStatus.PWM,e,0)},e.prototype.setPan=function(e){this.set(t.MStatus.PAN,e,0)},e.prototype.setFormant=function(e){this.set(t.MStatus.FORMANT,e,0)},e.prototype.setDetune=function(e){this.set(t.MStatus.DETUNE,e,0)},e.prototype.setLFOFMSF=function(e,s){this.set(t.MStatus.LFO_FMSF,e,s)},e.prototype.setLFODPWD=function(e,s){this.set(t.MStatus.LFO_DPWD,e,s)},e.prototype.setLFODLTM=function(e,s){this.set(t.MStatus.LFO_DLTM,e,s)},e.prototype.setLFOTarget=function(e){this.set(t.MStatus.LFO_TARGET,e,0)},e.prototype.setLPFSWTAMT=function(e,s){this.set(t.MStatus.LPF_SWTAMT,e,s)},e.prototype.setLPFFRQRES=function(e,s){this.set(t.MStatus.LPF_FRQRES,e,s)},e.prototype.setClose=function(){this.set(t.MStatus.CLOSE,0,0)},e.prototype.setVolMode=function(e){this.set(t.MStatus.VOL_MODE,e,0)},e.prototype.setInput=function(e,s){this.set(t.MStatus.INPUT,e,s)},e.prototype.setOutput=function(e,s){this.set(t.MStatus.OUTPUT,e,s)},e.prototype.setExpression=function(e){this.set(t.MStatus.EXPRESSION,e,0)},e.prototype.setRing=function(e,s){this.set(t.MStatus.RINGMODULATE,e,s)},e.prototype.setSync=function(e,s){this.set(t.MStatus.SYNC,e,s)},e.prototype.setDelta=function(t){this.m_delta=t},e.prototype.setTick=function(t){this.m_tick=t},e.prototype.setPortamento=function(e,s){this.set(t.MStatus.PORTAMENTO,e,s)},e.prototype.setMidiPort=function(e){this.set(t.MStatus.MIDIPORT,e,0)},e.prototype.setMidiPortRate=function(e){this.set(t.MStatus.MIDIPORTRATE,e,0)},e.prototype.setPortBase=function(e){this.set(t.MStatus.BASENOTE,e,0)},e.prototype.setPoly=function(e){this.set(t.MStatus.POLY,e,0)},e.prototype.setResetAll=function(){this.set(t.MStatus.RESET_ALL,0,0)},e.prototype.setSoundOff=function(){this.set(t.MStatus.SOUND_OFF,0,0)},e.prototype.setHwLfo=function(e,s,i,o,h,_,r){this.set(t.MStatus.HW_LFO,(3&e)<<27|(255&s)<<19|(127&i)<<12|(127&o)<<5|(7&h)<<2|3&_,0)},e.prototype.getStatus=function(){return this.m_status},e.prototype.getDelta=function(){return this.m_delta},e.prototype.getTick=function(){return this.m_tick},e.prototype.getNoteNo=function(){return this.m_data0},e.prototype.getVelocity=function(){return this.m_data1},e.prototype.getTempo=function(){return Math.floor(this.m_data0)/this.TEMPO_SCALE},e.prototype.getVolume=function(){return this.m_data0},e.prototype.getForm=function(){return this.m_data0},e.prototype.getSubForm=function(){return this.m_data1},e.prototype.getEnvelopeA=function(){return this.m_data0},e.prototype.getEnvelopeT=function(){return this.m_data0},e.prototype.getEnvelopeL=function(){return this.m_data1},e.prototype.getEnvelopeR=function(){return this.m_data0},e.prototype.getNoiseFreq=function(){return this.m_data0},e.prototype.getPWM=function(){return this.m_data0},e.prototype.getPan=function(){return this.m_data0},e.prototype.getVowel=function(){return this.m_data0},e.prototype.getDetune=function(){return this.m_data0},e.prototype.getLFODepth=function(){return this.m_data0},e.prototype.getLFOWidth=function(){return this.m_data1},e.prototype.getLFOForm=function(){return this.m_data0},e.prototype.getLFOSubForm=function(){return this.m_data1},e.prototype.getLFODelay=function(){return this.m_data0},e.prototype.getLFOTime=function(){return this.m_data1},e.prototype.getLFOTarget=function(){return this.m_data0},e.prototype.getLPFSwt=function(){return this.m_data0},e.prototype.getLPFAmt=function(){return this.m_data1},e.prototype.getLPFFrq=function(){return this.m_data0},e.prototype.getLPFRes=function(){return this.m_data1},e.prototype.getVolMode=function(){return this.m_data0},e.prototype.getInputSens=function(){return this.m_data0},e.prototype.getInputPipe=function(){return this.m_data1},e.prototype.getOutputMode=function(){return this.m_data0},e.prototype.getOutputPipe=function(){return this.m_data1},e.prototype.getExpression=function(){return this.m_data0},e.prototype.getRingSens=function(){return this.m_data0},e.prototype.getRingInput=function(){return this.m_data1},e.prototype.getSyncMode=function(){return this.m_data0},e.prototype.getSyncPipe=function(){return this.m_data1},e.prototype.getPorDepth=function(){return this.m_data0},e.prototype.getPorLen=function(){return this.m_data1},e.prototype.getMidiPort=function(){return this.m_data0},e.prototype.getMidiPortRate=function(){return this.m_data0},e.prototype.getPortBase=function(){return this.m_data0},e.prototype.getVoiceCount=function(){return this.m_data0},e.prototype.getHwLfoData=function(){return this.m_data0},e}();t.MEvent=e}(e=t.flmml||(t.flmml={}))}(FlMMLWorker||(FlMMLWorker={}));var FlMMLWorker;!function(t){var e;!function(t){var e=function(){function e(){var s=e.BUFFER_SIZE,i=s*e.BACK_MULTIPLE;e.SAMPLE_RATE=global.worker.sampleRate,this.m_output=!1,t.MChannel.boot(i),t.MOscillator.boot(),t.MEnvelope.boot(),this.m_trackArr=new Array,this.m_playSide=1,this.m_playSize=0,this.m_step=e.STEP_NONE,this.m_maxProcTime=s/e.SAMPLE_RATE*1e3*e.PROC_MULTIPLE,this.m_buffer=[[new Float32Array(i),new Float32Array(i)],[new Float32Array(i),new Float32Array(i)]],global.worker.onRequestBuffer=this.onSampleData.bind(this),this.stop()}return e.prototype.play=function(){if(this.m_status==e.STATUS_PAUSE){var t=e.BUFFER_SIZE/e.SAMPLE_RATE*1e3;this.m_pausedPos=t*Math.ceil(this.m_pausedPos/t);var s=this.getTotalMSec(),i=s>this.m_pausedPos?s-this.m_pausedPos:0;this.m_status=e.STATUS_PLAY,this.m_startTime=global.performance.now(),this.startRestTimer(i),global.worker.playSound()}else{this.m_globalTick=0;for(var o=0;o<this.m_trackArr.length;o++)this.m_trackArr[o].seekTop();this.m_status=e.STATUS_BUFFERING,this.processStart()}},e.prototype.stop=function(t){void 0===t&&(t=null),clearTimeout(this.m_restTimer),global.worker.stopSound(t,!0),this.m_status=e.STATUS_STOP,this.m_pausedPos=0},e.prototype.pause=function(){this.m_status==e.STATUS_PLAY&&(clearTimeout(this.m_restTimer),global.worker.stopSound(),this.m_pausedPos=this.getNowMSec(),this.m_status=e.STATUS_PAUSE)},e.prototype.disconnectAll=function(){for(;this.m_trackArr.pop(););this.m_status=e.STATUS_STOP},e.prototype.connect=function(t){this.m_trackArr.push(t)},e.prototype.getGlobalTick=function(){return this.m_globalTick},e.prototype.onStopReq=function(){this.stop(),global.worker.complete()},e.prototype.reqBuffering=function(){clearTimeout(this.m_buffTimer),this.m_buffTimer=setTimeout(this.onBufferingReq.bind(this),0,this)},e.prototype.onBufferingReq=function(){clearTimeout(this.m_restTimer),this.m_pausedPos=this.getNowMSec(),this.m_status=e.STATUS_BUFFERING},e.prototype.startProcTimer=function(t){void 0===t&&(t=0),clearTimeout(this.m_procTimer),this.m_procTimer=setTimeout(this.processAll.bind(this),t)},e.prototype.startRestTimer=function(t){void 0===t&&(t=0),clearTimeout(this.m_restTimer),this.m_restTimer=setTimeout(this.onStopReq.bind(this),t)},e.prototype.processStart=function(){this.m_step=e.STEP_PRE,this.startProcTimer()},e.prototype.processAll=function(){var s,i,o=this.m_buffer[1-this.m_playSide],h=e.BUFFER_SIZE,_=h*e.BACK_MULTIPLE,r=2*h,n=this.m_trackArr.length;switch(this.m_step){case e.STEP_PRE:if(this.m_output)return void this.startProcTimer();if(o=this.m_buffer[1-this.m_playSide],o[0].set(e.ZEROBUFFER),o[1].set(e.ZEROBUFFER),n>0){var a=this.m_trackArr[t.MTrack.TEMPO_TRACK];a.onSampleData(null,0,h*e.BACK_MULTIPLE,!0)}this.m_processTrack=t.MTrack.FIRST_TRACK,this.m_processOffset=0,this.m_step++,this.startProcTimer();break;case e.STEP_TRACK:if(this.m_output)return void this.startProcTimer();s=global.performance.now(),i=0;do{if(this.m_processTrack>=n){this.m_step++;break}this.m_trackArr[this.m_processTrack].onSampleData(o,this.m_processOffset,this.m_processOffset+r),this.m_processOffset+=r,this.m_processOffset>=_&&(this.m_processTrack++,this.m_processOffset=0),i=(this.m_processTrack*_+this.m_processOffset)/(this.m_trackArr.length*_)*100|0}while(global.performance.now()-s<this.m_maxProcTime);this.m_status==e.STATUS_BUFFERING&&global.worker.buffering(i),this.startProcTimer();break;case e.STEP_POST:if(this.m_step=e.STEP_COMPLETE,this.m_status==e.STATUS_BUFFERING){var m=e.BUFFER_SIZE/e.SAMPLE_RATE*1e3;this.m_pausedPos=m*Math.ceil(this.m_pausedPos/m);var c=this.getTotalMSec(),p=c>this.m_pausedPos?c-this.m_pausedPos:0;this.m_status=e.STATUS_PLAY,this.m_playSide=1-this.m_playSide,this.m_playSize=0,this.m_startTime=global.performance.now(),this.processStart(),this.startRestTimer(p),global.worker.playSound()}}},e.prototype.onSampleData=function(s){var i,o,h,_=e.BUFFER_SIZE;if(this.m_output=!0,this.m_playSize>=e.BACK_MULTIPLE){if(this.m_step!=e.STEP_COMPLETE)return this.m_output=!1,void this.reqBuffering();if(this.m_playSide=1-this.m_playSide,this.m_playSize=0,this.processStart(),this.m_status==e.STATUS_LAST)return void(this.m_output=!1);this.m_status==e.STATUS_PLAY&&this.m_trackArr[t.MTrack.TEMPO_TRACK].isEnd()&&(this.m_status=e.STATUS_LAST)}for(h=s.retBuf?s.retBuf:[new Float32Array(_),new Float32Array(_)],o=_*this.m_playSize,i=0;2>i;i++)h[i].set(this.m_buffer[this.m_playSide][i].subarray(o,o+_));global.worker.sendBuffer(h),this.m_playSize++,this.m_output=!1},e.prototype.createPipes=function(e){t.MChannel.createPipes(e)},e.prototype.createSyncSources=function(e){t.MChannel.createSyncSources(e)},e.prototype.isPlaying=function(){return this.m_status>e.STATUS_PAUSE},e.prototype.isPaused=function(){return this.m_status==e.STATUS_PAUSE},e.prototype.getTotalMSec=function(){return this.m_trackArr[t.MTrack.TEMPO_TRACK]?this.m_trackArr[t.MTrack.TEMPO_TRACK].getTotalMSec():0},e.prototype.getNowMSec=function(){var t,s=this.getTotalMSec();switch(this.m_status){case e.STATUS_PLAY:case e.STATUS_LAST:t=global.performance.now()-this.m_startTime+this.m_pausedPos;break;case e.STATUS_PAUSE:case e.STATUS_BUFFERING:t=this.m_pausedPos;break;default:return 0}return s>t?t:s},e.prototype.getNowTimeStr=function(){var t=this.getNowMSec()/1e3,e="0"+(t/60|0),s="0"+(t%60|0);return e.substr(e.length-2,2)+":"+s.substr(s.length-2,2)},e.BUFFER_SIZE=8192,e.BACK_MULTIPLE=32,e.PROC_MULTIPLE=.5,e.ZEROBUFFER=new Float32Array(e.BUFFER_SIZE*e.BACK_MULTIPLE),e.STATUS_STOP=0,e.STATUS_PAUSE=1,e.STATUS_BUFFERING=2,e.STATUS_PLAY=3,e.STATUS_LAST=4,e.STEP_NONE=0,e.STEP_PRE=1,e.STEP_TRACK=2,e.STEP_POST=3,e.STEP_COMPLETE=4,e}();t.MSequencer=e}(e=t.flmml||(t.flmml={}))}(FlMMLWorker||(FlMMLWorker={}));var FlMMLWorker;!function(t){var e;!function(t){var e=function(){function e(){this.resetPhase(),this.setFrequency(440)}return e.prototype.resetPhase=function(){this.m_phase=0},e.prototype.addPhase=function(t){this.m_phase=this.m_phase+this.m_freqShift*t&e.PHASE_MSK},e.prototype.getNextSample=function(){return 0},e.prototype.getNextSampleOfs=function(t){return 0},e.prototype.getSamples=function(t,e,s){},e.prototype.getSamplesWithSyncIn=function(t,e,s,i){this.getSamples(t,s,i)},e.prototype.getSamplesWithSyncOut=function(t,e,s,i){this.getSamples(t,s,i)},e.prototype.getFrequency=function(){return this.m_frequency},e.prototype.setFrequency=function(s){this.m_frequency=s,this.m_freqShift=s*(e.PHASE_LEN/t.MSequencer.SAMPLE_RATE)|0},e.prototype.setWaveNo=function(t){},e.prototype.setNoteNo=function(t){},e.TABLE_LEN=65536,e.PHASE_SFT=14,e.PHASE_LEN=e.TABLE_LEN<<e.PHASE_SFT,e.PHASE_HLF=e.TABLE_LEN<<e.PHASE_SFT-1,e.PHASE_MSK=e.PHASE_LEN-1,e}();t.MOscMod=e}(e=t.flmml||(t.flmml={}))}(FlMMLWorker||(FlMMLWorker={}));var FlMMLWorker;!function(t){var e;!function(t){var e=function(){function t(){this.next=null}return t}();t.MEnvelopePoint=e}(e=t.flmml||(t.flmml={}))}(FlMMLWorker||(FlMMLWorker={}));var FlMMLWorker;!function(t){var e;!function(t){var e=function(){function e(t,e,s,i){this.setAttack(t),this.addPoint(e,s),this.setRelease(i),this.m_playing=!1,this.m_currentVal=0,this.m_releasing=!0,this.m_releaseStep=0}return e.boot=function(){if(!e.s_init){var t;for(e.s_volumeLen=256,e.s_volumeMap=new Array(3),t=0;3>t;t++)e.s_volumeMap[t]=new Array(e.s_volumeLen),e.s_volumeMap[t][0]=0;for(t=1;t<e.s_volumeLen;t++)e.s_volumeMap[0][t]=t/255,e.s_volumeMap[1][t]=Math.pow(10,(t-255)*(48/5100)),e.s_volumeMap[2][t]=Math.pow(10,(t-255)*(96/5100));e.s_init=1}},e.prototype.setAttack=function(e){this.m_envelopePoint=this.m_envelopeLastPoint=new t.MEnvelopePoint,this.m_envelopePoint.time=0,this.m_envelopePoint.level=0,this.addPoint(e,1)},e.prototype.setRelease=function(e){if(this.m_releaseTime=(e>0?e:1/127)*t.MSequencer.SAMPLE_RATE,this.m_playing&&!this.m_releasing){for(this.m_counter=this.m_timeInSamples,this.m_currentPoint=this.m_envelopePoint;null!=this.m_currentPoint.next&&this.m_counter>=this.m_currentPoint.next.time;)this.m_currentPoint=this.m_currentPoint.next,this.m_counter-=this.m_currentPoint.time;null==this.m_currentPoint.next?this.m_currentVal=this.m_currentPoint.level:(this.m_step=(this.m_currentPoint.next.level-this.m_currentPoint.level)/this.m_currentPoint.next.time,this.m_currentVal=this.m_currentPoint.level+this.m_step*this.m_counter)}},e.prototype.addPoint=function(e,s){var i=new t.MEnvelopePoint;i.time=e*t.MSequencer.SAMPLE_RATE,i.level=s,this.m_envelopeLastPoint.next=i,this.m_envelopeLastPoint=i},e.prototype.triggerEnvelope=function(t){this.m_playing=!0,this.m_releasing=!1,this.m_currentPoint=this.m_envelopePoint,this.m_currentVal=this.m_currentPoint.level=t?0:this.m_currentVal,this.m_step=(1-this.m_currentVal)/this.m_currentPoint.next.time,this.m_timeInSamples=this.m_counter=0},e.prototype.releaseEnvelope=function(){this.m_releasing=!0,this.m_releaseStep=this.m_currentVal/this.m_releaseTime},e.prototype.soundOff=function(){this.releaseEnvelope(),this.m_playing=!1},e.prototype.getNextAmplitudeLinear=function(){if(!this.m_playing)return 0;if(this.m_releasing)this.m_currentVal-=this.m_releaseStep;else if(null==this.m_currentPoint.next)this.m_currentVal=this.m_currentPoint.level;else{for(var t=!1;this.m_counter>=this.m_currentPoint.next.time;){if(this.m_counter=0,this.m_currentPoint=this.m_currentPoint.next,null==this.m_currentPoint.next){this.m_currentVal=this.m_currentPoint.level,t=!0;break}this.m_step=(this.m_currentPoint.next.level-this.m_currentPoint.level)/this.m_currentPoint.next.time,this.m_currentVal=this.m_currentPoint.level,t=!0}t||(this.m_currentVal+=this.m_step),this.m_counter++}return this.m_currentVal<=0&&this.m_releasing&&(this.m_playing=!1,this.m_currentVal=0),this.m_timeInSamples++,this.m_currentVal},e.prototype.ampSamplesLinear=function(t,e,s,i){var o,h=this.m_currentVal*i;for(o=e;s>o;o++)if(this.m_playing){if(this.m_releasing)this.m_currentVal-=this.m_releaseStep,h=this.m_currentVal*i;else if(null==this.m_currentPoint.next);else{for(var _=!1;this.m_counter>=this.m_currentPoint.next.time;){if(this.m_counter=0,this.m_currentPoint=this.m_currentPoint.next,null==this.m_currentPoint.next){this.m_currentVal=this.m_currentPoint.level,_=!0;break}this.m_step=(this.m_currentPoint.next.level-this.m_currentPoint.level)/this.m_currentPoint.next.time,this.m_currentVal=this.m_currentPoint.level,_=!0}_||(this.m_currentVal+=this.m_step),h=this.m_currentVal*i,this.m_counter++}this.m_currentVal<=0&&this.m_releasing&&(this.m_playing=!1,h=this.m_currentVal=0),this.m_timeInSamples++,t[o]*=h}else t[o]=0},e.prototype.ampSamplesNonLinear=function(t,s,i,o,h){var _;for(_=s;i>_;_++)if(this.m_playing){if(this.m_releasing)this.m_currentVal-=this.m_releaseStep;else if(null==this.m_currentPoint.next)this.m_currentVal=this.m_currentPoint.level;else{for(var r=!1;this.m_counter>=this.m_currentPoint.next.time;){if(this.m_counter=0,this.m_currentPoint=this.m_currentPoint.next,null==this.m_currentPoint.next){this.m_currentVal=this.m_currentPoint.level,r=!0;break}this.m_step=(this.m_currentPoint.next.level-this.m_currentPoint.level)/this.m_currentPoint.next.time,this.m_currentVal=this.m_currentPoint.level,r=!0}r||(this.m_currentVal+=this.m_step),this.m_counter++}this.m_currentVal<=0&&this.m_releasing&&(this.m_playing=!1,this.m_currentVal=0),this.m_timeInSamples++;var n=255*this.m_currentVal|0;n>255&&(n=0),t[_]*=e.s_volumeMap[h][n]*o}else t[_]=0},e.prototype.isPlaying=function(){return this.m_playing},e.prototype.isReleasing=function(){return this.m_releasing},e.s_init=0,e}();t.MEnvelope=e}(e=t.flmml||(t.flmml={}))}(FlMMLWorker||(FlMMLWorker={}));var FlMMLWorker;!function(t){var e;!function(t){var e=function(){function e(){this.setSwitch(0)}return e.prototype.reset=function(){this.m_t1=this.m_t2=this.m_b0=this.m_b1=this.m_b2=this.m_b3=this.m_b4=0},e.prototype.setSwitch=function(t){this.reset(),this.sw=t},e.prototype.checkToSilence=function(){switch(this.sw){case 0:return!1;case 1:case-1:return-1e-6<=this.m_b0&&this.m_b0<=1e-6&&-1e-6<=this.m_b1&&this.m_b1<=1e-6;case 2:case-2:return-1e-6<=this.m_t1&&this.m_t1<=1e-6&&-1e-6<=this.m_t2&&this.m_t2<=1e-6&&-1e-6<=this.m_b0&&this.m_b0<=1e-6&&-1e-6<=this.m_b1&&this.m_b1<=1e-6&&-1e-6<=this.m_b2&&this.m_b2<=1e-6&&-1e-6<=this.m_b3&&this.m_b3<=1e-6&&-1e-6<=this.m_b4&&this.m_b4<=1e-6}return!1},e.prototype.run=function(t,e,s,i,o,h,_,r){switch(this.sw){case-2:this.hpf2(t,e,s,i,o,h,_,r);break;case-1:this.hpf1(t,e,s,i,o,h,_,r);break;case 0:return;case 1:this.lpf1(t,e,s,i,o,h,_,r);break;case 2:this.lpf2(t,e,s,i,o,h,_,r)}},e.prototype.lpf1=function(e,s,i,o,h,_,r,n){var a,m,c,p=this.m_b0,l=this.m_b1,u=n*(2*Math.PI/(440*t.MSequencer.SAMPLE_RATE));if(_>1e-4||-1e-4>_)for(a=s;i>a;a++)c=t.MChannel.getFrequency(h+_*o.getNextAmplitudeLinear())*u,1/127>c&&(c=0),c>.9999&&(c=.9999),m=r+r/(1-c),p+=c*(e[a]-p+m*(p-l)),e[a]=l+=c*(p-l);else for(c=t.MChannel.getFrequency(h)*u,1/127>c&&(c=0),c>.9999&&(c=.9999),m=r+r/(1-c),a=s;i>a;a++)p+=c*(e[a]-p+m*(p-l)),e[a]=l+=c*(p-l);this.m_b0=p,this.m_b1=l},e.prototype.lpf2=function(e,s,i,o,h,_,r,n){for(var a=this.m_t1,m=this.m_t2,c=this.m_b0,p=this.m_b1,l=this.m_b2,u=this.m_b3,f=this.m_b4,S=n*(2*Math.PI/(440*t.MSequencer.SAMPLE_RATE)),g=s;i>g;g++){var M=t.MChannel.getFrequency(h+_*o.getNextAmplitudeLinear())*S;1/127>M&&(M=0),M>1&&(M=1);var v=1-M,E=M+.8*M*v,y=E+E-1;v=r*(1+.5*v*(1-v+5.6*v*v));var P=e[g];P-=v*f,a=p,p=(P+c)*E-p*y,m=l,l=(p+a)*E-l*y,a=u,u=(l+m)*E-u*y,f=(u+a)*E-f*y,f-=f*f*f*.166667,c=P,e[g]=f}this.m_t1=a,this.m_t2=m,this.m_b0=c,this.m_b1=p,this.m_b2=l,this.m_b3=u,this.m_b4=f},e.prototype.hpf1=function(e,s,i,o,h,_,r,n){var a,m,c,p,l=this.m_b0,u=this.m_b1,f=n*(2*Math.PI/(440*t.MSequencer.SAMPLE_RATE));if(_>1e-4||-1e-4>_)for(a=s;i>a;a++)c=t.MChannel.getFrequency(h+_*o.getNextAmplitudeLinear())*f,1/127>c&&(c=0),c>.9999&&(c=.9999),m=r+r/(1-c),p=e[a],l+=c*(p-l+m*(l-u)),u+=c*(l-u),e[a]=p-l;else for(c=t.MChannel.getFrequency(h)*f,1/127>c&&(c=0),c>.9999&&(c=.9999),m=r+r/(1-c),a=s;i>a;a++)p=e[a],l+=c*(p-l+m*(l-u)),u+=c*(l-u),e[a]=p-l;this.m_b0=l,this.m_b1=u},e.prototype.hpf2=function(e,s,i,o,h,_,r,n){for(var a=this.m_t1,m=this.m_t2,c=this.m_b0,p=this.m_b1,l=this.m_b2,u=this.m_b3,f=this.m_b4,S=n*(2*Math.PI/(440*t.MSequencer.SAMPLE_RATE)),g=s;i>g;g++){var M=t.MChannel.getFrequency(h+_*o.getNextAmplitudeLinear())*S;1/127>M&&(M=0),M>1&&(M=1);var v=1-M,E=M+.8*M*v,y=E+E-1;v=r*(1+.5*v*(1-v+5.6*v*v));var P=e[g];P-=v*f,a=p,p=(P+c)*E-p*y,m=l,l=(p+a)*E-l*y,a=u,u=(l+m)*E-u*y,f=(u+a)*E-f*y,f-=f*f*f*.166667,c=P,e[g]=P-f}this.m_t1=a,this.m_t2=m,this.m_b0=c,this.m_b1=p,this.m_b2=l,this.m_b3=u,this.m_b4=f},e}();t.MFilter=e}(e=t.flmml||(t.flmml={}))}(FlMMLWorker||(FlMMLWorker={}));var FlMMLWorker;!function(t){var e;!function(t){var e=function(){function e(){e.boot(),this.m_osc=new Array(e.MAX),this.m_osc[e.SINE]=new t.MOscSine,this.m_osc[e.SAW]=new t.MOscSaw,this.m_osc[e.TRIANGLE]=new t.MOscTriangle,this.m_osc[e.PULSE]=new t.MOscPulse,this.m_osc[e.NOISE]=new t.MOscNoise,this.m_osc[e.FC_PULSE]=new t.MOscPulse,this.m_osc[e.FC_TRI]=new t.MOscFcTri,this.m_osc[e.FC_NOISE]=new t.MOscFcNoise,this.m_osc[e.FC_S_NOISE]=null,this.m_osc[e.FC_DPCM]=new t.MOscFcDpcm,this.m_osc[e.GB_WAVE]=new t.MOscGbWave,this.m_osc[e.GB_NOISE]=new t.MOscGbLNoise,this.m_osc[e.GB_S_NOISE]=new t.MOscGbSNoise,this.m_osc[e.WAVE]=new t.MOscWave,this.m_osc[e.OPM]=new t.MOscOPM,this.setForm(e.PULSE),this.setNoiseToPulse()}return e.prototype.asLFO=function(){this.m_osc[e.NOISE]&&this.m_osc[e.NOISE].disableResetPhase()},e.boot=function(){e.s_init||(t.MOscSine.boot(),t.MOscSaw.boot(),t.MOscTriangle.boot(),t.MOscPulse.boot(),t.MOscNoise.boot(),t.MOscFcTri.boot(),t.MOscFcNoise.boot(),t.MOscFcDpcm.boot(),t.MOscGbWave.boot(),t.MOscGbLNoise.boot(),t.MOscGbSNoise.boot(),t.MOscWave.boot(),t.MOscOPM.boot(),e.s_init=1)},e.prototype.setForm=function(t){var s,i;switch(t>=e.MAX&&(t=e.MAX-1),this.m_form=t,t){case e.NOISE:s=this.m_osc[e.NOISE],s.restoreFreq();break;case e.FC_NOISE:i=this.getMod(e.FC_NOISE),i.setLongMode();break;case e.FC_S_NOISE:i=this.getMod(e.FC_S_NOISE),i.setShortMode()}return this.getMod(t)},e.prototype.getForm=function(){return this.m_form},e.prototype.getCurrent=function(){return this.getMod(this.m_form)},e.prototype.getMod=function(t){return t!=e.FC_S_NOISE?this.m_osc[t]:this.m_osc[e.FC_NOISE]},e.prototype.setNoiseToPulse=function(){var t=this.getMod(e.PULSE),s=this.getMod(e.NOISE);t.setNoise(s)},e.SINE=0,e.SAW=1,e.TRIANGLE=2,e.PULSE=3,e.NOISE=4,e.FC_PULSE=5,e.FC_TRI=6,e.FC_NOISE=7,e.FC_S_NOISE=8,e.FC_DPCM=9,e.GB_WAVE=10,e.GB_NOISE=11,e.GB_S_NOISE=12,e.WAVE=13,e.OPM=14,e.MAX=15,e.s_init=0,e}();t.MOscillator=e}(e=t.flmml||(t.flmml={}))}(FlMMLWorker||(FlMMLWorker={}));var FlMMLWorker;!function(t){var e;!function(t){var e=function(){function e(){this.m_noteNo=0,this.m_detune=0,this.m_freqNo=0,this.m_envelope1=new t.MEnvelope(0,60/127,30/127,1/127),this.m_envelope2=new t.MEnvelope(0,30/127,0,1),this.m_oscSet1=new t.MOscillator,this.m_oscMod1=this.m_oscSet1.getCurrent(),this.m_oscSet2=new t.MOscillator,this.m_oscSet2.asLFO(),this.m_oscSet2.setForm(t.MOscillator.SINE),this.m_oscMod2=this.m_oscSet2.getCurrent(),this.m_osc2Connect=0,this.m_filter=new t.MFilter,this.m_filterConnect=0,this.m_formant=new t.MFormant,this.m_volMode=0,this.setExpression(127),this.setVelocity(100),this.setPan(64),this.m_onCounter=0,this.m_lfoDelay=0,this.m_lfoDepth=0,this.m_lfoEnd=0,this.m_lpfAmt=0,this.m_lpfFrq=0,this.m_lpfRes=0,this.m_pulseWidth=.5,this.setInput(0,0),this.setOutput(0,0),this.setRing(0,0),this.setSync(0,0),this.m_portDepth=0,this.m_portDepthAdd=0,this.m_lastFreqNo=4800,this.m_portamento=0,this.m_portRate=0,this.m_voiceid=0,this.m_slaveVoice=!1}return e.boot=function(t){if(!e.s_init){var s;for(e.s_frequencyLen=e.s_frequencyMap.length,s=0;s<e.s_frequencyLen;s++)e.s_frequencyMap[s]=440*Math.pow(2,(s-69*e.PITCH_RESOLUTION)/(12*e.PITCH_RESOLUTION));for(e.s_volumeLen=128,e.s_volumeMap=new Array(3),s=0;3>s;s++)e.s_volumeMap[s]=new Array(e.s_volumeLen),e.s_volumeMap[s][0]=0;for(s=1;s<e.s_volumeLen;s++)e.s_volumeMap[0][s]=s/127,e.s_volumeMap[1][s]=Math.pow(10,(s-127)*(48/2540)),e.s_volumeMap[2][s]=Math.pow(10,(s-127)*(96/2540));e.s_init=1}e.s_samples=new Float32Array(t)},e.createPipes=function(t){e.s_pipeArr=new Array(t);for(var s=0;t>s;s++)e.s_pipeArr[s]=new Float32Array(e.s_samples.length)},e.createSyncSources=function(t){e.s_syncSources=new Array(t);for(var s=0;t>s;s++){e.s_syncSources[s]=new Array(e.s_samples.length);for(var i=0;i<e.s_samples.length;i++)e.s_syncSources[s][i]=!1}},e.getFrequency=function(t){return t|=0,t=0>t?0:t>=e.s_frequencyLen?e.s_frequencyLen-1:t,e.s_frequencyMap[t]},e.prototype.setExpression=function(s){this.m_expression=e.s_volumeMap[this.m_volMode][s],this.m_ampLevel=this.m_velocity*this.m_expression,this.m_oscSet1.getMod(t.MOscillator.OPM).setExpression(this.m_expression)},e.prototype.setVelocity=function(s){this.m_velocity=e.s_volumeMap[this.m_volMode][s],this.m_ampLevel=this.m_velocity*this.m_expression,this.m_oscSet1.getMod(t.MOscillator.OPM).setVelocity(s)},e.prototype.setNoteNo=function(t,s){void 0===s&&(s=!0),this.m_noteNo=t,this.m_freqNo=this.m_noteNo*e.PITCH_RESOLUTION+this.m_detune,this.m_oscMod1.setFrequency(e.getFrequency(this.m_freqNo)),1==this.m_portamento&&(s?this.m_portDepth+=this.m_lastFreqNo-this.m_freqNo:this.m_portDepth=this.m_lastFreqNo-this.m_freqNo,this.m_portDepthAdd=this.m_portDepth<0?this.m_portRate:-1*this.m_portRate),this.m_lastFreqNo=this.m_freqNo},e.prototype.setDetune=function(t){this.m_detune=t,this.m_freqNo=this.m_noteNo*e.PITCH_RESOLUTION+this.m_detune,this.m_oscMod1.setFrequency(e.getFrequency(this.m_freqNo))},e.prototype.getNoteNo=function(){return this.m_noteNo},e.prototype.isPlaying=function(){return this.m_oscSet1.getForm()==t.MOscillator.OPM?this.m_oscSet1.getCurrent().IsPlaying():this.m_envelope1.isPlaying()},e.prototype.getId=function(){return this.m_voiceid},e.prototype.getVoiceCount=function(){return this.isPlaying()?1:0},e.prototype.setSlaveVoice=function(t){this.m_slaveVoice=t},e.prototype.noteOnWidthId=function(t,e,s){this.m_voiceid=s,this.noteOn(t,e)},e.prototype.noteOn=function(e,s){this.setNoteNo(e,!1),this.m_envelope1.triggerEnvelope(0),this.m_envelope2.triggerEnvelope(1),this.m_oscMod1.resetPhase(),this.m_oscMod2.resetPhase(),this.m_filter.reset(),this.setVelocity(s),this.m_onCounter=0;var i=this.m_oscSet1.getMod(t.MOscillator.PULSE);i.setPWM(this.m_pulseWidth),this.m_oscSet1.getMod(t.MOscillator.FC_NOISE).setNoteNo(this.m_noteNo),this.m_oscSet1.getMod(t.MOscillator.GB_NOISE).setNoteNo(this.m_noteNo),this.m_oscSet1.getMod(t.MOscillator.GB_S_NOISE).setNoteNo(this.m_noteNo),this.m_oscSet1.getMod(t.MOscillator.FC_DPCM).setNoteNo(this.m_noteNo),this.m_oscSet1.getMod(t.MOscillator.OPM).setNoteNo(this.m_noteNo)},e.prototype.noteOff=function(e){(0>e||e==this.m_noteNo)&&(this.m_envelope1.releaseEnvelope(),this.m_envelope2.releaseEnvelope(),this.m_oscSet1.getMod(t.MOscillator.OPM).noteOff())},e.prototype.setSoundOff=function(){this.m_envelope1.soundOff(),this.m_envelope2.soundOff()},e.prototype.close=function(){this.noteOff(this.m_noteNo),this.m_filter.setSwitch(0)},e.prototype.setNoiseFreq=function(e){var s=this.m_oscSet1.getMod(t.MOscillator.NOISE);s.setNoiseFreq(1-e*(1/128))},e.prototype.setForm=function(t,e){this.m_oscMod1=this.m_oscSet1.setForm(t),this.m_oscMod1.setWaveNo(e)},e.prototype.setEnvelope1Atk=function(t){this.m_envelope1.setAttack(t*(1/127))},e.prototype.setEnvelope1Point=function(t,e){this.m_envelope1.addPoint(t*(1/127),e*(1/127))},e.prototype.setEnvelope1Rel=function(t){this.m_envelope1.setRelease(t*(1/127))},e.prototype.setEnvelope2Atk=function(t){this.m_envelope2.setAttack(t*(1/127))},e.prototype.setEnvelope2Point=function(t,e){this.m_envelope2.addPoint(t*(1/127),e*(1/127))},e.prototype.setEnvelope2Rel=function(t){this.m_envelope2.setRelease(t*(1/127))},e.prototype.setPWM=function(e){if(this.m_oscSet1.getForm()!=t.MOscillator.FC_PULSE){var s=this.m_oscSet1.getMod(t.MOscillator.PULSE);0>e?(s.setMIX(1),e*=-1):s.setMIX(0),this.m_pulseWidth=.01*e,s.setPWM(this.m_pulseWidth)}else{var i=this.m_oscSet1.getMod(t.MOscillator.FC_PULSE);0>e&&(e*=-1),i.setPWM(.125*Math.floor(e))}},e.prototype.setPan=function(t){this.m_pan=(t-1)*(.5/63),this.m_pan<0&&(this.m_pan=0)},e.prototype.setFormant=function(t){t>=0?this.m_formant.setVowel(t):this.m_formant.disable()},e.prototype.setLFOFMSF=function(e,s){this.m_oscMod2=this.m_oscSet2.setForm(e>=0?e-1:-e-1),this.m_oscMod2.setWaveNo(s),this.m_osc2Sign=e>=0?1:-1,0>e&&(e=-e),e--,e>=t.MOscillator.MAX&&(this.m_osc2Connect=0)},e.prototype.setLFODPWD=function(e,s){this.m_lfoDepth=e,this.m_osc2Connect=0==e?0:1,this.m_oscMod2.setFrequency(s),this.m_oscMod2.resetPhase(),this.m_oscSet2.getMod(t.MOscillator.NOISE).setNoiseFreq(s/t.MSequencer.SAMPLE_RATE)},e.prototype.setLFODLTM=function(t,e){this.m_lfoDelay=t,this.m_lfoEnd=e>0?this.m_lfoDelay+e:0},e.prototype.setLFOTarget=function(t){this.m_lfoTarget=t},e.prototype.setLpfSwtAmt=function(t,s){t>-3&&3>t&&t!=this.m_filterConnect&&(this.m_filterConnect=t,this.m_filter.setSwitch(t)),this.m_lpfAmt=(-127>s?-127:127>s?s:127)*e.PITCH_RESOLUTION},e.prototype.setLpfFrqRes=function(t,s){0>t&&(t=0),t>127&&(t=127),this.m_lpfFrq=t*e.PITCH_RESOLUTION,this.m_lpfRes=s*(1/127),this.m_lpfRes<0&&(this.m_lpfRes=0),this.m_lpfRes>1&&(this.m_lpfRes=1)},e.prototype.setVolMode=function(t){switch(t){case 0:case 1:case 2:this.m_volMode=t}},e.prototype.setInput=function(e,s){this.m_inSens=(1<<e-1)*(1/8)*t.MOscMod.PHASE_LEN,this.m_inPipe=s},e.prototype.setOutput=function(t,e){this.m_outMode=t,this.m_outPipe=e},e.prototype.setRing=function(t,e){this.m_ringSens=(1<<t-1)/8,this.m_ringPipe=e},e.prototype.setSync=function(t,e){this.m_syncMode=t,this.m_syncPipe=e},e.prototype.setPortamento=function(t,e){this.m_portamento=0,this.m_portDepth=t,this.m_portDepthAdd=Math.floor(this.m_portDepth)/e*-1},e.prototype.setMidiPort=function(t){this.m_portamento=t,this.m_portDepth=0},e.prototype.setMidiPortRate=function(t){this.m_portRate=t},e.prototype.setPortBase=function(t){this.m_lastFreqNo=t},e.prototype.setVoiceLimit=function(t){},e.prototype.setHwLfo=function(e){var s=e>>27&3,i=e>>19&255,o=e>>12&127,h=e>>5&127,_=e>>2&7,r=e>>0&3,n=this.m_oscSet1.getMod(t.MOscillator.OPM);n.setWF(s),n.setLFRQ(i),n.setPMD(o),n.setAMD(h),n.setPMSAMS(_,r)},e.prototype.reset=function(){this.setSoundOff(),this.m_pulseWidth=.5,this.m_voiceid=0,this.setForm(0,0),this.setDetune(0),this.setExpression(127),this.setVelocity(100),this.setPan(64),this.setVolMode(0),this.setNoiseFreq(0),this.setLFOFMSF(0,0),this.m_osc2Connect=0,this.m_onCounter=0,this.m_lfoTarget=0,this.m_lfoDelay=0,this.m_lfoDepth=0,this.m_lfoEnd=0,this.setLpfSwtAmt(0,0),this.setLpfFrqRes(0,0),this.setFormant(-1),this.setInput(0,0),this.setOutput(0,0),this.setRing(0,0),this.setSync(0,0),this.m_portDepth=0,this.m_portDepthAdd=0,this.m_lastFreqNo=4800,this.m_portamento=0,this.m_portRate=0},e.prototype.clearOutPipe=function(s,i,o){1==this.m_outMode&&e.s_pipeArr[this.m_outPipe].set(t.MSequencer.ZEROBUFFER.subarray(0,o),i)},e.prototype.getNextCutoff=function(){var s=this.m_lpfFrq+this.m_lpfAmt*this.m_envelope2.getNextAmplitudeLinear();return s=e.getFrequency(s)*this.m_oscMod1.getFrequency()*(2*Math.PI/(440*t.MSequencer.SAMPLE_RATE)),1/127>s&&(s=0),s},e.prototype.getSamples=function(s,i,o,h){var _,r,n,a,m,c,p,l,u,f,S,g,M=o+h,v=e.s_samples,E=this.isPlaying();M>=i&&(M=i);var y=e.getFrequency(this.m_freqNo);if(1==this.m_outMode&&0==this.m_slaveVoice&&(v=e.s_pipeArr[this.m_outPipe]),E&&(0==this.m_portDepth?this.m_inSens>=1e-6?0==this.m_osc2Connect?this.getSamplesF__(v,o,M):this.m_lfoTarget==e.LFO_TARGET_PITCH?this.getSamplesFP_(v,o,M):this.m_lfoTarget==e.LFO_TARGET_PWM?this.getSamplesFW_(v,o,M):this.m_lfoTarget==e.LFO_TARGET_FM?this.getSamplesFF_(v,o,M):this.getSamplesF__(v,o,M):2==this.m_syncMode?0==this.m_osc2Connect?this.getSamplesI__(v,o,M):this.m_lfoTarget==e.LFO_TARGET_PITCH?this.getSamplesIP_(v,o,M):this.m_lfoTarget==e.LFO_TARGET_PWM?this.getSamplesIW_(v,o,M):this.getSamplesI__(v,o,M):1==this.m_syncMode?0==this.m_osc2Connect?this.getSamplesO__(v,o,M):this.m_lfoTarget==e.LFO_TARGET_PITCH?this.getSamplesOP_(v,o,M):this.m_lfoTarget==e.LFO_TARGET_PWM?this.getSamplesOW_(v,o,M):this.getSamplesO__(v,o,M):0==this.m_osc2Connect?this.getSamples___(v,o,M):this.m_lfoTarget==e.LFO_TARGET_PITCH?this.getSamples_P_(v,o,M):this.m_lfoTarget==e.LFO_TARGET_PWM?this.getSamples_W_(v,o,M):this.getSamples___(v,o,M):this.m_inSens>=1e-6?0==this.m_osc2Connect?this.getSamplesF_P(v,o,M):this.m_lfoTarget==e.LFO_TARGET_PITCH?this.getSamplesFPP(v,o,M):this.m_lfoTarget==e.LFO_TARGET_PWM?this.getSamplesFWP(v,o,M):this.m_lfoTarget==e.LFO_TARGET_FM?this.getSamplesFFP(v,o,M):this.getSamplesF_P(v,o,M):2==this.m_syncMode?0==this.m_osc2Connect?this.getSamplesI_P(v,o,M):this.m_lfoTarget==e.LFO_TARGET_PITCH?this.getSamplesIPP(v,o,M):this.m_lfoTarget==e.LFO_TARGET_PWM?this.getSamplesIWP(v,o,M):this.getSamplesI_P(v,o,M):1==this.m_syncMode?0==this.m_osc2Connect?this.getSamplesO_P(v,o,M):this.m_lfoTarget==e.LFO_TARGET_PITCH?this.getSamplesOPP(v,o,M):this.m_lfoTarget==e.LFO_TARGET_PWM?this.getSamplesOWP(v,o,M):this.getSamplesO_P(v,o,M):0==this.m_osc2Connect?this.getSamples__P(v,o,M):this.m_lfoTarget==e.LFO_TARGET_PITCH?this.getSamples_PP(v,o,M):this.m_lfoTarget==e.LFO_TARGET_PWM?this.getSamples_WP(v,o,M):this.getSamples__P(v,o,M)),this.m_oscSet1.getForm()!=t.MOscillator.OPM&&(0==this.m_volMode?this.m_envelope1.ampSamplesLinear(v,o,M,this.m_ampLevel):this.m_envelope1.ampSamplesNonLinear(v,o,M,this.m_ampLevel,this.m_volMode)),this.m_lfoTarget==e.LFO_TARGET_AMPLITUDE&&0!=this.m_osc2Connect)for(u=this.m_osc2Sign*this.m_lfoDepth/127,S=o,f=o;M>f;f++)c=1,this.m_onCounter>=this.m_lfoDelay&&(0==this.m_lfoEnd||this.m_onCounter<this.m_lfoEnd)&&(c+=this.m_oscMod2.getNextSample()*u),0>c&&(c=0),v[f]*=c,this.m_onCounter++;if(E&&this.m_ringSens>=1e-6)for(r=e.s_pipeArr[this.m_ringPipe],_=this.m_ringSens,f=o;M>f;f++)v[f]*=r[f]*_;if(m=E,E=E||this.m_formant.checkToSilence(),E!=m&&v.set(t.MSequencer.ZEROBUFFER.subarray(0,h),o),E&&this.m_formant.run(v,o,M),m=E,E=E||this.m_filter.checkToSilence(),E!=m&&v.set(t.MSequencer.ZEROBUFFER.subarray(0,h),o),E)if(this.m_lfoTarget==e.LFO_TARGET_CUTOFF&&0!=this.m_osc2Connect){u=this.m_osc2Sign*this.m_lfoDepth,S=o;do g=S+e.s_lfoDelta,g>M&&(g=M),p=this.m_lpfFrq,this.m_onCounter>=this.m_lfoDelay&&(0==this.m_lfoEnd||this.m_onCounter<this.m_lfoEnd)&&(p+=this.m_oscMod2.getNextSample()*u|0,this.m_oscMod2.addPhase(g-S-1)),0>p?p=0:p>127*e.PITCH_RESOLUTION&&(p=127*e.PITCH_RESOLUTION),this.m_filter.run(e.s_samples,S,g,this.m_envelope2,p,this.m_lpfAmt,this.m_lpfRes,y),this.m_onCounter+=g-S,S=g;while(M>S)}else this.m_filter.run(v,o,M,this.m_envelope2,this.m_lpfFrq,this.m_lpfAmt,this.m_lpfRes,y);if(E)switch(this.m_outMode){case 0:if(this.m_lfoTarget==e.LFO_TARGET_PANPOT&&0!=this.m_osc2Connect)for(u=this.m_osc2Sign*this.m_lfoDepth*(1/127),f=o;M>f;f++)l=this.m_pan+this.m_oscMod2.getNextSample()*u,0>l?l=0:l>1&&(l=1),n=.5*v[f],a=n*l,s[0][f]+=n-a,s[1][f]+=a;else for(f=o;M>f;f++)n=.5*v[f],a=n*this.m_pan,s[0][f]+=n-a,s[1][f]+=a;break;case 1:if(r=e.s_pipeArr[this.m_outPipe],0==this.m_slaveVoice)for(f=o;M>f;f++)r[f]=v[f];else for(f=o;M>f;f++)r[f]+=v[f];break;case 2:for(r=e.s_pipeArr[this.m_outPipe],f=o;M>f;f++)r[f]+=v[f]}else 1==this.m_outMode&&(r=e.s_pipeArr[this.m_outPipe],0==this.m_slaveVoice&&r.set(t.MSequencer.ZEROBUFFER.subarray(0,h),o))},e.prototype.getSamples___=function(t,e,s){this.m_oscMod1.getSamples(t,e,s)},e.prototype.getSamples_P_=function(t,s,i){var o,h,_=s,r=this.m_osc2Sign*this.m_lfoDepth;do o=_+e.s_lfoDelta,o>i&&(o=i),h=this.m_freqNo,this.m_onCounter>=this.m_lfoDelay&&(0==this.m_lfoEnd||this.m_onCounter<this.m_lfoEnd)&&(h+=this.m_oscMod2.getNextSample()*r|0,this.m_oscMod2.addPhase(o-_-1)),this.m_oscMod1.setFrequency(e.getFrequency(h)),this.m_oscMod1.getSamples(t,_,o),this.m_onCounter+=o-_,_=o;while(i>_)},e.prototype.getSamples_W_=function(s,i,o){var h,_,r=i,n=this.m_osc2Sign*this.m_lfoDepth*.01,a=this.m_oscSet1.getMod(t.MOscillator.PULSE);do h=r+e.s_lfoDelta,h>o&&(h=o),_=this.m_pulseWidth,this.m_onCounter>=this.m_lfoDelay&&(0==this.m_lfoEnd||this.m_onCounter<this.m_lfoEnd)&&(_+=this.m_oscMod2.getNextSample()*n,this.m_oscMod2.addPhase(h-r-1)),0>_?_=0:_>100&&(_=100),a.setPWM(_),this.m_oscMod1.getSamples(s,r,h),this.m_onCounter+=h-r,r=h;while(o>r)},e.prototype.getSamplesF__=function(t,s,i){var o,h=this.m_inSens,_=e.s_pipeArr[this.m_inPipe];for(this.m_oscMod1.setFrequency(e.getFrequency(this.m_freqNo)),o=s;i>o;o++)t[o]=this.m_oscMod1.getNextSampleOfs(_[o]*h)},e.prototype.getSamplesFP_=function(t,s,i){var o,h,_=this.m_inSens,r=this.m_osc2Sign*this.m_lfoDepth,n=e.s_pipeArr[this.m_inPipe];for(o=s;i>o;o++)h=this.m_freqNo,this.m_onCounter>=this.m_lfoDelay&&(0==this.m_lfoEnd||this.m_onCounter<this.m_lfoEnd)&&(h+=this.m_oscMod2.getNextSample()*r|0),this.m_oscMod1.setFrequency(e.getFrequency(h)),t[o]=this.m_oscMod1.getNextSampleOfs(n[o]*_),this.m_onCounter++},e.prototype.getSamplesFW_=function(s,i,o){var h,_,r=this.m_osc2Sign*this.m_lfoDepth*.01,n=this.m_oscSet1.getMod(t.MOscillator.PULSE),a=this.m_inSens,m=e.s_pipeArr[this.m_inPipe];for(this.m_oscMod1.setFrequency(e.getFrequency(this.m_freqNo)),h=i;o>h;h++)_=this.m_pulseWidth,this.m_onCounter>=this.m_lfoDelay&&(0==this.m_lfoEnd||this.m_onCounter<this.m_lfoEnd)&&(_+=this.m_oscMod2.getNextSample()*r),0>_?_=0:_>100&&(_=100),n.setPWM(_),s[h]=this.m_oscMod1.getNextSampleOfs(m[h]*a),this.m_onCounter++},e.prototype.getSamplesFF_=function(t,s,i){var o,h,_=this.m_osc2Sign*this.m_lfoDepth*(1/127),r=e.s_pipeArr[this.m_inPipe];for(this.m_oscMod1.setFrequency(e.getFrequency(this.m_freqNo)),o=s;i>o;o++)h=this.m_inSens,this.m_onCounter>=this.m_lfoDelay&&(0==this.m_lfoEnd||this.m_onCounter<this.m_lfoEnd)&&(h*=this.m_oscMod2.getNextSample()*_),t[o]=this.m_oscMod1.getNextSampleOfs(r[o]*h),this.m_onCounter++},e.prototype.getSamplesI__=function(t,s,i){this.m_oscMod1.getSamplesWithSyncIn(t,e.s_syncSources[this.m_syncPipe],s,i)},e.prototype.getSamplesIP_=function(t,s,i){var o,h,_=s,r=this.m_osc2Sign*this.m_lfoDepth,n=e.s_syncSources[this.m_syncPipe];do o=_+e.s_lfoDelta,o>i&&(o=i),h=this.m_freqNo,this.m_onCounter>=this.m_lfoDelay&&(0==this.m_lfoEnd||this.m_onCounter<this.m_lfoEnd)&&(h+=this.m_oscMod2.getNextSample()*r|0,this.m_oscMod2.addPhase(o-_-1)),this.m_oscMod1.setFrequency(e.getFrequency(h)),this.m_oscMod1.getSamplesWithSyncIn(t,n,_,o),this.m_onCounter+=o-_,_=o;while(i>_)},e.prototype.getSamplesIW_=function(s,i,o){var h,_,r=i,n=this.m_osc2Sign*this.m_lfoDepth*.01,a=this.m_oscSet1.getMod(t.MOscillator.PULSE),m=e.s_syncSources[this.m_syncPipe];do h=r+e.s_lfoDelta,h>o&&(h=o),_=this.m_pulseWidth,this.m_onCounter>=this.m_lfoDelay&&(0==this.m_lfoEnd||this.m_onCounter<this.m_lfoEnd)&&(_+=this.m_oscMod2.getNextSample()*n,this.m_oscMod2.addPhase(h-r-1)),0>_?_=0:_>100&&(_=100),a.setPWM(_),this.m_oscMod1.getSamplesWithSyncIn(s,m,r,h),this.m_onCounter+=h-r,r=h;while(o>r)},e.prototype.getSamplesO__=function(t,s,i){this.m_oscMod1.getSamplesWithSyncOut(t,e.s_syncSources[this.m_syncPipe],s,i)},e.prototype.getSamplesOP_=function(t,s,i){var o,h,_=s,r=this.m_osc2Sign*this.m_lfoDepth,n=e.s_syncSources[this.m_syncPipe];do o=_+e.s_lfoDelta,o>i&&(o=i),h=this.m_freqNo,this.m_onCounter>=this.m_lfoDelay&&(0==this.m_lfoEnd||this.m_onCounter<this.m_lfoEnd)&&(h+=this.m_oscMod2.getNextSample()*r|0,this.m_oscMod2.addPhase(o-_-1)),this.m_oscMod1.setFrequency(e.getFrequency(h)),this.m_oscMod1.getSamplesWithSyncOut(t,n,_,o),this.m_onCounter+=o-_,_=o;while(i>_)},e.prototype.getSamplesOW_=function(s,i,o){var h,_,r=i,n=this.m_osc2Sign*this.m_lfoDepth*.01,a=this.m_oscSet1.getMod(t.MOscillator.PULSE),m=e.s_syncSources[this.m_syncPipe];do h=r+e.s_lfoDelta,h>o&&(h=o),_=this.m_pulseWidth,this.m_onCounter>=this.m_lfoDelay&&(0==this.m_lfoEnd||this.m_onCounter<this.m_lfoEnd)&&(_+=this.m_oscMod2.getNextSample()*n,this.m_oscMod2.addPhase(h-r-1)),0>_?_=0:_>100&&(_=100),a.setPWM(_),this.m_oscMod1.getSamplesWithSyncOut(s,m,r,h),this.m_onCounter+=h-r,r=h;while(o>r)},e.prototype.getSamples__P=function(t,s,i){var o,h,_=s;do o=_+e.s_lfoDelta,o>i&&(o=i),h=this.m_freqNo,0!=this.m_portDepth&&(h+=0|this.m_portDepth,this.m_portDepth+=this.m_portDepthAdd*(o-_-1),this.m_portDepth*this.m_portDepthAdd>0&&(this.m_portDepth=0)),this.m_oscMod1.setFrequency(e.getFrequency(h)),this.m_oscMod1.getSamples(t,_,o),_=o;while(i>_);0==this.m_portDepth&&this.m_oscMod1.setFrequency(e.getFrequency(this.m_freqNo))},e.prototype.getSamples_PP=function(t,s,i){var o,h,_=s,r=this.m_osc2Sign*this.m_lfoDepth;do o=_+e.s_lfoDelta,o>i&&(o=i),h=this.m_freqNo,0!=this.m_portDepth&&(h+=0|this.m_portDepth,this.m_portDepth+=this.m_portDepthAdd*(o-_-1),this.m_portDepth*this.m_portDepthAdd>0&&(this.m_portDepth=0)),this.m_onCounter>=this.m_lfoDelay&&(0==this.m_lfoEnd||this.m_onCounter<this.m_lfoEnd)&&(h+=this.m_oscMod2.getNextSample()*r,this.m_oscMod2.addPhase(o-_-1),this.m_portDepth*this.m_portDepthAdd>0&&(this.m_portDepth=0)),this.m_oscMod1.setFrequency(e.getFrequency(h)),this.m_oscMod1.getSamples(t,_,o),this.m_onCounter+=o-_,_=o;while(i>_)},e.prototype.getSamples_WP=function(s,i,o){var h,_,r,n=i,a=this.m_osc2Sign*this.m_lfoDepth*.01,m=this.m_oscSet1.getMod(t.MOscillator.PULSE);do h=n+e.s_lfoDelta,h>o&&(h=o),r=this.m_freqNo,0!=this.m_portDepth&&(r+=0|this.m_portDepth,this.m_portDepth+=this.m_portDepthAdd*(h-n-1),this.m_portDepth*this.m_portDepthAdd>0&&(this.m_portDepth=0)),this.m_oscMod1.setFrequency(e.getFrequency(r)),_=this.m_pulseWidth,this.m_onCounter>=this.m_lfoDelay&&(0==this.m_lfoEnd||this.m_onCounter<this.m_lfoEnd)&&(_+=this.m_oscMod2.getNextSample()*a,this.m_oscMod2.addPhase(h-n-1)),0>_?_=0:_>100&&(_=100),m.setPWM(_),this.m_oscMod1.getSamples(s,n,h),this.m_onCounter+=h-n,n=h;while(o>n);0==this.m_portDepth&&this.m_oscMod1.setFrequency(e.getFrequency(this.m_freqNo))},e.prototype.getSamplesF_P=function(t,s,i){var o,h,_=this.m_inSens,r=e.s_pipeArr[this.m_inPipe];for(h=s;i>h;h++)o=this.m_freqNo,0!=this.m_portDepth&&(o+=0|this.m_portDepth,this.m_portDepth+=this.m_portDepthAdd,this.m_portDepth*this.m_portDepthAdd>0&&(this.m_portDepth=0)),this.m_oscMod1.setFrequency(e.getFrequency(o)),t[h]=this.m_oscMod1.getNextSampleOfs(r[h]*_)},e.prototype.getSamplesFPP=function(t,s,i){var o,h,_=this.m_inSens,r=this.m_osc2Sign*this.m_lfoDepth,n=e.s_pipeArr[this.m_inPipe];for(o=s;i>o;o++)h=this.m_freqNo,0!=this.m_portDepth&&(h+=0|this.m_portDepth,this.m_portDepth+=this.m_portDepthAdd,this.m_portDepth*this.m_portDepthAdd>0&&(this.m_portDepth=0)),this.m_onCounter>=this.m_lfoDelay&&(0==this.m_lfoEnd||this.m_onCounter<this.m_lfoEnd)&&(h+=this.m_oscMod2.getNextSample()*r|0),this.m_oscMod1.setFrequency(e.getFrequency(h)),t[o]=this.m_oscMod1.getNextSampleOfs(n[o]*_),this.m_onCounter++},e.prototype.getSamplesFWP=function(s,i,o){var h,_,r,n=this.m_osc2Sign*this.m_lfoDepth*.01,a=this.m_oscSet1.getMod(t.MOscillator.PULSE),m=this.m_inSens,c=e.s_pipeArr[this.m_inPipe];for(h=i;o>h;h++)_=this.m_freqNo,0!=this.m_portDepth&&(_+=0|this.m_portDepth,this.m_portDepth+=this.m_portDepthAdd,this.m_portDepth*this.m_portDepthAdd>0&&(this.m_portDepth=0)),this.m_oscMod1.setFrequency(e.getFrequency(_)),r=this.m_pulseWidth,this.m_onCounter>=this.m_lfoDelay&&(0==this.m_lfoEnd||this.m_onCounter<this.m_lfoEnd)&&(r+=this.m_oscMod2.getNextSample()*n),0>r?r=0:r>100&&(r=100),a.setPWM(r),s[h]=this.m_oscMod1.getNextSampleOfs(c[h]*m),this.m_onCounter++},e.prototype.getSamplesFFP=function(t,s,i){var o,h,_,r=this.m_osc2Sign*this.m_lfoDepth*(1/127),n=e.s_pipeArr[this.m_inPipe];for(o=s;i>o;o++)h=this.m_freqNo,0!=this.m_portDepth&&(h+=0|this.m_portDepth,this.m_portDepth+=this.m_portDepthAdd,this.m_portDepth*this.m_portDepthAdd>0&&(this.m_portDepth=0)),this.m_oscMod1.setFrequency(e.getFrequency(h)),_=this.m_inSens,this.m_onCounter>=this.m_lfoDelay&&(0==this.m_lfoEnd||this.m_onCounter<this.m_lfoEnd)&&(_*=this.m_oscMod2.getNextSample()*r),t[o]=this.m_oscMod1.getNextSampleOfs(n[o]*_),this.m_onCounter++},e.prototype.getSamplesI_P=function(t,s,i){var o,h,_=s,r=e.s_syncSources[this.m_syncPipe];do o=_+e.s_lfoDelta,o>i&&(o=i),h=this.m_freqNo,0!=this.m_portDepth&&(h+=0|this.m_portDepth,this.m_portDepth+=this.m_portDepthAdd*(o-_-1),this.m_portDepth*this.m_portDepthAdd>0&&(this.m_portDepth=0)),this.m_oscMod1.setFrequency(e.getFrequency(h)),this.m_oscMod1.getSamplesWithSyncIn(t,r,_,o),this.m_onCounter+=o-_,_=o;while(i>_);0==this.m_portDepth&&this.m_oscMod1.setFrequency(e.getFrequency(this.m_freqNo))},e.prototype.getSamplesIPP=function(t,s,i){var o,h,_=s,r=this.m_osc2Sign*this.m_lfoDepth,n=e.s_syncSources[this.m_syncPipe];do o=_+e.s_lfoDelta,o>i&&(o=i),h=this.m_freqNo,0!=this.m_portDepth&&(h+=0|this.m_portDepth,this.m_portDepth+=this.m_portDepthAdd*(o-_-1),this.m_portDepth*this.m_portDepthAdd>0&&(this.m_portDepth=0)),this.m_onCounter>=this.m_lfoDelay&&(0==this.m_lfoEnd||this.m_onCounter<this.m_lfoEnd)&&(h+=this.m_oscMod2.getNextSample()*r|0,this.m_oscMod2.addPhase(o-_-1)),this.m_oscMod1.setFrequency(e.getFrequency(h)),this.m_oscMod1.getSamplesWithSyncIn(t,n,_,o),this.m_onCounter+=o-_,_=o;while(i>_)},e.prototype.getSamplesIWP=function(s,i,o){var h,_,r,n=i,a=this.m_osc2Sign*this.m_lfoDepth*.01,m=this.m_oscSet1.getMod(t.MOscillator.PULSE),c=e.s_syncSources[this.m_syncPipe];do h=n+e.s_lfoDelta,h>o&&(h=o),_=this.m_freqNo,0!=this.m_portDepth&&(_+=0|this.m_portDepth,this.m_portDepth+=this.m_portDepthAdd*(h-n-1),this.m_portDepth*this.m_portDepthAdd>0&&(this.m_portDepth=0)),this.m_oscMod1.setFrequency(e.getFrequency(_)),r=this.m_pulseWidth,this.m_onCounter>=this.m_lfoDelay&&(0==this.m_lfoEnd||this.m_onCounter<this.m_lfoEnd)&&(r+=this.m_oscMod2.getNextSample()*a,this.m_oscMod2.addPhase(h-n-1)),0>r?r=0:r>100&&(r=100),m.setPWM(r),this.m_oscMod1.getSamplesWithSyncIn(s,c,n,h),this.m_onCounter+=h-n,n=h;while(o>n);0==this.m_portDepth&&this.m_oscMod1.setFrequency(e.getFrequency(this.m_freqNo))},e.prototype.getSamplesO_P=function(t,s,i){var o,h,_=s,r=e.s_syncSources[this.m_syncPipe];do o=_+e.s_lfoDelta,o>i&&(o=i),h=this.m_freqNo,0!=this.m_portDepth&&(h+=0|this.m_portDepth,this.m_portDepth+=this.m_portDepthAdd*(o-_-1),this.m_portDepth*this.m_portDepthAdd>0&&(this.m_portDepth=0)),this.m_oscMod1.setFrequency(e.getFrequency(h)),this.m_oscMod1.getSamplesWithSyncOut(t,r,_,o),this.m_onCounter+=o-_,_=o;while(i>_);0==this.m_portDepth&&this.m_oscMod1.setFrequency(e.getFrequency(this.m_freqNo))},e.prototype.getSamplesOPP=function(t,s,i){var o,h,_=s,r=this.m_osc2Sign*this.m_lfoDepth,n=e.s_syncSources[this.m_syncPipe];do o=_+e.s_lfoDelta,o>i&&(o=i),h=this.m_freqNo,0!=this.m_portDepth&&(h+=0|this.m_portDepth,this.m_portDepth+=this.m_portDepthAdd*(o-_-1),this.m_portDepth*this.m_portDepthAdd>0&&(this.m_portDepth=0)),this.m_onCounter>=this.m_lfoDelay&&(0==this.m_lfoEnd||this.m_onCounter<this.m_lfoEnd)&&(h+=this.m_oscMod2.getNextSample()*r|0,this.m_oscMod2.addPhase(o-_-1)),this.m_oscMod1.setFrequency(e.getFrequency(h)),this.m_oscMod1.getSamplesWithSyncOut(t,n,_,o),this.m_onCounter+=o-_,_=o;while(i>_)},e.prototype.getSamplesOWP=function(s,i,o){var h,_,r,n=i,a=this.m_osc2Sign*this.m_lfoDepth*.01,m=this.m_oscSet1.getMod(t.MOscillator.PULSE),c=e.s_syncSources[this.m_syncPipe];do h=n+e.s_lfoDelta,h>o&&(h=o),_=this.m_freqNo,0!=this.m_portDepth&&(_+=0|this.m_portDepth,this.m_portDepth+=this.m_portDepthAdd*(h-n-1),this.m_portDepth*this.m_portDepthAdd>0&&(this.m_portDepth=0)),this.m_oscMod1.setFrequency(e.getFrequency(_)),r=this.m_pulseWidth,this.m_onCounter>=this.m_lfoDelay&&(0==this.m_lfoEnd||this.m_onCounter<this.m_lfoEnd)&&(r+=this.m_oscMod2.getNextSample()*a,this.m_oscMod2.addPhase(h-n-1)),0>r?r=0:r>100&&(r=100),m.setPWM(r),this.m_oscMod1.getSamplesWithSyncOut(s,c,n,h),this.m_onCounter+=h-n,n=h;while(o>n);0==this.m_portDepth&&this.m_oscMod1.setFrequency(e.getFrequency(this.m_freqNo))},e.LFO_TARGET_PITCH=0,e.LFO_TARGET_AMPLITUDE=1,e.LFO_TARGET_CUTOFF=2,e.LFO_TARGET_PWM=3,e.LFO_TARGET_FM=4,e.LFO_TARGET_PANPOT=5,e.PITCH_RESOLUTION=100,e.s_init=0,e.s_frequencyMap=new Array(128*e.PITCH_RESOLUTION),e.s_lfoDelta=245,e}();t.MChannel=e}(e=t.flmml||(t.flmml={}))}(FlMMLWorker||(FlMMLWorker={}));var FlMMLWorker;!function(t){var e;!function(t){var e=function(){function e(){this.m_isEnd=0,this.m_ch=new t.MChannel,this.m_needle=0,this.m_polyFound=!1,this.playTempo(e.DEFAULT_BPM),this.m_volume=100,this.recGate(.9375),this.recGate2(0),this.m_events=new Array,this.m_pointer=0,this.m_delta=0,this.m_globalTick=0,this.m_lfoWidth=0,this.m_totalMSec=0,this.m_chordBegin=0,this.m_chordEnd=0,this.m_chordMode=!1}return e.prototype.getNumEvents=function(){return this.m_events.length},e.prototype.onSampleData=function(e,s,i,o){if(void 0===o&&(o=!1),!this.isEnd())for(var h=s;i>h;){var _,r,n=0,a=this.m_events.length;do if(n=0,this.m_pointer<a&&(_=this.m_events[this.m_pointer],r=_.getDelta()*this.m_spt,this.m_needle>=r)){switch(n=1,_.getStatus()){case t.MStatus.NOTE_ON:this.m_ch.noteOn(_.getNoteNo(),_.getVelocity());break;case t.MStatus.NOTE_OFF:this.m_ch.noteOff(_.getNoteNo());break;case t.MStatus.NOTE:this.m_ch.setNoteNo(_.getNoteNo());break;case t.MStatus.VOLUME:break;case t.MStatus.TEMPO:this.playTempo(_.getTempo());break;case t.MStatus.FORM:this.m_ch.setForm(_.getForm(),_.getSubForm());break;case t.MStatus.ENVELOPE1_ATK:this.m_ch.setEnvelope1Atk(_.getEnvelopeA());break;case t.MStatus.ENVELOPE1_ADD:this.m_ch.setEnvelope1Point(_.getEnvelopeT(),_.getEnvelopeL());break;case t.MStatus.ENVELOPE1_REL:this.m_ch.setEnvelope1Rel(_.getEnvelopeR());break;case t.MStatus.ENVELOPE2_ATK:this.m_ch.setEnvelope2Atk(_.getEnvelopeA());break;case t.MStatus.ENVELOPE2_ADD:this.m_ch.setEnvelope2Point(_.getEnvelopeT(),_.getEnvelopeL());break;case t.MStatus.ENVELOPE2_REL:this.m_ch.setEnvelope2Rel(_.getEnvelopeR());break;case t.MStatus.NOISE_FREQ:this.m_ch.setNoiseFreq(_.getNoiseFreq());break;case t.MStatus.PWM:this.m_ch.setPWM(_.getPWM());break;case t.MStatus.PAN:this.m_ch.setPan(_.getPan());break;case t.MStatus.FORMANT:this.m_ch.setFormant(_.getVowel());break;case t.MStatus.DETUNE:this.m_ch.setDetune(_.getDetune());break;case t.MStatus.LFO_FMSF:this.m_ch.setLFOFMSF(_.getLFOForm(),_.getLFOSubForm());break;case t.MStatus.LFO_DPWD:this.m_lfoWidth=_.getLFOWidth()*this.m_spt,this.m_ch.setLFODPWD(_.getLFODepth(),t.MSequencer.SAMPLE_RATE/this.m_lfoWidth);break;case t.MStatus.LFO_DLTM:this.m_ch.setLFODLTM(_.getLFODelay()*this.m_spt,_.getLFOTime()*this.m_lfoWidth);break;case t.MStatus.LFO_TARGET:this.m_ch.setLFOTarget(_.getLFOTarget());break;case t.MStatus.LPF_SWTAMT:this.m_ch.setLpfSwtAmt(_.getLPFSwt(),_.getLPFAmt());break;case t.MStatus.LPF_FRQRES:this.m_ch.setLpfFrqRes(_.getLPFFrq(),_.getLPFRes());break;case t.MStatus.VOL_MODE:this.m_ch.setVolMode(_.getVolMode());break;case t.MStatus.INPUT:this.m_ch.setInput(_.getInputSens(),_.getInputPipe());break;case t.MStatus.OUTPUT:this.m_ch.setOutput(_.getOutputMode(),_.getOutputPipe());break;case t.MStatus.EXPRESSION:this.m_ch.setExpression(_.getExpression());break;case t.MStatus.RINGMODULATE:this.m_ch.setRing(_.getRingSens(),_.getRingInput());break;case t.MStatus.SYNC:this.m_ch.setSync(_.getSyncMode(),_.getSyncPipe());break;case t.MStatus.PORTAMENTO:this.m_ch.setPortamento(100*_.getPorDepth(),_.getPorLen()*this.m_spt);break;case t.MStatus.MIDIPORT:this.m_ch.setMidiPort(_.getMidiPort());break;case t.MStatus.MIDIPORTRATE:var m=_.getMidiPortRate();this.m_ch.setMidiPortRate((8-7.99*m/128)/m);break;case t.MStatus.BASENOTE:this.m_ch.setPortBase(100*_.getPortBase());break;case t.MStatus.POLY:this.m_ch.setVoiceLimit(_.getVoiceCount());break;case t.MStatus.HW_LFO:this.m_ch.setHwLfo(_.getHwLfoData());break;case t.MStatus.SOUND_OFF:this.m_ch.setSoundOff();break;case t.MStatus.RESET_ALL:this.m_ch.reset();break;case t.MStatus.CLOSE:this.m_ch.close();break;case t.MStatus.EOT:this.m_isEnd=1;break;case t.MStatus.NOP:}this.m_needle-=r,this.m_pointer++}while(n);var c;if(!(this.m_pointer<a))break;_=this.m_events[this.m_pointer],r=_.getDelta()*this.m_spt,c=Math.ceil(r-this.m_needle),h+c>=i&&(c=i-h),this.m_needle+=c,o||this.m_ch.getSamples(e,i,h,c),h+=c}},e.prototype.seek=function(t){this.m_delta+=t,this.m_globalTick+=t,this.m_chordEnd=Math.max(this.m_chordEnd,this.m_globalTick)},e.prototype.seekChordStart=function(){this.m_globalTick=this.m_chordBegin},e.prototype.recDelta=function(t){t.setDelta(this.m_delta),this.m_delta=0},e.prototype.recNote=function(t,e,s,i,o){void 0===i&&(i=1),void 0===o&&(o=1);var h=this.makeEvent();if(i?h.setNoteOn(t,s):h.setNote(t),this.pushEvent(h),o){var _;_=(e*this.m_gate|0)-this.m_gate2,0>=_&&(_=0),this.seek(_),this.recNoteOff(t,s),this.seek(e-_),this.m_chordMode&&this.seekChordStart()}else this.seek(e)},e.prototype.recNoteOff=function(t,e){var s=this.makeEvent();s.setNoteOff(t,e),this.pushEvent(s)},e.prototype.recRest=function(t){this.seek(t),this.m_chordMode&&(this.m_chordBegin+=t)},e.prototype.recChordStart=function(){0==this.m_chordMode&&(this.m_chordMode=!0,this.m_chordBegin=this.m_globalTick)},e.prototype.recChordEnd=function(){this.m_chordMode&&(this.m_events.length>0?this.m_delta=this.m_chordEnd-this.m_events[this.m_events.length-1].getTick():this.m_delta=0,this.m_globalTick=this.m_chordEnd,this.m_chordMode=!1)},e.prototype.recRestMSec=function(e){var s=e*t.MSequencer.SAMPLE_RATE/(1e3*this.m_spt)|0;this.seek(s)},e.prototype.recVolume=function(t){var e=this.makeEvent();e.setVolume(t),this.pushEvent(e)},e.prototype.recGlobal=function(e,s){for(var i=this.m_events.length,o=0,h=0;i>h;h++){var _=this.m_events[h],r=o+_.getDelta();if(r>e||r==e&&_.getStatus()!=t.MStatus.TEMPO)return _.setDelta(r-e),s.setDelta(e-o),void this.m_events.splice(h,0,s);o=r}s.setDelta(e-o),this.m_events.push(s)},e.prototype.insertEvent=function(t){for(var e=this.m_events.length,s=0,i=t.getTick(),o=0;e>o;o++){var h=this.m_events[o],_=s+h.getDelta();if(_>i)return h.setDelta(_-i),t.setDelta(i-s),void this.m_events.splice(o,0,t);s=_}t.setDelta(i-s),this.m_events.push(t)},e.prototype.makeEvent=function(){var e=new t.MEvent(this.m_globalTick);return e.setDelta(this.m_delta),this.m_delta=0,e},e.prototype.pushEvent=function(t){0==this.m_chordMode?this.m_events.push(t):this.insertEvent(t)},e.prototype.recTempo=function(e,s){var i=new t.MEvent(e);i.setTempo(s),this.recGlobal(e,i)},e.prototype.recEOT=function(){var t=this.makeEvent();t.setEOT(),this.pushEvent(t)},e.prototype.recGate=function(t){this.m_gate=t},e.prototype.recGate2=function(t){0>t&&(t=0),this.m_gate2=t},e.prototype.recForm=function(t,e){var s=this.makeEvent();s.setForm(t,e),this.pushEvent(s)},e.prototype.recEnvelope=function(t,e,s,i,o){var h=this.makeEvent();1==t?h.setEnvelope1Atk(e):h.setEnvelope2Atk(e),this.pushEvent(h);for(var _=0,r=s.length;r>_;_++)h=this.makeEvent(),1==t?h.setEnvelope1Point(s[_],i[_]):h.setEnvelope2Point(s[_],i[_]),this.pushEvent(h);h=this.makeEvent(),1==t?h.setEnvelope1Rel(o):h.setEnvelope2Rel(o),this.pushEvent(h)},e.prototype.recNoiseFreq=function(t){var e=this.makeEvent();e.setNoiseFreq(t),this.pushEvent(e)},e.prototype.recPWM=function(t){var e=this.makeEvent();e.setPWM(t),this.pushEvent(e)},e.prototype.recPan=function(t){var e=this.makeEvent();e.setPan(t),this.pushEvent(e)},e.prototype.recFormant=function(t){var e=this.makeEvent();e.setFormant(t),this.pushEvent(e)},e.prototype.recDetune=function(t){var e=this.makeEvent();e.setDetune(t),this.pushEvent(e)},e.prototype.recLFO=function(t,e,s,i,o,h,_){var r=this.makeEvent();r.setLFOFMSF(s,i),this.pushEvent(r),r=this.makeEvent(),r.setLFODPWD(t,e),this.pushEvent(r),r=this.makeEvent(),r.setLFODLTM(o,h),this.pushEvent(r),r=this.makeEvent(),r.setLFOTarget(_),this.pushEvent(r)},e.prototype.recLPF=function(t,e,s,i){var o=this.makeEvent();o.setLPFSWTAMT(t,e),this.pushEvent(o),o=this.makeEvent(),o.setLPFFRQRES(s,i),this.pushEvent(o)},e.prototype.recVolMode=function(t){var e=this.makeEvent();e.setVolMode(t),this.pushEvent(e)},e.prototype.recInput=function(t,e){var s=this.makeEvent();s.setInput(t,e),this.pushEvent(s)},e.prototype.recOutput=function(t,e){var s=this.makeEvent();s.setOutput(t,e),this.pushEvent(s)},e.prototype.recExpression=function(t){var e=this.makeEvent();e.setExpression(t),this.pushEvent(e)},e.prototype.recRing=function(t,e){var s=this.makeEvent();s.setRing(t,e),this.pushEvent(s)},e.prototype.recSync=function(t,e){var s=this.makeEvent();s.setSync(t,e),this.pushEvent(s)},e.prototype.recClose=function(){var t=this.makeEvent();t.setClose(),this.pushEvent(t)},e.prototype.recPortamento=function(t,e){var s=this.makeEvent();s.setPortamento(t,e),this.pushEvent(s)},e.prototype.recMidiPort=function(t){var e=this.makeEvent();e.setMidiPort(t),this.pushEvent(e)},e.prototype.recMidiPortRate=function(t){var e=this.makeEvent();e.setMidiPortRate(t),this.pushEvent(e)},e.prototype.recPortBase=function(t){var e=this.makeEvent();e.setPortBase(t),this.pushEvent(e)},e.prototype.recPoly=function(t){var e=this.makeEvent();e.setPoly(t),this.pushEvent(e),this.m_polyFound=!0},e.prototype.recHwLfo=function(t,e,s,i,o,h,_){var r=this.makeEvent();r.setHwLfo(t,e,s,i,o,h,_),this.pushEvent(r)},e.prototype.isEnd=function(){return this.m_isEnd},e.prototype.getRecGlobalTick=function(){return this.m_globalTick},e.prototype.seekTop=function(){this.m_globalTick=0},e.prototype.conduct=function(s){var i,o,h,_=this.m_events.length,r=s.length,n=0,a=0,m=this.calcSpt(e.DEFAULT_BPM);for(i=0;_>i;i++)switch(h=this.m_events[i],n+=h.getDelta(),a+=h.getDelta()*m,h.getStatus()){case t.MStatus.TEMPO:for(m=this.calcSpt(h.getTempo()),o=e.FIRST_TRACK;r>o;o++)s[o].recTempo(n,h.getTempo())}var c=0;for(o=e.FIRST_TRACK;r>o;o++)c<s[o].getRecGlobalTick()&&(c=s[o].getRecGlobalTick());h=this.makeEvent(),h.setClose(),this.recGlobal(c,h),a+=(c-n)*m,this.recRestMSec(3e3),this.recEOT(),a+=3*t.MSequencer.SAMPLE_RATE,this.m_totalMSec=1e3*a/t.MSequencer.SAMPLE_RATE},e.prototype.calcSpt=function(e){var s=96*e/60;return t.MSequencer.SAMPLE_RATE/s},e.prototype.playTempo=function(t){this.m_bpm=t,this.m_spt=this.calcSpt(t)},e.prototype.getTotalMSec=function(){return this.m_totalMSec},e.prototype.getTotalTimeStr=function(){var t=Math.ceil(this.m_totalMSec/1e3),e="0"+Math.floor(t/60),s="0"+t%60;return e.substr(e.length-2,2)+":"+s.substr(s.length-2,2)},e.prototype.getVoiceCount=function(){return this.m_ch.getVoiceCount()},e.prototype.usingMono=function(){this.m_ch=new t.MChannel},e.prototype.usingPoly=function(e){this.m_ch=new t.MPolyChannel(e)},e.prototype.findPoly=function(){return this.m_polyFound},e.TEMPO_TRACK=0,e.FIRST_TRACK=1,e.DEFAULT_BPM=120,e}();t.MTrack=e}(e=t.flmml||(t.flmml={}))}(FlMMLWorker||(FlMMLWorker={}));var FlMMLWorker;!function(t){var e;!function(t){var e=function(){function t(){this.m_ca0=811044e-11,this.m_ca1=8.943665402,this.m_ca2=-36.83889529,this.m_ca3=92.01697887,this.m_ca4=-154.337906,this.m_ca5=181.6233289,this.m_ca6=-151.8651235,this.m_ca7=89.09614114,this.m_ca8=-35.10298511,this.m_ca9=8.388101016,this.m_caA=-.923313471,this.m_ce0=436215e-11,this.m_ce1=8.90438318,this.m_ce2=-36.55179099,this.m_ce3=91.05750846,this.m_ce4=-152.422234,this.m_ce5=179.1170248,this.m_ce6=-149.6496211,this.m_ce7=87.78352223,this.m_ce8=-34.60687431,this.m_ce9=8.282228154,this.m_ceA=-.914150747,this.m_ci0=333819e-11,this.m_ci1=8.893102966,this.m_ci2=-36.49532826,this.m_ci3=90.96543286,this.m_ci4=-152.4545478,this.m_ci5=179.4835618,this.m_ci6=-150.315433,this.m_ci7=88.43409371,this.m_ci8=-34.98612086,this.m_ci9=8.407803364,this.m_ciA=-.932568035,this.m_co0=113572e-11,this.m_co1=8.994734087,this.m_co2=-37.2084849,this.m_co3=93.22900521,this.m_co4=-156.6929844,this.m_co5=184.596544,this.m_co6=-154.3755513,this.m_co7=90.49663749,this.m_co8=-35.58964535,this.m_co9=8.478996281,this.m_coA=-.929252233,this.m_cu0=4.09431e-7,this.m_cu1=8.997322763,this.m_cu2=-37.20218544,this.m_cu3=93.11385476,this.m_cu4=-156.2530937,this.m_cu5=183.7080141,this.m_cu6=-153.2631681,this.m_cu7=89.59539726,this.m_cu8=-35.12454591,this.m_cu9=8.338655623,this.m_cuA=-.910251753,this.m_vowel=t.VOWEL_A,this.m_power=!1,this.reset()}return t.prototype.setVowel=function(t){this.m_power=!0,this.m_vowel=t},t.prototype.disable=function(){this.m_power=!1,this.reset()},t.prototype.reset=function(){this.m_m0=this.m_m1=this.m_m2=this.m_m3=this.m_m4=this.m_m5=this.m_m6=this.m_m7=this.m_m8=this.m_m9=0},t.prototype.checkToSilence=function(){return this.m_power&&-1e-6<=this.m_m0&&this.m_m0<=1e-6&&-1e-6<=this.m_m1&&this.m_m1<=1e-6&&-1e-6<=this.m_m2&&this.m_m2<=1e-6&&-1e-6<=this.m_m3&&this.m_m3<=1e-6&&-1e-6<=this.m_m4&&this.m_m4<=1e-6&&-1e-6<=this.m_m5&&this.m_m5<=1e-6&&-1e-6<=this.m_m6&&this.m_m6<=1e-6&&-1e-6<=this.m_m7&&this.m_m7<=1e-6&&-1e-6<=this.m_m8&&this.m_m8<=1e-6&&-1e-6<=this.m_m9&&this.m_m9<=1e-6},t.prototype.run=function(t,e,s){if(this.m_power){var i;switch(this.m_vowel){case 0:for(i=e;s>i;i++)t[i]=this.m_ca0*t[i]+this.m_ca1*this.m_m0+this.m_ca2*this.m_m1+this.m_ca3*this.m_m2+this.m_ca4*this.m_m3+this.m_ca5*this.m_m4+this.m_ca6*this.m_m5+this.m_ca7*this.m_m6+this.m_ca8*this.m_m7+this.m_ca9*this.m_m8+this.m_caA*this.m_m9,this.m_m9=this.m_m8,this.m_m8=this.m_m7,this.m_m7=this.m_m6,this.m_m6=this.m_m5,this.m_m5=this.m_m4,this.m_m4=this.m_m3,this.m_m3=this.m_m2,this.m_m2=this.m_m1,this.m_m1=this.m_m0,this.m_m0=t[i];return;case 1:for(i=e;s>i;i++)t[i]=this.m_ce0*t[i]+this.m_ce1*this.m_m0+this.m_ce2*this.m_m1+this.m_ce3*this.m_m2+this.m_ce4*this.m_m3+this.m_ce5*this.m_m4+this.m_ce6*this.m_m5+this.m_ce7*this.m_m6+this.m_ce8*this.m_m7+this.m_ce9*this.m_m8+this.m_ceA*this.m_m9,this.m_m9=this.m_m8,this.m_m8=this.m_m7,this.m_m7=this.m_m6,this.m_m6=this.m_m5,this.m_m5=this.m_m4,this.m_m4=this.m_m3,this.m_m3=this.m_m2,this.m_m2=this.m_m1,this.m_m1=this.m_m0,this.m_m0=t[i];return;case 2:for(i=e;s>i;i++)t[i]=this.m_ci0*t[i]+this.m_ci1*this.m_m0+this.m_ci2*this.m_m1+this.m_ci3*this.m_m2+this.m_ci4*this.m_m3+this.m_ci5*this.m_m4+this.m_ci6*this.m_m5+this.m_ci7*this.m_m6+this.m_ci8*this.m_m7+this.m_ci9*this.m_m8+this.m_ciA*this.m_m9,this.m_m9=this.m_m8,this.m_m8=this.m_m7,this.m_m7=this.m_m6,this.m_m6=this.m_m5,this.m_m5=this.m_m4,this.m_m4=this.m_m3,this.m_m3=this.m_m2,this.m_m2=this.m_m1,this.m_m1=this.m_m0,this.m_m0=t[i];return;case 3:for(i=e;s>i;i++)t[i]=this.m_co0*t[i]+this.m_co1*this.m_m0+this.m_co2*this.m_m1+this.m_co3*this.m_m2+this.m_co4*this.m_m3+this.m_co5*this.m_m4+this.m_co6*this.m_m5+this.m_co7*this.m_m6+this.m_co8*this.m_m7+this.m_co9*this.m_m8+this.m_coA*this.m_m9,this.m_m9=this.m_m8,this.m_m8=this.m_m7,this.m_m7=this.m_m6,this.m_m6=this.m_m5,this.m_m5=this.m_m4,this.m_m4=this.m_m3,this.m_m3=this.m_m2,this.m_m2=this.m_m1,this.m_m1=this.m_m0,this.m_m0=t[i];return;case 4:for(i=e;s>i;i++)t[i]=this.m_cu0*t[i]+this.m_cu1*this.m_m0+this.m_cu2*this.m_m1+this.m_cu3*this.m_m2+this.m_cu4*this.m_m3+this.m_cu5*this.m_m4+this.m_cu6*this.m_m5+this.m_cu7*this.m_m6+this.m_cu8*this.m_m7+this.m_cu9*this.m_m8+this.m_cuA*this.m_m9,this.m_m9=this.m_m8,this.m_m8=this.m_m7,this.m_m7=this.m_m6,this.m_m6=this.m_m5,this.m_m5=this.m_m4,this.m_m4=this.m_m3,this.m_m3=this.m_m2,this.m_m2=this.m_m1,this.m_m1=this.m_m0,this.m_m0=t[i];return}}},t.VOWEL_A=0,t.VOWEL_E=1,t.VOWEL_I=2,t.VOWEL_O=3,t.VOWEL_U=4,t}();t.MFormant=e}(e=t.flmml||(t.flmml={}))}(FlMMLWorker||(FlMMLWorker={}));var FlMMLWorker;!function(t){var e;!function(t){var e=function(){function e(){this.m_sequencer=new t.MSequencer}return e.prototype.getWarnings=function(){return this.m_warning},e.prototype.warning=function(e,s){this.m_warning+=t.MWarning.getString(e,s)+"\n"},e.prototype.len2tick=function(t){return 0==t?this.m_length:384/t|0},e.prototype.note=function(t){if(t+=this.m_noteShift+this.getKeySig(),"*"==this.getChar())this.m_beforeNote=t+12*this.m_octave,this.m_portamento=1,this.next();else{var e,s,i,o=0,h=0,_=0==this.m_keyoff?0:1;for(this.m_keyoff=1;;){if("%"!=this.getChar()?e=0:(e=1,this.next()),s=this.getUInt(0),1==h&&0==s){this.m_keyoff=0;break}if(i=e?s:this.len2tick(s),o+=this.getDot(i),h=0,"&"!=this.getChar())break;h=1,this.next()}1==this.m_portamento&&this.m_tracks[this.m_trackNo].recPortamento(this.m_beforeNote-(t+12*this.m_octave),o),this.m_tracks[this.m_trackNo].recNote(t+12*this.m_octave,o,this.m_velocity,_,this.m_keyoff),1==this.m_portamento&&(this.m_tracks[this.m_trackNo].recPortamento(0,0),this.m_portamento=0)}},e.prototype.rest=function(){var t=0;"%"==this.getChar()&&(t=1,this.next());var e;e=this.getUInt(0);var s=t?e:this.len2tick(e);s=this.getDot(s),this.m_tracks[this.m_trackNo].recRest(s)},e.prototype.atmark=function(){var s,i,o,h,_=this,r=this.getChar(),n=1,a=0,m=64,c=32,p=0,l=0,u=0,f=0,S=0;switch(r){case"v":this.m_velDetail=!0,this.next(),this.m_velocity=this.getUInt(this.m_velocity),this.m_velocity>127&&(this.m_velocity=127);break;case"x":this.next(),n=this.getUInt(127),n>127&&(n=127),this.m_tracks[this.m_trackNo].recExpression(n);break;case"e":!function(){var t,e=new Array,s=new Array;for(_.next(),n=_.getUInt(n),","==_.getChar()&&_.next(),a=_.getUInt(a),t=_.m_letter;;){if(","!=_.getChar())break;if(_.next(),t=_.m_letter-1,m=_.getUInt(m),","!=_.getChar()){_.m_letter=t;break}_.next(),c=_.getUInt(c),e.push(m),s.push(c)}0==e.length&&(e.push(m),s.push(c)),","==_.getChar()&&_.next(),p=_.getUInt(p),_.m_tracks[_.m_trackNo].recEnvelope(n,a,e,s,p)}();break;case"m":if(this.next(),"h"==this.getChar()){this.next(),f=0,S=0,s=0,i=0,o=0,h=0,c=1;do{if(f=this.getUInt(f),","!=this.getChar())break;if(this.next(),S=this.getUInt(S),","!=this.getChar())break;if(this.next(),s=this.getUInt(s),","!=this.getChar())break;if(this.next(),i=this.getUInt(i),","!=this.getChar())break;if(this.next(),o=this.getUInt(o),","!=this.getChar())break;if(this.next(),h=this.getUInt(h),","!=this.getChar())break;this.next(),c=this.getUInt(c)}while(!1);this.m_tracks[this.m_trackNo].recHwLfo(f,S,s,i,o,h,c)}break;case"n":this.next(),"s"==this.getChar()?(this.next(),this.m_noteShift+=this.getSInt(0)):(n=this.getUInt(0),(0>n||n>127)&&(n=0),this.m_tracks[this.m_trackNo].recNoiseFreq(n));break;case"w":this.next(),n=this.getSInt(50),0>n?(n>-1&&(n=-1),-99>n&&(n=-99)):(1>n&&(n=1),n>99&&(n=99)),this.m_tracks[this.m_trackNo].recPWM(n);break;case"p":this.next(),"l"==this.getChar()?(this.next(),n=this.getUInt(this.m_polyVoice),n=Math.max(0,Math.min(this.m_polyVoice,n)),this.m_tracks[this.m_trackNo].recPoly(n)):(n=this.getUInt(64),1>n&&(n=1),n>127&&(n=127),this.m_tracks[this.m_trackNo].recPan(n));break;case"'":if(this.next(),n=this.m_string.indexOf("'",this.m_letter),n>=0){var g=this.m_string.substring(this.m_letter,n),M=0;switch(g){case"a":M=t.MFormant.VOWEL_A;break;case"e":M=t.MFormant.VOWEL_E;break;case"i":M=t.MFormant.VOWEL_I;break;case"o":M=t.MFormant.VOWEL_O;break;case"u":M=t.MFormant.VOWEL_U;break;default:M=-1}this.m_tracks[this.m_trackNo].recFormant(M),this.m_letter=n+1}break;case"d":this.next(),n=this.getSInt(0),this.m_tracks[this.m_trackNo].recDetune(n);break;case"l":!function(){var t=0,e=0,s=1,i=0,o=1,h=0,r=0,n=0;_.next(),t=_.getUInt(t),","==_.getChar()&&_.next(),e=_.getUInt(e),","==_.getChar()&&(_.next(),"-"==_.getChar()&&(o=-1,_.next()),s=(_.getUInt(s)+1)*o,"-"==_.getChar()&&(_.next(),i=_.getUInt(0)),","==_.getChar()&&(_.next(),h=_.getUInt(h),","==_.getChar()&&(_.next(),r=_.getUInt(r),","==_.getChar()&&(_.next(),n=_.getUInt(n))))),_.m_tracks[_.m_trackNo].recLFO(t,e,s,i,h,r,n)}();break;case"f":!function(){var t=0,e=0,s=0,i=0;_.next(),t=_.getSInt(t),","==_.getChar()&&(_.next(),e=_.getSInt(e),","==_.getChar()&&(_.next(),s=_.getUInt(s),","==_.getChar()&&(_.next(),i=_.getUInt(i)))),_.m_tracks[_.m_trackNo].recLPF(t,e,s,i)}();break;case"q":this.next(),this.m_tracks[this.m_trackNo].recGate2(2*this.getUInt(2));break;case"i":l=0,this.next(),l=this.getUInt(l),","==this.getChar()&&(this.next(),a=this.getUInt(a),a>this.m_maxPipe&&(a=this.m_maxPipe)),this.m_tracks[this.m_trackNo].recInput(l,a);break;case"o":u=0,this.next(),u=this.getUInt(u),","==this.getChar()&&(this.next(),a=this.getUInt(a),a>this.m_maxPipe&&(this.m_maxPipe=a,this.m_maxPipe>=e.MAX_PIPE&&(this.m_maxPipe=a=e.MAX_PIPE))),this.m_tracks[this.m_trackNo].recOutput(u,a);break;case"r":!function(){l=0,_.next(),l=_.getUInt(l),","==_.getChar()&&(_.next(),a=_.getUInt(a),a>_.m_maxPipe&&(a=_.m_maxPipe)),_.m_tracks[_.m_trackNo].recRing(l,a)}();break;case"s":u=0,this.next(),u=this.getUInt(u),","==this.getChar()&&(this.next(),a=this.getUInt(a),1==u?a>this.m_maxSyncSource&&(this.m_maxSyncSource=a,this.m_maxSyncSource>=e.MAX_SYNCSOURCE&&(this.m_maxSyncSource=a=e.MAX_SYNCSOURCE)):2==u&&a>this.m_maxSyncSource&&(a=this.m_maxSyncSource)),this.m_tracks[this.m_trackNo].recSync(u,a);break;case"u":this.next();var v;switch(u=this.getUInt(0)){case 0:case 1:this.m_tracks[this.m_trackNo].recMidiPort(u);break;case 2:v=0,","==this.getChar()&&(this.next(),v=this.getUInt(0),0>v&&(v=0),v>127&&(v=127)),this.m_tracks[this.m_trackNo].recMidiPortRate(1*v);break;case 3:if(","==this.getChar()){this.next();var E,y=-1;switch("o"!=this.getChar()?E=this.m_octave:(this.next(),E=this.getUInt(0)),r=this.getChar()){case"c":y=0;break;case"d":y=2;break;case"e":y=4;break;case"f":y=5;break;case"g":y=7;break;case"a":y=9;break;case"b":y=11}y>=0?(this.next(),y+=this.m_noteShift+this.getKeySig(),y+=12*E):y=this.getUInt(60),0>y&&(y=0),y>127&&(y=127),this.m_tracks[this.m_trackNo].recPortBase(y)}}break;default:this.m_form=this.getUInt(this.m_form),a=0,"-"==this.getChar()&&(this.next(),a=this.getUInt(0)),this.m_tracks[this.m_trackNo].recForm(this.m_form,a)}},e.prototype.firstLetter=function(){var e,s,i=this.getCharNext();switch(i){case"c":this.note(0);break;case"d":this.note(2);break;case"e":this.note(4);break;case"f":this.note(5);break;case"g":this.note(7);break;case"a":this.note(9);break;case"b":this.note(11);break;case"r":this.rest();break;case"o":this.m_octave=this.getUInt(this.m_octave),this.m_octave<-2&&(this.m_octave=-2),this.m_octave>8&&(this.m_octave=8);break;case"v":this.m_velDetail=!1,this.m_velocity=8*this.getUInt((this.m_velocity-7)/8)+7,this.m_velocity<0&&(this.m_velocity=0),this.m_velocity>127&&(this.m_velocity=127);break;case"(":case")":s=this.getUInt(1),"("==i&&this.m_velDir||")"==i&&!this.m_velDir?(this.m_velocity+=this.m_velDetail?1*s:8*s,this.m_velocity>127&&(this.m_velocity=127)):(this.m_velocity-=this.m_velDetail?1*s:8*s,this.m_velocity<0&&(this.m_velocity=0));break;case"l":this.m_length=this.len2tick(this.getUInt(0)),this.m_length=this.getDot(this.m_length);break;case"t":this.m_tempo=this.getUNumber(this.m_tempo),this.m_tempo<1&&(this.m_tempo=1),this.m_tracks[t.MTrack.TEMPO_TRACK].recTempo(this.m_tracks[this.m_trackNo].getRecGlobalTick(),this.m_tempo);break;case"q":this.m_gate=this.getUInt(this.m_gate),this.m_tracks[this.m_trackNo].recGate(Number(this.m_gate)/Number(this.m_maxGate));break;case"<":this.m_relativeDir?this.m_octave++:this.m_octave--;break;case">":this.m_relativeDir?this.m_octave--:this.m_octave++;break;case";":this.m_keyoff=1,this.m_tracks[this.m_trackNo].getNumEvents()>0&&this.m_trackNo++,this.m_tracks[this.m_trackNo]=this.createTrack();break;case"@":this.atmark();break;case"x":this.m_tracks[this.m_trackNo].recVolMode(this.getUInt(1));break;case"n":e=this.getChar(),"s"==e?(this.next(),this.m_noteShift=this.getSInt(this.m_noteShift)):this.warning(t.MWarning.UNKNOWN_COMMAND,i+e);break;case"[":this.m_tracks[this.m_trackNo].recChordStart();break;case"]":this.m_tracks[this.m_trackNo].recChordEnd();break;default:var o=i.charCodeAt(0);128>o&&this.warning(t.MWarning.UNKNOWN_COMMAND,i)}},e.prototype.getCharNext=function(){return this.m_letter<this.m_string.length?this.m_string.charAt(this.m_letter++):""},e.prototype.getChar=function(){return this.m_letter<this.m_string.length?this.m_string.charAt(this.m_letter):""},e.prototype.next=function(t){void 0===t&&(t=1),this.m_letter+=1},e.prototype.getKeySig=function(){for(var t=0,e=1;e;){var s=this.getChar();switch(s){case"+":case"#":t++,this.next();break;case"-":t--,this.next();break;default:e=0}}return t},e.prototype.getUInt=function(t){for(var e=0,s=this.m_letter,i=1;i;){var o=this.getChar();switch(o){case"0":e=10*e+0,this.next();break;case"1":e=10*e+1,this.next();break;case"2":e=10*e+2,this.next();break;case"3":e=10*e+3,this.next();break;case"4":e=10*e+4,this.next();break;case"5":e=10*e+5,this.next();break;case"6":e=10*e+6,this.next();break;case"7":e=10*e+7,this.next();break;case"8":e=10*e+8,this.next();break;case"9":e=10*e+9,this.next();break;default:i=0}}return this.m_letter==s?t:e},e.prototype.getUNumber=function(t){var e=this.getUInt(0|t),s=1;if("."==this.getChar()){this.next();for(var i=!0;i;){var o=this.getChar();switch(s*=.1,o){case"0":e+=0*s,this.next();break;case"1":e+=1*s,this.next();break;case"2":e+=2*s,this.next();break;case"3":e+=3*s,this.next();break;case"4":e+=4*s,this.next();break;case"5":e+=5*s,this.next();break;case"6":e+=6*s,this.next();break;case"7":e+=7*s,this.next();break;case"8":e+=8*s,this.next();break;case"9":e+=9*s,this.next();break;default:i=!1}}}return e},e.prototype.getSInt=function(t){var e=this.getChar(),s=1;return"-"==e?(s=-1,this.next()):"+"==e&&this.next(),this.getUInt(t)*s},e.prototype.getDot=function(t){for(var e=this.getChar(),s=t;"."==e;)this.next(),s/=2,t+=s,e=this.getChar();return t},e.prototype.createTrack=function(){return this.m_octave=4,this.m_velocity=100,this.m_noteShift=0,new t.MTrack},e.prototype.begin=function(){this.m_letter=0},e.prototype.process=function(){for(this.begin();this.m_letter<this.m_string.length;)this.firstLetter()},e.prototype.processRepeat=function(){this.m_string=this.m_string.toLowerCase(),this.begin();for(var e=new Array,s=new Array,i=new Array,o=new Array,h=-1;this.m_letter<this.m_string.length;){var _=this.getCharNext();switch(_){case"/":":"==this.getChar()?(this.next(),s[++h]=this.m_letter-2,e[h]=this.getUInt(2),i[h]=this.m_letter,o[h]=-1):h>=0&&(o[h]=this.m_letter-1,this.m_string=this.m_string.substring(0,this.m_letter-1)+this.m_string.substring(this.m_letter),this.m_letter--);break;case":":if("/"==this.getChar()&&h>=0){this.next();for(var r=this.m_string.substring(i[h],this.m_letter-2),n=this.m_string.substring(0,s[h]),a=0;a<e[h];a++)n+=a<e[h]-1||o[h]<0?r:this.m_string.substring(i[h],o[h]);var m=n.length;n+=this.m_string.substring(this.m_letter),this.m_string=n,this.m_letter=m,h--}}}h>=0&&this.warning(t.MWarning.UNCLOSED_REPEAT,"")},e.prototype.replaceMacro=function(s){for(var i in s){var o=s[i];if(this.m_string.substr(this.m_letter,o.id.length)==o.id){var h=this.m_letter,_=this.m_letter+o.id.length,r=o.code;this.m_letter+=o.id.length;for(var n=this.getCharNext();e.isWhitespace(n);)n=this.getCharNext();var a=new Array,m=0;if(o.args.length>0){if("{"==n){for(n=this.getCharNext();1==m||"}"!=n&&""!=n;)'"'==n&&(m=1-m),"$"==n&&this.replaceMacro(s),n=this.getCharNext();_=this.m_letter;for(var c=this.m_string.substring(h+o.id.length+1,_-1),p="",l=!1,u=0;u<c.length;u++)l||'"'!=c.charAt(u)?l&&u+1<c.length&&"\\"==c.charAt(u)&&'"'==c.charAt(u+1)?(p+='"',u++):l&&'"'==c.charAt(u)?l=!1:l||","!=c.charAt(u)?p+=c.charAt(u):(a.push(p),p=""):l=!0;a.push(p),l&&this.warning(t.MWarning.UNCLOSED_ARGQUOTE,"")}for(var f=0;f<r.length;f++)for(var S=0;S<a.length&&!(S>=o.args.length);S++)if(r.substr(f,o.args[S].id.length+1)=="%"+o.args[S].id){r=r.substring(0,f)+r.substring(f).replace("%"+o.args[S].id,a[o.args[S].index]),f+=a[o.args[S].index].length-1;break}}return this.m_string=this.m_string.substring(0,h-1)+r+this.m_string.substring(_),this.m_letter=h-1,!0}}return!1},e.prototype.processMacro=function(){var s,i,o=/^#OCTAVE\s+REVERSE\s*$/m;if(this.m_string.match(o)&&(this.m_string=this.m_string.replace(o,""),this.m_relativeDir=!1),o=/^#VELOCITY\s+REVERSE\s*$/m,this.m_string.match(o)&&(this.m_string=this.m_string.replace(o,""),this.m_velDir=!1),this.m_metaTitle=this.findMetaDescN("TITLE"),this.m_metaArtist=this.findMetaDescN("ARTIST"),this.m_metaComment=this.findMetaDescN("COMMENT"),this.m_metaCoding=this.findMetaDescN("CODING"),this.findMetaDescN("PRAGMA"),o=/^#OPM@(\d+)[ \t]*{([^}]*)}/gm,i=this.m_string.match(o)){this.m_string=this.m_string.replace(o,"");var h;for(s=0;s<i.length;s++)h=i[s].match(/^#OPM@(\d+)[ \t]*{([^}]*)}/m),t.MOscOPM.setTimber(parseInt(h[1]),t.MOscOPM.TYPE_OPM,h[2])}if(o=/^#OPN@(\d+)[ \t]*{([^}]*)}/gm,i=this.m_string.match(o)){this.m_string=this.m_string.replace(o,"");var _;for(s=0;s<i.length;s++)_=i[s].match(/^#OPN@(\d+)[ \t]*{([^}]*)}/m),t.MOscOPM.setTimber(parseInt(_[1]),t.MOscOPM.TYPE_OPN,_[2])}var r=this.findMetaDescV("FMGAIN");for(s=0;s<r.length;s++)t.MOscOPM.setCommonGain(20*parseInt(r[s])/127);var n=this.findMetaDescN("USING\\s+POLY");if(n=n.replace("\r",""),n=n.replace("\n"," "),n=n.toLowerCase(),n.length>0){var a=n.split(" ");for(a.length<1?this.m_usingPoly=!1:(this.m_usingPoly=!0,this.m_polyVoice=Math.min(Math.max(1,parseInt(a[0])),e.MAX_POLYVOICE)),s=1;s<a.length;s++)"force"==a[s]&&(this.m_polyForce=!0);this.m_polyVoice<=1&&(this.m_usingPoly=!1,this.m_polyForce=!1)}if(o=/^#WAV10\s.*$/gm,i=this.m_string.match(o))for(s=0;s<i.length;s++){this.m_string=this.m_string.replace(o,"");for(var m=i[s].split(" "),c="",p=1;p<m.length;p++)c+=m[p];var l=c.split(","),u=parseInt(l[0]);0>u&&(u=0),u>=t.MOscGbWave.MAX_WAVE&&(u=t.MOscGbWave.MAX_WAVE-1),t.MOscGbWave.setWave(u,(l[1].toLowerCase()+"00000000000000000000000000000000").substr(0,32))}if(o=/^#WAV13\s.*$/gm,i=this.m_string.match(o))for(s=0;s<i.length;s++){for(this.m_string=this.m_string.replace(o,""),m=i[s].split(" "),c="",p=1;p<m.length;p++)c+=m[p];l=c.split(","),u=parseInt(l[0]),0>u&&(u=0),u>=t.MOscWave.MAX_WAVE&&(u=t.MOscWave.MAX_WAVE-1),t.MOscWave.setWave(u,l[1].toLowerCase())}if(o=/^#WAV9\s.*$/gm,i=this.m_string.match(o))for(s=0;s<i.length;s++){for(this.m_string=this.m_string.replace(o,""),m=i[s].split(" "),c="",p=1;p<m.length;p++)c+=m[p];l=c.split(","),u=parseInt(l[0]),0>u&&(u=0),u>=t.MOscFcDpcm.MAX_WAVE&&(u=t.MOscFcDpcm.MAX_WAVE-1);var f=parseInt(l[1]);0>f&&(f=0),f>127&&(f=127);var S=parseInt(l[2]);0>S&&(S=0),S>1&&(S=1),t.MOscFcDpcm.setWave(u,f,S,l[3])}this.begin();for(var g=!0,M=new Array,v=/^\s*/m,E=/\s*$/m;this.m_letter<this.m_string.length;){var y=this.getCharNext();switch(y){case"$":if(g){var P=this.m_string.indexOf(";",this.m_letter);if(P>this.m_letter){var F=this.m_string.indexOf("=",this.m_letter);if(F>this.m_letter&&P>F){var T=this.m_letter,O=this.m_string.indexOf("{");(0>O||O>=F)&&(O=F);var d=this.m_string.substring(T,O),A=d.match("[a-zA-Z_][a-zA-Z_0-9#+()]*");if(null!=A){var N=A[0];if(d=d.replace(v,"").replace(E,""),d!=N&&this.warning(t.MWarning.INVALID_MACRO_NAME,d),N.length>0){var b=new Array;if(F>O){var L=this.m_string.substring(O+1,this.m_string.indexOf("}",O));for(b=L.split(","),s=0;s<b.length;s++){var k=b[s].match("[a-zA-Z_][a-zA-Z_0-9#+()]*");b[s]={id:null!=k?k[0]:"",index:s}}b.sort(function(t,e){return t.id.length>e.id.length?-1:t.id.length==e.id.length?0:1})}for(this.m_letter=F+1,y=this.getCharNext();this.m_letter<P;)"$"==y&&(this.replaceMacro(M)||this.m_string.substr(this.m_letter,N.length)==N&&(this.m_letter--,this.m_string=e.remove(this.m_string,this.m_letter,this.m_letter+N.length),this.warning(t.MWarning.RECURSIVE_MACRO,N)),P=this.m_string.indexOf(";",this.m_letter)),y=this.getCharNext();for(var I=0;I<M.length;I++)if(M[I].id!=N){if(M[I].id.length<N.length)break}else M.splice(I,1),I--;M.splice(I,0,{id:N,code:this.m_string.substring(F+1,P),args:b}),this.m_string=e.remove(this.m_string,T-1,P),this.m_letter=T-1}}}else this.replaceMacro(M),g=!1}else this.replaceMacro(M),g=!1}else this.replaceMacro(M),g=!1;break;case";":g=!0;break;default:e.isWhitespace(y)||(g=!1)}}},e.prototype.findMetaDescV=function(t){var e,s,i,o,h,_=new Array;if(o=new RegExp("^#"+t+"(\\s*|\\s+(.*))$","gm"),h=new RegExp("^#"+t+"(\\s*|\\s+(.*))$","m"),s=this.m_string.match(o))for(this.m_string=this.m_string.replace(o,""),e=0;e<s.length;e++)i=s[e].match(h),i.length>=3&&_.push(i[2]);return _},e.prototype.findMetaDescN=function(t){var e,s,i,o,h,_="";if(o=new RegExp("^#"+t+"(\\s*|\\s+(.*))$","gm"),h=new RegExp("^#"+t+"(\\s*|\\s+(.*))$","m"),s=this.m_string.match(o))for(this.m_string=this.m_string.replace(o,""),e=0;e<s.length;e++)i=s[e].match(h),i.length>=3&&(_+=i[2],e+1<s.length&&(_+="\r\n"));return _},e.prototype.processComment=function(s){this.m_string=s,this.begin();for(var i=-1;this.m_letter<this.m_string.length;){var o=this.getCharNext();switch(o){case"/":"*"==this.getChar()&&(0>i&&(i=this.m_letter-1),this.next());break;case"*":"/"==this.getChar()&&(i>=0?(this.m_string=e.remove(this.m_string,i,this.m_letter),this.m_letter=i,i=-1):this.warning(t.MWarning.UNOPENED_COMMENT,""))}}for(i>=0&&this.warning(t.MWarning.UNCLOSED_COMMENT,""),this.begin(),i=-1;this.m_letter<this.m_string.length;)"`"==this.getCharNext()&&(0>i?i=this.m_letter-1:(this.m_string=e.remove(this.m_string,i,this.m_letter-1),this.m_letter=i,i=-1))},e.prototype.processGroupNotes=function(){var e,s,i,o,h,_,r,n,a,m,c=-1,p=0,l=96;for(this.begin();this.m_letter<this.m_string.length;){var u=this.getCharNext();switch(u){case"l":l=this.len2tick(this.getUInt(0)),l=this.getDot(l);break;case"{":c=this.m_letter-1,p=0;break;case"}":for(s=this.m_letter,0>c&&this.warning(t.MWarning.UNOPENED_GROUPNOTES,""),o=0;;){if("%"!=this.getChar()?a=0:(a=1,this.next()),i=this.getUInt(0),0==i){0==o&&(o=l);break}if(h=a?i:this.len2tick(i),h=this.getDot(h),o+=h,"&"!=this.getChar())break;this.next()}for(e=this.m_letter,this.m_letter=c+1,m=this.m_string.substring(0,c),h=0,_=Number(o)/Number(p),p=1,n=0;this.m_letter<s;){switch(u=this.getCharNext()){case"+":case"#":case"-":break;default:if((u>="a"&&"g">=u||"r"==u)&&0==n){n=1;break}1==n&&(r=Math.round(Number(p)*_-Number(h)),p++,h+=r,h>o&&(r-=h-o,h=o),m+="%",m+=r.toString()),n=0,(u>="a"&&"g">=u||"r"==u)&&(n=1)}"}"!=u&&(m+=u)}this.m_letter=m.length,m+=this.m_string.substring(e),this.m_string=m,c=-1;break;default:(u>="a"&&"g">=u||"r"==u)&&p++}}c>=0&&this.warning(t.MWarning.UNCLOSED_GROUPNOTES,"")},e.isWhitespace=function(t){return" "==t||"	"==t||"\n"==t||"\r"==t||""==t?!0:!1},e.removeWhitespace=function(t){return t.replace(new RegExp("[ \n\r	\f]+","g"),"")},e.remove=function(t,e,s){return t.substring(0,e)+t.substring(s+1)},e.prototype.play=function(t){return this.m_sequencer.isPaused()?void this.m_sequencer.play():void global.worker.stopSound(this.play2.bind(this,t),!0)},e.prototype.play2=function(s){this.m_sequencer.disconnectAll(),this.m_tracks=new Array,this.m_tracks[0]=this.createTrack(),this.m_tracks[1]=this.createTrack(),this.m_warning="",this.m_trackNo=t.MTrack.FIRST_TRACK,this.m_octave=4,this.m_relativeDir=!0,this.m_velocity=100,this.m_velDetail=!0,this.m_velDir=!0,this.m_length=this.len2tick(4),this.m_tempo=t.MTrack.DEFAULT_BPM,this.m_keyoff=1,this.m_gate=15,this.m_maxGate=16,this.m_form=t.MOscillator.PULSE,this.m_noteShift=0,this.m_maxPipe=0,this.m_maxSyncSource=0,this.m_beforeNote=0,this.m_portamento=0,this.m_usingPoly=!1,this.m_polyVoice=1,this.m_polyForce=!1,this.m_metaTitle="",this.m_metaArtist="",this.m_metaCoding="",this.m_metaComment="",this.processComment(s),this.processMacro(),this.m_string=e.removeWhitespace(this.m_string),this.processRepeat(),this.processGroupNotes(),this.process(),0==this.m_tracks[this.m_tracks.length-1].getNumEvents()&&this.m_tracks.pop(),this.m_tracks[t.MTrack.TEMPO_TRACK].conduct(this.m_tracks);for(var i=t.MTrack.TEMPO_TRACK;i<this.m_tracks.length;i++)i>t.MTrack.TEMPO_TRACK&&(this.m_usingPoly&&(this.m_polyForce||this.m_tracks[i].findPoly())&&this.m_tracks[i].usingPoly(this.m_polyVoice),this.m_tracks[i].recRestMSec(2e3),this.m_tracks[i].recClose()),this.m_sequencer.connect(this.m_tracks[i]);this.m_sequencer.createPipes(this.m_maxPipe+1),this.m_sequencer.createSyncSources(this.m_maxSyncSource+1),global.worker.compileComplete(),this.m_sequencer.play()},e.prototype.stop=function(){this.m_sequencer.stop()},e.prototype.pause=function(){this.m_sequencer.pause()},e.prototype.resume=function(){this.m_sequencer.play()},e.prototype.getGlobalTick=function(){return this.m_sequencer.getGlobalTick()},e.prototype.isPlaying=function(){return this.m_sequencer.isPlaying()},e.prototype.isPaused=function(){return this.m_sequencer.isPaused()},e.prototype.getTotalMSec=function(){return this.m_tracks[t.MTrack.TEMPO_TRACK].getTotalMSec()},e.prototype.getTotalTimeStr=function(){return this.m_tracks[t.MTrack.TEMPO_TRACK].getTotalTimeStr()},e.prototype.getNowMSec=function(){return this.m_sequencer.getNowMSec()},e.prototype.getNowTimeStr=function(){return this.m_sequencer.getNowTimeStr()},e.prototype.getVoiceCount=function(){var t,e=0;for(t=0;t<this.m_tracks.length;t++)e+=this.m_tracks[t].getVoiceCount();return e},e.prototype.getMetaTitle=function(){return this.m_metaTitle},e.prototype.getMetaComment=function(){return this.m_metaComment},e.prototype.getMetaArtist=function(){return this.m_metaArtist},e.prototype.getMetaCoding=function(){return this.m_metaCoding},e.MAX_PIPE=3,e.MAX_SYNCSOURCE=3,e.MAX_POLYVOICE=64,e}();t.MML=e}(e=t.flmml||(t.flmml={}))}(FlMMLWorker||(FlMMLWorker={}));var __extends=this.__extends||function(t,e){function s(){this.constructor=t}for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i]);s.prototype=e.prototype,t.prototype=new s},FlMMLWorker;!function(t){var e;!function(t){var e=function(e){function s(){s.boot(),this.m_readCount=0,this.m_address=0,this.m_bit=0,this.m_wav=0,this.m_length=0,this.m_ofs=0,e.call(this),this.setWaveNo(0)}return __extends(s,e),s.boot=function(){s.s_init||(s.FC_DPCM_NEXT=t.MSequencer.SAMPLE_RATE<<s.FC_DPCM_PHASE_SFT,s.s_table=new Array(s.MAX_WAVE),s.s_intVol=new Array(s.MAX_WAVE),s.s_loopFg=new Array(s.MAX_WAVE),s.s_length=new Array(s.MAX_WAVE),s.setWave(0,127,0,""),s.s_init=1)},s.setWave=function(t,e,i,o){s.s_intVol[t]=e,s.s_loopFg[t]=i,s.s_length[t]=0,s.s_table[t]=new Array(s.FC_DPCM_TABLE_MAX_LEN);for(var h=0,_=0,r=0,n=0,a=0;a<s.FC_DPCM_TABLE_MAX_LEN;a++)s.s_table[t][a]=0;for(h=0;h<o.length;h++){var m=o.charCodeAt(h);for(m>=65&&90>=m?m-=65:m>=97&&122>=m?m-=71:m>=48&&57>=m?m-=-4:m=43==m?62:47==m?63:0,a=5;a>=0;a--)s.s_table[t][n]+=(m>>a&1)<<8*_+7-r,r++,r>=8&&(r=0,_++),s.s_length[t]++,_>=4&&(_=0,n++,n>=s.FC_DPCM_TABLE_MAX_LEN&&(n=s.FC_DPCM_TABLE_MAX_LEN-1))}s.s_length[t]-=(s.s_length[t]-8)%128,s.s_length[t]>8*s.FC_DPCM_MAX_LEN&&(s.s_length[t]=8*s.FC_DPCM_MAX_LEN),0==s.s_length[t]&&(s.s_length[t]=8)},s.prototype.setWaveNo=function(t){t>=s.MAX_WAVE&&(t=s.MAX_WAVE-1),s.s_table[t]||(t=0),this.m_waveNo=t},s.prototype.getValue=function(){return this.m_length>0?(s.s_table[this.m_waveNo][this.m_address]>>this.m_bit&1?this.m_wav<126&&(this.m_wav+=2):this.m_wav>1&&(this.m_wav-=2),this.m_bit++,this.m_bit>=32&&(this.m_bit=0,this.m_address++),this.m_length--,0==this.m_length&&s.s_loopFg[this.m_waveNo]&&(this.m_address=0,this.m_bit=0,this.m_length=s.s_length[this.m_waveNo]),(this.m_wav-64)/64):(this.m_wav-64)/64},s.prototype.resetPhase=function(){this.m_phase=0,this.m_address=0,this.m_bit=0,this.m_ofs=0,this.m_wav=s.s_intVol[this.m_waveNo],this.m_length=s.s_length[this.m_waveNo]},s.prototype.getNextSample=function(){var t=(this.m_wav-64)/64;for(this.m_phase=this.m_phase+this.m_freqShift&s.PHASE_MSK;s.FC_DPCM_NEXT<=this.m_phase;)this.m_phase-=s.FC_DPCM_NEXT,this.m_length>0?(s.s_table[this.m_waveNo][this.m_address]>>this.m_bit&1?this.m_wav<126&&(this.m_wav+=2):this.m_wav>1&&(this.m_wav-=2),this.m_bit++,this.m_bit>=32&&(this.m_bit=0,this.m_address++),this.m_length--,0==this.m_length&&s.s_loopFg[this.m_waveNo]&&(this.m_address=0,this.m_bit=0,this.m_length=s.s_length[this.m_waveNo]),t=(this.m_wav-64)/64):t=(this.m_wav-64)/64;return t},s.prototype.getNextSampleOfs=function(t){var e=(this.m_wav-64)/64;for(this.m_phase=this.m_phase+this.m_freqShift+(t-this.m_ofs>>s.PHASE_SFT-7)&s.PHASE_MSK;s.FC_DPCM_NEXT<=this.m_phase;)this.m_phase-=s.FC_DPCM_NEXT,this.m_length>0?(s.s_table[this.m_waveNo][this.m_address]>>this.m_bit&1?this.m_wav<126&&(this.m_wav+=2):this.m_wav>1&&(this.m_wav-=2),this.m_bit++,this.m_bit>=32&&(this.m_bit=0,this.m_address++),this.m_length--,0==this.m_length&&s.s_loopFg[this.m_waveNo]&&(this.m_address=0,this.m_bit=0,this.m_length=s.s_length[this.m_waveNo]),e=(this.m_wav-64)/64):e=(this.m_wav-64)/64;return this.m_ofs=t,e},s.prototype.getSamples=function(t,e,i){var o,h=(this.m_wav-64)/64;for(o=e;i>o;o++){for(this.m_phase=this.m_phase+this.m_freqShift&s.PHASE_MSK;s.FC_DPCM_NEXT<=this.m_phase;)this.m_phase-=s.FC_DPCM_NEXT,this.m_length>0?(s.s_table[this.m_waveNo][this.m_address]>>this.m_bit&1?this.m_wav<126&&(this.m_wav+=2):this.m_wav>1&&(this.m_wav-=2),this.m_bit++,this.m_bit>=32&&(this.m_bit=0,this.m_address++),this.m_length--,0==this.m_length&&s.s_loopFg[this.m_waveNo]&&(this.m_address=0,this.m_bit=0,this.m_length=s.s_length[this.m_waveNo]),h=(this.m_wav-64)/64):h=(this.m_wav-64)/64;t[o]=h}},s.prototype.setFrequency=function(t){this.m_freqShift=t*(1<<s.FC_DPCM_PHASE_SFT+4)|0},s.prototype.setDpcmFreq=function(t){0>t&&(t=0),t>15&&(t=15),this.m_freqShift=(s.FC_CPU_CYCLE<<s.FC_DPCM_PHASE_SFT)/s.s_interval[t]|0},s.prototype.setNoteNo=function(t){this.setDpcmFreq(t)},s.MAX_WAVE=16,s.FC_CPU_CYCLE=1789773,s.FC_DPCM_PHASE_SFT=2,s.FC_DPCM_MAX_LEN=4081,s.FC_DPCM_TABLE_MAX_LEN=(s.FC_DPCM_MAX_LEN>>2)+2,s.s_interval=[428,380,340,320,286,254,226,214,190,160,142,128,106,85,72,54],s}(t.MOscMod);t.MOscFcDpcm=e}(e=t.flmml||(t.flmml={}))}(FlMMLWorker||(FlMMLWorker={}));var FlMMLWorker;!function(t){var e;!function(t){var e=function(e){function s(){s.boot(),e.call(this),this.setLongMode(),this.m_fcr=32768,this.m_val=this.getValue(),this.setNoiseFreq(0)}return __extends(s,e),s.prototype.getValue=function(){return this.m_fcr>>=1,this.m_fcr|=(1&(this.m_fcr^this.m_fcr>>this.m_snz))<<15,1&this.m_fcr?1:-1},s.prototype.setShortMode=function(){this.m_snz=6},s.prototype.setLongMode=function(){this.m_snz=1},s.prototype.resetPhase=function(){},s.prototype.addPhase=function(t){for(this.m_phase=this.m_phase+s.FC_NOISE_PHASE_DLT*t|0;this.m_phase>=this.m_freqShift;)this.m_phase-=this.m_freqShift,this.m_val=this.getValue()},s.boot=function(){s.FC_NOISE_PHASE_DLT=s.FC_NOISE_PHASE_SEC/t.MSequencer.SAMPLE_RATE|0},s.prototype.getNextSample=function(){for(var t=this.m_val,e=0,i=0,o=s.FC_NOISE_PHASE_DLT;o>=this.m_freqShift;)o-=this.m_freqShift,this.m_phase=0,e+=this.getValue(),i+=1;return i>0&&(this.m_val=e/i),this.m_phase=this.m_phase+o|0,this.m_phase>=this.m_freqShift&&(this.m_phase-=this.m_freqShift,this.m_val=this.getValue()),t},s.prototype.getNextSampleOfs=function(t){for(var e=this.m_fcr,i=this.m_phase,o=this.m_val,h=0,_=0,r=s.FC_NOISE_PHASE_DLT+t;r>=this.m_freqShift;)r-=this.m_freqShift,this.m_phase=0,h+=this.getValue(),_+=1;return _>0&&(this.m_val=h/_),this.m_phase=this.m_phase+r|0,this.m_phase>=this.m_freqShift&&(this.m_phase=this.m_freqShift,this.m_val=this.getValue()),this.m_fcr=e,this.m_phase=i,this.getNextSample(),o},s.prototype.getSamples=function(t,e,s){for(var i=e;s>i;i++)t[i]=this.getNextSample()},s.prototype.setFrequency=function(t){this.m_freqShift=s.FC_NOISE_PHASE_SEC/t|0},s.prototype.setNoiseFreq=function(t){0>t&&(t=0),t>15&&(t=15),this.m_freqShift=s.s_interval[t]<<s.FC_NOISE_PHASE_SFT|0},s.prototype.setNoteNo=function(t){this.setNoiseFreq(t)},s.FC_NOISE_PHASE_SFT=10,s.FC_NOISE_PHASE_SEC=1789773<<s.FC_NOISE_PHASE_SFT|0,s.s_interval=[4,8,16,32,64,96,128,160,202,254,380,508,762,1016,2034,4068],s}(t.MOscMod);t.MOscFcNoise=e}(e=t.flmml||(t.flmml={}))}(FlMMLWorker||(FlMMLWorker={}));var FlMMLWorker;!function(t){var e;!function(t){var e=function(t){function e(){e.boot(),t.call(this),this.setWaveNo(0)}return __extends(e,t),e.boot=function(){if(!e.s_init){e.s_table=new Array(e.MAX_WAVE),e.s_table[0]=new Array(e.FC_TRI_TABLE_LEN),e.s_table[1]=new Array(e.FC_TRI_TABLE_LEN);var t;for(t=0;16>t;t++)e.s_table[0][t]=e.s_table[0][31-t]=2*t/15-1;for(t=0;32>t;t++)e.s_table[1][t]=8>t?2*t/14:24>t?2*(8-t)/15+1:2*(t-24)/15-1;e.s_init=1}},e.prototype.getNextSample=function(){var t=e.s_table[this.m_waveNo][this.m_phase>>e.PHASE_SFT+11];return this.m_phase=this.m_phase+this.m_freqShift&e.PHASE_MSK,t},e.prototype.getNextSampleOfs=function(t){var s=e.s_table[this.m_waveNo][(this.m_phase+t&e.PHASE_MSK)>>e.PHASE_SFT+11];return this.m_phase=this.m_phase+this.m_freqShift&e.PHASE_MSK,s},e.prototype.getSamples=function(t,s,i){var o;for(o=s;i>o;o++)t[o]=e.s_table[this.m_waveNo][this.m_phase>>e.PHASE_SFT+11],this.m_phase=this.m_phase+this.m_freqShift&e.PHASE_MSK},e.prototype.getSamplesWithSyncIn=function(t,s,i,o){var h;for(h=i;o>h;h++)s[h]&&this.resetPhase(),t[h]=e.s_table[this.m_waveNo][this.m_phase>>e.PHASE_SFT+11],this.m_phase=this.m_phase+this.m_freqShift&e.PHASE_MSK},e.prototype.getSamplesWithSyncOut=function(t,s,i,o){var h;for(h=i;o>h;h++)t[h]=e.s_table[this.m_waveNo][this.m_phase>>e.PHASE_SFT+11],this.m_phase+=this.m_freqShift,s[h]=this.m_phase>e.PHASE_MSK,this.m_phase&=e.PHASE_MSK},e.prototype.setWaveNo=function(t){this.m_waveNo=Math.min(t,e.MAX_WAVE-1)},e.FC_TRI_TABLE_LEN=32,e.MAX_WAVE=2,e.s_init=0,e}(t.MOscMod);t.MOscFcTri=e}(e=t.flmml||(t.flmml={}))}(FlMMLWorker||(FlMMLWorker={}));var FlMMLWorker;!function(t){var e;!function(t){var e=function(t){function e(){e.boot(),t.call(this),this.m_sum=0,this.m_skip=0}return __extends(e,t),e.boot=function(){if(!e.s_init){for(var t=65535,s=1,i=0;i<e.GB_NOISE_TABLE_LEN;i++)0==t&&(t=1),t+=t+(1&(t>>6^t>>5))|0,s^=1&t,e.s_table[i]=2*s-1;e.s_init=1}},e.prototype.getNextSample=function(){var t=e.s_table[this.m_phase>>e.GB_NOISE_PHASE_SFT];this.m_skip>0&&(t=(t+this.m_sum)/Number(this.m_skip+1)),this.m_sum=0,this.m_skip=0;for(var s=this.m_freqShift;s>e.GB_NOISE_PHASE_DLT;)this.m_phase=(this.m_phase+e.GB_NOISE_PHASE_DLT)%e.GB_NOISE_TABLE_MOD,s-=e.GB_NOISE_PHASE_DLT,this.m_sum+=e.s_table[this.m_phase>>e.GB_NOISE_PHASE_SFT],this.m_skip++;return this.m_phase=(this.m_phase+s)%e.GB_NOISE_TABLE_MOD,t},e.prototype.getNextSampleOfs=function(t){var s=(this.m_phase+t)%e.GB_NOISE_TABLE_MOD,i=e.s_table[s+(s>>31&e.GB_NOISE_TABLE_MOD)>>e.GB_NOISE_PHASE_SFT];return this.m_phase=(this.m_phase+this.m_freqShift)%e.GB_NOISE_TABLE_MOD,i},e.prototype.getSamples=function(t,s,i){var o,h;for(o=s;i>o;o++){h=e.s_table[this.m_phase>>e.GB_NOISE_PHASE_SFT],this.m_skip>0&&(h=(h+this.m_sum)/Number(this.m_skip+1)),t[o]=h,this.m_sum=0,this.m_skip=0;for(var _=this.m_freqShift;_>e.GB_NOISE_PHASE_DLT;)this.m_phase=(this.m_phase+e.GB_NOISE_PHASE_DLT)%e.GB_NOISE_TABLE_MOD,_-=e.GB_NOISE_PHASE_DLT,this.m_sum+=e.s_table[this.m_phase>>e.GB_NOISE_PHASE_SFT],this.m_skip++;this.m_phase=(this.m_phase+_)%e.GB_NOISE_TABLE_MOD}},e.prototype.setFrequency=function(t){this.m_frequency=t},e.prototype.setNoiseFreq=function(t){0>t&&(t=0),t>63&&(t=63),this.m_freqShift=(1048576<<e.GB_NOISE_PHASE_SFT-2)/(11025*e.s_interval[t])},e.prototype.setNoteNo=function(t){this.setNoiseFreq(t)},e.GB_NOISE_PHASE_SFT=12,e.GB_NOISE_PHASE_DLT=1<<e.GB_NOISE_PHASE_SFT,e.GB_NOISE_TABLE_LEN=127,e.GB_NOISE_TABLE_MOD=(e.GB_NOISE_TABLE_LEN<<e.GB_NOISE_PHASE_SFT)-1,e.s_init=0,e.s_table=new Array(e.GB_NOISE_TABLE_LEN),e.s_interval=[2,4,8,12,16,20,24,28,32,40,48,56,64,80,96,112,128,160,192,224,256,320,384,448,512,640,768,896,1024,1280,1536,1792,2048,2560,3072,3584,4096,5120,6144,7168,8192,10240,12288,14336,16384,20480,24576,28672,32768,40960,49152,57344,65536,81920,98304,114688,131072,163840,196608,229376,262144,327680,393216,458752],e}(t.MOscMod);t.MOscGbSNoise=e}(e=t.flmml||(t.flmml={}))}(FlMMLWorker||(FlMMLWorker={}));var FlMMLWorker;!function(t){var e;!function(t){var e=function(t){function e(){e.boot(),t.call(this),this.m_sum=0,this.m_skip=0}return __extends(e,t),e.boot=function(){if(!e.s_init){for(var t=65535,s=1,i=0;i<e.GB_NOISE_TABLE_LEN;i++)0==t&&(t=1),t+=t+(1&(t>>14^t>>13))|0,s^=1&t,e.s_table[i]=2*s-1;e.s_init=1}},e.prototype.getNextSample=function(){var t=e.s_table[this.m_phase>>e.GB_NOISE_PHASE_SFT];this.m_skip>0&&(t=(t+this.m_sum)/(this.m_skip+1)),this.m_sum=0,this.m_skip=0;for(var s=this.m_freqShift;s>e.GB_NOISE_PHASE_DLT;)this.m_phase=(this.m_phase+e.GB_NOISE_PHASE_DLT)%e.GB_NOISE_TABLE_MOD,s-=e.GB_NOISE_PHASE_DLT,this.m_sum+=e.s_table[this.m_phase>>e.GB_NOISE_PHASE_SFT],this.m_skip++;return this.m_phase=(this.m_phase+s)%e.GB_NOISE_TABLE_MOD,t},e.prototype.getNextSampleOfs=function(t){var s=(this.m_phase+t)%e.GB_NOISE_TABLE_MOD,i=e.s_table[s+(s>>31&e.GB_NOISE_TABLE_MOD)>>e.GB_NOISE_PHASE_SFT];return this.m_phase=(this.m_phase+this.m_freqShift)%e.GB_NOISE_TABLE_MOD,i},e.prototype.getSamples=function(t,s,i){var o,h;for(o=s;i>o;o++){h=e.s_table[this.m_phase>>e.GB_NOISE_PHASE_SFT],this.m_skip>0&&(h=(h+this.m_sum)/(this.m_skip+1)),t[o]=h,this.m_sum=0,this.m_skip=0;for(var _=this.m_freqShift;_>e.GB_NOISE_PHASE_DLT;)this.m_phase=(this.m_phase+e.GB_NOISE_PHASE_DLT)%e.GB_NOISE_TABLE_MOD,_-=e.GB_NOISE_PHASE_DLT,this.m_sum+=e.s_table[this.m_phase>>e.GB_NOISE_PHASE_SFT],this.m_skip++;this.m_phase=(this.m_phase+_)%e.GB_NOISE_TABLE_MOD}},e.prototype.setFrequency=function(t){this.m_frequency=t},e.prototype.setNoiseFreq=function(t){0>t&&(t=0),t>63&&(t=63),this.m_freqShift=(1048576<<e.GB_NOISE_PHASE_SFT-2)/(11025*e.s_interval[t])|0},e.prototype.setNoteNo=function(t){this.setNoiseFreq(t)},e.GB_NOISE_PHASE_SFT=12,e.GB_NOISE_PHASE_DLT=1<<e.GB_NOISE_PHASE_SFT,e.GB_NOISE_TABLE_LEN=32767,e.GB_NOISE_TABLE_MOD=(e.GB_NOISE_TABLE_LEN<<e.GB_NOISE_PHASE_SFT)-1,e.s_init=0,e.s_table=new Array(e.GB_NOISE_TABLE_LEN),e.s_interval=[2,4,8,12,16,20,24,28,32,40,48,56,64,80,96,112,128,160,192,224,256,320,384,448,512,640,768,896,1024,1280,1536,1792,2048,2560,3072,3584,4096,5120,6144,7168,8192,10240,12288,14336,16384,20480,24576,28672,32768,40960,49152,57344,65536,81920,98304,114688,131072,163840,196608,229376,262144,327680,393216,458752],e}(t.MOscMod);t.MOscGbLNoise=e}(e=t.flmml||(t.flmml={}))}(FlMMLWorker||(FlMMLWorker={}));var FlMMLWorker;!function(t){var e;!function(t){var e=function(t){function e(){e.boot(),t.call(this),this.setWaveNo(0)}return __extends(e,t),e.boot=function(){e.s_init||(e.s_table=new Array(e.MAX_WAVE),this.setWave(0,"0123456789abcdeffedcba9876543210"),e.s_init=1)},e.setWave=function(t,s){e.s_table[t]=new Array(e.GB_WAVE_TABLE_LEN);for(var i=0;32>i;i++){var o=s.charCodeAt(i);o>=48&&58>o?o-=48:o>=97&&103>o?o-=87:o=0,e.s_table[t][i]=(o-7.5)/7.5}},e.prototype.setWaveNo=function(t){t>=e.MAX_WAVE&&(t=e.MAX_WAVE-1),e.s_table[t]||(t=0),this.m_waveNo=t},e.prototype.getNextSample=function(){var t=e.s_table[this.m_waveNo][this.m_phase>>e.PHASE_SFT+11];return this.m_phase=this.m_phase+this.m_freqShift&e.PHASE_MSK,t},e.prototype.getNextSampleOfs=function(t){var s=e.s_table[this.m_waveNo][(this.m_phase+t&e.PHASE_MSK)>>e.PHASE_SFT+11];return this.m_phase=this.m_phase+this.m_freqShift&e.PHASE_MSK,s},e.prototype.getSamples=function(t,s,i){var o;for(o=s;i>o;o++)t[o]=e.s_table[this.m_waveNo][this.m_phase>>e.PHASE_SFT+11],this.m_phase=this.m_phase+this.m_freqShift&e.PHASE_MSK},e.prototype.getSamplesWithSyncIn=function(t,s,i,o){var h;for(h=i;o>h;h++)s[h]&&this.resetPhase(),t[h]=e.s_table[this.m_waveNo][this.m_phase>>e.PHASE_SFT+11],this.m_phase=this.m_phase+this.m_freqShift&e.PHASE_MSK},e.prototype.getSamplesWithSyncOut=function(t,s,i,o){var h;for(h=i;o>h;h++)t[h]=e.s_table[this.m_waveNo][this.m_phase>>e.PHASE_SFT+11],this.m_phase+=this.m_freqShift,s[h]=this.m_phase>e.PHASE_MSK,this.m_phase&=e.PHASE_MSK},e.MAX_WAVE=32,e.GB_WAVE_TABLE_LEN=32,e.s_init=0,e}(t.MOscMod);t.MOscGbWave=e}(e=t.flmml||(t.flmml={}))}(FlMMLWorker||(FlMMLWorker={}));var FlMMLWorker;!function(t){var e;!function(t){var e=function(t){function e(){e.boot(),t.call(this),this.setNoiseFreq(1),this.m_phase=0,this.m_counter=0,this.m_resetPhase=!0}return __extends(e,t),e.prototype.disableResetPhase=function(){this.m_resetPhase=!1},e.boot=function(){if(!e.s_init){for(var t=0;t<e.TABLE_LEN;t++)e.s_table[t]=2*Math.random()-1;e.s_init=1}},e.prototype.resetPhase=function(){this.m_resetPhase&&(this.m_phase=0)},e.prototype.addPhase=function(t){this.m_counter=this.m_counter+this.m_freqShift*t,this.m_phase=this.m_phase+(this.m_counter>>e.NOISE_PHASE_SFT)&e.TABLE_MSK,this.m_counter&=e.NOISE_PHASE_MSK},e.prototype.getNextSample=function(){var t=e.s_table[this.m_phase];return this.m_counter=this.m_counter+this.m_freqShift,this.m_phase=this.m_phase+(this.m_counter>>e.NOISE_PHASE_SFT)&e.TABLE_MSK,this.m_counter&=e.NOISE_PHASE_MSK,t},e.prototype.getNextSampleOfs=function(t){var s=e.s_table[this.m_phase+(t<<e.PHASE_SFT)&e.TABLE_MSK];return this.m_counter=this.m_counter+this.m_freqShift,this.m_phase=this.m_phase+(this.m_counter>>e.NOISE_PHASE_SFT)&e.TABLE_MSK,this.m_counter&=e.NOISE_PHASE_MSK,s},e.prototype.getSamples=function(t,s,i){var o;for(o=s;i>o;o++)t[o]=e.s_table[this.m_phase],this.m_counter=this.m_counter+this.m_freqShift,this.m_phase=this.m_phase+(this.m_counter>>e.NOISE_PHASE_SFT)&e.TABLE_MSK,this.m_counter&=e.NOISE_PHASE_MSK},e.prototype.setFrequency=function(t){this.m_frequency=t},e.prototype.setNoiseFreq=function(t){this.m_noiseFreq=t*(1<<e.NOISE_PHASE_SFT),this.m_freqShift=this.m_noiseFreq},e.prototype.restoreFreq=function(){this.m_freqShift=this.m_noiseFreq},e.TABLE_MSK=e.TABLE_LEN-1,e.NOISE_PHASE_SFT=30,e.NOISE_PHASE_MSK=(1<<e.NOISE_PHASE_SFT)-1,e.s_init=0,e.s_table=new Array(e.TABLE_LEN),e}(t.MOscMod);t.MOscNoise=e}(e=t.flmml||(t.flmml={}))}(FlMMLWorker||(FlMMLWorker={}));var FlMMLWorker;!function(t){var e;!function(t){var e=function(){function t(){}return t.I2=function(t,e){for(var s=new Array(t),i=0;t>i;i++)s[i]=new Array(e);return s},t.I3=function(t,e,s){for(var i=new Array(t),o=0;t>o;o++){i[o]=new Array(e);for(var h=0;e>h;h++)i[o][h]=new Array(s)}return i},t}();t.JaggArray=e}(e=t.fmgenAs||(t.fmgenAs={}))}(FlMMLWorker||(FlMMLWorker={}));var FlMMLWorker;!function(t){var e;!function(t){var e=function(){function e(){}return e.MakeLFOTable=function(){var t,s;if(!e.tablemade){for(var i=[[0,1/360,2/360,3/360,4/360,6/360,12/360,24/360],[0,1/480,2/480,4/480,10/480,20/480,80/480,140/480]],o=[[31,6,4,3],[31,2,1,0]],h=0;2>h;h++){for(t=0;8>t;t++){var _=i[h][t];for(s=0;s<e.FM_LFOENTS;s++){var r=(Math.pow(2,_*(2*s-e.FM_LFOENTS+1)/(e.FM_LFOENTS-1)),.6*_*Math.sin(2*s*Math.PI/e.FM_LFOENTS)+1);e.pmtable[h][t][s]=65536*(r-1)|0}}for(t=0;4>t;t++)for(s=0;s<e.FM_LFOENTS;s++)e.amtable[h][t][s]=2*(4*s>>o[h][t])<<2}e.tablemade=!0}},e.FM_SINEPRESIS=2,e.FM_OPSINBITS=10,e.FM_OPSINENTS=1<<e.FM_OPSINBITS,e.FM_EGCBITS=18,e.FM_LFOCBITS=14,e.FM_PGBITS=9,e.FM_RATIOBITS=7,e.FM_EGBITS=16,e.FM_VOLBITS=14,e.FM_VOLENTS=1<<e.FM_VOLBITS,e.FM_LFOBITS=8,e.FM_TLBITS=7,e.FM_TLENTS=1<<e.FM_TLBITS,e.FM_LFOENTS=1<<e.FM_LFOBITS,e.FM_TLPOS=e.FM_TLENTS/4,e.FM_CLENTS=8192,e.FM_EG_BOTTOM=955,e.pmtable=t.JaggArray.I3(2,8,e.FM_LFOENTS),e.amtable=t.JaggArray.I3(2,8,e.FM_LFOENTS),e.tablemade=!1,e}();t.FM=e}(e=t.fmgenAs||(t.fmgenAs={}))}(FlMMLWorker||(FlMMLWorker={}));var FlMMLWorker;!function(t){var e;!function(t){var e=function(){function e(){this.ratio_=0,this.aml_=0,this.pml_=0,this.pmv_=0,this.multable_=t.JaggArray.I2(4,16)}return e.prototype.Chip=function(){this.MakeTable()},e.prototype.SetRatio=function(t){this.ratio_!=t&&(this.ratio_=t,this.MakeTable())},e.prototype.SetAML=function(e){this.aml_=e&t.FM.FM_LFOENTS-1},e.prototype.SetPML=function(e){this.pml_=e&t.FM.FM_LFOENTS-1},e.prototype.SetPMV=function(t){this.pmv_=t},e.prototype.GetMulValue=function(t,e){return this.multable_[t][e]},e.prototype.GetAML=function(){return this.aml_},e.prototype.GetPML=function(){return this.pml_},e.prototype.GetPMV=function(){return this.pmv_},e.prototype.GetRatio=function(){return this.ratio_},e.prototype.MakeTable=function(){var s,i;for(s=0;4>s;s++){var o=e.dt2lv[s]*this.ratio_/(1<<2+t.FM.FM_RATIOBITS-t.FM.FM_PGBITS);for(i=0;16>i;i++){var h=0!=i?2*i:1;this.multable_[s][i]=h*o|0}}},e.dt2lv=[1,1.414,1.581,1.732],e}();t.Chip=e}(e=t.fmgenAs||(t.fmgenAs={}))}(FlMMLWorker||(FlMMLWorker={}));var FlMMLWorker;!function(t){var e;!function(t){var e=function(){function t(){this.regta=new Array(2)}return t.prototype.Reset=function(){this.timera_count=0,this.timerb_count=0},t.prototype.Count=function(t){var e=!1;if(0!=this.timera_count&&(this.timera_count-=t<<16,this.timera_count<=0)){for(e=!0,this.TimerA();this.timera_count<=0;)this.timera_count+=this.timera;0!=(4&this.regtc)&&this.SetStatus(1)}if(0!=this.timerb_count&&(this.timerb_count-=t<<12,this.timerb_count<=0)){for(e=!0;this.timerb_count<=0;)this.timerb_count+=this.timerb;0!=(8&this.regtc)&&this.SetStatus(2)}return e},t.prototype.GetNextEvent=function(){var t=(this.timera_count+65535>>16)-1,e=(this.timerb_count+4095>>12)-1;return(e>t?t:e)+1},t.prototype.SetStatus=function(t){},t.prototype.ResetStatus=function(t){},t.prototype.SetTimerBase=function(t){this.timer_step=65536e6/t|0},t.prototype.SetTimerA=function(t,e){var s;this.regta[1&t]=0|e,s=(this.regta[0]<<2)+(3&this.regta[1]),this.timera=(1024-s)*this.timer_step},t.prototype.SetTimerB=function(t){this.timerb=(256-t)*this.timer_step},t.prototype.SetTimerControl=function(t){var e=this.regtc^t;this.regtc=0|t,0!=(16&t)&&this.ResetStatus(1),0!=(32&t)&&this.ResetStatus(2),0!=(1&e)&&(this.timera_count=0!=(1&t)?this.timera:0),0!=(2&e)&&(this.timerb_count=0!=(2&t)?this.timerb:0)},t.prototype.TimerA=function(){},t}();t.Timer=e}(e=t.fmgenAs||(t.fmgenAs={}))}(FlMMLWorker||(FlMMLWorker={}));var FlMMLWorker;!function(t){var e;!function(t){var e=function(){function t(){}return t.typeN=0,t.typeM=1,t}();t.OpType=e}(e=t.fmgenAs||(t.fmgenAs={}))}(FlMMLWorker||(FlMMLWorker={}));var FlMMLWorker;!function(t){var e;!function(t){var e=function(){function t(){}return t.next=0,t.attack=1,t.decay=2,t.sustain=3,t.release=4,t.off=5,t}();t.EGPhase=e}(e=t.fmgenAs||(t.fmgenAs={}))}(FlMMLWorker||(FlMMLWorker={}));var FlMMLWorker;!function(t){var e;!function(t){var e=function(){function e(){this.buf=new Array(4),this.ix=new Array(3),this.ox=new Array(3),this.op=[new t.Operator,new t.Operator,new t.Operator,new t.Operator],this.SetAlgorithm(0),this.pms=t.FM.pmtable[0][0]}return e.prototype.SetType=function(t){for(var e=0;4>e;e++)this.op[e].type_=t},e.prototype.SetFB=function(t){this.fb=e.fbtable[t]},e.prototype.SetMS=function(t){this.op[0].SetMS(t),this.op[1].SetMS(t),this.op[2].SetMS(t),this.op[3].SetMS(t)},e.prototype.Mute=function(t){for(var e=0;4>e;e++)this.op[e].Mute(t)},e.prototype.Refresh=function(){for(var t=0;4>t;t++)this.op[t].Refresh()},e.prototype.SetChip=function(t){this.chip_=t;for(var e=0;4>e;e++)this.op[e].SetChip(t)},e.prototype.Reset=function(){this.op[0].Reset(),this.op[1].Reset(),this.op[2].Reset(),this.op[3].Reset()},e.prototype.Prepare=function(){this.op[0].Prepare(),this.op[1].Prepare(),this.op[2].Prepare(),this.op[3].Prepare(),this.pms=t.FM.pmtable[this.op[0].type_][7&this.op[0].ms_];var e=this.op[0].IsOn()||this.op[1].IsOn()||this.op[2].IsOn()||this.op[3].IsOn()?1:0,s=0!=(this.op[0].ms_&(this.op[0].amon_||this.op[1].amon_||this.op[2].amon_||this.op[3].amon_?55:7))?2:0;return e|s},e.prototype.SetFNum=function(t){for(var e=0;4>e;e++)this.op[e].SetFNum(t)},e.prototype.SetKCKF=function(t,s){var i=19-(t>>4&7),o=e.kctable[15&t];o=4*((o+2)/4|0);var h=o*e.kftable[63&s];h>>=19,h<<=19,h>>=i;var _=t>>2&31;this.op[0].SetDPBN(h,_),this.op[1].SetDPBN(h,_),this.op[2].SetDPBN(h,_),this.op[3].SetDPBN(h,_)},e.prototype.KeyControl=function(t){0!=(1&t)?this.op[0].KeyOn():this.op[0].KeyOff(),0!=(2&t)?this.op[1].KeyOn():this.op[1].KeyOff(),0!=(4&t)?this.op[2].KeyOn():this.op[2].KeyOff(),0!=(8&t)?this.op[3].KeyOn():this.op[3].KeyOff()},e.prototype.SetAlgorithm=function(t){var s=e.iotable;this.ix[0]=s[t][0],this.ox[0]=s[t][1],this.ix[1]=s[t][2],this.ox[1]=s[t][3],this.ix[2]=s[t][4],this.ox[2]=s[t][5],this.op[0].ResetFB(),this.algo_=t},e.prototype.GetAlgorithm=function(){return this.algo_},e.prototype.Calc=function(){var t=0;switch(this.algo_){case 0:this.op[2].Calc(this.op[1].Out()),this.op[1].Calc(this.op[0].Out()),t=this.op[3].Calc(this.op[2].Out()),this.op[0].CalcFB(this.fb);break;case 1:this.op[2].Calc(this.op[0].Out()+this.op[1].Out()),this.op[1].Calc(0),t=this.op[3].Calc(this.op[2].Out()),this.op[0].CalcFB(this.fb);break;case 2:this.op[2].Calc(this.op[1].Out()),this.op[1].Calc(0),t=this.op[3].Calc(this.op[0].Out()+this.op[2].Out()),this.op[0].CalcFB(this.fb);break;case 3:this.op[2].Calc(0),this.op[1].Calc(this.op[0].Out()),t=this.op[3].Calc(this.op[1].Out()+this.op[2].Out()),this.op[0].CalcFB(this.fb);break;case 4:this.op[2].Calc(0),t=this.op[1].Calc(this.op[0].Out()),t+=this.op[3].Calc(this.op[2].Out()),this.op[0].CalcFB(this.fb);break;case 5:t=this.op[2].Calc(this.op[0].Out()),t+=this.op[1].Calc(this.op[0].Out()),t+=this.op[3].Calc(this.op[0].Out()),this.op[0].CalcFB(this.fb);break;case 6:t=this.op[2].Calc(0),t+=this.op[1].Calc(this.op[0].Out()),t+=this.op[3].Calc(0),this.op[0].CalcFB(this.fb);break;case 7:t=this.op[2].Calc(0),t+=this.op[1].Calc(0),t+=this.op[3].Calc(0),t+=this.op[0].CalcFB(this.fb)}return t},e.prototype.CalcL=function(){this.chip_.SetPMV(this.pms[this.chip_.GetPML()]);var t=0;switch(this.algo_){case 0:this.op[2].CalcL(this.op[1].Out()),this.op[1].CalcL(this.op[0].Out()),t=this.op[3].CalcL(this.op[2].Out()),this.op[0].CalcFBL(this.fb);break;case 1:this.op[2].CalcL(this.op[0].Out()+this.op[1].Out()),this.op[1].CalcL(0),t=this.op[3].CalcL(this.op[2].Out()),this.op[0].CalcFBL(this.fb);break;case 2:this.op[2].CalcL(this.op[1].Out()),this.op[1].CalcL(0),t=this.op[3].CalcL(this.op[0].Out()+this.op[2].Out()),this.op[0].CalcFBL(this.fb);break;case 3:this.op[2].CalcL(0),this.op[1].CalcL(this.op[0].Out()),t=this.op[3].CalcL(this.op[1].Out()+this.op[2].Out()),this.op[0].CalcFBL(this.fb);break;case 4:this.op[2].CalcL(0),t=this.op[1].CalcL(this.op[0].Out()),t+=this.op[3].CalcL(this.op[2].Out()),this.op[0].CalcFBL(this.fb);break;case 5:t=this.op[2].CalcL(this.op[0].Out()),t+=this.op[1].CalcL(this.op[0].Out()),t+=this.op[3].CalcL(this.op[0].Out()),this.op[0].CalcFBL(this.fb);break;case 6:t=this.op[2].CalcL(0),t+=this.op[1].CalcL(this.op[0].Out()),t+=this.op[3].CalcL(0),this.op[0].CalcFBL(this.fb);break;case 7:t=this.op[2].CalcL(0),t+=this.op[1].CalcL(0),t+=this.op[3].CalcL(0),t+=this.op[0].CalcFBL(this.fb)}return t},e.prototype.CalcN=function(t){this.buf[1]=this.buf[2]=this.buf[3]=0,this.buf[0]=this.op[0].Out(),this.op[0].CalcFB(this.fb),this.buf[this.ox[0]]+=this.op[1].Calc(this.buf[this.ix[0]]),this.buf[this.ox[1]]+=this.op[2].Calc(this.buf[this.ix[1]]);var e=this.op[3].Out();return this.op[3].CalcN(t),this.buf[this.ox[2]]+e},e.prototype.CalcLN=function(t){this.chip_.SetPMV(this.pms[this.chip_.GetPML()]),this.buf[1]=this.buf[2]=this.buf[3]=0,this.buf[0]=this.op[0].Out(),this.op[0].CalcFBL(this.fb),this.buf[this.ox[0]]+=this.op[1].CalcL(this.buf[this.ix[0]]),this.buf[this.ox[1]]+=this.op[2].CalcL(this.buf[this.ix[1]]);var e=this.op[3].Out();return this.op[3].CalcN(t),this.buf[this.ox[2]]+e},e.fbtable=[31,7,6,5,4,3,2,1],e.kftable=[65536,65595,65654,65713,65773,65832,65891,65951,66010,66070,66130,66189,66249,66309,66369,66429,66489,66549,66609,66669,66729,66789,66850,66910,66971,67031,67092,67152,67213,67273,67334,67395,67456,67517,67578,67639,67700,67761,67822,67883,67945,68006,68067,68129,68190,68252,68314,68375,68437,68499,68561,68623,68685,68747,68809,68871,68933,68995,69057,69120,69182,69245,69307,69370],e.kctable=[5197,5506,5833,6180,6180,6547,6937,7349,7349,7786,8249,8740,8740,9259,9810,10394],e.iotable=[[0,1,1,2,2,3],[1,0,0,1,1,2],[1,1,1,0,0,2],[0,1,2,1,1,2],[0,1,2,2,2,1],[0,1,0,1,0,1],[0,1,2,1,2,1],[1,0,1,0,1,0]],e}();t.Channel4=e}(e=t.fmgenAs||(t.fmgenAs={}))}(FlMMLWorker||(FlMMLWorker={}));var FlMMLWorker;!function(t){var e;!function(e){var s=t.flmml.MSequencer,i=function(t){function i(){t.call(this),this.amplevel=e.FM.FM_VOLENTS,this.kc=new Array(8),this.kf=new Array(8),this.pan=new Array(8),this.chip=new e.Chip,this.buf=new Array(4),this.ch=[new e.Channel4,new e.Channel4,new e.Channel4,new e.Channel4,new e.Channel4,new e.Channel4,new e.Channel4,new e.Channel4],this.lfo_count_=0,this.lfo_count_prev_=-1,i.BuildLFOTable();for(var s=0;8>s;s++)this.ch[s].SetChip(this.chip),this.ch[s].SetType(e.OpType.typeM);this.ix=this.ch[0].ix,this.ox=this.ch[0].ox}return __extends(i,t),i.rand=function(){return 32768*Math.random()+0|0},i.BuildLFOTable=function(){if(!i.s_init){for(var t=0;4>t;t++)for(var e=0,s=0;s<i.OPM_LFOENTS;s++){var o=0,h=0;switch(t){case 0:h=(s+256&511)/2-128,o=255-s/2;break;case 1:o=256>s?255:0,h=256>s?127:-128;break;case 2:h=s+128&511,h=256>h?h-128:383-h,o=256>s?255-s:s-256;break;case 3:0==(3&s)&&(e=this.rand()/17&255),o=e,h=e-128}i.amtable[t][s]=o,i.pmtable[t][s]=-h-1}i.s_init=!0}},i.prototype.Init=function(t,e){return this.SetRate(t,e)?(this.Reset(),this.SetVolume(0),this.SetChannelMask(0),!0):!1},i.prototype.SetRate=function(t,e){return this.clock=t,this.pcmrate=e,this.rate=e,this.RebuildTimeTable(),!0},i.prototype.SetChannelMask=function(t){for(var e=0;8>e;e++)this.ch[e].Mute(0!=(t&1<<e))},i.prototype.Reset=function(){var e;for(e=0;256>e;e++)this.SetReg(e,0);for(this.SetReg(25,128),t.prototype.Reset.call(this),this.status=0,this.noise=12345,this.noisecount=0,e=0;8>e;e++)this.ch[e].Reset()},i.prototype.RebuildTimeTable=function(){var t=this.clock/64|0;this.rateratio=((t<<e.FM.FM_RATIOBITS)+this.rate/2)/this.rate|0,this.SetTimerBase(t),this.chip.SetRatio(this.rateratio)},i.prototype.TimerA=function(){if(0!=(128&this.regtc))for(var t=0;8>t;t++)this.ch[t].KeyControl(0),this.ch[t].KeyControl(15)},i.prototype.SetVolume=function(t){t=Math.min(t,20),t>-192?this.fmvolume=e.FM.FM_VOLENTS*Math.pow(10,t/40)|0:this.fmvolume=0},i.prototype.SetExpression=function(t){this.amplevel=t*e.FM.FM_VOLENTS|0},i.prototype.ReadStatus=function(){return 3&this.status},i.prototype.SetStatus=function(t){0==(this.status&t)&&(this.status|=t,this.Intr(!0))},i.prototype.ResetStatus=function(t){0!=(this.status&t)&&(this.status&=~t,0==this.status&&this.Intr(!1))},i.prototype.SetReg=function(t,s){if(!(t>=256)){var i=7&t;switch(255&t){case 1:0!=(2&s)&&(this.lfo_count_=0,this.lfo_count_prev_=-1),this.reg01=s;break;case 8:0==(128&this.regtc)?this.ch[7&s].KeyControl(s>>3):(i=7&s,0==(8&s)&&this.ch[i].op[0].KeyOff(),0==(16&s)&&this.ch[i].op[1].KeyOff(),0==(32&s)&&this.ch[i].op[2].KeyOff(),0==(64&s)&&this.ch[i].op[3].KeyOff());break;case 16:case 17:this.SetTimerA(t,s);break;case 18:this.SetTimerB(s);break;case 20:this.SetTimerControl(s);break;case 24:this.lfofreq=s,this.lfo_count_diff_=this.rateratio*(16+(15&this.lfofreq)<<12-e.FM.FM_RATIOBITS)/(1<<15-(this.lfofreq>>4));break;case 25:0!=(128&s)?this.pmd=127&s:this.amd=127&s;break;case 27:this.lfowaveform=3&s;break;case 32:case 33:case 34:case 35:case 36:case 37:case 38:case 39:this.ch[i].SetFB(s>>3&7),this.ch[i].SetAlgorithm(7&s),this.pan[i]=s>>6&3;break;case 40:case 41:case 42:case 43:case 44:case 45:case 46:case 47:this.kc[i]=s,this.ch[i].SetKCKF(this.kc[i],this.kf[i]);break;case 48:case 49:case 50:case 51:case 52:case 53:case 54:case 55:this.kf[i]=s>>2,this.ch[i].SetKCKF(this.kc[i],this.kf[i]);break;case 56:case 57:case 58:case 59:case 60:case 61:case 62:case 63:this.ch[i].SetMS(s<<4|s>>4);break;case 15:this.noisedelta=s,this.noisecount=0;break;default:t>=64&&this.SetParameter(t,s)}}},i.prototype.SetParameter=function(t,e){var s=i.slottable[t>>3&3],o=this.ch[7&t].op[s];switch(t>>5&7){case 2:o.SetDT(e>>4&7),o.SetMULTI(15&e);break;case 3:o.SetTL(127&e,0!=(128&this.regtc));break;case 4:o.SetKS(e>>6&3),o.SetAR(2*(31&e));break;case 5:o.SetDR(2*(31&e)),o.SetAMON(0!=(128&e));break;case 6:o.SetSR(2*(31&e)),o.SetDT2(e>>6&3);break;case 7:o.SetSL(i.sltable[e>>4&15]),o.SetRR(4*(15&e)+2)}},i.prototype.LFO=function(){var t;3!=this.lfowaveform?(t=this.lfo_count_>>15&510,this.chip.SetPML(i.pmtable[this.lfowaveform][t]*this.pmd/128+128|0),this.chip.SetAML(i.amtable[this.lfowaveform][t]*this.amd/128|0)):0!=(-131072&(this.lfo_count_^this.lfo_count_prev_))&&(t=i.rand()/17&255,this.chip.SetPML((t-128)*this.pmd/128+128|0),this.chip.SetAML(t*this.amd/128|0)),this.lfo_count_prev_=this.lfo_count_,this.lfo_step_++,0==(7&this.lfo_step_)&&(this.lfo_count_+=this.lfo_count_diff_)},i.prototype.Noise=function(){if(this.noisecount+=2*this.rateratio,this.noisecount>=32<<e.FM.FM_RATIOBITS){var t=32-(31&this.noisedelta);1==t&&(t=2),this.noisecount=this.noisecount-(t<<e.FM.FM_RATIOBITS),31==(31&this.noisedelta)&&(this.noisecount-=e.FM.FM_RATIOBITS),this.noise=this.noise>>1^(0!=(1&this.noise)?33800:0)}return this.noise},i.prototype.MixSub=function(t,e){0!=(16384&t)&&(e[this.pan[0]]=this.ch[0].Calc()),0!=(4096&t)&&(e[this.pan[1]]+=this.ch[1].Calc()),0!=(1024&t)&&(e[this.pan[2]]+=this.ch[2].Calc()),0!=(256&t)&&(e[this.pan[3]]+=this.ch[3].Calc()),0!=(64&t)&&(e[this.pan[4]]+=this.ch[4].Calc()),0!=(16&t)&&(e[this.pan[5]]+=this.ch[5].Calc()),0!=(4&t)&&(e[this.pan[6]]+=this.ch[6].Calc()),0!=(1&t)&&(0!=(128&this.noisedelta)?e[this.pan[7]]+=this.ch[7].CalcN(this.Noise()):e[this.pan[7]]+=this.ch[7].Calc())},i.prototype.MixSubL=function(t,e){0!=(16384&t)&&(e[this.pan[0]]=this.ch[0].CalcL()),0!=(4096&t)&&(e[this.pan[1]]+=this.ch[1].CalcL()),0!=(1024&t)&&(e[this.pan[2]]+=this.ch[2].CalcL()),0!=(256&t)&&(e[this.pan[3]]+=this.ch[3].CalcL()),0!=(64&t)&&(e[this.pan[4]]+=this.ch[4].CalcL()),0!=(16&t)&&(e[this.pan[5]]+=this.ch[5].CalcL()),0!=(4&t)&&(e[this.pan[6]]+=this.ch[6].CalcL()),0!=(1&t)&&(0!=(128&this.noisedelta)?e[this.pan[7]]+=this.ch[7].CalcLN(this.Noise()):e[this.pan[7]]+=this.ch[7].CalcL())},i.prototype.Mix=function(t,o,h){var _,r=0;for(_=0;8>_;_++)r=r<<2|this.ch[_].Prepare();if(0!=(21845&r)){0!=(2&this.reg01)&&(r&=21845);var n,a,m,c,p,l,u,f=(this.ch[0].algo_,this.ch[0].fb),S=this.ch[0].op[0],g=this.ch[0].op[1],M=this.ch[0].op[2],v=this.ch[0].op[3];for(_=o;o+h>_;_++)3!=this.lfowaveform?(a=this.lfo_count_>>15&510,this.chip.pml_=i.pmtable[this.lfowaveform][a]*this.pmd/128+128&e.FM.FM_LFOENTS-1,this.chip.aml_=i.amtable[this.lfowaveform][a]*this.amd/128&e.FM.FM_LFOENTS-1):0!=(-131072&(this.lfo_count_^this.lfo_count_prev_))&&(a=i.rand()/17&255,this.chip.pml_=(a-128)*this.pmd/128+128&e.FM.FM_LFOENTS-1,this.chip.aml_=a*this.amd/128&e.FM.FM_LFOENTS-1),this.lfo_count_prev_=this.lfo_count_,this.lfo_step_++,0==(7&this.lfo_step_)&&(this.lfo_count_+=this.lfo_count_diff_),m=0,0!=(16384&r)&&(0!=(43690&r)?(this.ch[0].chip_.pmv_=this.ch[0].pms[this.ch[0].chip_.pml_],this.buf[1]=this.buf[2]=this.buf[3]=0,this.buf[0]=S.out_,S.eg_count_-=S.eg_count_diff_,S.eg_count_<=0&&(S.eg_count_=6141<<e.FM.FM_RATIOBITS,S.eg_phase_==e.EGPhase.attack?(a=e.Operator.attacktable[S.eg_rate_][7&S.eg_curve_count_],a>=0&&(S.eg_level_-=1+(S.eg_level_>>a),S.eg_level_<=0&&S.ShiftPhase(e.EGPhase.decay))):(S.eg_level_+=e.Operator.decaytable1[S.eg_rate_][7&S.eg_curve_count_],S.eg_level_>=S.eg_level_on_next_phase_&&S.ShiftPhase(S.eg_phase_+1)),n=S.tl_out_+S.eg_level_,1023>n?S.eg_out_=n<<3:S.eg_out_=8184,S.eg_curve_count_++),c=S.out_+S.out2_,S.out2_=S.out_,p=S.pg_count_,S.pg_count_+=S.pg_diff_+(S.pg_diff_lfo_*S.chip_.pmv_>>5),l=p>>20+e.FM.FM_PGBITS-e.FM.FM_OPSINBITS,31>f&&(l+=c<<1+e.Operator.IS2EC_SHIFT>>f>>20+e.FM.FM_PGBITS-e.FM.FM_OPSINBITS),u=S.eg_out_+e.Operator.sinetable[l&e.FM.FM_OPSINENTS-1]+S.ams_[S.chip_.aml_],u<e.FM.FM_CLENTS?S.out_=e.Operator.cltable[u]:S.out_=0,g.eg_count_-=g.eg_count_diff_,g.eg_count_<=0&&(g.eg_count_=6141<<e.FM.FM_RATIOBITS,g.eg_phase_==e.EGPhase.attack?(a=e.Operator.attacktable[g.eg_rate_][7&g.eg_curve_count_],a>=0&&(g.eg_level_-=1+(g.eg_level_>>a),g.eg_level_<=0&&g.ShiftPhase(e.EGPhase.decay))):(g.eg_level_+=e.Operator.decaytable1[g.eg_rate_][7&g.eg_curve_count_],g.eg_level_>=g.eg_level_on_next_phase_&&g.ShiftPhase(g.eg_phase_+1)),n=g.tl_out_+g.eg_level_,1023>n?g.eg_out_=n<<3:g.eg_out_=8184,g.eg_curve_count_++),c=this.buf[this.ix[0]],g.out2_=g.out_,p=g.pg_count_,g.pg_count_+=g.pg_diff_+(g.pg_diff_lfo_*g.chip_.pmv_>>5),l=p>>20+e.FM.FM_PGBITS-e.FM.FM_OPSINBITS,l+=c>>20+e.FM.FM_PGBITS-e.FM.FM_OPSINBITS-(2+e.Operator.IS2EC_SHIFT),u=g.eg_out_+e.Operator.sinetable[l&e.FM.FM_OPSINENTS-1]+g.ams_[g.chip_.aml_],u<e.FM.FM_CLENTS?g.out_=e.Operator.cltable[u]:g.out_=0,this.buf[this.ox[0]]+=g.out_,M.eg_count_-=M.eg_count_diff_,M.eg_count_<=0&&(M.eg_count_=6141<<e.FM.FM_RATIOBITS,M.eg_phase_==e.EGPhase.attack?(a=e.Operator.attacktable[M.eg_rate_][7&M.eg_curve_count_],a>=0&&(M.eg_level_-=1+(M.eg_level_>>a),M.eg_level_<=0&&M.ShiftPhase(e.EGPhase.decay))):(M.eg_level_+=e.Operator.decaytable1[M.eg_rate_][7&M.eg_curve_count_],M.eg_level_>=M.eg_level_on_next_phase_&&M.ShiftPhase(M.eg_phase_+1)),n=M.tl_out_+M.eg_level_,1023>n?M.eg_out_=n<<3:M.eg_out_=8184,M.eg_curve_count_++),c=this.buf[this.ix[1]],M.out2_=M.out_,p=M.pg_count_,M.pg_count_+=M.pg_diff_+(M.pg_diff_lfo_*M.chip_.pmv_>>5),l=p>>20+e.FM.FM_PGBITS-e.FM.FM_OPSINBITS,l+=c>>20+e.FM.FM_PGBITS-e.FM.FM_OPSINBITS-(2+e.Operator.IS2EC_SHIFT),u=M.eg_out_+e.Operator.sinetable[l&e.FM.FM_OPSINENTS-1]+M.ams_[M.chip_.aml_],u<e.FM.FM_CLENTS?M.out_=e.Operator.cltable[u]:M.out_=0,this.buf[this.ox[1]]+=M.out_,v.eg_count_-=v.eg_count_diff_,v.eg_count_<=0&&(v.eg_count_=6141<<e.FM.FM_RATIOBITS,v.eg_phase_==e.EGPhase.attack?(a=e.Operator.attacktable[v.eg_rate_][7&v.eg_curve_count_],a>=0&&(v.eg_level_-=1+(v.eg_level_>>a),v.eg_level_<=0&&v.ShiftPhase(e.EGPhase.decay))):(v.eg_level_+=e.Operator.decaytable1[v.eg_rate_][7&v.eg_curve_count_],v.eg_level_>=v.eg_level_on_next_phase_&&v.ShiftPhase(v.eg_phase_+1)),n=v.tl_out_+v.eg_level_,1023>n?v.eg_out_=n<<3:v.eg_out_=8184,v.eg_curve_count_++),c=this.buf[this.ix[2]],v.out2_=v.out_,p=v.pg_count_,v.pg_count_+=v.pg_diff_+(v.pg_diff_lfo_*v.chip_.pmv_>>5),l=p>>20+e.FM.FM_PGBITS-e.FM.FM_OPSINBITS,l+=c>>20+e.FM.FM_PGBITS-e.FM.FM_OPSINBITS-(2+e.Operator.IS2EC_SHIFT),u=v.eg_out_+e.Operator.sinetable[l&e.FM.FM_OPSINENTS-1]+v.ams_[v.chip_.aml_],u<e.FM.FM_CLENTS?v.out_=e.Operator.cltable[u]:v.out_=0,m=this.buf[this.ox[2]]+v.out_):(this.buf[1]=this.buf[2]=this.buf[3]=0,this.buf[0]=S.out_,S.eg_count_-=S.eg_count_diff_,S.eg_count_<=0&&(S.eg_count_=6141<<e.FM.FM_RATIOBITS,S.eg_phase_==e.EGPhase.attack?(a=e.Operator.attacktable[S.eg_rate_][7&S.eg_curve_count_],a>=0&&(S.eg_level_-=1+(S.eg_level_>>a),S.eg_level_<=0&&S.ShiftPhase(e.EGPhase.decay))):(S.eg_level_+=e.Operator.decaytable1[S.eg_rate_][7&S.eg_curve_count_],S.eg_level_>=S.eg_level_on_next_phase_&&S.ShiftPhase(S.eg_phase_+1)),n=S.tl_out_+S.eg_level_,1023>n?S.eg_out_=n<<3:S.eg_out_=8184,S.eg_curve_count_++),c=S.out_+S.out2_,S.out2_=S.out_,p=S.pg_count_,S.pg_count_+=S.pg_diff_,l=p>>20+e.FM.FM_PGBITS-e.FM.FM_OPSINBITS,31>f&&(l+=c<<1+e.Operator.IS2EC_SHIFT>>f>>20+e.FM.FM_PGBITS-e.FM.FM_OPSINBITS),u=S.eg_out_+e.Operator.sinetable[l&e.FM.FM_OPSINENTS-1],u<e.FM.FM_CLENTS?S.out_=e.Operator.cltable[u]:S.out_=0,g.eg_count_-=g.eg_count_diff_,g.eg_count_<=0&&(g.eg_count_=6141<<e.FM.FM_RATIOBITS,g.eg_phase_==e.EGPhase.attack?(a=e.Operator.attacktable[g.eg_rate_][7&g.eg_curve_count_],a>=0&&(g.eg_level_-=1+(g.eg_level_>>a),g.eg_level_<=0&&g.ShiftPhase(e.EGPhase.decay))):(g.eg_level_+=e.Operator.decaytable1[g.eg_rate_][7&g.eg_curve_count_],g.eg_level_>=g.eg_level_on_next_phase_&&g.ShiftPhase(g.eg_phase_+1)),n=g.tl_out_+g.eg_level_,1023>n?g.eg_out_=n<<3:g.eg_out_=8184,g.eg_curve_count_++),c=this.buf[this.ix[0]],g.out2_=g.out_,p=g.pg_count_,g.pg_count_+=g.pg_diff_,l=p>>20+e.FM.FM_PGBITS-e.FM.FM_OPSINBITS,l+=c>>20+e.FM.FM_PGBITS-e.FM.FM_OPSINBITS-(2+e.Operator.IS2EC_SHIFT),u=g.eg_out_+e.Operator.sinetable[l&e.FM.FM_OPSINENTS-1],u<e.FM.FM_CLENTS?g.out_=e.Operator.cltable[u]:g.out_=0,this.buf[this.ox[0]]+=g.out_,M.eg_count_-=M.eg_count_diff_,M.eg_count_<=0&&(M.eg_count_=6141<<e.FM.FM_RATIOBITS,M.eg_phase_==e.EGPhase.attack?(a=e.Operator.attacktable[M.eg_rate_][7&M.eg_curve_count_],a>=0&&(M.eg_level_-=1+(M.eg_level_>>a),M.eg_level_<=0&&M.ShiftPhase(e.EGPhase.decay))):(M.eg_level_+=e.Operator.decaytable1[M.eg_rate_][7&M.eg_curve_count_],M.eg_level_>=M.eg_level_on_next_phase_&&M.ShiftPhase(M.eg_phase_+1)),n=M.tl_out_+M.eg_level_,1023>n?M.eg_out_=n<<3:M.eg_out_=8184,M.eg_curve_count_++),c=this.buf[this.ix[1]],M.out2_=M.out_,p=M.pg_count_,M.pg_count_+=M.pg_diff_,l=p>>20+e.FM.FM_PGBITS-e.FM.FM_OPSINBITS,l+=c>>20+e.FM.FM_PGBITS-e.FM.FM_OPSINBITS-(2+e.Operator.IS2EC_SHIFT),u=M.eg_out_+e.Operator.sinetable[l&e.FM.FM_OPSINENTS-1],u<e.FM.FM_CLENTS?M.out_=e.Operator.cltable[u]:M.out_=0,this.buf[this.ox[1]]+=M.out_,v.eg_count_-=v.eg_count_diff_,v.eg_count_<=0&&(v.eg_count_=6141<<e.FM.FM_RATIOBITS,v.eg_phase_==e.EGPhase.attack?(a=e.Operator.attacktable[v.eg_rate_][7&v.eg_curve_count_],a>=0&&(v.eg_level_-=1+(v.eg_level_>>a),v.eg_level_<=0&&v.ShiftPhase(e.EGPhase.decay))):(v.eg_level_+=e.Operator.decaytable1[v.eg_rate_][7&v.eg_curve_count_],v.eg_level_>=v.eg_level_on_next_phase_&&v.ShiftPhase(v.eg_phase_+1)),n=v.tl_out_+v.eg_level_,1023>n?v.eg_out_=n<<3:v.eg_out_=8184,v.eg_curve_count_++),c=this.buf[this.ix[2]],v.out2_=v.out_,p=v.pg_count_,v.pg_count_+=v.pg_diff_,l=p>>20+e.FM.FM_PGBITS-e.FM.FM_OPSINBITS,l+=c>>20+e.FM.FM_PGBITS-e.FM.FM_OPSINBITS-(2+e.Operator.IS2EC_SHIFT),u=v.eg_out_+e.Operator.sinetable[l&e.FM.FM_OPSINENTS-1],u<e.FM.FM_CLENTS?v.out_=e.Operator.cltable[u]:v.out_=0,m=this.buf[this.ox[2]]+v.out_),t[_]=((m*this.fmvolume>>e.FM.FM_VOLBITS)*this.amplevel>>e.FM.FM_VOLBITS)/8192)}else t.set(s.ZEROBUFFER.subarray(0,h),o)},i.prototype.Intr=function(t){},i.prototype.IsOn=function(t){var s=this.ch[7&t];switch(s.algo_){case 0:case 1:case 2:case 3:return s.op[3].eg_phase_!=e.EGPhase.off;case 4:return s.op[1].eg_phase_!=e.EGPhase.off||s.op[3].eg_phase_!=e.EGPhase.off;case 5:case 6:return s.op[1].eg_phase_!=e.EGPhase.off||s.op[2].eg_phase_!=e.EGPhase.off||s.op[3].eg_phase_!=e.EGPhase.off;case 7:return s.op[0].eg_phase_!=e.EGPhase.off||s.op[1].eg_phase_!=e.EGPhase.off||s.op[2].eg_phase_!=e.EGPhase.off||s.op[3].eg_phase_!=e.EGPhase.off}return!1},i.OPM_LFOENTS=512,i.s_init=!1,i.amtable=e.JaggArray.I2(4,i.OPM_LFOENTS),i.pmtable=e.JaggArray.I2(4,i.OPM_LFOENTS),i.sltable=[0,4,8,12,16,20,24,28,32,36,40,44,48,52,56,124],i.slottable=[0,2,1,3],i}(e.Timer);e.OPM=i}(e=t.fmgenAs||(t.fmgenAs={}))}(FlMMLWorker||(FlMMLWorker={}));var FlMMLWorker;!function(t){var e;!function(t){var e=function(){function e(){this.chip_=null,e.tablehasmade||e.MakeTable(),this.ar_=this.dr_=this.sr_=this.rr_=this.key_scale_rate_=0,this.ams_=t.FM.amtable[0][0],this.mute_=!1,this.keyon_=!1,this.tl_out_=0,this.ssg_type_=0,this.multiple_=0,this.detune_=0,this.detune2_=0,this.ms_=0}return e.prototype.SetChip=function(t){this.chip_=t},e.prototype.Reset=function(){this.tl_=this.tl_latch_=127,this.ShiftPhase(t.EGPhase.off),this.eg_count_=0,this.eg_curve_count_=0,this.ssg_phase_=0,this.pg_count_=0,this.out_=this.out2_=0,this.param_changed_=!0},e.MakeTable=function(){var s,i;for(s=0,i=0;256>s;s++){var o=Math.floor(Math.pow(2,13-s/256));o=o+2&-4,e.cltable[i++]=o,e.cltable[i++]=-o}for(s=i;i<t.FM.FM_CLENTS;)e.cltable[i++]=e.cltable[s++-512]/2|0;var h=Math.log(2);for(s=0;s<t.FM.FM_OPSINENTS/2;s++){var _=(2*s+1)*Math.PI/t.FM.FM_OPSINENTS,r=-256*Math.log(Math.sin(_))/h,n=Math.floor(r+.5)+1;e.sinetable[s]=2*n,e.sinetable[t.FM.FM_OPSINENTS/2+s|0]=2*n+1}t.FM.MakeLFOTable(),this.tablehasmade=!0},e.prototype.SetDPBN=function(t,e){this.dp_=t,this.bn_=e,this.param_changed_=!0},e.prototype.Prepare=function(){if(0!=this.param_changed_){switch(this.param_changed_=!1,this.pg_diff_=(this.dp_+e.dttable[this.detune_+this.bn_])*this.chip_.GetMulValue(this.detune2_,this.multiple_),this.pg_diff_lfo_=this.pg_diff_>>11,this.key_scale_rate_=this.bn_>>3-this.ks_,this.tl_out_=this.mute_?1023:8*this.tl_,this.eg_phase_){case t.EGPhase.attack:this.SetEGRate(0!=this.ar_?Math.min(63,this.ar_+this.key_scale_rate_):0);break;case t.EGPhase.decay:this.SetEGRate(0!=this.dr_?Math.min(63,this.dr_+this.key_scale_rate_):0),this.eg_level_on_next_phase_=8*this.sl_;break;case t.EGPhase.sustain:this.SetEGRate(0!=this.sr_?Math.min(63,this.sr_+this.key_scale_rate_):0);break;case t.EGPhase.release:this.SetEGRate(Math.min(63,this.rr_+this.key_scale_rate_))}if(0!=this.ssg_type_&&this.eg_phase_!=t.EGPhase.release){var s=this.ar_>=(8==this.ssg_type_||12==this.ssg_type_?56:60)?1:0;this.ssg_offset_=512*e.ssgenvtable[7&this.ssg_type_][s][this.ssg_phase_][0],this.ssg_vector_=e.ssgenvtable[7&this.ssg_type_][s][this.ssg_phase_][1]}this.ams_=t.FM.amtable[0|this.type_][this.amon_?this.ms_>>4&3:0],this.EGUpdate()}},e.prototype.ShiftPhase=function(s){switch(s){case t.EGPhase.attack:if(this.tl_=this.tl_latch_,0!=this.ssg_type_){this.ssg_phase_=this.ssg_phase_+1,this.ssg_phase_>2&&(this.ssg_phase_=1);var i=this.ar_>=(8==this.ssg_type_||12==this.ssg_type_?56:60)?1:0;this.ssg_offset_=512*e.ssgenvtable[7&this.ssg_type_][i][this.ssg_phase_][0],this.ssg_vector_=e.ssgenvtable[7&this.ssg_type_][i][this.ssg_phase_][1]}if(this.ar_+this.key_scale_rate_<62){this.SetEGRate(0!=this.ar_?Math.min(63,this.ar_+this.key_scale_rate_):0),this.eg_phase_=t.EGPhase.attack;break}case t.EGPhase.decay:if(0!=this.sl_){this.eg_level_=0,this.eg_level_on_next_phase_=0!=this.ssg_type_?Math.min(8*this.sl_,512):8*this.sl_,this.SetEGRate(0!=this.dr_?Math.min(63,this.dr_+this.key_scale_rate_):0),this.eg_phase_=t.EGPhase.decay;break}case t.EGPhase.sustain:this.eg_level_=8*this.sl_,this.eg_level_on_next_phase_=0!=this.ssg_type_?512:1024,this.SetEGRate(0!=this.sr_?Math.min(63,this.sr_+this.key_scale_rate_):0),this.eg_phase_=t.EGPhase.sustain;break;case t.EGPhase.release:if(0!=this.ssg_type_&&(this.eg_level_=this.eg_level_*this.ssg_vector_+this.ssg_offset_,this.ssg_vector_=1,this.ssg_offset_=0),this.eg_phase_==t.EGPhase.attack||this.eg_level_<t.FM.FM_EG_BOTTOM){this.eg_level_on_next_phase_=1024,this.SetEGRate(Math.min(63,this.rr_+this.key_scale_rate_)),this.eg_phase_=t.EGPhase.release;break}case t.EGPhase.off:default:this.eg_level_=t.FM.FM_EG_BOTTOM,this.eg_level_on_next_phase_=t.FM.FM_EG_BOTTOM,this.EGUpdate(),this.SetEGRate(0),this.eg_phase_=t.EGPhase.off}},e.prototype.SetFNum=function(t){this.dp_=(2047&t)<<(t>>11&7),this.bn_=e.notetable[t>>7&127],this.param_changed_=!0},e.prototype.SINE=function(s){return e.sinetable[s&t.FM.FM_OPSINENTS-1]},e.prototype.LogToLin=function(s){return s<t.FM.FM_CLENTS?e.cltable[s]:0},e.prototype.EGUpdate=function(){var t;t=0==this.ssg_type_?this.tl_out_+this.eg_level_:this.tl_out_+this.eg_level_*this.ssg_vector_+this.ssg_offset_,1023>t?this.eg_out_=t<<3:this.eg_out_=8184},e.prototype.SetEGRate=function(t){this.eg_rate_=t,this.eg_count_diff_=e.decaytable2[t/4|0]*this.chip_.GetRatio()},e.prototype.EGCalc=function(){if(this.eg_count_=6141<<t.FM.FM_RATIOBITS,this.eg_phase_==t.EGPhase.attack){var s=e.attacktable[this.eg_rate_][7&this.eg_curve_count_];s>=0&&(this.eg_level_-=1+(this.eg_level_>>s),this.eg_level_<=0&&this.ShiftPhase(t.EGPhase.decay)),this.EGUpdate()}else if(0==this.ssg_type_)this.eg_level_+=e.decaytable1[this.eg_rate_][7&this.eg_curve_count_],this.eg_level_>=this.eg_level_on_next_phase_&&this.ShiftPhase(this.eg_phase_+1),this.EGUpdate();else if(this.eg_level_+=4*e.decaytable1[this.eg_rate_][7&this.eg_curve_count_],this.eg_level_>=this.eg_level_on_next_phase_)switch(this.EGUpdate(),this.eg_phase_){case t.EGPhase.decay:this.ShiftPhase(t.EGPhase.sustain);break;case t.EGPhase.sustain:this.ShiftPhase(t.EGPhase.attack);break;case t.EGPhase.release:this.ShiftPhase(t.EGPhase.off)}this.eg_curve_count_++},e.prototype.EGStep=function(){this.eg_count_-=this.eg_count_diff_,this.eg_count_<=0&&this.EGCalc()},e.prototype.PGCalc=function(){var t=this.pg_count_;return this.pg_count_+=this.pg_diff_,t},e.prototype.PGCalcL=function(){var t=this.pg_count_;return this.pg_count_+=this.pg_diff_+(this.pg_diff_lfo_*this.chip_.GetPMV()>>5),t},e.prototype.Calc=function(s){if(this.eg_count_-=this.eg_count_diff_,this.eg_count_<=0){if(this.eg_count_=6141<<t.FM.FM_RATIOBITS,this.eg_phase_==t.EGPhase.attack){var i=e.attacktable[this.eg_rate_][7&this.eg_curve_count_];i>=0&&(this.eg_level_-=1+(this.eg_level_>>i),this.eg_level_<=0&&this.ShiftPhase(t.EGPhase.decay))}else this.eg_level_+=e.decaytable1[this.eg_rate_][7&this.eg_curve_count_],this.eg_level_>=this.eg_level_on_next_phase_&&this.ShiftPhase(this.eg_phase_+1);var o=this.tl_out_+this.eg_level_;1023>o?this.eg_out_=o<<3:this.eg_out_=8184,this.eg_curve_count_++}this.out2_=this.out_;var h=this.pg_count_;this.pg_count_+=this.pg_diff_;var _=h>>20+t.FM.FM_PGBITS-t.FM.FM_OPSINBITS;_+=s>>20+t.FM.FM_PGBITS-t.FM.FM_OPSINBITS-(2+e.IS2EC_SHIFT);var r=this.eg_out_+e.sinetable[_&t.FM.FM_OPSINENTS-1];return r<t.FM.FM_CLENTS?this.out_=e.cltable[r]:this.out_=0,this.out_},e.prototype.CalcL=function(s){if(this.eg_count_-=this.eg_count_diff_,this.eg_count_<=0){if(this.eg_count_=6141<<t.FM.FM_RATIOBITS,this.eg_phase_==t.EGPhase.attack){var i=e.attacktable[this.eg_rate_][7&this.eg_curve_count_];i>=0&&(this.eg_level_-=1+(this.eg_level_>>i),this.eg_level_<=0&&this.ShiftPhase(t.EGPhase.decay))}else this.eg_level_+=e.decaytable1[this.eg_rate_][7&this.eg_curve_count_],this.eg_level_>=this.eg_level_on_next_phase_&&this.ShiftPhase(this.eg_phase_+1);var o=this.tl_out_+this.eg_level_;1023>o?this.eg_out_=o<<3:this.eg_out_=8184,this.eg_curve_count_++}var h=this.pg_count_;this.pg_count_+=this.pg_diff_+(this.pg_diff_lfo_*this.chip_.pmv_>>5);var _=h>>20+t.FM.FM_PGBITS-t.FM.FM_OPSINBITS;_+=s>>20+t.FM.FM_PGBITS-t.FM.FM_OPSINBITS-(2+e.IS2EC_SHIFT);var r=this.eg_out_+e.sinetable[_&t.FM.FM_OPSINENTS-1]+this.ams_[this.chip_.aml_];return r<t.FM.FM_CLENTS?this.out_=e.cltable[r]:this.out_=0,this.out_},e.prototype.CalcN=function(t){this.EGStep();var e=Math.max(0,1023-(this.tl_out_+this.eg_level_))<<1;return t=(1&t)-1,this.out_=e+t^t,this.out_},e.prototype.CalcFB=function(s){if(this.eg_count_-=this.eg_count_diff_,this.eg_count_<=0){if(this.eg_count_=6141<<t.FM.FM_RATIOBITS,this.eg_phase_==t.EGPhase.attack){var i=e.attacktable[this.eg_rate_][7&this.eg_curve_count_];i>=0&&(this.eg_level_-=1+(this.eg_level_>>i),this.eg_level_<=0&&this.ShiftPhase(t.EGPhase.decay))}else this.eg_level_+=e.decaytable1[this.eg_rate_][7&this.eg_curve_count_],this.eg_level_>=this.eg_level_on_next_phase_&&this.ShiftPhase(this.eg_phase_+1);var o=this.tl_out_+this.eg_level_;1023>o?this.eg_out_=o<<3:this.eg_out_=8184,this.eg_curve_count_++}var h=this.out_+this.out2_;this.out2_=this.out_;var _=this.pg_count_;this.pg_count_+=this.pg_diff_;var r=_>>20+t.FM.FM_PGBITS-t.FM.FM_OPSINBITS;31>s&&(r+=h<<1+e.IS2EC_SHIFT>>s>>20+t.FM.FM_PGBITS-t.FM.FM_OPSINBITS);var n=this.eg_out_+e.sinetable[r&t.FM.FM_OPSINENTS-1];return n<t.FM.FM_CLENTS?this.out_=e.cltable[n]:this.out_=0,this.out2_},e.prototype.CalcFBL=function(s){if(this.eg_count_-=this.eg_count_diff_,this.eg_count_<=0){if(this.eg_count_=6141<<t.FM.FM_RATIOBITS,this.eg_phase_==t.EGPhase.attack){var i=e.attacktable[this.eg_rate_][7&this.eg_curve_count_];i>=0&&(this.eg_level_-=1+(this.eg_level_>>i),this.eg_level_<=0&&this.ShiftPhase(t.EGPhase.decay))}else this.eg_level_+=e.decaytable1[this.eg_rate_][7&this.eg_curve_count_],this.eg_level_>=this.eg_level_on_next_phase_&&this.ShiftPhase(this.eg_phase_+1);var o=this.tl_out_+this.eg_level_;1023>o?this.eg_out_=o<<3:this.eg_out_=8184,this.eg_curve_count_++}var h=this.out_+this.out2_;this.out2_=this.out_;var _=this.pg_count_;this.pg_count_+=this.pg_diff_+(this.pg_diff_lfo_*this.chip_.pmv_>>5);var r=_>>20+t.FM.FM_PGBITS-t.FM.FM_OPSINBITS;31>s&&(r+=h<<1+e.IS2EC_SHIFT>>s>>20+t.FM.FM_PGBITS-t.FM.FM_OPSINBITS);var n=this.eg_out_+e.sinetable[r&t.FM.FM_OPSINENTS-1]+this.ams_[this.chip_.aml_];return n<t.FM.FM_CLENTS?this.out_=e.cltable[n]:this.out_=0,this.out_},e.prototype.ResetFB=function(){this.out_=this.out2_=0},e.prototype.KeyOn=function(){this.keyon_||(this.keyon_=!0,(this.eg_phase_==t.EGPhase.off||this.eg_phase_==t.EGPhase.release)&&(this.ssg_phase_=-1,this.ShiftPhase(t.EGPhase.attack),this.EGUpdate(),this.in2_=this.out_=this.out2_=0,this.pg_count_=0))},e.prototype.KeyOff=function(){this.keyon_&&(this.keyon_=!1,this.ShiftPhase(t.EGPhase.release))},e.prototype.IsOn=function(){return this.eg_phase_!=t.EGPhase.off},e.prototype.SetDT=function(t){this.detune_=32*t,this.param_changed_=!0},e.prototype.SetDT2=function(t){this.detune2_=3&t,this.param_changed_=!0},e.prototype.SetMULTI=function(t){this.multiple_=t,this.param_changed_=!0},e.prototype.SetTL=function(t,e){e||(this.tl_=t,this.param_changed_=!0),this.tl_latch_=t},e.prototype.SetAR=function(t){this.ar_=t,this.param_changed_=!0},e.prototype.SetDR=function(t){this.dr_=t,this.param_changed_=!0},e.prototype.SetSR=function(t){this.sr_=t,this.param_changed_=!0},e.prototype.SetSL=function(t){this.sl_=t,this.param_changed_=!0},e.prototype.SetRR=function(t){this.rr_=t,this.param_changed_=!0},e.prototype.SetKS=function(t){this.ks_=t,this.param_changed_=!0},e.prototype.SetAMON=function(t){this.amon_=t,this.param_changed_=!0},e.prototype.Mute=function(t){this.mute_=t,this.param_changed_=!0},e.prototype.SetMS=function(t){this.ms_=t,this.param_changed_=!0},e.prototype.Out=function(){return this.out_},e.prototype.Refresh=function(){this.param_changed_=!0},e.notetable=[0,0,0,0,0,0,0,1,2,3,3,3,3,3,3,3,4,4,4,4,4,4,4,5,6,7,7,7,7,7,7,7,8,8,8,8,8,8,8,9,10,11,11,11,11,11,11,11,12,12,12,12,12,12,12,13,14,15,15,15,15,15,15,15,16,16,16,16,16,16,16,17,18,19,19,19,19,19,19,19,20,20,20,20,20,20,20,21,22,23,23,23,23,23,23,23,24,24,24,24,24,24,24,25,26,27,27,27,27,27,27,27,28,28,28,28,28,28,28,29,30,31,31,31,31,31,31,31],e.dttable=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,2,2,2,2,2,2,2,4,4,4,4,4,6,6,6,8,8,8,10,10,12,12,14,16,16,16,16,2,2,2,2,4,4,4,4,4,6,6,6,8,8,8,10,10,12,12,14,16,16,18,20,22,24,26,28,32,32,32,32,4,4,4,4,4,6,6,6,8,8,8,10,10,12,12,14,16,16,18,20,22,24,26,28,32,34,38,40,44,44,44,44,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-2,-2,-2,-2,-2,-2,-2,-2,-4,-4,-4,-4,-4,-6,-6,-6,-8,-8,-8,-10,-10,-12,-12,-14,-16,-16,-16,-16,-2,-2,-2,-2,-4,-4,-4,-4,-4,-6,-6,-6,-8,-8,-8,-10,-10,-12,-12,-14,-16,-16,-18,-20,-22,-24,-26,-28,-32,-32,-32,-32,-4,-4,-4,-4,-4,-6,-6,-6,-8,-8,-8,-10,-10,-12,-12,-14,-16,-16,-18,-20,-22,-24,-26,-28,-32,-34,-38,-40,-44,-44,-44,-44],e.decaytable1=[[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[1,1,1,1,1,1,1,1],[1,1,1,1,1,1,1,1],[1,1,1,1,1,1,1,1],[1,1,1,1,1,1,1,1],[1,1,1,0,1,1,1,0],[1,1,1,0,1,1,1,0],[1,0,1,0,1,0,1,0],[1,1,1,0,1,0,1,0],[1,1,1,0,1,1,1,0],[1,1,1,1,1,1,1,0],[1,0,1,0,1,0,1,0],[1,1,1,0,1,0,1,0],[1,1,1,0,1,1,1,0],[1,1,1,1,1,1,1,0],[1,0,1,0,1,0,1,0],[1,1,1,0,1,0,1,0],[1,1,1,0,1,1,1,0],[1,1,1,1,1,1,1,0],[1,0,1,0,1,0,1,0],[1,1,1,0,1,0,1,0],[1,1,1,0,1,1,1,0],[1,1,1,1,1,1,1,0],[1,0,1,0,1,0,1,0],[1,1,1,0,1,0,1,0],[1,1,1,0,1,1,1,0],[1,1,1,1,1,1,1,0],[1,0,1,0,1,0,1,0],[1,1,1,0,1,0,1,0],[1,1,1,0,1,1,1,0],[1,1,1,1,1,1,1,0],[1,0,1,0,1,0,1,0],[1,1,1,0,1,0,1,0],[1,1,1,0,1,1,1,0],[1,1,1,1,1,1,1,0],[1,0,1,0,1,0,1,0],[1,1,1,0,1,0,1,0],[1,1,1,0,1,1,1,0],[1,1,1,1,1,1,1,0],[1,0,1,0,1,0,1,0],[1,1,1,0,1,0,1,0],[1,1,1,0,1,1,1,0],[1,1,1,1,1,1,1,0],[1,0,1,0,1,0,1,0],[1,1,1,0,1,0,1,0],[1,1,1,0,1,1,1,0],[1,1,1,1,1,1,1,0],[1,1,1,1,1,1,1,1],[2,1,1,1,2,1,1,1],[2,1,2,1,2,1,2,1],[2,2,2,1,2,2,2,1],[2,2,2,2,2,2,2,2],[4,2,2,2,4,2,2,2],[4,2,4,2,4,2,4,2],[4,4,4,2,4,4,4,2],[4,4,4,4,4,4,4,4],[8,4,4,4,8,4,4,4],[8,4,8,4,8,4,8,4],[8,8,8,4,8,8,8,4],[16,16,16,16,16,16,16,16],[16,16,16,16,16,16,16,16],[16,16,16,16,16,16,16,16],[16,16,16,16,16,16,16,16]],e.decaytable2=[1,2,4,8,16,32,64,128,256,512,1024,2047,2047,2047,2047,2047],e.attacktable=[[-1,-1,-1,-1,-1,-1,-1,-1],[-1,-1,-1,-1,-1,-1,-1,-1],[4,4,4,4,4,4,4,4],[4,4,4,4,4,4,4,4],[4,4,4,4,4,4,4,4],[4,4,4,4,4,4,4,4],[4,4,4,-1,4,4,4,-1],[4,4,4,-1,4,4,4,-1],[4,-1,4,-1,4,-1,4,-1],[4,4,4,-1,4,-1,4,-1],[4,4,4,-1,4,4,4,-1],[4,4,4,4,4,4,4,-1],[4,-1,4,-1,4,-1,4,-1],[4,4,4,-1,4,-1,4,-1],[4,4,4,-1,4,4,4,-1],[4,4,4,4,4,4,4,-1],[4,-1,4,-1,4,-1,4,-1],[4,4,4,-1,4,-1,4,-1],[4,4,4,-1,4,4,4,-1],[4,4,4,4,4,4,4,-1],[4,-1,4,-1,4,-1,4,-1],[4,4,4,-1,4,-1,4,-1],[4,4,4,-1,4,4,4,-1],[4,4,4,4,4,4,4,-1],[4,-1,4,-1,4,-1,4,-1],[4,4,4,-1,4,-1,4,-1],[4,4,4,-1,4,4,4,-1],[4,4,4,4,4,4,4,-1],[4,-1,4,-1,4,-1,4,-1],[4,4,4,-1,4,-1,4,-1],[4,4,4,-1,4,4,4,-1],[4,4,4,4,4,4,4,-1],[4,-1,4,-1,4,-1,4,-1],[4,4,4,-1,4,-1,4,-1],[4,4,4,-1,4,4,4,-1],[4,4,4,4,4,4,4,-1],[4,-1,4,-1,4,-1,4,-1],[4,4,4,-1,4,-1,4,-1],[4,4,4,-1,4,4,4,-1],[4,4,4,4,4,4,4,-1],[4,-1,4,-1,4,-1,4,-1],[4,4,4,-1,4,-1,4,-1],[4,4,4,-1,4,4,4,-1],[4,4,4,4,4,4,4,-1],[4,-1,4,-1,4,-1,4,-1],[4,4,4,-1,4,-1,4,-1],[4,4,4,-1,4,4,4,-1],[4,4,4,4,4,4,4,-1],[4,4,4,4,4,4,4,4],[3,4,4,4,3,4,4,4],[3,4,3,4,3,4,3,4],[3,3,3,4,3,3,3,4],[3,3,3,3,3,3,3,3],[2,3,3,3,2,3,3,3],[2,3,2,3,2,3,2,3],[2,2,2,3,2,2,2,3],[2,2,2,2,2,2,2,2],[1,2,2,2,1,2,2,2],[1,2,1,2,1,2,1,2],[1,1,1,2,1,1,1,2],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0]],e.ssgenvtable=[[[[1,1],[1,1],[1,1]],[[0,1],[1,1],[1,1]]],[[[0,1],[2,0],[2,0]],[[0,1],[2,0],[2,0]]],[[[1,-1],[0,1],[1,-1]],[[0,1],[1,-1],[0,1]]],[[[1,-1],[0,0],[0,0]],[[0,1],[0,0],[0,0]]],[[[2,-1],[2,-1],[2,-1]],[[1,-1],[2,-1],[2,-1]]],[[[1,-1],[0,0],[0,0]],[[1,-1],[0,0],[0,0]]],[[[0,1],[1,-1],[0,1]],[[1,-1],[0,1],[1,-1]]],[[[0,1],[2,0],[2,0]],[[1,-1],[2,0],[2,0]]]],e.sinetable=new Array(t.FM.FM_OPSINENTS),e.cltable=new Array(t.FM.FM_CLENTS),e.tablehasmade=!1,e.IS2EC_SHIFT=20+t.FM.FM_PGBITS-13,e}();t.Operator=e}(e=t.fmgenAs||(t.fmgenAs={}))}(FlMMLWorker||(FlMMLWorker={}));var FlMMLWorker;!function(t){var e;!function(e){var s=t.fmgenAs.FM,i=t.fmgenAs.OPM,o=function(t){function o(){this.m_fm=new i,this.m_oneSample=new Float32Array(1),this.m_velocity=127,this.m_al=0,this.m_tl=new Array(4),t.call(this),o.boot(),this.m_fm.Init(o.OPM_CLOCK,e.MSequencer.SAMPLE_RATE),this.m_fm.Reset(),this.m_fm.SetVolume(o.s_comGain),this.setOpMask(15),this.setWaveNo(0)}return __extends(o,t),o.boot=function(){0==o.s_init&&(o.s_table=new Array(o.MAX_WAVE),o.s_table[0]=o.defTimbre,s.MakeLFOTable(),o.s_init=1)},o.clearTimber=function(){for(var t=0;t<o.s_table.length;t++)0==t?o.s_table[t]=o.defTimbre:o.s_table[t]=null},o.trim=function(t){var e=/^[,]*/m,s=/[,]*$/m;return t.replace(e,"").replace(s,"")},o.setTimber=function(t,e,s){if(!(0>t||o.MAX_WAVE<=t)){s=s.replace(/[,;\s\t\r\n]+/gm,","),s=this.trim(s);var i=s.split(","),h=new Array(o.TIMB_SZ_M);switch(e){case o.TYPE_OPM:if(i.length<46)return;break;case o.TYPE_OPN:if(i.length<42)return;break;default:return}var _,r,n;switch(e){case o.TYPE_OPM:for(n=Math.min(o.TIMB_SZ_M,i.length),_=0;n>_;_++)h[_]=parseInt(i[_]);for(;_<o.TIMB_SZ_M;_++)h[_]=o.zeroTimbre[_];break;case o.TYPE_OPN:for(_=0,r=0;2>_;_++,r++)h[_]=parseInt(i[r]);for(;46>_;_++)(_-2)%11==9?h[_]=0:h[_]=parseInt(i[r++]);for(n=Math.min(o.TIMB_SZ_N,i.length);n>r;_++,r++)h[_]=parseInt(i[r]);for(;_<o.TIMB_SZ_M;_++)h[_]=o.zeroTimbre[_]}o.s_table[t]=h}},o.prototype.loadTimbre=function(t){this.SetFBAL(t[1],t[0]);var e,s,i=o.slottable;for(e=2,s=0;4>s;s++,e+=11)this.SetDT1ML(i[s],t[e+8],t[e+7]),this.m_tl[s]=t[e+5],this.SetTL(i[s],t[e+5]),this.SetKSAR(i[s],t[e+6],t[e+0]),this.SetDRAMS(i[s],t[e+1],t[e+10]),this.SetDT2SR(i[s],t[e+9],t[e+2]),this.SetSLRR(i[s],t[e+4],t[e+3]);this.setVelocity(this.m_velocity),this.setOpMask(t[e+0]),this.setWF(t[e+1]),this.setLFRQ(t[e+2]),this.setPMD(t[e+3]),this.setAMD(t[e+4]),this.setPMSAMS(t[e+5],t[e+6]),this.setNENFRQ(t[e+7],t[e+8])},o.setCommonGain=function(t){o.s_comGain=t},o.prototype.SetFBAL=function(t,e){var s=3;this.m_al=7&e,this.m_fm.SetReg(32,(3&s)<<6|(7&t)<<3|7&e)},o.prototype.SetDT1ML=function(t,e,s){this.m_fm.SetReg(64|(3&t)<<3,(7&e)<<4|15&s)},o.prototype.SetTL=function(t,e){0>e&&(e=0),e>127&&(e=127),this.m_fm.SetReg(96|(3&t)<<3,127&e)},o.prototype.SetKSAR=function(t,e,s){this.m_fm.SetReg(128|(3&t)<<3,(3&e)<<6|31&s)},o.prototype.SetDRAMS=function(t,e,s){this.m_fm.SetReg(160|(3&t)<<3,(1&s)<<7|31&e)},o.prototype.SetDT2SR=function(t,e,s){this.m_fm.SetReg(192|(3&t)<<3,(3&e)<<6|31&s)},o.prototype.SetSLRR=function(t,e,s){this.m_fm.SetReg(224|(3&t)<<3,(15&e)<<4|15&s)},o.prototype.setPMSAMS=function(t,e){this.m_fm.SetReg(56,(7&t)<<4|3&e)},o.prototype.setPMD=function(t){this.m_fm.SetReg(25,128|127&t)},o.prototype.setAMD=function(t){this.m_fm.SetReg(25,0|127&t)},o.prototype.setNENFRQ=function(t,e){this.m_fm.SetReg(15,(1&t)<<7|31&e)},o.prototype.setLFRQ=function(t){this.m_fm.SetReg(24,255&t)},o.prototype.setWF=function(t){this.m_fm.SetReg(27,3&t)},o.prototype.noteOn=function(){this.m_fm.SetReg(1,2),this.m_fm.SetReg(1,0),this.m_fm.SetReg(8,this.m_opMask<<3)},o.prototype.noteOff=function(){this.m_fm.SetReg(8,0)},o.prototype.setWaveNo=function(t){t>=o.MAX_WAVE&&(t=o.MAX_WAVE-1),null==o.s_table[t]&&(t=0),this.m_fm.SetVolume(o.s_comGain),this.loadTimbre(o.s_table[t])},o.prototype.setNoteNo=function(t){this.noteOn()},o.prototype.setOpMask=function(t){this.m_opMask=15&t},o.prototype.setVelocity=function(t){var e=o.carrierop,s=o.slottable;this.m_velocity=t,0!=(8&e[this.m_al])?this.SetTL(s[0],this.m_tl[0]+(127-this.m_velocity)):this.SetTL(s[0],this.m_tl[0]),0!=(16&e[this.m_al])?this.SetTL(s[1],this.m_tl[1]+(127-this.m_velocity)):this.SetTL(s[1],this.m_tl[1]),0!=(32&e[this.m_al])?this.SetTL(s[2],this.m_tl[2]+(127-this.m_velocity)):this.SetTL(s[2],this.m_tl[2]),0!=(64&e[this.m_al])?this.SetTL(s[3],this.m_tl[3]+(127-this.m_velocity)):this.SetTL(s[3],this.m_tl[3])},o.prototype.setExpression=function(t){this.m_fm.SetExpression(t)},o.prototype.setFrequency=function(e){if(this.m_frequency!=e){t.prototype.setFrequency.call(this,e);var s=Math.floor(1200*Math.log(e/440)*Math.LOG2E+5700+o.OPM_RATIO+.5),i=s/100|0,h=s%100,_=Math.floor(64*h/100+.5),r=(i-1)/12<<4|o.kctable[(i+1200)%12];this.m_fm.SetReg(48,_<<2),this.m_fm.SetReg(40,r)}},o.prototype.getNextSample=function(){return this.m_fm.Mix(this.m_oneSample,0,1),this.m_oneSample[0]},o.prototype.getNextSampleOfs=function(t){return this.m_fm.Mix(this.m_oneSample,0,1),this.m_oneSample[0]},o.prototype.getSamples=function(t,e,s){this.m_fm.Mix(t,e,s-e)},o.prototype.IsPlaying=function(){return this.m_fm.IsOn(0)},o.MAX_WAVE=128,o.OPM_CLOCK=358e4,o.OPM_RATIO=0,o.TIMB_SZ_M=55,o.TIMB_SZ_N=51,o.TYPE_OPM=0,o.TYPE_OPN=1,o.s_init=0,o.s_comGain=14.25,o.kctable=[14,0,1,2,4,5,6,8,9,10,12,13],o.slottable=[0,2,1,3],o.carrierop=[64,64,64,64,80,112,112,120],o.defTimbre=[4,5,31,5,0,0,0,23,1,1,3,0,0,20,10,3,7,8,0,1,1,3,0,0,31,3,0,0,0,25,1,1,7,0,0,31,12,3,7,10,2,1,1,7,0,0,15,0,0,0,0,0,0,0,0],o.zeroTimbre=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,15,0,0,0,0,0,0,0,0],o}(e.MOscMod);e.MOscOPM=o}(e=t.flmml||(t.flmml={}))}(FlMMLWorker||(FlMMLWorker={}));var FlMMLWorker;!function(t){var e;!function(t){var e=function(t){function e(){e.boot(),t.call(this),this.setPWM(.5),this.setMIX(0)}return __extends(e,t),e.boot=function(){},e.prototype.getNextSample=function(){var t=this.m_phase<this.m_pwm?1:this.m_mix?this.m_modNoise.getNextSample():-1;return this.m_phase=this.m_phase+this.m_freqShift&e.PHASE_MSK,t},e.prototype.getNextSampleOfs=function(t){var s=(this.m_phase+t&e.PHASE_MSK)<this.m_pwm?1:this.m_mix?this.m_modNoise.getNextSampleOfs(t):-1;return this.m_phase=this.m_phase+this.m_freqShift&e.PHASE_MSK,s},e.prototype.getSamples=function(t,s,i){var o;if(this.m_mix)for(o=s;i>o;o++)t[o]=this.m_phase<this.m_pwm?1:this.m_modNoise.getNextSample(),this.m_phase=this.m_phase+this.m_freqShift&e.PHASE_MSK;else for(o=s;i>o;o++)t[o]=this.m_phase<this.m_pwm?1:-1,this.m_phase=this.m_phase+this.m_freqShift&e.PHASE_MSK},e.prototype.getSamplesWithSyncIn=function(t,s,i,o){var h;if(this.m_mix)for(h=i;o>h;h++)s[h]&&this.resetPhase(),t[h]=this.m_phase<this.m_pwm?1:this.m_modNoise.getNextSample(),this.m_phase=this.m_phase+this.m_freqShift&e.PHASE_MSK;else for(h=i;o>h;h++)s[h]&&this.resetPhase(),t[h]=this.m_phase<this.m_pwm?1:-1,this.m_phase=this.m_phase+this.m_freqShift&e.PHASE_MSK},e.prototype.getSamplesWithSyncOut=function(t,s,i,o){var h;if(this.m_mix)for(h=i;o>h;h++)t[h]=this.m_phase<this.m_pwm?1:this.m_modNoise.getNextSample(),this.m_phase+=this.m_freqShift,s[h]=this.m_phase>e.PHASE_MSK,this.m_phase&=e.PHASE_MSK;else for(h=i;o>h;h++)t[h]=this.m_phase<this.m_pwm?1:-1,this.m_phase+=this.m_freqShift,s[h]=this.m_phase>e.PHASE_MSK,this.m_phase&=e.PHASE_MSK},e.prototype.setPWM=function(t){this.m_pwm=t*e.PHASE_LEN},e.prototype.setMIX=function(t){this.m_mix=t},e.prototype.setNoise=function(t){this.m_modNoise=t},e}(t.MOscMod);t.MOscPulse=e}(e=t.flmml||(t.flmml={}))}(FlMMLWorker||(FlMMLWorker={}));var FlMMLWorker;!function(t){var e;!function(t){var e=function(t){function e(){e.boot(),t.call(this),this.setWaveNo(0)}return __extends(e,t),e.boot=function(){if(!e.s_init){var t,s,i=1/e.TABLE_LEN;for(e.s_table=new Array(e.MAX_WAVE),s=0;s<e.MAX_WAVE;s++)e.s_table[s]=new Array(e.TABLE_LEN);for(s=0,t=0;s<e.TABLE_LEN;s++)e.s_table[0][s]=2*t-1,e.s_table[1][s]=.5>t?2*t:2*t-2,t+=i;e.s_init=1}},e.prototype.getNextSample=function(){var t=e.s_table[this.m_waveNo][this.m_phase>>e.PHASE_SFT];return this.m_phase=this.m_phase+this.m_freqShift&e.PHASE_MSK,t},e.prototype.getNextSampleOfs=function(t){var s=e.s_table[this.m_waveNo][(this.m_phase+t&e.PHASE_MSK)>>e.PHASE_SFT];return this.m_phase=this.m_phase+this.m_freqShift&e.PHASE_MSK,s},e.prototype.getSamples=function(t,s,i){var o;for(o=s;i>o;o++)t[o]=e.s_table[this.m_waveNo][this.m_phase>>e.PHASE_SFT],this.m_phase=this.m_phase+this.m_freqShift&e.PHASE_MSK},e.prototype.getSamplesWithSyncIn=function(t,s,i,o){var h;for(h=i;o>h;h++)s[h]&&this.resetPhase(),t[h]=e.s_table[this.m_waveNo][this.m_phase>>e.PHASE_SFT],this.m_phase=this.m_phase+this.m_freqShift&e.PHASE_MSK},e.prototype.getSamplesWithSyncOut=function(t,s,i,o){var h;for(h=i;o>h;h++)t[h]=e.s_table[this.m_waveNo][this.m_phase>>e.PHASE_SFT],this.m_phase+=this.m_freqShift,s[h]=this.m_phase>e.PHASE_MSK,this.m_phase&=e.PHASE_MSK},e.prototype.setWaveNo=function(t){this.m_waveNo=Math.min(t,e.MAX_WAVE-1)},e.MAX_WAVE=2,e.s_init=0,e}(t.MOscMod);t.MOscSaw=e}(e=t.flmml||(t.flmml={}))}(FlMMLWorker||(FlMMLWorker={}));var FlMMLWorker;!function(t){var e;!function(t){var e=function(t){function e(){e.boot(),t.call(this),this.setWaveNo(0)}return __extends(e,t),e.boot=function(){if(!e.s_init){var t,s,i=2*Math.PI/this.TABLE_LEN;for(e.s_table=new Array(this.MAX_WAVE),s=0;s<this.MAX_WAVE;s++)e.s_table[s]=new Array(this.TABLE_LEN);for(s=0,t=0;s<this.TABLE_LEN;s++)e.s_table[0][s]=Math.sin(t),e.s_table[1][s]=Math.max(0,e.s_table[0][s]),e.s_table[2][s]=e.s_table[0][s]>=0?e.s_table[0][s]:-1*e.s_table[0][s],t+=i;e.s_init=1}},e.prototype.getNextSample=function(){var t=e.s_table[this.m_waveNo][this.m_phase>>e.PHASE_SFT];return this.m_phase=this.m_phase+this.m_freqShift&e.PHASE_MSK,t},e.prototype.getNextSampleOfs=function(t){var s=e.s_table[this.m_waveNo][(this.m_phase+t&e.PHASE_MSK)>>e.PHASE_SFT];return this.m_phase=this.m_phase+this.m_freqShift&e.PHASE_MSK,s},e.prototype.getSamples=function(t,s,i){var o,h=e.s_table[this.m_waveNo];for(o=s;i>o;o++)t[o]=h[this.m_phase>>e.PHASE_SFT],this.m_phase=this.m_phase+this.m_freqShift&e.PHASE_MSK},e.prototype.getSamplesWithSyncIn=function(t,s,i,o){var h,_=e.s_table[this.m_waveNo];for(h=i;o>h;h++)s[h]&&this.resetPhase(),t[h]=_[this.m_phase>>e.PHASE_SFT],this.m_phase=this.m_phase+this.m_freqShift&e.PHASE_MSK},e.prototype.getSamplesWithSyncOut=function(t,s,i,o){var h,_=e.s_table[this.m_waveNo];for(h=i;o>h;h++)t[h]=_[this.m_phase>>e.PHASE_SFT],this.m_phase+=this.m_freqShift,s[h]=this.m_phase>e.PHASE_MSK,this.m_phase&=e.PHASE_MSK},e.prototype.setWaveNo=function(t){t>=e.MAX_WAVE&&(t=e.MAX_WAVE-1),e.s_table[t]||(t=0),this.m_waveNo=t},e.MAX_WAVE=3,e.s_init=0,e}(t.MOscMod);t.MOscSine=e}(e=t.flmml||(t.flmml={}))}(FlMMLWorker||(FlMMLWorker={}));var FlMMLWorker;!function(t){var e;!function(t){var e=function(t){function e(){e.boot(),t.call(this),this.setWaveNo(0)}return __extends(e,t),e.boot=function(){if(!e.s_init){var t,s,i=1/e.TABLE_LEN;for(e.s_table=new Array(e.MAX_WAVE),s=0;s<e.MAX_WAVE;s++)e.s_table[s]=new Array(e.TABLE_LEN);for(s=0,t=0;s<e.TABLE_LEN;s++)e.s_table[0][s]=.5>t?1-4*t:1-4*(1-t),e.s_table[1][s]=.25>t?0-4*t:.75>t?-2+4*t:4-4*t,t+=i;e.s_init=1}},e.prototype.getNextSample=function(){var t=e.s_table[this.m_waveNo][this.m_phase>>e.PHASE_SFT];return this.m_phase=this.m_phase+this.m_freqShift&e.PHASE_MSK,t},e.prototype.getNextSampleOfs=function(t){var s=e.s_table[this.m_waveNo][(this.m_phase+t&e.PHASE_MSK)>>e.PHASE_SFT];return this.m_phase=this.m_phase+this.m_freqShift&e.PHASE_MSK,s},e.prototype.getSamples=function(t,s,i){var o;for(o=s;i>o;o++)t[o]=e.s_table[this.m_waveNo][this.m_phase>>e.PHASE_SFT],this.m_phase=this.m_phase+this.m_freqShift&e.PHASE_MSK},e.prototype.getSamplesWithSyncIn=function(t,s,i,o){var h;for(h=i;o>h;h++)s[h]&&this.resetPhase(),t[h]=e.s_table[this.m_waveNo][this.m_phase>>e.PHASE_SFT],this.m_phase=this.m_phase+this.m_freqShift&e.PHASE_MSK},e.prototype.getSamplesWithSyncOut=function(t,s,i,o){var h;for(h=i;o>h;h++)t[h]=e.s_table[this.m_waveNo][this.m_phase>>e.PHASE_SFT],this.m_phase+=this.m_freqShift,s[h]=this.m_phase>e.PHASE_MSK,this.m_phase&=e.PHASE_MSK},e.prototype.setWaveNo=function(t){this.m_waveNo=Math.min(t,e.MAX_WAVE-1)},e.MAX_WAVE=2,e.s_init=0,e}(t.MOscMod);t.MOscTriangle=e}(e=t.flmml||(t.flmml={}))}(FlMMLWorker||(FlMMLWorker={}));var FlMMLWorker;!function(t){var e;!function(t){var e=function(t){function e(){e.boot(),t.call(this),this.setWaveNo(0)}return __extends(e,t),e.boot=function(){e.s_init||(e.s_table=new Array(e.MAX_WAVE),e.s_length=new Array(e.MAX_WAVE),e.setWave(0,"00112233445566778899AABBCCDDEEFFFFEEDDCCBBAA99887766554433221100"),e.s_init=1)},e.setWave=function(t,s){e.s_length[t]=0,e.s_table[t]=new Array(s.length/2),e.s_table[t][0]=0;for(var i=0,o=0,h=0;i<e.MAX_LENGTH&&i<s.length;i++,o++){var _=s.charCodeAt(i);_>=48&&58>_?_-=48:_>=97&&103>_?_-=87:_=0,1&o?(h+=_,e.s_table[t][e.s_length[t]]=(Number(h)-127.5)/127.5,e.s_length[t]++):h=_<<4}0==e.s_length[t]&&(e.s_length[t]=1),e.s_length[t]=(e.PHASE_MSK+1)/e.s_length[t]},e.prototype.setWaveNo=function(t){t>=e.MAX_WAVE&&(t=e.MAX_WAVE-1),e.s_table[t]||(t=0),this.m_waveNo=t},e.prototype.getNextSample=function(){var t=e.s_table[this.m_waveNo][Math.floor(this.m_phase/e.s_length[this.m_waveNo])];return this.m_phase=this.m_phase+this.m_freqShift&e.PHASE_MSK,t},e.prototype.getNextSampleOfs=function(t){var s=e.s_table[this.m_waveNo][Math.floor((this.m_phase+t&e.PHASE_MSK)/e.s_length[this.m_waveNo])];return this.m_phase=this.m_phase+this.m_freqShift&e.PHASE_MSK,s},e.prototype.getSamples=function(t,s,i){var o;for(o=s;i>o;o++)t[o]=e.s_table[this.m_waveNo][Math.floor(this.m_phase/e.s_length[this.m_waveNo])],this.m_phase=this.m_phase+this.m_freqShift&e.PHASE_MSK},e.prototype.getSamplesWithSyncIn=function(t,s,i,o){var h;for(h=i;o>h;h++)s[h]&&this.resetPhase(),t[h]=e.s_table[this.m_waveNo][Math.floor(this.m_phase/e.s_length[this.m_waveNo])],this.m_phase=this.m_phase+this.m_freqShift&e.PHASE_MSK},e.prototype.getSamplesWithSyncOut=function(t,s,i,o){var h;for(h=i;o>h;h++)t[h]=e.s_table[this.m_waveNo][Math.floor(this.m_phase/e.s_length[this.m_waveNo])],this.m_phase+=this.m_freqShift,s[h]=this.m_phase>e.PHASE_MSK,this.m_phase&=e.PHASE_MSK},e.MAX_WAVE=32,e.MAX_LENGTH=2048,e.s_init=0,e}(t.MOscMod);t.MOscWave=e}(e=t.flmml||(t.flmml={}))}(FlMMLWorker||(FlMMLWorker={}));var FlMMLWorker;!function(t){var e;!function(t){var e=function(){function e(e){this.m_voices=new Array(e);for(var s=0;s<this.m_voices.length;s++)this.m_voices[s]=new t.MChannel;this.m_form=t.MOscillator.FC_PULSE,this.m_subform=0,this.m_voiceId=0,this.m_volMode=0,this.m_voiceLimit=e,this.m_lastVoice=null,this.m_voiceLen=this.m_voices.length}return e.prototype.setExpression=function(t){for(var e=0;e<this.m_voiceLen;e++)this.m_voices[e].setExpression(t)},e.prototype.setVelocity=function(t){for(var e=0;e<this.m_voiceLen;e++)this.m_voices[e].setVelocity(t)},e.prototype.setNoteNo=function(t,e){void 0===e&&(e=!0),null!=this.m_lastVoice&&this.m_lastVoice.isPlaying()&&this.m_lastVoice.setNoteNo(t,e)},e.prototype.setDetune=function(t){for(var e=0;e<this.m_voiceLen;e++)this.m_voices[e].setDetune(t)},e.prototype.getVoiceCount=function(){var t,e=0;for(t=0;t<this.m_voiceLen;t++)e+=this.m_voices[t].getVoiceCount();return e},e.prototype.noteOn=function(t,e){var s,i=null;if(this.getVoiceCount()<=this.m_voiceLimit)for(s=0;s<this.m_voiceLen;s++)if(0==this.m_voices[s].isPlaying()){i=this.m_voices[s];break}if(null==i){var o=Number.MAX_VALUE;for(s=0;s<this.m_voiceLen;s++)o>this.m_voices[s].getId()&&(o=this.m_voices[s].getId(),i=this.m_voices[s])}i.setForm(this.m_form,this.m_subform),i.setVolMode(this.m_volMode),i.noteOnWidthId(t,e,this.m_voiceId++),this.m_lastVoice=i},e.prototype.noteOff=function(t){for(var e=0;e<this.m_voiceLen;e++)this.m_voices[e].getNoteNo()==t&&this.m_voices[e].noteOff(t)},e.prototype.setSoundOff=function(){for(var t=0;t<this.m_voiceLen;t++)this.m_voices[t].setSoundOff()},e.prototype.close=function(){for(var t=0;t<this.m_voiceLen;t++)this.m_voices[t].close()},e.prototype.setNoiseFreq=function(t){for(var e=0;e<this.m_voiceLen;e++)this.m_voices[e].setNoiseFreq(t)},e.prototype.setForm=function(t,e){this.m_form=t,this.m_subform=e},e.prototype.setEnvelope1Atk=function(t){for(var e=0;e<this.m_voiceLen;e++)this.m_voices[e].setEnvelope1Atk(t)},e.prototype.setEnvelope1Point=function(t,e){for(var s=0;s<this.m_voiceLen;s++)this.m_voices[s].setEnvelope1Point(t,e)},e.prototype.setEnvelope1Rel=function(t){for(var e=0;e<this.m_voiceLen;e++)this.m_voices[e].setEnvelope1Rel(t)},e.prototype.setEnvelope2Atk=function(t){for(var e=0;e<this.m_voiceLen;e++)this.m_voices[e].setEnvelope2Atk(t)},e.prototype.setEnvelope2Point=function(t,e){for(var s=0;s<this.m_voiceLen;s++)this.m_voices[s].setEnvelope2Point(t,e)},e.prototype.setEnvelope2Rel=function(t){for(var e=0;e<this.m_voiceLen;e++)this.m_voices[e].setEnvelope2Rel(t)},e.prototype.setPWM=function(t){for(var e=0;e<this.m_voiceLen;e++)this.m_voices[e].setPWM(t)},e.prototype.setPan=function(t){for(var e=0;e<this.m_voiceLen;e++)this.m_voices[e].setPan(t)},e.prototype.setFormant=function(t){for(var e=0;e<this.m_voiceLen;e++)this.m_voices[e].setFormant(t)},e.prototype.setLFOFMSF=function(t,e){for(var s=0;s<this.m_voiceLen;s++)this.m_voices[s].setLFOFMSF(t,e)},e.prototype.setLFODPWD=function(t,e){for(var s=0;s<this.m_voiceLen;s++)this.m_voices[s].setLFODPWD(t,e)},e.prototype.setLFODLTM=function(t,e){for(var s=0;s<this.m_voiceLen;s++)this.m_voices[s].setLFODLTM(t,e)},e.prototype.setLFOTarget=function(t){for(var e=0;e<this.m_voiceLen;e++)this.m_voices[e].setLFOTarget(t)},e.prototype.setLpfSwtAmt=function(t,e){for(var s=0;s<this.m_voiceLen;s++)this.m_voices[s].setLpfSwtAmt(t,e)},e.prototype.setLpfFrqRes=function(t,e){for(var s=0;s<this.m_voiceLen;s++)this.m_voices[s].setLpfFrqRes(t,e)},e.prototype.setVolMode=function(t){this.m_volMode=t},e.prototype.setInput=function(t,e){for(var s=0;s<this.m_voiceLen;s++)this.m_voices[s].setInput(t,e)},e.prototype.setOutput=function(t,e){for(var s=0;s<this.m_voiceLen;s++)this.m_voices[s].setOutput(t,e)},e.prototype.setRing=function(t,e){for(var s=0;s<this.m_voiceLen;s++)this.m_voices[s].setRing(t,e)},e.prototype.setSync=function(t,e){for(var s=0;s<this.m_voiceLen;s++)this.m_voices[s].setSync(t,e)},e.prototype.setPortamento=function(t,e){for(var s=0;s<this.m_voiceLen;s++)this.m_voices[s].setPortamento(t,e)},e.prototype.setMidiPort=function(t){for(var e=0;e<this.m_voiceLen;e++)this.m_voices[e].setMidiPort(t)},e.prototype.setMidiPortRate=function(t){for(var e=0;e<this.m_voiceLen;e++)this.m_voices[e].setMidiPortRate(t)},e.prototype.setPortBase=function(t){for(var e=0;e<this.m_voiceLen;e++)this.m_voices[e].setPortBase(t)},e.prototype.setVoiceLimit=function(t){this.m_voiceLimit=Math.max(1,Math.min(t,this.m_voiceLen))},e.prototype.setHwLfo=function(t){for(var e=0;e<this.m_voiceLen;e++)this.m_voices[e].setHwLfo(t)},e.prototype.reset=function(){this.m_form=0,this.m_subform=0,this.m_voiceId=0,this.m_volMode=0;for(var t=0;t<this.m_voiceLen;t++)this.m_voices[t].reset()},e.prototype.getSamples=function(t,e,s,i){for(var o=!1,h=0;h<this.m_voiceLen;h++)this.m_voices[h].isPlaying()&&(this.m_voices[h].setSlaveVoice(o),this.m_voices[h].getSamples(t,e,s,i),o=!0);0==o&&this.m_voices[0].clearOutPipe(e,s,i)},e}();t.MPolyChannel=e}(e=t.flmml||(t.flmml={}))}(FlMMLWorker||(FlMMLWorker={}));var FlMMLWorker;!function(t){var e;!function(t){var e=function(){function t(){}return t.getString=function(e,s){return t.s_string[e].replace("%s",s)},t.UNKNOWN_COMMAND=0,t.UNCLOSED_REPEAT=1,t.UNOPENED_COMMENT=2,t.UNCLOSED_COMMENT=3,t.RECURSIVE_MACRO=4,t.UNCLOSED_ARGQUOTE=5,t.UNCLOSED_GROUPNOTES=6,t.UNOPENED_GROUPNOTES=7,t.INVALID_MACRO_NAME=8,t.s_string=[" '%s' ","","","","",' "" ',"","","'%s'"],t}();t.MWarning=e}(e=t.flmml||(t.flmml={}))}(FlMMLWorker||(FlMMLWorker={}));var global=this,FlMMLWorker;!function(t){var e=t.flmml.MML,s=1,i=2,o=3,h=4,_=5,r=6,n=7,a=8,m=9,c=10,p=11,l=function(){function t(){this.onStopSound=null,this.onRequestBuffer=null,global.addEventListener("message",this.onMessage.bind(this))}return t.prototype.onMessage=function(t){var r=t.data,n=r.type,a=this.m_mml;if(n)switch(n){case s:this.sampleRate=t.data.sampleRate,this.m_mml=new e;break;case i:a.play(r.mml);break;case o:a.stop(),this.syncInfo();break;case h:a.pause(),this.syncInfo();break;case _:this.onRequestBuffer&&this.onRequestBuffer(r);break;case m:this.syncInfo();break;case p:this.onStopSound&&this.onStopSound()}},t.prototype.buffering=function(t){global.postMessage({type:n,progress:t})},t.prototype.compileComplete=function(){var t=this.m_mml;global.postMessage({type:r,info:{totalMSec:t.getTotalMSec(),totalTimeStr:t.getTotalTimeStr(),warnings:t.getWarnings(),metaTitle:t.getMetaTitle(),metaComment:t.getMetaComment(),metaArtist:t.getMetaArtist(),metaCoding:t.getMetaCoding()}})},t.prototype.playSound=function(){global.postMessage({type:c}),this.syncInfo()},t.prototype.stopSound=function(t,e){void 0===t&&(t=null),void 0===e&&(e=!1),global.postMessage({type:p,isFlushBuf:e}),t?this.onStopSound=t:this.onStopSound=null},t.prototype.sendBuffer=function(t){try{global.postMessage({type:_,buffer:t},[t[0].buffer,t[1].buffer])}catch(e){console.log("Buffer is null")}},t.prototype.complete=function(){global.postMessage({type:a}),this.syncInfo()},t.prototype.syncInfo=function(){var t=this.m_mml;global.postMessage({type:m,info:{_isPlaying:t.isPlaying(),_isPaused:t.isPaused(),nowMSec:t.getNowMSec(),nowTimeStr:t.getNowTimeStr(),voiceCount:t.getVoiceCount()}})},t}();t.Worker=l,global.worker=new l}(FlMMLWorker||(FlMMLWorker={}));