var flmml,fmgenAs,messenger,__extends=this&&this.__extends||function(){var i=function(t,e){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var s in e)e.hasOwnProperty(s)&&(t[s]=e[s])})(t,e)};return function(t,e){function s(){this.constructor=t}i(t,e),t.prototype=null===e?Object.create(e):(s.prototype=e.prototype,new s)}}();!function(d){var t=function(){function P(){this.m_noteNo=0,this.m_detune=0,this.m_freqNo=0,this.m_envelope1=new d.MEnvelope(0,60/127,30/127,1/127),this.m_envelope2=new d.MEnvelope(0,30/127,0,1),this.m_oscSet1=new d.MOscillator,this.m_oscMod1=this.m_oscSet1.getCurrent(),this.m_oscSet2=new d.MOscillator,this.m_oscSet2.asLFO(),this.m_oscSet2.setForm(d.MOscillator.SINE),this.m_oscMod2=this.m_oscSet2.getCurrent(),this.m_osc2Connect=0,this.m_filter=new d.MFilter,this.m_filterConnect=0,this.m_formant=new d.MFormant,this.m_volMode=0,this.setExpression(127),this.setVelocity(100),this.setPan(64),this.m_onCounter=0,this.m_lfoDelay=0,this.m_lfoDepth=0,this.m_lfoEnd=0,this.m_lpfAmt=0,this.m_lpfFrq=0,this.m_lpfRes=0,this.m_pulseWidth=.5,this.setInput(0,0),this.setOutput(0,0),this.setRing(0,0),this.setSync(0,0),this.m_portDepth=0,this.m_portDepthAdd=0,this.m_lastFreqNo=4800,this.m_portamento=0,this.m_portRate=0,this.m_voiceid=0,this.m_slaveVoice=!1}return P.boot=function(t){if(!this.s_init){var e;for(this.emptyBuffer=msgr.emptyBuffer,this.s_frequencyLen=this.s_frequencyMap.length,e=0;e<this.s_frequencyLen;e++)this.s_frequencyMap[e]=440*Math.pow(2,(e-69*this.PITCH_RESOLUTION)/(12*this.PITCH_RESOLUTION));for(this.s_volumeLen=128,this.s_volumeMap=new Array(3),e=0;e<3;e++)this.s_volumeMap[e]=new Array(this.s_volumeLen),this.s_volumeMap[e][0]=0;for(e=1;e<this.s_volumeLen;e++)this.s_volumeMap[0][e]=e/127,this.s_volumeMap[1][e]=Math.pow(10,48/2540*(e-127)),this.s_volumeMap[2][e]=Math.pow(10,96/2540*(e-127));this.s_init=1}this.s_samples=new Float32Array(t)},P.createPipes=function(t){this.s_pipeArr=new Array(t);for(var e=0;e<t;e++)this.s_pipeArr[e]=new Float32Array(this.s_samples.length)},P.createSyncSources=function(t){this.s_syncSources=new Array(t);for(var e=0;e<t;e++){this.s_syncSources[e]=new Array(this.s_samples.length);for(var s=0;s<this.s_samples.length;s++)this.s_syncSources[e][s]=!1}},P.getFrequency=function(t){return P.s_frequencyMap[t=(t|=0)<0?0:P.s_frequencyLen<=t?P.s_frequencyLen-1:t]},P.prototype.setExpression=function(t){this.m_expression=P.s_volumeMap[this.m_volMode][t],this.m_ampLevel=this.m_velocity*this.m_expression,this.m_oscSet1.getMod(d.MOscillator.OPM).setExpression(this.m_expression)},P.prototype.setVelocity=function(t){this.m_velocity=P.s_volumeMap[this.m_volMode][t],this.m_ampLevel=this.m_velocity*this.m_expression,this.m_oscSet1.getMod(d.MOscillator.OPM).setVelocity(t)},P.prototype.setNoteNo=function(t,e){void 0===e&&(e=!0),this.m_noteNo=t,this.m_freqNo=this.m_noteNo*P.PITCH_RESOLUTION+this.m_detune,this.m_oscMod1.setFrequency(P.getFrequency(this.m_freqNo)),1===this.m_portamento&&(e?this.m_portDepth+=this.m_lastFreqNo-this.m_freqNo:this.m_portDepth=this.m_lastFreqNo-this.m_freqNo,this.m_portDepthAdd=this.m_portDepth<0?this.m_portRate:-1*this.m_portRate),this.m_lastFreqNo=this.m_freqNo},P.prototype.setDetune=function(t){this.m_detune=t,this.m_freqNo=this.m_noteNo*P.PITCH_RESOLUTION+this.m_detune,this.m_oscMod1.setFrequency(P.getFrequency(this.m_freqNo))},P.prototype.getNoteNo=function(){return this.m_noteNo},P.prototype.isPlaying=function(){return this.m_oscSet1.getForm()===d.MOscillator.OPM?this.m_oscSet1.getCurrent().IsPlaying():this.m_envelope1.isPlaying()},P.prototype.getId=function(){return this.m_voiceid},P.prototype.getVoiceCount=function(){return this.isPlaying()?1:0},P.prototype.setSlaveVoice=function(t){this.m_slaveVoice=t},P.prototype.noteOnWidthId=function(t,e,s){this.m_voiceid=s,this.noteOn(t,e)},P.prototype.noteOn=function(t,e){this.setNoteNo(t,!1),this.m_envelope1.triggerEnvelope(0),this.m_envelope2.triggerEnvelope(1),this.m_oscMod1.resetPhase(),this.m_oscMod2.resetPhase(),this.m_filter.reset(),this.setVelocity(e),this.m_onCounter=0,this.m_oscSet1.getMod(d.MOscillator.PULSE).setPWM(this.m_pulseWidth);var s=this.m_oscSet1;s.getMod(d.MOscillator.FC_NOISE).setNoteNo(this.m_noteNo),s.getMod(d.MOscillator.GB_NOISE).setNoteNo(this.m_noteNo),s.getMod(d.MOscillator.GB_S_NOISE).setNoteNo(this.m_noteNo),s.getMod(d.MOscillator.FC_DPCM).setNoteNo(this.m_noteNo),s.getMod(d.MOscillator.OPM).setNoteNo(this.m_noteNo)},P.prototype.noteOff=function(t){(t<0||t===this.m_noteNo)&&(this.m_envelope1.releaseEnvelope(),this.m_envelope2.releaseEnvelope(),this.m_oscSet1.getMod(d.MOscillator.OPM).noteOff())},P.prototype.setSoundOff=function(){this.m_envelope1.soundOff(),this.m_envelope2.soundOff()},P.prototype.close=function(){this.noteOff(this.m_noteNo),this.m_filter.setSwitch(0)},P.prototype.setNoiseFreq=function(t){this.m_oscSet1.getMod(d.MOscillator.NOISE).setNoiseFreq(1-t*(1/128))},P.prototype.setForm=function(t,e){this.m_oscMod1=this.m_oscSet1.setForm(t),this.m_oscMod1.setWaveNo(e)},P.prototype.setEnvelope1Atk=function(t){this.m_envelope1.setAttack(t*(1/127))},P.prototype.setEnvelope1Point=function(t,e){this.m_envelope1.addPoint(t*(1/127),e*(1/127))},P.prototype.setEnvelope1Rel=function(t){this.m_envelope1.setRelease(t*(1/127))},P.prototype.setEnvelope2Atk=function(t){this.m_envelope2.setAttack(t*(1/127))},P.prototype.setEnvelope2Point=function(t,e){this.m_envelope2.addPoint(t*(1/127),e*(1/127))},P.prototype.setEnvelope2Rel=function(t){this.m_envelope2.setRelease(t*(1/127))},P.prototype.setPWM=function(t){if(this.m_oscSet1.getForm()!==d.MOscillator.FC_PULSE){var e=this.m_oscSet1.getMod(d.MOscillator.PULSE);t<0?(e.setMIX(1),t*=-1):e.setMIX(0),this.m_pulseWidth=.01*t,e.setPWM(this.m_pulseWidth)}else{t<0&&(t*=-1),this.m_oscSet1.getMod(d.MOscillator.FC_PULSE).setPWM(.125*Math.floor(t))}},P.prototype.setPan=function(t){this.m_pan=.5/63*(t-1),this.m_pan<0&&(this.m_pan=0)},P.prototype.setFormant=function(t){0<=t?this.m_formant.setVowel(t):this.m_formant.disable()},P.prototype.setLFOFMSF=function(t,e){this.m_oscMod2=this.m_oscSet2.setForm(0<=t?t-1:-t-1),this.m_oscMod2.setWaveNo(e),this.m_osc2Sign=0<=t?1:-1,t<0&&(t=-t),--t>=d.MOscillator.MAX&&(this.m_osc2Connect=0)},P.prototype.setLFODPWD=function(t,e){this.m_lfoDepth=t,this.m_osc2Connect=0===t?0:1,this.m_oscMod2.setFrequency(e),this.m_oscMod2.resetPhase(),this.m_oscSet2.getMod(d.MOscillator.NOISE).setNoiseFreq(e/d.MSequencer.SAMPLE_RATE)},P.prototype.setLFODLTM=function(t,e){this.m_lfoDelay=t,this.m_lfoEnd=0<e?this.m_lfoDelay+e:0},P.prototype.setLFOTarget=function(t){this.m_lfoTarget=t},P.prototype.setLpfSwtAmt=function(t,e){-3<t&&t<3&&t!==this.m_filterConnect&&(this.m_filterConnect=t,this.m_filter.setSwitch(t)),this.m_lpfAmt=(e<-127?-127:e<127?e:127)*P.PITCH_RESOLUTION},P.prototype.setLpfFrqRes=function(t,e){t<0&&(t=0),127<t&&(t=127),this.m_lpfFrq=t*P.PITCH_RESOLUTION,this.m_lpfRes=e*(1/127),this.m_lpfRes<0&&(this.m_lpfRes=0),1<this.m_lpfRes&&(this.m_lpfRes=1)},P.prototype.setVolMode=function(t){switch(t){case 0:case 1:case 2:this.m_volMode=t}},P.prototype.setInput=function(t,e){this.m_inSens=1/8*(1<<t-1)*d.MOscMod.PHASE_LEN,this.m_inPipe=e},P.prototype.setOutput=function(t,e){this.m_outMode=t,this.m_outPipe=e},P.prototype.setRing=function(t,e){this.m_ringSens=(1<<t-1)/8,this.m_ringPipe=e},P.prototype.setSync=function(t,e){this.m_syncMode=t,this.m_syncPipe=e},P.prototype.setPortamento=function(t,e){this.m_portamento=0,this.m_portDepth=t,this.m_portDepthAdd=Math.floor(this.m_portDepth)/e*-1},P.prototype.setMidiPort=function(t){this.m_portamento=t,this.m_portDepth=0},P.prototype.setMidiPortRate=function(t){this.m_portRate=t},P.prototype.setPortBase=function(t){this.m_lastFreqNo=t},P.prototype.setVoiceLimit=function(t){},P.prototype.setHwLfo=function(t){var e=t>>27&3,s=t>>19&255,i=t>>12&127,h=t>>5&127,o=t>>2&7,_=t>>0&3,r=this.m_oscSet1.getMod(d.MOscillator.OPM);r.setWF(e),r.setLFRQ(s),r.setPMD(i),r.setAMD(h),r.setPMSAMS(o,_)},P.prototype.reset=function(){this.setSoundOff(),this.m_pulseWidth=.5,this.m_voiceid=0,this.setForm(0,0),this.setDetune(0),this.setExpression(127),this.setVelocity(100),this.setPan(64),this.setVolMode(0),this.setNoiseFreq(0),this.setLFOFMSF(0,0),this.m_osc2Connect=0,this.m_onCounter=0,this.m_lfoTarget=0,this.m_lfoDelay=0,this.m_lfoDepth=0,this.m_lfoEnd=0,this.setLpfSwtAmt(0,0),this.setLpfFrqRes(0,0),this.setFormant(-1),this.setInput(0,0),this.setOutput(0,0),this.setRing(0,0),this.setSync(0,0),this.m_portDepth=0,this.m_portDepthAdd=0,this.m_lastFreqNo=4800,this.m_portamento=0,this.m_portRate=0},P.prototype.clearOutPipe=function(t,e,s){1===this.m_outMode&&P.s_pipeArr[this.m_outPipe].set(P.emptyBuffer.subarray(0,s),e)},P.prototype.getNextCutoff=function(){var t=this.m_lpfFrq+this.m_lpfAmt*this.m_envelope2.getNextAmplitudeLinear();return(t=P.getFrequency(t)*this.m_oscMod1.getFrequency()*(2*Math.PI/(440*d.MSequencer.SAMPLE_RATE)))<1/127&&(t=0),t},P.prototype.getSamples=function(t,e,s,i){var h,o,_,r,n,a,m,c,p,l,u,f,g=s+i,S=P.s_samples,v=this.isPlaying();e<=g&&(g=e);var y=P.getFrequency(this.m_freqNo);if(1===this.m_outMode&&!1===this.m_slaveVoice&&(S=P.s_pipeArr[this.m_outPipe]),v&&(0===this.m_portDepth?1e-6<=this.m_inSens?0===this.m_osc2Connect?this.getSamplesF__(S,s,g):0===this.m_lfoTarget?this.getSamplesFP_(S,s,g):3===this.m_lfoTarget?this.getSamplesFW_(S,s,g):4===this.m_lfoTarget?this.getSamplesFF_(S,s,g):this.getSamplesF__(S,s,g):2===this.m_syncMode?0===this.m_osc2Connect?this.getSamplesI__(S,s,g):0===this.m_lfoTarget?this.getSamplesIP_(S,s,g):3===this.m_lfoTarget?this.getSamplesIW_(S,s,g):this.getSamplesI__(S,s,g):1===this.m_syncMode?0===this.m_osc2Connect?this.getSamplesO__(S,s,g):0===this.m_lfoTarget?this.getSamplesOP_(S,s,g):3===this.m_lfoTarget?this.getSamplesOW_(S,s,g):this.getSamplesO__(S,s,g):0===this.m_osc2Connect?this.getSamples___(S,s,g):0===this.m_lfoTarget?this.getSamples_P_(S,s,g):3===this.m_lfoTarget?this.getSamples_W_(S,s,g):this.getSamples___(S,s,g):1e-6<=this.m_inSens?0===this.m_osc2Connect?this.getSamplesF_P(S,s,g):0===this.m_lfoTarget?this.getSamplesFPP(S,s,g):3===this.m_lfoTarget?this.getSamplesFWP(S,s,g):4===this.m_lfoTarget?this.getSamplesFFP(S,s,g):this.getSamplesF_P(S,s,g):2===this.m_syncMode?0===this.m_osc2Connect?this.getSamplesI_P(S,s,g):0===this.m_lfoTarget?this.getSamplesIPP(S,s,g):3===this.m_lfoTarget?this.getSamplesIWP(S,s,g):this.getSamplesI_P(S,s,g):1===this.m_syncMode?0===this.m_osc2Connect?this.getSamplesO_P(S,s,g):0===this.m_lfoTarget?this.getSamplesOPP(S,s,g):3===this.m_lfoTarget?this.getSamplesOWP(S,s,g):this.getSamplesO_P(S,s,g):0===this.m_osc2Connect?this.getSamples__P(S,s,g):0===this.m_lfoTarget?this.getSamples_PP(S,s,g):3===this.m_lfoTarget?this.getSamples_WP(S,s,g):this.getSamples__P(S,s,g)),this.m_oscSet1.getForm()!==d.MOscillator.OPM&&(0===this.m_volMode?this.m_envelope1.ampSamplesLinear(S,s,g,this.m_ampLevel):this.m_envelope1.ampSamplesNonLinear(S,s,g,this.m_ampLevel,this.m_volMode)),1===this.m_lfoTarget&&0!==this.m_osc2Connect)for(p=this.m_osc2Sign*this.m_lfoDepth/127,l=u=s;l<g;l++)a=1,this.m_onCounter>=this.m_lfoDelay&&(0===this.m_lfoEnd||this.m_onCounter<this.m_lfoEnd)&&(a+=this.m_oscMod2.getNextSample()*p),a<0&&(a=0),S[l]*=a,this.m_onCounter++;if(v&&1e-6<=this.m_ringSens)for(o=P.s_pipeArr[this.m_ringPipe],h=this.m_ringSens,l=s;l<g;l++)S[l]*=o[l]*h;if((v=(n=v)||this.m_formant.checkToSilence())!==n&&S.set(P.emptyBuffer.subarray(0,i),s),v&&this.m_formant.run(S,s,g),(v=(n=v)||this.m_filter.checkToSilence())!==n&&S.set(P.emptyBuffer.subarray(0,i),s),v)if(2===this.m_lfoTarget&&0!==this.m_osc2Connect)for(p=this.m_osc2Sign*this.m_lfoDepth,u=s;g<(f=u+P.s_lfoDelta)&&(f=g),m=this.m_lpfFrq,this.m_onCounter>=this.m_lfoDelay&&(0===this.m_lfoEnd||this.m_onCounter<this.m_lfoEnd)&&(m+=this.m_oscMod2.getNextSample()*p|0,this.m_oscMod2.addPhase(f-u-1)),m<0?m=0:127*P.PITCH_RESOLUTION<m&&(m=127*P.PITCH_RESOLUTION),this.m_filter.run(P.s_samples,u,f,this.m_envelope2,m,this.m_lpfAmt,this.m_lpfRes,y),this.m_onCounter+=f-u,(u=f)<g;);else this.m_filter.run(S,s,g,this.m_envelope2,this.m_lpfFrq,this.m_lpfAmt,this.m_lpfRes,y);if(v)switch(this.m_outMode){case 0:var M=t[0],E=t[1];if(5===this.m_lfoTarget&&0!==this.m_osc2Connect)for(p=this.m_osc2Sign*this.m_lfoDepth*(1/127),l=s;l<g;l++)(c=this.m_pan+this.m_oscMod2.getNextSample()*p)<0?c=0:1<c&&(c=1),r=(_=.5*S[l])*c,M[l]+=_-r,E[l]+=r;else for(l=s;l<g;l++)r=(_=.5*S[l])*this.m_pan,M[l]+=_-r,E[l]+=r;break;case 1:if(o=P.s_pipeArr[this.m_outPipe],!1===this.m_slaveVoice)for(l=s;l<g;l++)o[l]=S[l];else for(l=s;l<g;l++)o[l]+=S[l];break;case 2:for(o=P.s_pipeArr[this.m_outPipe],l=s;l<g;l++)o[l]+=S[l]}else 1===this.m_outMode&&(o=P.s_pipeArr[this.m_outPipe],!1===this.m_slaveVoice&&o.set(P.emptyBuffer.subarray(0,i),s))},P.prototype.getSamples___=function(t,e,s){this.m_oscMod1.getSamples(t,e,s)},P.prototype.getSamples_P_=function(t,e,s){for(var i,h,o=e,_=this.m_osc2Sign*this.m_lfoDepth,r=this.m_oscMod1,n=this.m_oscMod2;s<(i=o+P.s_lfoDelta)&&(i=s),h=this.m_freqNo,this.m_onCounter>=this.m_lfoDelay&&(0===this.m_lfoEnd||this.m_onCounter<this.m_lfoEnd)&&(h+=n.getNextSample()*_|0,n.addPhase(i-o-1)),r.setFrequency(P.getFrequency(h)),r.getSamples(t,o,i),this.m_onCounter+=i-o,(o=i)<s;);},P.prototype.getSamples_W_=function(t,e,s){for(var i,h,o=e,_=this.m_osc2Sign*this.m_lfoDepth*.01,r=this.m_oscSet1.getMod(d.MOscillator.PULSE),n=this.m_oscMod1,a=this.m_oscMod2;s<(i=o+P.s_lfoDelta)&&(i=s),h=this.m_pulseWidth,this.m_onCounter>=this.m_lfoDelay&&(0===this.m_lfoEnd||this.m_onCounter<this.m_lfoEnd)&&(h+=a.getNextSample()*_,a.addPhase(i-o-1)),h<0?h=0:100<h&&(h=100),r.setPWM(h),n.getSamples(t,o,i),this.m_onCounter+=i-o,(o=i)<s;);},P.prototype.getSamplesF__=function(t,e,s){var i,h=this.m_inSens,o=P.s_pipeArr[this.m_inPipe],_=this.m_oscMod1;for(_.setFrequency(P.getFrequency(this.m_freqNo)),i=e;i<s;i++)t[i]=_.getNextSampleOfs(o[i]*h)},P.prototype.getSamplesFP_=function(t,e,s){var i,h,o=this.m_inSens,_=this.m_osc2Sign*this.m_lfoDepth,r=P.s_pipeArr[this.m_inPipe],n=this.m_oscMod1,a=this.m_oscMod2;for(i=e;i<s;i++)h=this.m_freqNo,this.m_onCounter>=this.m_lfoDelay&&(0===this.m_lfoEnd||this.m_onCounter<this.m_lfoEnd)&&(h+=a.getNextSample()*_|0),n.setFrequency(P.getFrequency(h)),t[i]=n.getNextSampleOfs(r[i]*o),this.m_onCounter++},P.prototype.getSamplesFW_=function(t,e,s){var i,h,o=this.m_osc2Sign*this.m_lfoDepth*.01,_=this.m_oscSet1.getMod(d.MOscillator.PULSE),r=this.m_inSens,n=P.s_pipeArr[this.m_inPipe],a=this.m_oscMod1,m=this.m_oscMod2;for(a.setFrequency(P.getFrequency(this.m_freqNo)),i=e;i<s;i++)h=this.m_pulseWidth,this.m_onCounter>=this.m_lfoDelay&&(0===this.m_lfoEnd||this.m_onCounter<this.m_lfoEnd)&&(h+=m.getNextSample()*o),h<0?h=0:100<h&&(h=100),_.setPWM(h),t[i]=a.getNextSampleOfs(n[i]*r),this.m_onCounter++},P.prototype.getSamplesFF_=function(t,e,s){var i,h,o=this.m_osc2Sign*this.m_lfoDepth*(1/127),_=P.s_pipeArr[this.m_inPipe],r=this.m_oscMod1,n=this.m_oscMod2;for(r.setFrequency(P.getFrequency(this.m_freqNo)),i=e;i<s;i++)h=this.m_inSens,this.m_onCounter>=this.m_lfoDelay&&(0===this.m_lfoEnd||this.m_onCounter<this.m_lfoEnd)&&(h*=n.getNextSample()*o),t[i]=r.getNextSampleOfs(_[i]*h),this.m_onCounter++},P.prototype.getSamplesI__=function(t,e,s){this.m_oscMod1.getSamplesWithSyncIn(t,P.s_syncSources[this.m_syncPipe],e,s)},P.prototype.getSamplesIP_=function(t,e,s){for(var i,h,o=e,_=this.m_osc2Sign*this.m_lfoDepth,r=P.s_syncSources[this.m_syncPipe],n=this.m_oscMod1,a=this.m_oscMod2;s<(i=o+P.s_lfoDelta)&&(i=s),h=this.m_freqNo,this.m_onCounter>=this.m_lfoDelay&&(0===this.m_lfoEnd||this.m_onCounter<this.m_lfoEnd)&&(h+=a.getNextSample()*_|0,a.addPhase(i-o-1)),n.setFrequency(P.getFrequency(h)),n.getSamplesWithSyncIn(t,r,o,i),this.m_onCounter+=i-o,(o=i)<s;);},P.prototype.getSamplesIW_=function(t,e,s){for(var i,h,o=e,_=this.m_osc2Sign*this.m_lfoDepth*.01,r=this.m_oscSet1.getMod(d.MOscillator.PULSE),n=P.s_syncSources[this.m_syncPipe],a=this.m_oscMod1,m=this.m_oscMod2;s<(i=o+P.s_lfoDelta)&&(i=s),h=this.m_pulseWidth,this.m_onCounter>=this.m_lfoDelay&&(0===this.m_lfoEnd||this.m_onCounter<this.m_lfoEnd)&&(h+=m.getNextSample()*_,m.addPhase(i-o-1)),h<0?h=0:100<h&&(h=100),r.setPWM(h),a.getSamplesWithSyncIn(t,n,o,i),this.m_onCounter+=i-o,(o=i)<s;);},P.prototype.getSamplesO__=function(t,e,s){this.m_oscMod1.getSamplesWithSyncOut(t,P.s_syncSources[this.m_syncPipe],e,s)},P.prototype.getSamplesOP_=function(t,e,s){for(var i,h,o=e,_=this.m_osc2Sign*this.m_lfoDepth,r=P.s_syncSources[this.m_syncPipe],n=this.m_oscMod1,a=this.m_oscMod2;s<(i=o+P.s_lfoDelta)&&(i=s),h=this.m_freqNo,this.m_onCounter>=this.m_lfoDelay&&(0===this.m_lfoEnd||this.m_onCounter<this.m_lfoEnd)&&(h+=a.getNextSample()*_|0,a.addPhase(i-o-1)),n.setFrequency(P.getFrequency(h)),n.getSamplesWithSyncOut(t,r,o,i),this.m_onCounter+=i-o,(o=i)<s;);},P.prototype.getSamplesOW_=function(t,e,s){for(var i,h,o=e,_=this.m_osc2Sign*this.m_lfoDepth*.01,r=this.m_oscSet1.getMod(d.MOscillator.PULSE),n=P.s_syncSources[this.m_syncPipe],a=this.m_oscMod1,m=this.m_oscMod2;s<(i=o+P.s_lfoDelta)&&(i=s),h=this.m_pulseWidth,this.m_onCounter>=this.m_lfoDelay&&(0===this.m_lfoEnd||this.m_onCounter<this.m_lfoEnd)&&(h+=m.getNextSample()*_,m.addPhase(i-o-1)),h<0?h=0:100<h&&(h=100),r.setPWM(h),a.getSamplesWithSyncOut(t,n,o,i),this.m_onCounter+=i-o,(o=i)<s;);},P.prototype.getSamples__P=function(t,e,s){for(var i,h,o=e,_=this.m_oscMod1;s<(i=o+P.s_lfoDelta)&&(i=s),h=this.m_freqNo,0!==this.m_portDepth&&(h+=0|this.m_portDepth,this.m_portDepth+=this.m_portDepthAdd*(i-o-1),0<this.m_portDepth*this.m_portDepthAdd&&(this.m_portDepth=0)),_.setFrequency(P.getFrequency(h)),_.getSamples(t,o,i),(o=i)<s;);0===this.m_portDepth&&_.setFrequency(P.getFrequency(this.m_freqNo))},P.prototype.getSamples_PP=function(t,e,s){for(var i,h,o=e,_=this.m_osc2Sign*this.m_lfoDepth,r=this.m_oscMod1,n=this.m_oscMod2;s<(i=o+P.s_lfoDelta)&&(i=s),h=this.m_freqNo,0!==this.m_portDepth&&(h+=0|this.m_portDepth,this.m_portDepth+=this.m_portDepthAdd*(i-o-1),0<this.m_portDepth*this.m_portDepthAdd&&(this.m_portDepth=0)),this.m_onCounter>=this.m_lfoDelay&&(0===this.m_lfoEnd||this.m_onCounter<this.m_lfoEnd)&&(h+=n.getNextSample()*_,n.addPhase(i-o-1),0<this.m_portDepth*this.m_portDepthAdd&&(this.m_portDepth=0)),r.setFrequency(P.getFrequency(h)),r.getSamples(t,o,i),this.m_onCounter+=i-o,(o=i)<s;);},P.prototype.getSamples_WP=function(t,e,s){for(var i,h,o,_=e,r=this.m_osc2Sign*this.m_lfoDepth*.01,n=this.m_oscSet1.getMod(d.MOscillator.PULSE),a=this.m_oscMod1,m=this.m_oscMod2;s<(i=_+P.s_lfoDelta)&&(i=s),o=this.m_freqNo,0!==this.m_portDepth&&(o+=0|this.m_portDepth,this.m_portDepth+=this.m_portDepthAdd*(i-_-1),0<this.m_portDepth*this.m_portDepthAdd&&(this.m_portDepth=0)),a.setFrequency(P.getFrequency(o)),h=this.m_pulseWidth,this.m_onCounter>=this.m_lfoDelay&&(0===this.m_lfoEnd||this.m_onCounter<this.m_lfoEnd)&&(h+=m.getNextSample()*r,m.addPhase(i-_-1)),h<0?h=0:100<h&&(h=100),n.setPWM(h),a.getSamples(t,_,i),this.m_onCounter+=i-_,(_=i)<s;);0===this.m_portDepth&&a.setFrequency(P.getFrequency(this.m_freqNo))},P.prototype.getSamplesF_P=function(t,e,s){var i,h,o=this.m_inSens,_=P.s_pipeArr[this.m_inPipe],r=this.m_oscMod1;for(h=e;h<s;h++)i=this.m_freqNo,0!==this.m_portDepth&&(i+=0|this.m_portDepth,this.m_portDepth+=this.m_portDepthAdd,0<this.m_portDepth*this.m_portDepthAdd&&(this.m_portDepth=0)),r.setFrequency(P.getFrequency(i)),t[h]=r.getNextSampleOfs(_[h]*o)},P.prototype.getSamplesFPP=function(t,e,s){var i,h,o=this.m_inSens,_=this.m_osc2Sign*this.m_lfoDepth,r=P.s_pipeArr[this.m_inPipe],n=this.m_oscMod1,a=this.m_oscMod2;for(i=e;i<s;i++)h=this.m_freqNo,0!==this.m_portDepth&&(h+=0|this.m_portDepth,this.m_portDepth+=this.m_portDepthAdd,0<this.m_portDepth*this.m_portDepthAdd&&(this.m_portDepth=0)),this.m_onCounter>=this.m_lfoDelay&&(0===this.m_lfoEnd||this.m_onCounter<this.m_lfoEnd)&&(h+=a.getNextSample()*_|0),n.setFrequency(P.getFrequency(h)),t[i]=n.getNextSampleOfs(r[i]*o),this.m_onCounter++},P.prototype.getSamplesFWP=function(t,e,s){var i,h,o,_=this.m_osc2Sign*this.m_lfoDepth*.01,r=this.m_oscSet1.getMod(d.MOscillator.PULSE),n=this.m_inSens,a=P.s_pipeArr[this.m_inPipe],m=this.m_oscMod1,c=this.m_oscMod2;for(i=e;i<s;i++)h=this.m_freqNo,0!==this.m_portDepth&&(h+=0|this.m_portDepth,this.m_portDepth+=this.m_portDepthAdd,0<this.m_portDepth*this.m_portDepthAdd&&(this.m_portDepth=0)),m.setFrequency(P.getFrequency(h)),o=this.m_pulseWidth,this.m_onCounter>=this.m_lfoDelay&&(0===this.m_lfoEnd||this.m_onCounter<this.m_lfoEnd)&&(o+=c.getNextSample()*_),o<0?o=0:100<o&&(o=100),r.setPWM(o),t[i]=m.getNextSampleOfs(a[i]*n),this.m_onCounter++},P.prototype.getSamplesFFP=function(t,e,s){var i,h,o,_=this.m_osc2Sign*this.m_lfoDepth*(1/127),r=P.s_pipeArr[this.m_inPipe],n=this.m_oscMod1,a=this.m_oscMod2;for(i=e;i<s;i++)h=this.m_freqNo,0!==this.m_portDepth&&(h+=0|this.m_portDepth,this.m_portDepth+=this.m_portDepthAdd,0<this.m_portDepth*this.m_portDepthAdd&&(this.m_portDepth=0)),n.setFrequency(P.getFrequency(h)),o=this.m_inSens,this.m_onCounter>=this.m_lfoDelay&&(0===this.m_lfoEnd||this.m_onCounter<this.m_lfoEnd)&&(o*=a.getNextSample()*_),t[i]=n.getNextSampleOfs(r[i]*o),this.m_onCounter++},P.prototype.getSamplesI_P=function(t,e,s){for(var i,h,o=e,_=P.s_syncSources[this.m_syncPipe],r=this.m_oscMod1;s<(i=o+P.s_lfoDelta)&&(i=s),h=this.m_freqNo,0!==this.m_portDepth&&(h+=0|this.m_portDepth,this.m_portDepth+=this.m_portDepthAdd*(i-o-1),0<this.m_portDepth*this.m_portDepthAdd&&(this.m_portDepth=0)),r.setFrequency(P.getFrequency(h)),r.getSamplesWithSyncIn(t,_,o,i),this.m_onCounter+=i-o,(o=i)<s;);0===this.m_portDepth&&r.setFrequency(P.getFrequency(this.m_freqNo))},P.prototype.getSamplesIPP=function(t,e,s){for(var i,h,o=e,_=this.m_osc2Sign*this.m_lfoDepth,r=P.s_syncSources[this.m_syncPipe],n=this.m_oscMod1,a=this.m_oscMod2;s<(i=o+P.s_lfoDelta)&&(i=s),h=this.m_freqNo,0!==this.m_portDepth&&(h+=0|this.m_portDepth,this.m_portDepth+=this.m_portDepthAdd*(i-o-1),0<this.m_portDepth*this.m_portDepthAdd&&(this.m_portDepth=0)),this.m_onCounter>=this.m_lfoDelay&&(0===this.m_lfoEnd||this.m_onCounter<this.m_lfoEnd)&&(h+=a.getNextSample()*_|0,a.addPhase(i-o-1)),n.setFrequency(P.getFrequency(h)),n.getSamplesWithSyncIn(t,r,o,i),this.m_onCounter+=i-o,(o=i)<s;);},P.prototype.getSamplesIWP=function(t,e,s){for(var i,h,o,_=e,r=this.m_osc2Sign*this.m_lfoDepth*.01,n=this.m_oscSet1.getMod(d.MOscillator.PULSE),a=P.s_syncSources[this.m_syncPipe],m=this.m_oscMod1,c=this.m_oscMod2;s<(i=_+P.s_lfoDelta)&&(i=s),h=this.m_freqNo,0!==this.m_portDepth&&(h+=0|this.m_portDepth,this.m_portDepth+=this.m_portDepthAdd*(i-_-1),0<this.m_portDepth*this.m_portDepthAdd&&(this.m_portDepth=0)),m.setFrequency(P.getFrequency(h)),o=this.m_pulseWidth,this.m_onCounter>=this.m_lfoDelay&&(0===this.m_lfoEnd||this.m_onCounter<this.m_lfoEnd)&&(o+=c.getNextSample()*r,c.addPhase(i-_-1)),o<0?o=0:100<o&&(o=100),n.setPWM(o),m.getSamplesWithSyncIn(t,a,_,i),this.m_onCounter+=i-_,(_=i)<s;);0===this.m_portDepth&&m.setFrequency(P.getFrequency(this.m_freqNo))},P.prototype.getSamplesO_P=function(t,e,s){for(var i,h,o=e,_=P.s_syncSources[this.m_syncPipe],r=this.m_oscMod1;s<(i=o+P.s_lfoDelta)&&(i=s),h=this.m_freqNo,0!==this.m_portDepth&&(h+=0|this.m_portDepth,this.m_portDepth+=this.m_portDepthAdd*(i-o-1),0<this.m_portDepth*this.m_portDepthAdd&&(this.m_portDepth=0)),r.setFrequency(P.getFrequency(h)),r.getSamplesWithSyncOut(t,_,o,i),this.m_onCounter+=i-o,(o=i)<s;);0===this.m_portDepth&&r.setFrequency(P.getFrequency(this.m_freqNo))},P.prototype.getSamplesOPP=function(t,e,s){for(var i,h,o=e,_=this.m_osc2Sign*this.m_lfoDepth,r=P.s_syncSources[this.m_syncPipe],n=this.m_oscMod1,a=this.m_oscMod2;s<(i=o+P.s_lfoDelta)&&(i=s),h=this.m_freqNo,0!==this.m_portDepth&&(h+=0|this.m_portDepth,this.m_portDepth+=this.m_portDepthAdd*(i-o-1),0<this.m_portDepth*this.m_portDepthAdd&&(this.m_portDepth=0)),this.m_onCounter>=this.m_lfoDelay&&(0===this.m_lfoEnd||this.m_onCounter<this.m_lfoEnd)&&(h+=a.getNextSample()*_|0,a.addPhase(i-o-1)),n.setFrequency(P.getFrequency(h)),n.getSamplesWithSyncOut(t,r,o,i),this.m_onCounter+=i-o,(o=i)<s;);},P.prototype.getSamplesOWP=function(t,e,s){for(var i,h,o,_=e,r=this.m_osc2Sign*this.m_lfoDepth*.01,n=this.m_oscSet1.getMod(d.MOscillator.PULSE),a=P.s_syncSources[this.m_syncPipe],m=this.m_oscMod1,c=this.m_oscMod2;s<(i=_+P.s_lfoDelta)&&(i=s),h=this.m_freqNo,0!==this.m_portDepth&&(h+=0|this.m_portDepth,this.m_portDepth+=this.m_portDepthAdd*(i-_-1),0<this.m_portDepth*this.m_portDepthAdd&&(this.m_portDepth=0)),m.setFrequency(P.getFrequency(h)),o=this.m_pulseWidth,this.m_onCounter>=this.m_lfoDelay&&(0===this.m_lfoEnd||this.m_onCounter<this.m_lfoEnd)&&(o+=c.getNextSample()*r,c.addPhase(i-_-1)),o<0?o=0:100<o&&(o=100),n.setPWM(o),m.getSamplesWithSyncOut(t,a,_,i),this.m_onCounter+=i-_,(_=i)<s;);0===this.m_portDepth&&m.setFrequency(P.getFrequency(this.m_freqNo))},P.PITCH_RESOLUTION=100,P.s_init=0,P.s_frequencyMap=new Array(128*P.PITCH_RESOLUTION),P.s_lfoDelta=245,P}();d.MChannel=t}(flmml||(flmml={})),function(i){var t=function(){function n(t,e,s,i){this.setAttack(t),this.addPoint(e,s),this.setRelease(i),this.m_playing=!1,this.m_currentVal=0,this.m_releasing=!0,this.m_releaseStep=0}return n.boot=function(){if(!this.s_init){var t;for(this.s_volumeLen=256,t=0;t<3;t++)this.s_volumeMap[t]=new Array(this.s_volumeLen),this.s_volumeMap[t][0]=0;for(t=1;t<this.s_volumeLen;t++)this.s_volumeMap[0][t]=t/255,this.s_volumeMap[1][t]=Math.pow(10,48/5100*(t-255)),this.s_volumeMap[2][t]=Math.pow(10,96/5100*(t-255));this.s_init=1}},n.prototype.setAttack=function(t){this.m_envelopePoint=this.m_envelopeLastPoint=new i.MEnvelopePoint,this.m_envelopePoint.time=0,this.m_envelopePoint.level=0,this.addPoint(t,1)},n.prototype.setRelease=function(t){if(this.m_releaseTime=(0<t?t:1/127)*i.MSequencer.SAMPLE_RATE,this.m_playing&&!this.m_releasing){for(this.m_counter=this.m_timeInSamples,this.m_currentPoint=this.m_envelopePoint;null!==this.m_currentPoint.next&&this.m_counter>=this.m_currentPoint.next.time;)this.m_currentPoint=this.m_currentPoint.next,this.m_counter-=this.m_currentPoint.time;null==this.m_currentPoint.next?this.m_currentVal=this.m_currentPoint.level:(this.m_step=(this.m_currentPoint.next.level-this.m_currentPoint.level)/this.m_currentPoint.next.time,this.m_currentVal=this.m_currentPoint.level+this.m_step*this.m_counter)}},n.prototype.addPoint=function(t,e){var s=new i.MEnvelopePoint;s.time=t*i.MSequencer.SAMPLE_RATE,s.level=e,this.m_envelopeLastPoint.next=s,this.m_envelopeLastPoint=s},n.prototype.triggerEnvelope=function(t){this.m_playing=!0,this.m_releasing=!1,this.m_currentPoint=this.m_envelopePoint,this.m_currentVal=this.m_currentPoint.level=t?0:this.m_currentVal,this.m_step=(1-this.m_currentVal)/this.m_currentPoint.next.time,this.m_timeInSamples=this.m_counter=0},n.prototype.releaseEnvelope=function(){this.m_releasing=!0,this.m_releaseStep=this.m_currentVal/this.m_releaseTime},n.prototype.soundOff=function(){this.releaseEnvelope(),this.m_playing=!1},n.prototype.getNextAmplitudeLinear=function(){if(!this.m_playing)return 0;if(this.m_releasing)this.m_currentVal-=this.m_releaseStep;else if(null==this.m_currentPoint.next)this.m_currentVal=this.m_currentPoint.level;else{for(var t=!1;this.m_counter>=this.m_currentPoint.next.time;){if(this.m_counter=0,this.m_currentPoint=this.m_currentPoint.next,null==this.m_currentPoint.next){this.m_currentVal=this.m_currentPoint.level,t=!0;break}this.m_step=(this.m_currentPoint.next.level-this.m_currentPoint.level)/this.m_currentPoint.next.time,this.m_currentVal=this.m_currentPoint.level,t=!0}t||(this.m_currentVal+=this.m_step),this.m_counter++}return this.m_currentVal<=0&&this.m_releasing&&(this.m_playing=!1,this.m_currentVal=0),this.m_timeInSamples++,this.m_currentVal},n.prototype.ampSamplesLinear=function(t,e,s,i){var h,o=this.m_currentVal*i;for(h=e;h<s;h++)if(this.m_playing){if(this.m_releasing)this.m_currentVal-=this.m_releaseStep,o=this.m_currentVal*i;else if(null==this.m_currentPoint.next);else{for(var _=!1;this.m_counter>=this.m_currentPoint.next.time;){if(this.m_counter=0,this.m_currentPoint=this.m_currentPoint.next,null==this.m_currentPoint.next){this.m_currentVal=this.m_currentPoint.level,_=!0;break}this.m_step=(this.m_currentPoint.next.level-this.m_currentPoint.level)/this.m_currentPoint.next.time,this.m_currentVal=this.m_currentPoint.level,_=!0}_||(this.m_currentVal+=this.m_step),o=this.m_currentVal*i,this.m_counter++}this.m_currentVal<=0&&this.m_releasing&&(this.m_playing=!1,o=this.m_currentVal=0),this.m_timeInSamples++,t[h]*=o}else t[h]=0},n.prototype.ampSamplesNonLinear=function(t,e,s,i,h){var o;for(o=e;o<s;o++)if(this.m_playing){if(this.m_releasing)this.m_currentVal-=this.m_releaseStep;else if(null==this.m_currentPoint.next)this.m_currentVal=this.m_currentPoint.level;else{for(var _=!1;this.m_counter>=this.m_currentPoint.next.time;){if(this.m_counter=0,this.m_currentPoint=this.m_currentPoint.next,null==this.m_currentPoint.next){this.m_currentVal=this.m_currentPoint.level,_=!0;break}this.m_step=(this.m_currentPoint.next.level-this.m_currentPoint.level)/this.m_currentPoint.next.time,this.m_currentVal=this.m_currentPoint.level,_=!0}_||(this.m_currentVal+=this.m_step),this.m_counter++}this.m_currentVal<=0&&this.m_releasing&&(this.m_playing=!1,this.m_currentVal=0),this.m_timeInSamples++;var r=255*this.m_currentVal|0;255<r&&(r=0),t[o]*=n.s_volumeMap[h][r]*i}else t[o]=0},n.prototype.isPlaying=function(){return this.m_playing},n.prototype.isReleasing=function(){return this.m_releasing},n.s_init=0,n.s_volumeMap=new Array(3),n}();i.MEnvelope=t}(flmml||(flmml={})),function(t){var e=function(){this.next=null};(flmml||(flmml={})).MEnvelopePoint=e}(),function(t){var e=function(){function t(t){this.TEMPO_SCALE=100,this.set(1,0,0),this.setTick(t)}return t.prototype.set=function(t,e,s){this.m_status=t,this.m_data0=e,this.m_data1=s},t.prototype.setEOT=function(){this.set(0,0,0)},t.prototype.setNoteOn=function(t,e){this.set(2,t,e)},t.prototype.setNoteOff=function(t,e){this.set(3,t,e)},t.prototype.setTempo=function(t){this.set(4,t*this.TEMPO_SCALE,0)},t.prototype.setVolume=function(t){this.set(5,t,0)},t.prototype.setNote=function(t){this.set(6,t,0)},t.prototype.setForm=function(t,e){this.set(7,t,e)},t.prototype.setEnvelope1Atk=function(t){this.set(8,t,0)},t.prototype.setEnvelope1Point=function(t,e){this.set(9,t,e)},t.prototype.setEnvelope1Rel=function(t){this.set(10,t,0)},t.prototype.setEnvelope2Atk=function(t){this.set(24,t,0)},t.prototype.setEnvelope2Point=function(t,e){this.set(25,t,e)},t.prototype.setEnvelope2Rel=function(t){this.set(26,t,0)},t.prototype.setNoiseFreq=function(t){this.set(11,t,0)},t.prototype.setPWM=function(t){this.set(12,t,0)},t.prototype.setPan=function(t){this.set(13,t,0)},t.prototype.setFormant=function(t){this.set(14,t,0)},t.prototype.setDetune=function(t){this.set(15,t,0)},t.prototype.setLFOFMSF=function(t,e){this.set(16,t,e)},t.prototype.setLFODPWD=function(t,e){this.set(17,t,e)},t.prototype.setLFODLTM=function(t,e){this.set(18,t,e)},t.prototype.setLFOTarget=function(t){this.set(19,t,0)},t.prototype.setLPFSWTAMT=function(t,e){this.set(20,t,e)},t.prototype.setLPFFRQRES=function(t,e){this.set(21,t,e)},t.prototype.setClose=function(){this.set(22,0,0)},t.prototype.setVolMode=function(t){this.set(23,t,0)},t.prototype.setInput=function(t,e){this.set(27,t,e)},t.prototype.setOutput=function(t,e){this.set(28,t,e)},t.prototype.setExpression=function(t){this.set(29,t,0)},t.prototype.setRing=function(t,e){this.set(30,t,e)},t.prototype.setSync=function(t,e){this.set(31,t,e)},t.prototype.setDelta=function(t){this.m_delta=t},t.prototype.setTick=function(t){this.m_tick=t},t.prototype.setPortamento=function(t,e){this.set(32,t,e)},t.prototype.setMidiPort=function(t){this.set(33,t,0)},t.prototype.setMidiPortRate=function(t){this.set(34,t,0)},t.prototype.setPortBase=function(t){this.set(35,t,0)},t.prototype.setPoly=function(t){this.set(36,t,0)},t.prototype.setResetAll=function(){this.set(38,0,0)},t.prototype.setSoundOff=function(){this.set(37,0,0)},t.prototype.setHwLfo=function(t,e,s,i,h,o,_){this.set(39,(3&t)<<27|(255&e)<<19|(127&s)<<12|(127&i)<<5|(7&h)<<2|3&o,0)},t.prototype.getStatus=function(){return this.m_status},t.prototype.getDelta=function(){return this.m_delta},t.prototype.getTick=function(){return this.m_tick},t.prototype.getNoteNo=function(){return this.m_data0},t.prototype.getVelocity=function(){return this.m_data1},t.prototype.getTempo=function(){return Math.floor(this.m_data0)/this.TEMPO_SCALE},t.prototype.getVolume=function(){return this.m_data0},t.prototype.getForm=function(){return this.m_data0},t.prototype.getSubForm=function(){return this.m_data1},t.prototype.getEnvelopeA=function(){return this.m_data0},t.prototype.getEnvelopeT=function(){return this.m_data0},t.prototype.getEnvelopeL=function(){return this.m_data1},t.prototype.getEnvelopeR=function(){return this.m_data0},t.prototype.getNoiseFreq=function(){return this.m_data0},t.prototype.getPWM=function(){return this.m_data0},t.prototype.getPan=function(){return this.m_data0},t.prototype.getVowel=function(){return this.m_data0},t.prototype.getDetune=function(){return this.m_data0},t.prototype.getLFODepth=function(){return this.m_data0},t.prototype.getLFOWidth=function(){return this.m_data1},t.prototype.getLFOForm=function(){return this.m_data0},t.prototype.getLFOSubForm=function(){return this.m_data1},t.prototype.getLFODelay=function(){return this.m_data0},t.prototype.getLFOTime=function(){return this.m_data1},t.prototype.getLFOTarget=function(){return this.m_data0},t.prototype.getLPFSwt=function(){return this.m_data0},t.prototype.getLPFAmt=function(){return this.m_data1},t.prototype.getLPFFrq=function(){return this.m_data0},t.prototype.getLPFRes=function(){return this.m_data1},t.prototype.getVolMode=function(){return this.m_data0},t.prototype.getInputSens=function(){return this.m_data0},t.prototype.getInputPipe=function(){return this.m_data1},t.prototype.getOutputMode=function(){return this.m_data0},t.prototype.getOutputPipe=function(){return this.m_data1},t.prototype.getExpression=function(){return this.m_data0},t.prototype.getRingSens=function(){return this.m_data0},t.prototype.getRingInput=function(){return this.m_data1},t.prototype.getSyncMode=function(){return this.m_data0},t.prototype.getSyncPipe=function(){return this.m_data1},t.prototype.getPorDepth=function(){return this.m_data0},t.prototype.getPorLen=function(){return this.m_data1},t.prototype.getMidiPort=function(){return this.m_data0},t.prototype.getMidiPortRate=function(){return this.m_data0},t.prototype.getPortBase=function(){return this.m_data0},t.prototype.getVoiceCount=function(){return this.m_data0},t.prototype.getHwLfoData=function(){return this.m_data0},t}();t.MEvent=e}(flmml||(flmml={})),function(P){var t=function(){function t(){this.setSwitch(0)}return t.prototype.reset=function(){this.m_t1=this.m_t2=this.m_b0=this.m_b1=this.m_b2=this.m_b3=this.m_b4=0},t.prototype.setSwitch=function(t){this.reset(),this.sw=t},t.prototype.checkToSilence=function(){switch(this.sw){case 0:return!1;case 1:case-1:return-1e-6<=this.m_b0&&this.m_b0<=1e-6&&-1e-6<=this.m_b1&&this.m_b1<=1e-6;case 2:case-2:return-1e-6<=this.m_t1&&this.m_t1<=1e-6&&-1e-6<=this.m_t2&&this.m_t2<=1e-6&&-1e-6<=this.m_b0&&this.m_b0<=1e-6&&-1e-6<=this.m_b1&&this.m_b1<=1e-6&&-1e-6<=this.m_b2&&this.m_b2<=1e-6&&-1e-6<=this.m_b3&&this.m_b3<=1e-6&&-1e-6<=this.m_b4&&this.m_b4<=1e-6}return!1},t.prototype.run=function(t,e,s,i,h,o,_,r){switch(this.sw){case-2:this.hpf2(t,e,s,i,h,o,_,r);break;case-1:this.hpf1(t,e,s,i,h,o,_,r);break;case 0:return;case 1:this.lpf1(t,e,s,i,h,o,_,r);break;case 2:this.lpf2(t,e,s,i,h,o,_,r)}},t.prototype.lpf1=function(t,e,s,i,h,o,_,r){var n,a,m,c=this.m_b0,p=this.m_b1,l=r*(2*Math.PI/(440*P.MSequencer.SAMPLE_RATE));if(1e-4<o||o<-1e-4)for(n=e;n<s;n++)(m=P.MChannel.getFrequency(h+o*i.getNextAmplitudeLinear())*l)<1/127&&(m=0),.9999<m&&(m=.9999),a=_+_/(1-m),c+=m*(t[n]-c+a*(c-p)),t[n]=p+=m*(c-p);else for((m=P.MChannel.getFrequency(h)*l)<1/127&&(m=0),.9999<m&&(m=.9999),a=_+_/(1-m),n=e;n<s;n++)c+=m*(t[n]-c+a*(c-p)),t[n]=p+=m*(c-p);this.m_b0=c,this.m_b1=p},t.prototype.lpf2=function(t,e,s,i,h,o,_,r){for(var n=this.m_t1,a=this.m_t2,m=this.m_b0,c=this.m_b1,p=this.m_b2,l=this.m_b3,u=this.m_b4,f=r*(2*Math.PI/(440*P.MSequencer.SAMPLE_RATE)),g=e;g<s;g++){var S=P.MChannel.getFrequency(h+o*i.getNextAmplitudeLinear())*f;S<1/127&&(S=0),1<S&&(S=1);var v=1-S,y=S+.8*S*v,M=y+y-1;v=_*(1+.5*v*(1-v+5.6*v*v));var E=t[g];u=((l=((p=((c=((E-=v*u)+m)*y-(n=c)*M)+n)*y-(a=p)*M)+a)*y-(n=l)*M)+n)*y-u*M,u-=u*u*u*.166667,m=E,t[g]=u}this.m_t1=n,this.m_t2=a,this.m_b0=m,this.m_b1=c,this.m_b2=p,this.m_b3=l,this.m_b4=u},t.prototype.hpf1=function(t,e,s,i,h,o,_,r){var n,a,m,c,p=this.m_b0,l=this.m_b1,u=r*(2*Math.PI/(440*P.MSequencer.SAMPLE_RATE));if(1e-4<o||o<-1e-4)for(n=e;n<s;n++)(m=P.MChannel.getFrequency(h+o*i.getNextAmplitudeLinear())*u)<1/127&&(m=0),.9999<m&&(m=.9999),a=_+_/(1-m),l+=m*((p+=m*((c=t[n])-p+a*(p-l)))-l),t[n]=c-p;else for((m=P.MChannel.getFrequency(h)*u)<1/127&&(m=0),.9999<m&&(m=.9999),a=_+_/(1-m),n=e;n<s;n++)l+=m*((p+=m*((c=t[n])-p+a*(p-l)))-l),t[n]=c-p;this.m_b0=p,this.m_b1=l},t.prototype.hpf2=function(t,e,s,i,h,o,_,r){for(var n=this.m_t1,a=this.m_t2,m=this.m_b0,c=this.m_b1,p=this.m_b2,l=this.m_b3,u=this.m_b4,f=r*(2*Math.PI/(440*P.MSequencer.SAMPLE_RATE)),g=e;g<s;g++){var S=P.MChannel.getFrequency(h+o*i.getNextAmplitudeLinear())*f;S<1/127&&(S=0),1<S&&(S=1);var v=1-S,y=S+.8*S*v,M=y+y-1;v=_*(1+.5*v*(1-v+5.6*v*v));var E=t[g];u=((l=((p=((c=((E-=v*u)+m)*y-(n=c)*M)+n)*y-(a=p)*M)+a)*y-(n=l)*M)+n)*y-u*M,u-=u*u*u*.166667,m=E,t[g]=E-u}this.m_t1=n,this.m_t2=a,this.m_b0=m,this.m_b1=c,this.m_b2=p,this.m_b3=l,this.m_b4=u},t}();P.MFilter=t}(flmml||(flmml={})),function(t){var e=function(){function t(){this.m_ca0=811044e-11,this.m_ca1=8.943665402,this.m_ca2=-36.83889529,this.m_ca3=92.01697887,this.m_ca4=-154.337906,this.m_ca5=181.6233289,this.m_ca6=-151.8651235,this.m_ca7=89.09614114,this.m_ca8=-35.10298511,this.m_ca9=8.388101016,this.m_caA=-.923313471,this.m_ce0=436215e-11,this.m_ce1=8.90438318,this.m_ce2=-36.55179099,this.m_ce3=91.05750846,this.m_ce4=-152.422234,this.m_ce5=179.1170248,this.m_ce6=-149.6496211,this.m_ce7=87.78352223,this.m_ce8=-34.60687431,this.m_ce9=8.282228154,this.m_ceA=-.914150747,this.m_ci0=333819e-11,this.m_ci1=8.893102966,this.m_ci2=-36.49532826,this.m_ci3=90.96543286,this.m_ci4=-152.4545478,this.m_ci5=179.4835618,this.m_ci6=-150.315433,this.m_ci7=88.43409371,this.m_ci8=-34.98612086,this.m_ci9=8.407803364,this.m_ciA=-.932568035,this.m_co0=113572e-11,this.m_co1=8.994734087,this.m_co2=-37.2084849,this.m_co3=93.22900521,this.m_co4=-156.6929844,this.m_co5=184.596544,this.m_co6=-154.3755513,this.m_co7=90.49663749,this.m_co8=-35.58964535,this.m_co9=8.478996281,this.m_coA=-.929252233,this.m_cu0=4.09431e-7,this.m_cu1=8.997322763,this.m_cu2=-37.20218544,this.m_cu3=93.11385476,this.m_cu4=-156.2530937,this.m_cu5=183.7080141,this.m_cu6=-153.2631681,this.m_cu7=89.59539726,this.m_cu8=-35.12454591,this.m_cu9=8.338655623,this.m_cuA=-.910251753,this.m_vowel=t.VOWEL_A,this.m_power=!1,this.reset()}return t.prototype.setVowel=function(t){this.m_power=!0,this.m_vowel=t},t.prototype.disable=function(){this.m_power=!1,this.reset()},t.prototype.reset=function(){this.m_m0=this.m_m1=this.m_m2=this.m_m3=this.m_m4=this.m_m5=this.m_m6=this.m_m7=this.m_m8=this.m_m9=0},t.prototype.checkToSilence=function(){return this.m_power&&-1e-6<=this.m_m0&&this.m_m0<=1e-6&&-1e-6<=this.m_m1&&this.m_m1<=1e-6&&-1e-6<=this.m_m2&&this.m_m2<=1e-6&&-1e-6<=this.m_m3&&this.m_m3<=1e-6&&-1e-6<=this.m_m4&&this.m_m4<=1e-6&&-1e-6<=this.m_m5&&this.m_m5<=1e-6&&-1e-6<=this.m_m6&&this.m_m6<=1e-6&&-1e-6<=this.m_m7&&this.m_m7<=1e-6&&-1e-6<=this.m_m8&&this.m_m8<=1e-6&&-1e-6<=this.m_m9&&this.m_m9<=1e-6},t.prototype.run=function(t,e,s){var i;if(this.m_power)switch(this.m_vowel){case 0:for(i=e;i<s;i++)t[i]=this.m_ca0*t[i]+this.m_ca1*this.m_m0+this.m_ca2*this.m_m1+this.m_ca3*this.m_m2+this.m_ca4*this.m_m3+this.m_ca5*this.m_m4+this.m_ca6*this.m_m5+this.m_ca7*this.m_m6+this.m_ca8*this.m_m7+this.m_ca9*this.m_m8+this.m_caA*this.m_m9,this.m_m9=this.m_m8,this.m_m8=this.m_m7,this.m_m7=this.m_m6,this.m_m6=this.m_m5,this.m_m5=this.m_m4,this.m_m4=this.m_m3,this.m_m3=this.m_m2,this.m_m2=this.m_m1,this.m_m1=this.m_m0,this.m_m0=t[i];return;case 1:for(i=e;i<s;i++)t[i]=this.m_ce0*t[i]+this.m_ce1*this.m_m0+this.m_ce2*this.m_m1+this.m_ce3*this.m_m2+this.m_ce4*this.m_m3+this.m_ce5*this.m_m4+this.m_ce6*this.m_m5+this.m_ce7*this.m_m6+this.m_ce8*this.m_m7+this.m_ce9*this.m_m8+this.m_ceA*this.m_m9,this.m_m9=this.m_m8,this.m_m8=this.m_m7,this.m_m7=this.m_m6,this.m_m6=this.m_m5,this.m_m5=this.m_m4,this.m_m4=this.m_m3,this.m_m3=this.m_m2,this.m_m2=this.m_m1,this.m_m1=this.m_m0,this.m_m0=t[i];return;case 2:for(i=e;i<s;i++)t[i]=this.m_ci0*t[i]+this.m_ci1*this.m_m0+this.m_ci2*this.m_m1+this.m_ci3*this.m_m2+this.m_ci4*this.m_m3+this.m_ci5*this.m_m4+this.m_ci6*this.m_m5+this.m_ci7*this.m_m6+this.m_ci8*this.m_m7+this.m_ci9*this.m_m8+this.m_ciA*this.m_m9,this.m_m9=this.m_m8,this.m_m8=this.m_m7,this.m_m7=this.m_m6,this.m_m6=this.m_m5,this.m_m5=this.m_m4,this.m_m4=this.m_m3,this.m_m3=this.m_m2,this.m_m2=this.m_m1,this.m_m1=this.m_m0,this.m_m0=t[i];return;case 3:for(i=e;i<s;i++)t[i]=this.m_co0*t[i]+this.m_co1*this.m_m0+this.m_co2*this.m_m1+this.m_co3*this.m_m2+this.m_co4*this.m_m3+this.m_co5*this.m_m4+this.m_co6*this.m_m5+this.m_co7*this.m_m6+this.m_co8*this.m_m7+this.m_co9*this.m_m8+this.m_coA*this.m_m9,this.m_m9=this.m_m8,this.m_m8=this.m_m7,this.m_m7=this.m_m6,this.m_m6=this.m_m5,this.m_m5=this.m_m4,this.m_m4=this.m_m3,this.m_m3=this.m_m2,this.m_m2=this.m_m1,this.m_m1=this.m_m0,this.m_m0=t[i];return;case 4:for(i=e;i<s;i++)t[i]=this.m_cu0*t[i]+this.m_cu1*this.m_m0+this.m_cu2*this.m_m1+this.m_cu3*this.m_m2+this.m_cu4*this.m_m3+this.m_cu5*this.m_m4+this.m_cu6*this.m_m5+this.m_cu7*this.m_m6+this.m_cu8*this.m_m7+this.m_cu9*this.m_m8+this.m_cuA*this.m_m9,this.m_m9=this.m_m8,this.m_m8=this.m_m7,this.m_m7=this.m_m6,this.m_m6=this.m_m5,this.m_m5=this.m_m4,this.m_m4=this.m_m3,this.m_m3=this.m_m2,this.m_m2=this.m_m1,this.m_m1=this.m_m0,this.m_m0=t[i];return}},t.VOWEL_A=0,t.VOWEL_E=1,t.VOWEL_I=2,t.VOWEL_O=3,t.VOWEL_U=4,t}();t.MFormant=e}(flmml||(flmml={})),function(L){var t=function(){function F(){this.m_sequencer=new L.MSequencer}return F.isWhitespace=function(t){return" "===t||"\t"===t||"\n"===t||"\r"===t||"　"===t},F.removeWhitespace=function(t){return t.replace(new RegExp("[ 　\n\r\t\f]+","g"),"")},F.remove=function(t,e,s){return t.substring(0,e)+t.substring(s+1)},F.prototype.getWarnings=function(){return this.m_warning},F.prototype.warning=function(t,e){this.m_warning+=L.MWarning.getString(t,e)+"\n"},F.prototype.len2tick=function(t){return 0===t?this.m_length:384/t|0},F.prototype.note=function(t){if(t+=this.m_noteShift+this.getKeySig(),"*"===this.getChar())this.m_beforeNote=t+12*this.m_octave,this.m_portamento=1,this.next();else{var e,s,i,h=0,o=0,_=0===this.m_keyoff?0:1;for(this.m_keyoff=1;;){if("%"!==this.getChar()?e=0:(e=1,this.next()),s=this.getUInt(0),1===o&&0===s){this.m_keyoff=0;break}if(i=e?s:this.len2tick(s),h+=this.getDot(i),o=0,"&"!==this.getChar())break;o=1,this.next()}1===this.m_portamento&&this.m_tracks[this.m_trackNo].recPortamento(this.m_beforeNote-(t+12*this.m_octave),h),this.m_tracks[this.m_trackNo].recNote(t+12*this.m_octave,h,this.m_velocity,_,this.m_keyoff),1===this.m_portamento&&(this.m_tracks[this.m_trackNo].recPortamento(0,0),this.m_portamento=0)}},F.prototype.rest=function(){var t,e=0;"%"===this.getChar()&&(e=1,this.next()),t=this.getUInt(0);var s=e?t:this.len2tick(t);s=this.getDot(s),this.m_tracks[this.m_trackNo].recRest(s)},F.prototype.atmark=function(){var t,e,s,i,h,o,_,r,n,a,m,c,p,l,u,f,g=this,S=this.getChar(),v=1,y=0,M=64,E=32,P=0,d=0,b=0,A=0,O=0;switch(S){case"v":this.m_velDetail=!0,this.next(),this.m_velocity=this.getUInt(this.m_velocity),127<this.m_velocity&&(this.m_velocity=127);break;case"x":this.next(),127<(v=this.getUInt(127))&&(v=127),this.m_tracks[this.m_trackNo].recExpression(v);break;case"e":!function(){var t,e=new Array,s=new Array;for(g.next(),v=g.getUInt(v),","===g.getChar()&&g.next(),y=g.getUInt(y),t=g.m_letter;","===g.getChar();){if(g.next(),t=g.m_letter-1,M=g.getUInt(M),","!==g.getChar()){g.m_letter=t;break}g.next(),E=g.getUInt(E),e.push(M),s.push(E)}0===e.length&&(e.push(M),s.push(E)),","===g.getChar()&&g.next(),P=g.getUInt(P),g.m_tracks[g.m_trackNo].recEnvelope(v,y,e,s,P)}();break;case"m":if(this.next(),"h"===this.getChar()){this.next(),i=s=e=t=O=A=0,E=1;do{if(A=this.getUInt(A),","!==this.getChar())break;if(this.next(),O=this.getUInt(O),","!==this.getChar())break;if(this.next(),t=this.getUInt(t),","!==this.getChar())break;if(this.next(),e=this.getUInt(e),","!==this.getChar())break;if(this.next(),s=this.getUInt(s),","!==this.getChar())break;if(this.next(),i=this.getUInt(i),","!==this.getChar())break;this.next(),E=this.getUInt(E)}while(0);this.m_tracks[this.m_trackNo].recHwLfo(A,O,t,e,s,i,E)}break;case"n":this.next(),"s"===this.getChar()?(this.next(),this.m_noteShift+=this.getSInt(0)):(((v=this.getUInt(0))<0||127<v)&&(v=0),this.m_tracks[this.m_trackNo].recNoiseFreq(v));break;case"w":this.next(),(v=this.getSInt(50))<0?(-1<v&&(v=-1),v<-99&&(v=-99)):(v<1&&(v=1),99<v&&(v=99)),this.m_tracks[this.m_trackNo].recPWM(v);break;case"p":this.next(),"l"===this.getChar()?(this.next(),v=this.getUInt(this.m_polyVoice),v=Math.max(0,Math.min(this.m_polyVoice,v)),this.m_tracks[this.m_trackNo].recPoly(v)):((v=this.getUInt(64))<1&&(v=1),127<v&&(v=127),this.m_tracks[this.m_trackNo].recPan(v));break;case"'":if(this.next(),0<=(v=this.m_string.indexOf("'",this.m_letter))){var N=0;switch(this.m_string.substring(this.m_letter,v)){case"a":N=L.MFormant.VOWEL_A;break;case"e":N=L.MFormant.VOWEL_E;break;case"i":N=L.MFormant.VOWEL_I;break;case"o":N=L.MFormant.VOWEL_O;break;case"u":N=L.MFormant.VOWEL_U;break;default:N=-1}this.m_tracks[this.m_trackNo].recFormant(N),this.m_letter=v+1}break;case"d":this.next(),v=this.getSInt(0),this.m_tracks[this.m_trackNo].recDetune(v);break;case"l":p=m=1,f=u=l=c=a=n=0,g.next(),n=g.getUInt(n),","===g.getChar()&&g.next(),a=g.getUInt(a),","===g.getChar()&&(g.next(),"-"===g.getChar()&&(p=-1,g.next()),m=(g.getUInt(m)+1)*p,"-"===g.getChar()&&(g.next(),c=g.getUInt(0)),","===g.getChar()&&(g.next(),l=g.getUInt(l),","===g.getChar()&&(g.next(),u=g.getUInt(u),","===g.getChar()&&(g.next(),f=g.getUInt(f))))),g.m_tracks[g.m_trackNo].recLFO(n,a,m,c,l,u,f);break;case"f":r=_=o=h=0,g.next(),h=g.getSInt(h),","===g.getChar()&&(g.next(),o=g.getSInt(o),","===g.getChar()&&(g.next(),_=g.getUInt(_),","===g.getChar()&&(g.next(),r=g.getUInt(r)))),g.m_tracks[g.m_trackNo].recLPF(h,o,_,r);break;case"q":this.next(),this.m_tracks[this.m_trackNo].recGate2(2*this.getUInt(2));break;case"i":d=0,this.next(),d=this.getUInt(d),","===this.getChar()&&(this.next(),(y=this.getUInt(y))>this.m_maxPipe&&(y=this.m_maxPipe)),this.m_tracks[this.m_trackNo].recInput(d,y);break;case"o":b=0,this.next(),b=this.getUInt(b),","===this.getChar()&&(this.next(),(y=this.getUInt(y))>this.m_maxPipe&&(this.m_maxPipe=y,this.m_maxPipe>=F.MAX_PIPE&&(this.m_maxPipe=y=F.MAX_PIPE))),this.m_tracks[this.m_trackNo].recOutput(b,y);break;case"r":d=0,g.next(),d=g.getUInt(d),","===g.getChar()&&(g.next(),(y=g.getUInt(y))>g.m_maxPipe&&(y=g.m_maxPipe)),g.m_tracks[g.m_trackNo].recRing(d,y);break;case"s":b=0,this.next(),b=this.getUInt(b),","===this.getChar()&&(this.next(),y=this.getUInt(y),1===b?y>this.m_maxSyncSource&&(this.m_maxSyncSource=y,this.m_maxSyncSource>=F.MAX_SYNCSOURCE&&(this.m_maxSyncSource=y=F.MAX_SYNCSOURCE)):2===b&&y>this.m_maxSyncSource&&(y=this.m_maxSyncSource)),this.m_tracks[this.m_trackNo].recSync(b,y);break;case"u":var T;switch(this.next(),b=this.getUInt(0)){case 0:case 1:this.m_tracks[this.m_trackNo].recMidiPort(b);break;case 2:T=0,","===this.getChar()&&(this.next(),(T=this.getUInt(0))<0&&(T=0),127<T&&(T=127)),this.m_tracks[this.m_trackNo].recMidiPortRate(1*T);break;case 3:if(","===this.getChar()){var C;this.next();var k=-1;switch(C="o"!==this.getChar()?this.m_octave:(this.next(),this.getUInt(0)),S=this.getChar()){case"c":k=0;break;case"d":k=2;break;case"e":k=4;break;case"f":k=5;break;case"g":k=7;break;case"a":k=9;break;case"b":k=11}0<=k?(this.next(),k+=this.m_noteShift+this.getKeySig(),k+=12*C):k=this.getUInt(60),k<0&&(k=0),127<k&&(k=127),this.m_tracks[this.m_trackNo].recPortBase(k)}}break;default:this.m_form=this.getUInt(this.m_form),y=0,"-"===this.getChar()&&(this.next(),y=this.getUInt(0)),this.m_tracks[this.m_trackNo].recForm(this.m_form,y)}},F.prototype.firstLetter=function(){var t,e,s=this.getCharNext();switch(s){case"c":this.note(0);break;case"d":this.note(2);break;case"e":this.note(4);break;case"f":this.note(5);break;case"g":this.note(7);break;case"a":this.note(9);break;case"b":this.note(11);break;case"r":this.rest();break;case"o":this.m_octave=this.getUInt(this.m_octave),this.m_octave<-2&&(this.m_octave=-2),8<this.m_octave&&(this.m_octave=8);break;case"v":this.m_velDetail=!1,this.m_velocity=8*this.getUInt((this.m_velocity-7)/8)+7,this.m_velocity<0&&(this.m_velocity=0),127<this.m_velocity&&(this.m_velocity=127);break;case"(":case")":e=this.getUInt(1),"("===s&&this.m_velDir||")"===s&&!this.m_velDir?(this.m_velocity+=this.m_velDetail?1*e:8*e,127<this.m_velocity&&(this.m_velocity=127)):(this.m_velocity-=this.m_velDetail?1*e:8*e,this.m_velocity<0&&(this.m_velocity=0));break;case"l":this.m_length=this.len2tick(this.getUInt(0)),this.m_length=this.getDot(this.m_length);break;case"t":this.m_tempo=this.getUNumber(this.m_tempo),this.m_tempo<1&&(this.m_tempo=1),this.m_tracks[L.MTrack.TEMPO_TRACK].recTempo(this.m_tracks[this.m_trackNo].getRecGlobalTick(),this.m_tempo);break;case"q":this.m_gate=this.getUInt(this.m_gate),this.m_tracks[this.m_trackNo].recGate(this.m_gate/this.m_maxGate);break;case"<":this.m_relativeDir?this.m_octave++:this.m_octave--;break;case">":this.m_relativeDir?this.m_octave--:this.m_octave++;break;case";":this.m_keyoff=1,0<this.m_tracks[this.m_trackNo].getNumEvents()&&this.m_trackNo++,this.m_tracks[this.m_trackNo]=this.createTrack();break;case"@":this.atmark();break;case"x":this.m_tracks[this.m_trackNo].recVolMode(this.getUInt(1));break;case"n":"s"===(t=this.getChar())?(this.next(),this.m_noteShift=this.getSInt(this.m_noteShift)):this.warning(L.MWarning.UNKNOWN_COMMAND,s+t);break;case"[":this.m_tracks[this.m_trackNo].recChordStart();break;case"]":this.m_tracks[this.m_trackNo].recChordEnd();break;default:s.charCodeAt(0)<128&&this.warning(L.MWarning.UNKNOWN_COMMAND,s)}},F.prototype.getCharNext=function(){return this.m_letter<this.m_string.length?this.m_string.charAt(this.m_letter++):""},F.prototype.getChar=function(){return this.m_letter<this.m_string.length?this.m_string.charAt(this.m_letter):""},F.prototype.next=function(t){void 0===t&&(t=1),this.m_letter+=1},F.prototype.getKeySig=function(){for(var t=0,e=1;e;){switch(this.getChar()){case"+":case"#":t++,this.next();break;case"-":t--,this.next();break;default:e=0}}return t},F.prototype.getUInt=function(t){for(var e=0,s=this.m_letter,i=1;i;){switch(this.getChar()){case"0":e=10*e+0,this.next();break;case"1":e=10*e+1,this.next();break;case"2":e=10*e+2,this.next();break;case"3":e=10*e+3,this.next();break;case"4":e=10*e+4,this.next();break;case"5":e=10*e+5,this.next();break;case"6":e=10*e+6,this.next();break;case"7":e=10*e+7,this.next();break;case"8":e=10*e+8,this.next();break;case"9":e=10*e+9,this.next();break;default:i=0}}return this.m_letter===s?t:e},F.prototype.getUNumber=function(t){var e=this.getUInt(0|t),s=1;if("."===this.getChar()){this.next();for(var i=!0;i;){switch(s*=.1,this.getChar()){case"0":e+=0*s,this.next();break;case"1":e+=1*s,this.next();break;case"2":e+=2*s,this.next();break;case"3":e+=3*s,this.next();break;case"4":e+=4*s,this.next();break;case"5":e+=5*s,this.next();break;case"6":e+=6*s,this.next();break;case"7":e+=7*s,this.next();break;case"8":e+=8*s,this.next();break;case"9":e+=9*s,this.next();break;default:i=!1}}}return e},F.prototype.getSInt=function(t){var e=this.getChar(),s=1;return"-"===e?(s=-1,this.next()):"+"===e&&this.next(),this.getUInt(t)*s},F.prototype.getDot=function(t){for(var e=this.getChar(),s=t;"."===e;)this.next(),t+=s/=2,e=this.getChar();return t},F.prototype.createTrack=function(){return this.m_octave=4,this.m_velocity=100,this.m_noteShift=0,new L.MTrack},F.prototype.begin=function(){this.m_letter=0},F.prototype.process=function(){for(this.begin();this.m_letter<this.m_string.length;)this.firstLetter()},F.prototype.processRepeat=function(){this.m_string=this.m_string.toLowerCase(),this.begin();for(var t=new Array,e=new Array,s=new Array,i=new Array,h=-1;this.m_letter<this.m_string.length;){switch(this.getCharNext()){case"/":":"===this.getChar()?(this.next(),e[++h]=this.m_letter-2,t[h]=this.getUInt(2),s[h]=this.m_letter,i[h]=-1):0<=h&&(i[h]=this.m_letter-1,this.m_string=this.m_string.substring(0,this.m_letter-1)+this.m_string.substring(this.m_letter),this.m_letter--);break;case":":if("/"===this.getChar()&&0<=h){this.next();for(var o=this.m_string.substring(s[h],this.m_letter-2),_=this.m_string.substring(0,e[h]),r=0;r<t[h];r++)r<t[h]-1||i[h]<0?_+=o:_+=this.m_string.substring(s[h],i[h]);var n=_.length;_+=this.m_string.substring(this.m_letter),this.m_string=_,this.m_letter=n,h--}}}0<=h&&this.warning(L.MWarning.UNCLOSED_REPEAT,"")},F.prototype.replaceMacro=function(t){for(var e in t){var s=t[e];if(this.m_string.substr(this.m_letter,s.id.length)===s.id){var i=this.m_letter,h=this.m_letter+s.id.length,o=s.code;this.m_letter+=s.id.length;for(var _=this.getCharNext();F.isWhitespace(_);)_=this.getCharNext();var r=new Array,n=0;if(0<s.args.length){if("{"===_){for(_=this.getCharNext();1===n||"}"!==_&&""!==_;)'"'===_&&(n=1-n),"$"===_&&this.replaceMacro(t),_=this.getCharNext();h=this.m_letter;for(var a=this.m_string.substring(i+s.id.length+1,h-1),m="",c=!1,p=0;p<a.length;p++)c||'"'!==a.charAt(p)?c&&p+1<a.length&&"\\"===a.charAt(p)&&'"'===a.charAt(p+1)?(m+='"',p++):c&&'"'===a.charAt(p)?c=!1:c||","!==a.charAt(p)?m+=a.charAt(p):(r.push(m),m=""):c=!0;r.push(m),c&&this.warning(L.MWarning.UNCLOSED_ARGQUOTE,"")}for(var l=0;l<o.length;l++)for(var u=0;u<r.length&&!(u>=s.args.length);u++)if(o.substr(l,s.args[u].id.length+1)==="%"+s.args[u].id){o=o.substring(0,l)+o.substring(l).replace("%"+s.args[u].id,r[s.args[u].index]),l+=r[s.args[u].index].length-1;break}}return this.m_string=this.m_string.substring(0,i-1)+o+this.m_string.substring(h),this.m_letter=i-1,!0}}return!1},F.prototype.processMacro=function(){var t,e,s,i,h=/^#OCTAVE\s+REVERSE\s*$/m;if(this.m_string.match(h)&&(this.m_string=this.m_string.replace(h,""),this.m_relativeDir=!1),h=/^#VELOCITY\s+REVERSE\s*$/m,this.m_string.match(h)&&(this.m_string=this.m_string.replace(h,""),this.m_velDir=!1),this.m_metaTitle=this.findMetaDescN("TITLE"),this.m_metaArtist=this.findMetaDescN("ARTIST"),this.m_metaComment=this.findMetaDescN("COMMENT"),this.m_metaCoding=this.findMetaDescN("CODING"),this.findMetaDescN("PRAGMA"),h=/^#OPM@(\d+)[ \t]*{([^}]*)}/gm,e=this.m_string.match(h))for(this.m_string=this.m_string.replace(h,""),t=0;t<e.length;t++)s=e[t].match(/^#OPM@(\d+)[ \t]*{([^}]*)}/m),L.MOscOPM.setTimber(parseInt(s[1]),L.MOscOPM.TYPE_OPM,s[2]);if(h=/^#OPN@(\d+)[ \t]*{([^}]*)}/gm,e=this.m_string.match(h))for(this.m_string=this.m_string.replace(h,""),t=0;t<e.length;t++)i=e[t].match(/^#OPN@(\d+)[ \t]*{([^}]*)}/m),L.MOscOPM.setTimber(parseInt(i[1]),L.MOscOPM.TYPE_OPN,i[2]);var o=this.findMetaDescV("FMGAIN");for(t=0;t<o.length;t++)L.MOscOPM.setCommonGain(20*parseInt(o[t])/127);var _=this.findMetaDescN("USING\\s+POLY");if(0<(_=(_=(_=_.replace("\r","")).replace("\n"," ")).toLowerCase()).length){var r=_.split(" ");for(r.length<1?this.m_usingPoly=!1:(this.m_usingPoly=!0,this.m_polyVoice=Math.min(Math.max(1,parseInt(r[0])),F.MAX_POLYVOICE)),t=1;t<r.length;t++)"force"===r[t]&&(this.m_polyForce=!0);this.m_polyVoice<=1&&(this.m_usingPoly=!1,this.m_polyForce=!1)}if(h=/^#WAV10\s.*$/gm,e=this.m_string.match(h))for(t=0;t<e.length;t++){this.m_string=this.m_string.replace(h,"");for(var n=e[t].split(" "),a="",m=1;m<n.length;m++)a+=n[m];var c=a.split(","),p=parseInt(c[0]);p<0&&(p=0),p>=L.MOscGbWave.MAX_WAVE&&(p=L.MOscGbWave.MAX_WAVE-1),L.MOscGbWave.setWave(p,(c[1].toLowerCase()+"00000000000000000000000000000000").substr(0,32))}if(h=/^#WAV13\s.*$/gm,e=this.m_string.match(h))for(t=0;t<e.length;t++){for(this.m_string=this.m_string.replace(h,""),n=e[t].split(" "),a="",m=1;m<n.length;m++)a+=n[m];c=a.split(","),(p=parseInt(c[0]))<0&&(p=0),p>=L.MOscWave.MAX_WAVE&&(p=L.MOscWave.MAX_WAVE-1),L.MOscWave.setWave(p,c[1].toLowerCase())}if(h=/^#WAV9\s.*$/gm,e=this.m_string.match(h))for(t=0;t<e.length;t++){for(this.m_string=this.m_string.replace(h,""),n=e[t].split(" "),a="",m=1;m<n.length;m++)a+=n[m];c=a.split(","),(p=parseInt(c[0]))<0&&(p=0),p>=L.MOscFcDpcm.MAX_WAVE&&(p=L.MOscFcDpcm.MAX_WAVE-1);var l=parseInt(c[1]);l<0&&(l=0),127<l&&(l=127);var u=parseInt(c[2]);u<0&&(u=0),1<u&&(u=1),L.MOscFcDpcm.setWave(p,l,u,c[3])}this.begin();for(var f=!0,g=new Array,S=/^\s*/m,v=/\s*$/m;this.m_letter<this.m_string.length;){var y=this.getCharNext();switch(y){case"$":if(f){var M=this.m_string.indexOf(";",this.m_letter);if(M>this.m_letter){var E=this.m_string.indexOf("=",this.m_letter);if(E>this.m_letter&&E<M){var P=this.m_letter,d=this.m_string.indexOf("{");(d<0||E<=d)&&(d=E);var b=this.m_string.substring(P,d),A=b.match("[a-zA-Z_][a-zA-Z_0-9#+()]*");if(null!==A){var O=A[0];if((b=b.replace(S,"").replace(v,""))!==O&&this.warning(L.MWarning.INVALID_MACRO_NAME,b),0<O.length){var N=new Array;if(d<E){for(N=this.m_string.substring(d+1,this.m_string.indexOf("}",d)).split(","),t=0;t<N.length;t++){var T=N[t].match("[a-zA-Z_][a-zA-Z_0-9#+()]*");N[t]={id:null!==T?T[0]:"",index:t}}N.sort(function(t,e){return t.id.length>e.id.length?-1:t.id.length===e.id.length?0:1})}for(this.m_letter=E+1,y=this.getCharNext();this.m_letter<M;)"$"===y&&(this.replaceMacro(g)||this.m_string.substr(this.m_letter,O.length)===O&&(this.m_letter--,this.m_string=F.remove(this.m_string,this.m_letter,this.m_letter+O.length),this.warning(L.MWarning.RECURSIVE_MACRO,O)),M=this.m_string.indexOf(";",this.m_letter)),y=this.getCharNext();for(var C=0;C<g.length;C++)if(g[C].id!==O){if(g[C].id.length<O.length)break}else g.splice(C,1),C--;g.splice(C,0,{id:O,code:this.m_string.substring(E+1,M),args:N}),this.m_string=F.remove(this.m_string,P-1,M),this.m_letter=P-1}}}else this.replaceMacro(g),f=!1}else this.replaceMacro(g),f=!1}else this.replaceMacro(g),f=!1;break;case";":f=!0;break;default:F.isWhitespace(y)||(f=!1)}}},F.prototype.findMetaDescV=function(t){var e,s,i,h,o,_=new Array;if(h=new RegExp("^#"+t+"(\\s*|\\s+(.*))$","gm"),o=new RegExp("^#"+t+"(\\s*|\\s+(.*))$","m"),s=this.m_string.match(h))for(this.m_string=this.m_string.replace(h,""),e=0;e<s.length;e++)void 0!==(i=s[e].match(o))[2]&&_.push(i[2]);return _},F.prototype.findMetaDescN=function(t){var e,s,i,h,o,_="";if(h=new RegExp("^#"+t+"(\\s*|\\s+(.*))$","gm"),o=new RegExp("^#"+t+"(\\s*|\\s+(.*))$","m"),s=this.m_string.match(h))for(this.m_string=this.m_string.replace(h,""),e=0;e<s.length;e++)void 0!==(i=s[e].match(o))[2]&&(_+=i[2],e+1<s.length&&(_+="\r\n"));return _},F.prototype.processComment=function(t){this.m_string=t,this.begin();for(var e=-1;this.m_letter<this.m_string.length;){switch(this.getCharNext()){case"/":"*"===this.getChar()&&(e<0&&(e=this.m_letter-1),this.next());break;case"*":"/"===this.getChar()&&(0<=e?(this.m_string=F.remove(this.m_string,e,this.m_letter),this.m_letter=e,e=-1):this.warning(L.MWarning.UNOPENED_COMMENT,""))}}for(0<=e&&this.warning(L.MWarning.UNCLOSED_COMMENT,""),this.begin(),e=-1;this.m_letter<this.m_string.length;)"`"===this.getCharNext()&&(e=e<0?this.m_letter-1:(this.m_string=F.remove(this.m_string,e,this.m_letter-1),this.m_letter=e,-1))},F.prototype.processGroupNotes=function(){var t,e,s,i,h,o,_,r,n,a,m=-1,c=0,p=96;for(this.begin();this.m_letter<this.m_string.length;){var l=this.getCharNext();switch(l){case"l":p=this.len2tick(this.getUInt(0)),p=this.getDot(p);break;case"{":m=this.m_letter-1,c=0;break;case"}":for(e=this.m_letter,m<0&&this.warning(L.MWarning.UNOPENED_GROUPNOTES,""),i=0;;){if("%"!==this.getChar()?n=0:(n=1,this.next()),0===(s=this.getUInt(0))){0===i&&(i=p);break}if(h=n?s:this.len2tick(s),i+=h=this.getDot(h),"&"!==this.getChar())break;this.next()}for(t=this.m_letter,this.m_letter=m+1,a=this.m_string.substring(0,m),o=i/c,c=1,r=h=0;this.m_letter<e;){switch(l=this.getCharNext()){case"+":case"#":case"-":break;default:if(("a"<=l&&l<="g"||"r"===l)&&0===r){r=1;break}1===r&&(_=Math.round(c*o-h),c++,i<(h+=_)&&(_-=h-i,h=i),a+="%",a+=_.toString()),r=0,("a"<=l&&l<="g"||"r"===l)&&(r=1)}"}"!==l&&(a+=l)}this.m_letter=a.length,a+=this.m_string.substring(t),this.m_string=a,m=-1;break;default:("a"<=l&&l<="g"||"r"===l)&&c++}}0<=m&&this.warning(L.MWarning.UNCLOSED_GROUPNOTES,"")},F.prototype.play=function(t){this.m_sequencer.isPaused()?this.m_sequencer.play():(msgr.onstopsound=this.play2.bind(this,t),msgr.stopSound(!0))},F.prototype.play2=function(t){this.m_sequencer.disconnectAll(),this.m_tracks=new Array,this.m_tracks[0]=this.createTrack(),this.m_tracks[1]=this.createTrack(),this.m_warning="",this.m_trackNo=L.MTrack.FIRST_TRACK,this.m_octave=4,this.m_relativeDir=!0,this.m_velocity=100,this.m_velDetail=!0,this.m_velDir=!0,this.m_length=this.len2tick(4),this.m_tempo=L.MTrack.DEFAULT_BPM,this.m_keyoff=1,this.m_gate=15,this.m_maxGate=16,this.m_form=L.MOscillator.PULSE,this.m_noteShift=0,this.m_maxPipe=0,this.m_maxSyncSource=0,this.m_beforeNote=0,this.m_portamento=0,this.m_usingPoly=!1,this.m_polyVoice=1,this.m_polyForce=!1,this.m_metaTitle="",this.m_metaArtist="",this.m_metaCoding="",this.m_metaComment="",this.processComment(t),this.processMacro(),this.m_string=F.removeWhitespace(this.m_string),this.processRepeat(),this.processGroupNotes(),this.process(),0===this.m_tracks[this.m_tracks.length-1].getNumEvents()&&this.m_tracks.pop(),this.m_tracks[L.MTrack.TEMPO_TRACK].conduct(this.m_tracks);for(var e=L.MTrack.TEMPO_TRACK;e<this.m_tracks.length;e++)e>L.MTrack.TEMPO_TRACK&&(this.m_usingPoly&&(this.m_polyForce||this.m_tracks[e].findPoly())&&this.m_tracks[e].usingPoly(this.m_polyVoice),this.m_tracks[e].recRestMSec(2e3),this.m_tracks[e].recClose()),this.m_sequencer.connect(this.m_tracks[e]);this.m_sequencer.createPipes(this.m_maxPipe+1),this.m_sequencer.createSyncSources(this.m_maxSyncSource+1),msgr.compileComplete(),this.m_sequencer.play(),msgr.onstopsound=null},F.prototype.stop=function(){this.m_sequencer.stop()},F.prototype.pause=function(){this.m_sequencer.pause()},F.prototype.resume=function(){this.m_sequencer.play()},F.prototype.isPlaying=function(){return this.m_sequencer.isPlaying()},F.prototype.isPaused=function(){return this.m_sequencer.isPaused()},F.prototype.getTotalMSec=function(){return this.m_tracks[L.MTrack.TEMPO_TRACK].getTotalMSec()},F.prototype.getTotalTimeStr=function(){return this.m_tracks[L.MTrack.TEMPO_TRACK].getTotalTimeStr()},F.prototype.getNowMSec=function(){return this.m_sequencer.getNowMSec()},F.prototype.getNowTimeStr=function(){return this.m_sequencer.getNowTimeStr()},F.prototype.getVoiceCount=function(){var t,e=0;for(t=0;t<this.m_tracks.length;t++)e+=this.m_tracks[t].getVoiceCount();return e},F.prototype.getMetaTitle=function(){return this.m_metaTitle},F.prototype.getMetaComment=function(){return this.m_metaComment},F.prototype.getMetaArtist=function(){return this.m_metaArtist},F.prototype.getMetaCoding=function(){return this.m_metaCoding},F.MAX_PIPE=3,F.MAX_SYNCSOURCE=3,F.MAX_POLYVOICE=64,F}();L.MML=t}(flmml||(flmml={})),function(c){var t=function(){function m(){this.bufferSize=Math.round(msgr.audioBufferSize*m.SAMPLE_RATE/msgr.audioSampleRate),msgr.emptyBuffer=this.emptyBuffer=new Float32Array(this.bufferSize*m.MULTIPLE);var t=this.bufferSize*m.MULTIPLE;c.MChannel.boot(t),c.MOscillator.boot(),c.MEnvelope.boot(),this.m_trackArr=new Array,this.m_playSide=1,this.m_playSize=0,this.m_step=0,this.m_buffer=[[new Float32Array(t),new Float32Array(t)],[new Float32Array(t),new Float32Array(t)]],this.m_maxProcTime=this.bufferSize/m.SAMPLE_RATE*1e3*.8,this.processAllBinded=this.processAll.bind(this),msgr.onrequestbuffer=this.onSampleData.bind(this),this.stop()}return m.getTimer=function(){return self.performance?self.performance.now():(new Date).getTime()},m.prototype.play=function(){if(1===this.m_status){this.bufferSize;this.m_status=3,msgr.playSound(),this.startProcTimer()}else{this.m_globalSample=0,this.m_totalMSec=this.getTotalMSec();for(var t=0;t<this.m_trackArr.length;t++)this.m_trackArr[t].seekTop();this.lastSample=[0,0],this.m_status=2,this.processStart()}this.m_lastTime=0,this.m_waitPause=!1,0<msgr.infoInterval&&(clearInterval(msgr.tIDInfo),msgr.tIDInfo=setInterval(msgr.onInfoTimerBinded,msgr.infoInterval))},m.prototype.stop=function(){clearTimeout(this.m_procTimer),msgr.stopSound(!0),this.m_status=0,this.m_lastTime=0,this.m_maxNowMSec=0,this.m_waitPause=!1},m.prototype.pause=function(){switch(this.m_status){case 2:this.m_waitPause=!0;break;case 3:msgr.stopSound(),this.m_status=1,this.m_waitPause&&(msgr.syncInfo(),this.m_waitPause=!1)}},m.prototype.disconnectAll=function(){for(;this.m_trackArr.pop(););this.m_status=0},m.prototype.connect=function(t){this.m_trackArr.push(t)},m.prototype.reqBuffering=function(){this.m_buffTimer||(this.m_buffTimer=setTimeout(this.onBufferingReq.bind(this),0))},m.prototype.onBufferingReq=function(){this.m_status=2,this.startProcTimer(),this.m_buffTimer=0},m.prototype.startProcTimer=function(t){void 0===t&&(t=0),clearTimeout(this.m_procTimer),0!==this.m_status&&(this.m_procTimer=setTimeout(this.processAllBinded,t))},m.prototype.processStart=function(){this.m_step=1,this.startProcTimer()},m.prototype.processAll=function(){var t=this.m_buffer[1-this.m_playSide],e=this.bufferSize,s=e*m.MULTIPLE,i=2*e,h=this.m_trackArr.length,o=msgr;switch(this.m_step){case 1:if((t=this.m_buffer[1-this.m_playSide])[0].set(this.emptyBuffer),t[1].set(this.emptyBuffer),0<h)this.m_trackArr[c.MTrack.TEMPO_TRACK].onSampleData(null,0,e*m.MULTIPLE,!0);this.m_processTrack=c.MTrack.FIRST_TRACK,this.m_processOffset=0,this.m_step++,this.startProcTimer();break;case 2:var _=this.m_status,r=this.m_lastTime?this.m_maxProcTime+this.m_lastTime:0,n=o.infoInterval,a=o.lastInfoTime+n;do{if(this.m_trackArr[this.m_processTrack].onSampleData(t,this.m_processOffset,this.m_processOffset+i),this.m_processOffset+=i,this.m_processOffset>=s&&(this.m_processTrack++,this.m_processOffset=0),2===_&&o.buffering((this.m_processTrack*s+this.m_processOffset)/(h*s)*100|0),this.m_processTrack>=h){this.m_step++;break}0<n&&m.getTimer()>a&&(o.syncInfo(),a=o.lastInfoTime+n)}while(_<3||m.getTimer()<r);0<n&&(o.syncInfo(),clearInterval(o.tIDInfo),o.tIDInfo=setInterval(o.onInfoTimerBinded,o.infoInterval)),this.startProcTimer();break;case 3:this.m_step=4,2===this.m_status&&(this.m_status=3,this.m_playSide=1-this.m_playSide,this.m_playSize=0,this.m_waitPause?(this.pause(),this.m_step=1):(o.playSound(),this.processStart()))}},m.prototype.onSampleData=function(t){var s=this;if(this.m_lastTime=m.getTimer(),!(this.m_status<3)){if(this.m_globalSample/m.SAMPLE_RATE*1e3>=this.m_totalMSec)return this.stop(),void msgr.complete();if(this.m_playSize>=m.MULTIPLE){if(4!==this.m_step)return void this.reqBuffering();if(this.m_playSide=1-this.m_playSide,this.m_playSize=0,this.processStart(),4===this.m_status)return;3===this.m_status&&this.m_trackArr[c.MTrack.TEMPO_TRACK].isEnd()&&(this.m_status=4)}var i=this.bufferSize,h=msgr.audioBufferSize,o=h/i,_=t.retBuf||[new Float32Array(h),new Float32Array(h)],r=i*this.m_playSize;[0,1].forEach(function(t){var e=s.m_buffer[s.m_playSide][t].subarray(r,r+i);i===h?_[t].set(e):(s.convertRate(e,_[t],o,s.lastSample[t]),s.lastSample[t]=e[e.length-1])}),msgr.sendBuffer(_),this.m_playSize++,this.m_globalSample+=i}},m.prototype.convertRate=function(t,e,s,i){var h=(e.length-1)/s%1;i=null==i?0:i;for(var o=0;o<e.length;o++){var _=o/s-h,r=Math.floor(_),n=Math.ceil(_),a=r<0?i:t[r],m=t[n];e[o]=r===n?a:a+(m-a)*(_-r)}},m.prototype.createPipes=function(t){c.MChannel.createPipes(t)},m.prototype.createSyncSources=function(t){c.MChannel.createSyncSources(t)},m.prototype.isPlaying=function(){return 1<this.m_status},m.prototype.isPaused=function(){return 1===this.m_status},m.prototype.getTotalMSec=function(){return this.m_trackArr[c.MTrack.TEMPO_TRACK]?this.m_trackArr[c.MTrack.TEMPO_TRACK].getTotalMSec():0},m.prototype.getNowMSec=function(){if(0===this.m_status)return 0;var t=this.m_globalSample/m.SAMPLE_RATE*1e3,e=this.m_lastTime?m.getTimer()-this.m_lastTime:0,s=this.bufferSize/m.SAMPLE_RATE*1e3;return this.m_maxNowMSec=Math.max(this.m_maxNowMSec,t+Math.min(e,s)),this.m_maxNowMSec},m.prototype.getNowTimeStr=function(){var t=this.getNowMSec()/1e3,e="0"+(t/60|0),s="0"+(t%60|0);return e.substr(e.length-2,2)+":"+s.substr(s.length-2,2)},m.SAMPLE_RATE=44100,m.MULTIPLE=32,m}();c.MSequencer=t}(flmml||(flmml={})),function(s){var t=function(){function e(){this.resetPhase(),this.setFrequency(440)}return e.prototype.resetPhase=function(){this.m_phase=0},e.prototype.addPhase=function(t){this.m_phase=this.m_phase+this.m_freqShift*t&e.PHASE_MSK},e.prototype.getNextSample=function(){return 0},e.prototype.getNextSampleOfs=function(t){return 0},e.prototype.getSamples=function(t,e,s){},e.prototype.getSamplesWithSyncIn=function(t,e,s,i){this.getSamples(t,s,i)},e.prototype.getSamplesWithSyncOut=function(t,e,s,i){this.getSamples(t,s,i)},e.prototype.getFrequency=function(){return this.m_frequency},e.prototype.setFrequency=function(t){this.m_frequency=t,this.m_freqShift=t*(e.PHASE_LEN/s.MSequencer.SAMPLE_RATE)|0},e.prototype.setWaveNo=function(t){},e.prototype.setNoteNo=function(t){},e.PHASE_LEN=(e.TABLE_LEN=65536)<<(e.PHASE_SFT=14),e.PHASE_HLF=e.TABLE_LEN<<e.PHASE_SFT-1,e.PHASE_MSK=e.PHASE_LEN-1,e}();s.MOscMod=t}(flmml||(flmml={})),function(t){var e=function(e){function o(){var t=e.call(this)||this;return t.m_readCount=0,t.m_address=0,t.m_bit=0,t.m_wav=0,t.m_length=0,t.m_ofs=0,o.boot(),t.setWaveNo(0),t}return __extends(o,e),o.boot=function(){this.s_init||(this.s_table=new Array(this.MAX_WAVE),this.s_intVol=new Array(this.MAX_WAVE),this.s_loopFg=new Array(this.MAX_WAVE),this.s_length=new Array(this.MAX_WAVE),this.setWave(0,127,0,""),this.s_init=1)},o.setWave=function(t,e,s,i){this.s_intVol[t]=e,this.s_loopFg[t]=s,this.s_length[t]=0,this.s_table[t]=new Array(this.FC_DPCM_TABLE_MAX_LEN);for(var h=0,o=0,_=0,r=0,n=0;n<this.FC_DPCM_TABLE_MAX_LEN;n++)this.s_table[t][n]=0;for(h=0;h<i.length;h++){var a=i.charCodeAt(h);for(65<=a&&a<=90?a-=65:97<=a&&a<=122?a-=71:48<=a&&a<=57?a-=-4:a=43===a?62:47===a?63:0,n=5;0<=n;n--)this.s_table[t][r]+=(a>>n&1)<<8*o+7-_,8<=++_&&(_=0,o++),this.s_length[t]++,4<=o&&(o=0,++r>=this.FC_DPCM_TABLE_MAX_LEN&&(r=this.FC_DPCM_TABLE_MAX_LEN-1))}this.s_length[t]-=(this.s_length[t]-8)%128,this.s_length[t]>8*this.FC_DPCM_MAX_LEN&&(this.s_length[t]=8*this.FC_DPCM_MAX_LEN),0===this.s_length[t]&&(this.s_length[t]=8)},o.prototype.setWaveNo=function(t){o.MAX_WAVE<=t&&(t=o.MAX_WAVE-1),o.s_table[t]||(t=0),this.m_waveNo=t},o.prototype.getValue=function(){return 0<this.m_length&&(o.s_table[this.m_waveNo][this.m_address]>>this.m_bit&1?this.m_wav<126&&(this.m_wav+=2):1<this.m_wav&&(this.m_wav-=2),this.m_bit++,32<=this.m_bit&&(this.m_bit=0,this.m_address++),this.m_length--,0===this.m_length&&o.s_loopFg[this.m_waveNo]&&(this.m_address=0,this.m_bit=0,this.m_length=o.s_length[this.m_waveNo])),(this.m_wav-64)/64},o.prototype.resetPhase=function(){this.m_phase=0,this.m_address=0,this.m_bit=0,this.m_ofs=0,this.m_wav=o.s_intVol[this.m_waveNo],this.m_length=o.s_length[this.m_waveNo]},o.prototype.getNextSample=function(){var t=(this.m_wav-64)/64;for(this.m_phase=this.m_phase+this.m_freqShift&o.PHASE_MSK;o.FC_DPCM_NEXT<=this.m_phase;)this.m_phase-=o.FC_DPCM_NEXT,t=(0<this.m_length&&(o.s_table[this.m_waveNo][this.m_address]>>this.m_bit&1?this.m_wav<126&&(this.m_wav+=2):1<this.m_wav&&(this.m_wav-=2),this.m_bit++,32<=this.m_bit&&(this.m_bit=0,this.m_address++),this.m_length--,0===this.m_length&&o.s_loopFg[this.m_waveNo]&&(this.m_address=0,this.m_bit=0,this.m_length=o.s_length[this.m_waveNo])),(this.m_wav-64)/64);return t},o.prototype.getNextSampleOfs=function(t){var e=(this.m_wav-64)/64;for(this.m_phase=this.m_phase+this.m_freqShift+(t-this.m_ofs>>o.PHASE_SFT-7)&o.PHASE_MSK;o.FC_DPCM_NEXT<=this.m_phase;)this.m_phase-=o.FC_DPCM_NEXT,e=(0<this.m_length&&(o.s_table[this.m_waveNo][this.m_address]>>this.m_bit&1?this.m_wav<126&&(this.m_wav+=2):1<this.m_wav&&(this.m_wav-=2),this.m_bit++,32<=this.m_bit&&(this.m_bit=0,this.m_address++),this.m_length--,0===this.m_length&&o.s_loopFg[this.m_waveNo]&&(this.m_address=0,this.m_bit=0,this.m_length=o.s_length[this.m_waveNo])),(this.m_wav-64)/64);return this.m_ofs=t,e},o.prototype.getSamples=function(t,e,s){var i,h=(this.m_wav-64)/64;for(i=e;i<s;i++){for(this.m_phase=this.m_phase+this.m_freqShift&o.PHASE_MSK;o.FC_DPCM_NEXT<=this.m_phase;)this.m_phase-=o.FC_DPCM_NEXT,h=(0<this.m_length&&(o.s_table[this.m_waveNo][this.m_address]>>this.m_bit&1?this.m_wav<126&&(this.m_wav+=2):1<this.m_wav&&(this.m_wav-=2),this.m_bit++,32<=this.m_bit&&(this.m_bit=0,this.m_address++),this.m_length--,0===this.m_length&&o.s_loopFg[this.m_waveNo]&&(this.m_address=0,this.m_bit=0,this.m_length=o.s_length[this.m_waveNo])),(this.m_wav-64)/64);t[i]=h}},o.prototype.setFrequency=function(t){this.m_freqShift=t*(1<<o.FC_DPCM_PHASE_SFT+4)|0},o.prototype.setDpcmFreq=function(t){t<0&&(t=0),15<t&&(t=15),this.m_freqShift=(o.FC_CPU_CYCLE<<o.FC_DPCM_PHASE_SFT)/o.s_interval[t]|0},o.prototype.setNoteNo=function(t){this.setDpcmFreq(t)},o.MAX_WAVE=16,o.FC_CPU_CYCLE=1789773,o.FC_DPCM_PHASE_SFT=2,o.FC_DPCM_TABLE_MAX_LEN=2+((o.FC_DPCM_MAX_LEN=4081)>>2),o.FC_DPCM_NEXT=t.MSequencer.SAMPLE_RATE<<o.FC_DPCM_PHASE_SFT,o.s_interval=[428,380,340,320,286,254,226,214,190,160,142,128,106,85,72,54],o}(t.MOscMod);t.MOscFcDpcm=e}(flmml||(flmml={})),function(t){var e=function(e){function r(){var t=this;return r.boot(),(t=e.call(this)||this).setLongMode(),t.m_fcr=32768,t.m_val=t.getValue(),t.setNoiseFreq(0),t}return __extends(r,e),r.prototype.getValue=function(){return this.m_fcr>>=1,this.m_fcr|=(1&(this.m_fcr^this.m_fcr>>this.m_snz))<<15,1&this.m_fcr?1:-1},r.prototype.setShortMode=function(){this.m_snz=6},r.prototype.setLongMode=function(){this.m_snz=1},r.prototype.resetPhase=function(){},r.prototype.addPhase=function(t){for(this.m_phase=this.m_phase+r.FC_NOISE_PHASE_DLT*t|0;this.m_phase>=this.m_freqShift;)this.m_phase-=this.m_freqShift,this.m_val=this.getValue()},r.boot=function(){},r.prototype.getNextSample=function(){for(var t=this.m_val,e=0,s=0,i=r.FC_NOISE_PHASE_DLT;i>=this.m_freqShift;)i-=this.m_freqShift,this.m_phase=0,e+=this.getValue(),s+=1;return 0<s&&(this.m_val=e/s),this.m_phase=this.m_phase+i|0,this.m_phase>=this.m_freqShift&&(this.m_phase-=this.m_freqShift,this.m_val=this.getValue()),t},r.prototype.getNextSampleOfs=function(t){for(var e=this.m_fcr,s=this.m_phase,i=this.m_val,h=0,o=0,_=r.FC_NOISE_PHASE_DLT+t;_>=this.m_freqShift;)_-=this.m_freqShift,this.m_phase=0,h+=this.getValue(),o+=1;return 0<o&&(this.m_val=h/o),this.m_phase=this.m_phase+_|0,this.m_phase>=this.m_freqShift&&(this.m_phase=this.m_freqShift,this.m_val=this.getValue()),this.m_fcr=e,this.m_phase=s,this.getNextSample(),i},r.prototype.getSamples=function(t,e,s){for(var i=e;i<s;i++)t[i]=this.getNextSample()},r.prototype.setFrequency=function(t){this.m_freqShift=r.FC_NOISE_PHASE_SEC/t|0},r.prototype.setNoiseFreq=function(t){t<0&&(t=0),15<t&&(t=15),this.m_freqShift=r.s_interval[t]<<r.FC_NOISE_PHASE_SFT|0},r.prototype.setNoteNo=function(t){this.setNoiseFreq(t)},r.FC_NOISE_PHASE_DLT=(r.FC_NOISE_PHASE_SEC=1789773<<(r.FC_NOISE_PHASE_SFT=10)|0)/t.MSequencer.SAMPLE_RATE|0,r.s_interval=[4,8,16,32,64,96,128,160,202,254,380,508,762,1016,2034,4068],r}(t.MOscMod);t.MOscFcNoise=e}(flmml||(flmml={})),function(t){var e=function(e){function o(){var t=this;return o.boot(),(t=e.call(this)||this).setWaveNo(0),t}return __extends(o,e),o.boot=function(){if(!this.s_init){var t;for(this.s_table=new Array(this.MAX_WAVE),this.s_table[0]=new Array(this.FC_TRI_TABLE_LEN),this.s_table[1]=new Array(this.FC_TRI_TABLE_LEN),t=0;t<16;t++)this.s_table[0][t]=this.s_table[0][31-t]=2*t/15-1;for(t=0;t<32;t++)this.s_table[1][t]=t<8?2*t/14:t<24?2*(8-t)/15+1:2*(t-24)/15-1;this.s_init=1}},o.prototype.getNextSample=function(){var t=o.s_table[this.m_waveNo][this.m_phase>>o.PHASE_SFT+11];return this.m_phase=this.m_phase+this.m_freqShift&o.PHASE_MSK,t},o.prototype.getNextSampleOfs=function(t){var e=o.s_table[this.m_waveNo][(this.m_phase+t&o.PHASE_MSK)>>o.PHASE_SFT+11];return this.m_phase=this.m_phase+this.m_freqShift&o.PHASE_MSK,e},o.prototype.getSamples=function(t,e,s){var i;for(i=e;i<s;i++)t[i]=o.s_table[this.m_waveNo][this.m_phase>>o.PHASE_SFT+11],this.m_phase=this.m_phase+this.m_freqShift&o.PHASE_MSK},o.prototype.getSamplesWithSyncIn=function(t,e,s,i){var h;for(h=s;h<i;h++)e[h]&&this.resetPhase(),t[h]=o.s_table[this.m_waveNo][this.m_phase>>o.PHASE_SFT+11],this.m_phase=this.m_phase+this.m_freqShift&o.PHASE_MSK},o.prototype.getSamplesWithSyncOut=function(t,e,s,i){var h;for(h=s;h<i;h++)t[h]=o.s_table[this.m_waveNo][this.m_phase>>o.PHASE_SFT+11],this.m_phase+=this.m_freqShift,e[h]=this.m_phase>o.PHASE_MSK,this.m_phase&=o.PHASE_MSK},o.prototype.setWaveNo=function(t){this.m_waveNo=Math.min(t,o.MAX_WAVE-1)},o.FC_TRI_TABLE_LEN=32,o.MAX_WAVE=2,o.s_init=0,o}(t.MOscMod);t.MOscFcTri=e}(flmml||(flmml={})),function(t){var e=function(e){function _(){var t=this;return _.boot(),(t=e.call(this)||this).m_sum=0,t.m_skip=0,t}return __extends(_,e),_.boot=function(){if(!this.s_init){for(var t=65535,e=1,s=0;s<this.GB_NOISE_TABLE_LEN;s++)0===t&&(t=1),e^=1&(t+=t+(1&(t>>14^t>>13))|0),this.s_table[s]=2*e-1;this.s_init=1}},_.prototype.getNextSample=function(){var t=_.s_table[this.m_phase>>_.GB_NOISE_PHASE_SFT];0<this.m_skip&&(t=(t+this.m_sum)/(this.m_skip+1)),this.m_sum=0,this.m_skip=0;for(var e=this.m_freqShift;_.GB_NOISE_PHASE_DLT<e;)this.m_phase=(this.m_phase+_.GB_NOISE_PHASE_DLT)%_.GB_NOISE_TABLE_MOD,e-=_.GB_NOISE_PHASE_DLT,this.m_sum+=_.s_table[this.m_phase>>_.GB_NOISE_PHASE_SFT],this.m_skip++;return this.m_phase=(this.m_phase+e)%_.GB_NOISE_TABLE_MOD,t},_.prototype.getNextSampleOfs=function(t){var e=(this.m_phase+t)%_.GB_NOISE_TABLE_MOD,s=_.s_table[e+(e>>31&_.GB_NOISE_TABLE_MOD)>>_.GB_NOISE_PHASE_SFT];return this.m_phase=(this.m_phase+this.m_freqShift)%_.GB_NOISE_TABLE_MOD,s},_.prototype.getSamples=function(t,e,s){var i,h;for(i=e;i<s;i++){h=_.s_table[this.m_phase>>_.GB_NOISE_PHASE_SFT],0<this.m_skip&&(h=(h+this.m_sum)/(this.m_skip+1)),t[i]=h,this.m_sum=0,this.m_skip=0;for(var o=this.m_freqShift;_.GB_NOISE_PHASE_DLT<o;)this.m_phase=(this.m_phase+_.GB_NOISE_PHASE_DLT)%_.GB_NOISE_TABLE_MOD,o-=_.GB_NOISE_PHASE_DLT,this.m_sum+=_.s_table[this.m_phase>>_.GB_NOISE_PHASE_SFT],this.m_skip++;this.m_phase=(this.m_phase+o)%_.GB_NOISE_TABLE_MOD}},_.prototype.setFrequency=function(t){this.m_frequency=t},_.prototype.setNoiseFreq=function(t){t<0&&(t=0),63<t&&(t=63),this.m_freqShift=(1048576<<_.GB_NOISE_PHASE_SFT-2)/(11025*_.s_interval[t])|0},_.prototype.setNoteNo=function(t){this.setNoiseFreq(t)},_.GB_NOISE_PHASE_DLT=1<<(_.GB_NOISE_PHASE_SFT=12),_.GB_NOISE_TABLE_MOD=((_.GB_NOISE_TABLE_LEN=32767)<<_.GB_NOISE_PHASE_SFT)-1,_.s_init=0,_.s_table=new Array(_.GB_NOISE_TABLE_LEN),_.s_interval=[2,4,8,12,16,20,24,28,32,40,48,56,64,80,96,112,128,160,192,224,256,320,384,448,512,640,768,896,1024,1280,1536,1792,2048,2560,3072,3584,4096,5120,6144,7168,8192,10240,12288,14336,16384,20480,24576,28672,32768,40960,49152,57344,65536,81920,98304,114688,131072,163840,196608,229376,262144,327680,393216,458752],_}(t.MOscMod);t.MOscGbLNoise=e}(flmml||(flmml={})),function(t){var e=function(e){function _(){var t=this;return _.boot(),(t=e.call(this)||this).m_sum=0,t.m_skip=0,t}return __extends(_,e),_.boot=function(){if(!this.s_init){for(var t=65535,e=1,s=0;s<this.GB_NOISE_TABLE_LEN;s++)0===t&&(t=1),e^=1&(t+=t+(1&(t>>6^t>>5))|0),this.s_table[s]=2*e-1;this.s_init=1}},_.prototype.getNextSample=function(){var t=_.s_table[this.m_phase>>_.GB_NOISE_PHASE_SFT];0<this.m_skip&&(t=(t+this.m_sum)/Number(this.m_skip+1)),this.m_sum=0,this.m_skip=0;for(var e=this.m_freqShift;_.GB_NOISE_PHASE_DLT<e;)this.m_phase=(this.m_phase+_.GB_NOISE_PHASE_DLT)%_.GB_NOISE_TABLE_MOD,e-=_.GB_NOISE_PHASE_DLT,this.m_sum+=_.s_table[this.m_phase>>_.GB_NOISE_PHASE_SFT],this.m_skip++;return this.m_phase=(this.m_phase+e)%_.GB_NOISE_TABLE_MOD,t},_.prototype.getNextSampleOfs=function(t){var e=(this.m_phase+t)%_.GB_NOISE_TABLE_MOD,s=_.s_table[e+(e>>31&_.GB_NOISE_TABLE_MOD)>>_.GB_NOISE_PHASE_SFT];return this.m_phase=(this.m_phase+this.m_freqShift)%_.GB_NOISE_TABLE_MOD,s},_.prototype.getSamples=function(t,e,s){var i,h;for(i=e;i<s;i++){h=_.s_table[this.m_phase>>_.GB_NOISE_PHASE_SFT],0<this.m_skip&&(h=(h+this.m_sum)/Number(this.m_skip+1)),t[i]=h,this.m_sum=0,this.m_skip=0;for(var o=this.m_freqShift;_.GB_NOISE_PHASE_DLT<o;)this.m_phase=(this.m_phase+_.GB_NOISE_PHASE_DLT)%_.GB_NOISE_TABLE_MOD,o-=_.GB_NOISE_PHASE_DLT,this.m_sum+=_.s_table[this.m_phase>>_.GB_NOISE_PHASE_SFT],this.m_skip++;this.m_phase=(this.m_phase+o)%_.GB_NOISE_TABLE_MOD}},_.prototype.setFrequency=function(t){this.m_frequency=t},_.prototype.setNoiseFreq=function(t){t<0&&(t=0),63<t&&(t=63),this.m_freqShift=(1048576<<_.GB_NOISE_PHASE_SFT-2)/(11025*_.s_interval[t])},_.prototype.setNoteNo=function(t){this.setNoiseFreq(t)},_.GB_NOISE_PHASE_DLT=1<<(_.GB_NOISE_PHASE_SFT=12),_.GB_NOISE_TABLE_MOD=((_.GB_NOISE_TABLE_LEN=127)<<_.GB_NOISE_PHASE_SFT)-1,_.s_init=0,_.s_table=new Array(_.GB_NOISE_TABLE_LEN),_.s_interval=[2,4,8,12,16,20,24,28,32,40,48,56,64,80,96,112,128,160,192,224,256,320,384,448,512,640,768,896,1024,1280,1536,1792,2048,2560,3072,3584,4096,5120,6144,7168,8192,10240,12288,14336,16384,20480,24576,28672,32768,40960,49152,57344,65536,81920,98304,114688,131072,163840,196608,229376,262144,327680,393216,458752],_}(t.MOscMod);t.MOscGbSNoise=e}(flmml||(flmml={})),function(t){var e=function(e){function o(){var t=this;return o.boot(),(t=e.call(this)||this).setWaveNo(0),t}return __extends(o,e),o.boot=function(){this.s_init||(this.s_table=new Array(this.MAX_WAVE),this.setWave(0,"0123456789abcdeffedcba9876543210"),this.s_init=1)},o.setWave=function(t,e){this.s_table[t]=new Array(this.GB_WAVE_TABLE_LEN);for(var s=0;s<32;s++){var i=e.charCodeAt(s);48<=i&&i<58?i-=48:97<=i&&i<103?i-=87:i=0,this.s_table[t][s]=(i-7.5)/7.5}},o.prototype.setWaveNo=function(t){o.MAX_WAVE<=t&&(t=o.MAX_WAVE-1),o.s_table[t]||(t=0),this.m_waveNo=t},o.prototype.getNextSample=function(){var t=o.s_table[this.m_waveNo][this.m_phase>>o.PHASE_SFT+11];return this.m_phase=this.m_phase+this.m_freqShift&o.PHASE_MSK,t},o.prototype.getNextSampleOfs=function(t){var e=o.s_table[this.m_waveNo][(this.m_phase+t&o.PHASE_MSK)>>o.PHASE_SFT+11];return this.m_phase=this.m_phase+this.m_freqShift&o.PHASE_MSK,e},o.prototype.getSamples=function(t,e,s){var i;for(i=e;i<s;i++)t[i]=o.s_table[this.m_waveNo][this.m_phase>>o.PHASE_SFT+11],this.m_phase=this.m_phase+this.m_freqShift&o.PHASE_MSK},o.prototype.getSamplesWithSyncIn=function(t,e,s,i){var h;for(h=s;h<i;h++)e[h]&&this.resetPhase(),t[h]=o.s_table[this.m_waveNo][this.m_phase>>o.PHASE_SFT+11],this.m_phase=this.m_phase+this.m_freqShift&o.PHASE_MSK},o.prototype.getSamplesWithSyncOut=function(t,e,s,i){var h;for(h=s;h<i;h++)t[h]=o.s_table[this.m_waveNo][this.m_phase>>o.PHASE_SFT+11],this.m_phase+=this.m_freqShift,e[h]=this.m_phase>o.PHASE_MSK,this.m_phase&=o.PHASE_MSK},o.MAX_WAVE=32,o.GB_WAVE_TABLE_LEN=32,o.s_init=0,o}(t.MOscMod);t.MOscGbWave=e}(flmml||(flmml={})),function(t){var e=function(e){function h(){var t=this;return h.boot(),(t=e.call(this)||this).setNoiseFreq(1),t.m_phase=0,t.m_counter=0,t.m_resetPhase=!0,t}return __extends(h,e),h.prototype.disableResetPhase=function(){this.m_resetPhase=!1},h.boot=function(){if(!this.s_init){for(var t=0;t<this.TABLE_LEN;t++)this.s_table[t]=2*Math.random()-1;this.s_init=1}},h.prototype.resetPhase=function(){this.m_resetPhase&&(this.m_phase=0)},h.prototype.addPhase=function(t){this.m_counter=this.m_counter+this.m_freqShift*t,this.m_phase=this.m_phase+(this.m_counter>>h.NOISE_PHASE_SFT)&h.TABLE_MSK,this.m_counter&=h.NOISE_PHASE_MSK},h.prototype.getNextSample=function(){var t=h.s_table[this.m_phase];return this.m_counter=this.m_counter+this.m_freqShift,this.m_phase=this.m_phase+(this.m_counter>>h.NOISE_PHASE_SFT)&h.TABLE_MSK,this.m_counter&=h.NOISE_PHASE_MSK,t},h.prototype.getNextSampleOfs=function(t){var e=h.s_table[this.m_phase+(t<<h.PHASE_SFT)&h.TABLE_MSK];return this.m_counter=this.m_counter+this.m_freqShift,this.m_phase=this.m_phase+(this.m_counter>>h.NOISE_PHASE_SFT)&h.TABLE_MSK,this.m_counter&=h.NOISE_PHASE_MSK,e},h.prototype.getSamples=function(t,e,s){var i;for(i=e;i<s;i++)t[i]=h.s_table[this.m_phase],this.m_counter=this.m_counter+this.m_freqShift,this.m_phase=this.m_phase+(this.m_counter>>h.NOISE_PHASE_SFT)&h.TABLE_MSK,this.m_counter&=h.NOISE_PHASE_MSK},h.prototype.setFrequency=function(t){this.m_frequency=t},h.prototype.setNoiseFreq=function(t){this.m_noiseFreq=t*(1<<h.NOISE_PHASE_SFT),this.m_freqShift=this.m_noiseFreq},h.prototype.restoreFreq=function(){this.m_freqShift=this.m_noiseFreq},h.TABLE_MSK=h.TABLE_LEN-1,h.NOISE_PHASE_MSK=(1<<(h.NOISE_PHASE_SFT=30))-1,h.s_init=0,h.s_table=new Array(h.TABLE_LEN),h}(t.MOscMod);t.MOscNoise=e}(flmml||(flmml={})),function(t){var e=function(){function t(){this.regta=new Array(2)}return t.prototype.Reset=function(){this.timera_count=0,this.timerb_count=0},t.prototype.Count=function(t){var e=!1;if(0!==this.timera_count&&(this.timera_count-=t<<16,this.timera_count<=0)){for(e=!0,this.TimerA();this.timera_count<=0;)this.timera_count+=this.timera;4&this.regtc&&this.SetStatus(1)}if(0!==this.timerb_count&&(this.timerb_count-=t<<12,this.timerb_count<=0)){for(e=!0;this.timerb_count<=0;)this.timerb_count+=this.timerb;8&this.regtc&&this.SetStatus(2)}return e},t.prototype.GetNextEvent=function(){var t=(this.timera_count+65535>>16)-1,e=(this.timerb_count+4095>>12)-1;return(t<e?t:e)+1},t.prototype.SetStatus=function(t){},t.prototype.ResetStatus=function(t){},t.prototype.SetTimerBase=function(t){this.timer_step=65536e6/t|0},t.prototype.SetTimerA=function(t,e){var s;this.regta[1&t]=0|e,s=(this.regta[0]<<2)+(3&this.regta[1]),this.timera=(1024-s)*this.timer_step},t.prototype.SetTimerB=function(t){this.timerb=(256-t)*this.timer_step},t.prototype.SetTimerControl=function(t){var e=this.regtc^t;this.regtc=0|t,16&t&&this.ResetStatus(1),32&t&&this.ResetStatus(2),1&e&&(this.timera_count=1&t?this.timera:0),2&e&&(this.timerb_count=2&t?this.timerb:0)},t.prototype.TimerA=function(){},t}();t.Timer=e}(fmgenAs||(fmgenAs={})),function(t){var e=function(){function t(){}return t.I2=function(t,e){for(var s=new Array(t),i=0;i<t;i++)s[i]=new Array(e);return s},t.I3=function(t,e,s){for(var i=new Array(t),h=0;h<t;h++){i[h]=new Array(e);for(var o=0;o<e;o++)i[h][o]=new Array(s)}return i},t}();t.JaggArray=e}(fmgenAs||(fmgenAs={})),function(n){var t=function(){function r(){this.chip_=null,this.ar_=this.dr_=this.sr_=this.rr_=this.key_scale_rate_=0,this.ams_=r.amtable[0][0],this.mute_=!1,this.keyon_=!1,this.tl_out_=0,this.ssg_type_=0,this.multiple_=0,this.detune_=0,this.detune2_=0,this.ms_=0}return r.prototype.SetChip=function(t){this.chip_=t},r.prototype.Reset=function(){this.tl_=this.tl_latch_=127,this.ShiftPhase(n.EGPhase.off),this.eg_count_=0,this.eg_curve_count_=0,this.ssg_phase_=0,this.pg_count_=0,this.out_=this.out2_=0,this.param_changed_=!0},r.prototype.SetDPBN=function(t,e){this.dp_=t,this.bn_=e,this.param_changed_=!0},r.prototype.Prepare=function(){if(!1!==this.param_changed_){switch(this.param_changed_=!1,this.pg_diff_=(this.dp_+r.dttable[this.detune_+this.bn_])*this.chip_.GetMulValue(this.detune2_,this.multiple_),this.pg_diff_lfo_=this.pg_diff_>>11,this.key_scale_rate_=this.bn_>>3-this.ks_,this.tl_out_=this.mute_?1023:8*this.tl_,this.eg_phase_){case n.EGPhase.attack:this.SetEGRate(0!==this.ar_?Math.min(63,this.ar_+this.key_scale_rate_):0);break;case n.EGPhase.decay:this.SetEGRate(0!==this.dr_?Math.min(63,this.dr_+this.key_scale_rate_):0),this.eg_level_on_next_phase_=8*this.sl_;break;case n.EGPhase.sustain:this.SetEGRate(0!==this.sr_?Math.min(63,this.sr_+this.key_scale_rate_):0);break;case n.EGPhase.release:this.SetEGRate(Math.min(63,this.rr_+this.key_scale_rate_))}if(0!==this.ssg_type_&&this.eg_phase_!==n.EGPhase.release){var t=this.ar_>=(8===this.ssg_type_||12===this.ssg_type_?56:60)?1:0;this.ssg_offset_=512*r.ssgenvtable[7&this.ssg_type_][t][this.ssg_phase_][0],this.ssg_vector_=r.ssgenvtable[7&this.ssg_type_][t][this.ssg_phase_][1]}this.ams_=r.amtable[0|this.type_][this.amon_?this.ms_>>4&3:0],this.EGUpdate()}},r.prototype.ShiftPhase=function(t){switch(t){case n.EGPhase.attack:if(this.tl_=this.tl_latch_,0!==this.ssg_type_){this.ssg_phase_=this.ssg_phase_+1,2<this.ssg_phase_&&(this.ssg_phase_=1);var e=this.ar_>=(8===this.ssg_type_||12===this.ssg_type_?56:60)?1:0;this.ssg_offset_=512*r.ssgenvtable[7&this.ssg_type_][e][this.ssg_phase_][0],this.ssg_vector_=r.ssgenvtable[7&this.ssg_type_][e][this.ssg_phase_][1]}if(this.ar_+this.key_scale_rate_<62){this.SetEGRate(0!==this.ar_?Math.min(63,this.ar_+this.key_scale_rate_):0),this.eg_phase_=n.EGPhase.attack;break}case n.EGPhase.decay:if(0!==this.sl_){this.eg_level_=0,this.eg_level_on_next_phase_=0!==this.ssg_type_?Math.min(8*this.sl_,512):8*this.sl_,this.SetEGRate(0!==this.dr_?Math.min(63,this.dr_+this.key_scale_rate_):0),this.eg_phase_=n.EGPhase.decay;break}case n.EGPhase.sustain:this.eg_level_=8*this.sl_,this.eg_level_on_next_phase_=0!==this.ssg_type_?512:1024,this.SetEGRate(0!==this.sr_?Math.min(63,this.sr_+this.key_scale_rate_):0),this.eg_phase_=n.EGPhase.sustain;break;case n.EGPhase.release:if(0!==this.ssg_type_&&(this.eg_level_=this.eg_level_*this.ssg_vector_+this.ssg_offset_,this.ssg_vector_=1,this.ssg_offset_=0),this.eg_phase_===n.EGPhase.attack||this.eg_level_<955){this.eg_level_on_next_phase_=1024,this.SetEGRate(Math.min(63,this.rr_+this.key_scale_rate_)),this.eg_phase_=n.EGPhase.release;break}case n.EGPhase.off:default:this.eg_level_=955,this.eg_level_on_next_phase_=955,this.EGUpdate(),this.SetEGRate(0),this.eg_phase_=n.EGPhase.off}},r.prototype.SetFNum=function(t){this.dp_=(2047&t)<<(t>>11&7),this.bn_=r.notetable[t>>7&127],this.param_changed_=!0},r.prototype.SINE=function(t){return r.sinetable[1023&t]},r.prototype.LogToLin=function(t){return t<8192?r.cltable[t]:0},r.prototype.EGUpdate=function(){var t=0===this.ssg_type_?this.tl_out_+this.eg_level_:this.tl_out_+this.eg_level_*this.ssg_vector_+this.ssg_offset_;this.eg_out_=t<1023?t<<3:8184},r.prototype.SetEGRate=function(t){this.eg_rate_=t,this.eg_count_diff_=r.decaytable2[t/4|0]*this.chip_.GetRatio()},r.prototype.EGCalc=function(){if(this.eg_count_=786048,this.eg_phase_===n.EGPhase.attack){var t=r.attacktable[this.eg_rate_][7&this.eg_curve_count_];0<=t&&(this.eg_level_-=1+(this.eg_level_>>t),this.eg_level_<=0&&this.ShiftPhase(n.EGPhase.decay)),this.EGUpdate()}else if(0===this.ssg_type_)this.eg_level_+=r.decaytable1[this.eg_rate_][7&this.eg_curve_count_],this.eg_level_>=this.eg_level_on_next_phase_&&this.ShiftPhase(this.eg_phase_+1),this.EGUpdate();else if(this.eg_level_+=4*r.decaytable1[this.eg_rate_][7&this.eg_curve_count_],this.eg_level_>=this.eg_level_on_next_phase_)switch(this.EGUpdate(),this.eg_phase_){case n.EGPhase.decay:this.ShiftPhase(n.EGPhase.sustain);break;case n.EGPhase.sustain:this.ShiftPhase(n.EGPhase.attack);break;case n.EGPhase.release:this.ShiftPhase(n.EGPhase.off)}this.eg_curve_count_++},r.prototype.EGStep=function(){this.eg_count_-=this.eg_count_diff_,this.eg_count_<=0&&this.EGCalc()},r.prototype.PGCalc=function(){var t=this.pg_count_;return this.pg_count_+=this.pg_diff_,t},r.prototype.PGCalcL=function(){var t=this.pg_count_;return this.pg_count_+=this.pg_diff_+(this.pg_diff_lfo_*this.chip_.GetPMV()>>5),t},r.prototype.Calc=function(t){if(this.eg_count_-=this.eg_count_diff_,this.eg_count_<=0){if(this.eg_count_=786048,this.eg_phase_===n.EGPhase.attack){var e=r.attacktable[this.eg_rate_][7&this.eg_curve_count_];0<=e&&(this.eg_level_-=1+(this.eg_level_>>e),this.eg_level_<=0&&this.ShiftPhase(n.EGPhase.decay))}else this.eg_level_+=r.decaytable1[this.eg_rate_][7&this.eg_curve_count_],this.eg_level_>=this.eg_level_on_next_phase_&&this.ShiftPhase(this.eg_phase_+1);var s=this.tl_out_+this.eg_level_;this.eg_out_=s<1023?s<<3:8184,this.eg_curve_count_++}this.out2_=this.out_;var i=this.pg_count_;this.pg_count_+=this.pg_diff_;var h=i>>19;h+=t>>19-(2+r.IS2EC_SHIFT);var o=this.eg_out_+r.sinetable[1023&h];return this.out_=o<8192?r.cltable[o]:0,this.out_},r.prototype.CalcL=function(t){if(this.eg_count_-=this.eg_count_diff_,this.eg_count_<=0){if(this.eg_count_=786048,this.eg_phase_===n.EGPhase.attack){var e=r.attacktable[this.eg_rate_][7&this.eg_curve_count_];0<=e&&(this.eg_level_-=1+(this.eg_level_>>e),this.eg_level_<=0&&this.ShiftPhase(n.EGPhase.decay))}else this.eg_level_+=r.decaytable1[this.eg_rate_][7&this.eg_curve_count_],this.eg_level_>=this.eg_level_on_next_phase_&&this.ShiftPhase(this.eg_phase_+1);var s=this.tl_out_+this.eg_level_;this.eg_out_=s<1023?s<<3:8184,this.eg_curve_count_++}var i=this.pg_count_;this.pg_count_+=this.pg_diff_+(this.pg_diff_lfo_*this.chip_.pmv_>>5);var h=i>>19;h+=t>>19-(2+r.IS2EC_SHIFT);var o=this.eg_out_+r.sinetable[1023&h]+this.ams_[this.chip_.aml_];return this.out_=o<8192?r.cltable[o]:0,this.out_},r.prototype.CalcN=function(t){this.EGStep();var e=Math.max(0,1023-(this.tl_out_+this.eg_level_))<<1;return t=(1&t)-1,this.out_=e+t^t,this.out_},r.prototype.CalcFB=function(t){if(this.eg_count_-=this.eg_count_diff_,this.eg_count_<=0){if(this.eg_count_=786048,this.eg_phase_===n.EGPhase.attack){var e=r.attacktable[this.eg_rate_][7&this.eg_curve_count_];0<=e&&(this.eg_level_-=1+(this.eg_level_>>e),this.eg_level_<=0&&this.ShiftPhase(n.EGPhase.decay))}else this.eg_level_+=r.decaytable1[this.eg_rate_][7&this.eg_curve_count_],this.eg_level_>=this.eg_level_on_next_phase_&&this.ShiftPhase(this.eg_phase_+1);var s=this.tl_out_+this.eg_level_;this.eg_out_=s<1023?s<<3:8184,this.eg_curve_count_++}var i=this.out_+this.out2_;this.out2_=this.out_;var h=this.pg_count_;this.pg_count_+=this.pg_diff_;var o=h>>19;t<31&&(o+=i<<1+r.IS2EC_SHIFT>>t>>19);var _=this.eg_out_+r.sinetable[1023&o];return this.out_=_<8192?r.cltable[_]:0,this.out2_},r.prototype.CalcFBL=function(t){if(this.eg_count_-=this.eg_count_diff_,this.eg_count_<=0){if(this.eg_count_=786048,this.eg_phase_===n.EGPhase.attack){var e=r.attacktable[this.eg_rate_][7&this.eg_curve_count_];0<=e&&(this.eg_level_-=1+(this.eg_level_>>e),this.eg_level_<=0&&this.ShiftPhase(n.EGPhase.decay))}else this.eg_level_+=r.decaytable1[this.eg_rate_][7&this.eg_curve_count_],this.eg_level_>=this.eg_level_on_next_phase_&&this.ShiftPhase(this.eg_phase_+1);var s=this.tl_out_+this.eg_level_;this.eg_out_=s<1023?s<<3:8184,this.eg_curve_count_++}var i=this.out_+this.out2_;this.out2_=this.out_;var h=this.pg_count_;this.pg_count_+=this.pg_diff_+(this.pg_diff_lfo_*this.chip_.pmv_>>5);var o=h>>19;t<31&&(o+=i<<1+r.IS2EC_SHIFT>>t>>19);var _=this.eg_out_+r.sinetable[1023&o]+this.ams_[this.chip_.aml_];return this.out_=_<8192?r.cltable[_]:0,this.out_},r.prototype.ResetFB=function(){this.out_=this.out2_=0},r.prototype.KeyOn=function(){this.keyon_||(this.keyon_=!0,this.eg_phase_!==n.EGPhase.off&&this.eg_phase_!==n.EGPhase.release||(this.ssg_phase_=-1,this.ShiftPhase(n.EGPhase.attack),this.EGUpdate(),this.in2_=this.out_=this.out2_=0,this.pg_count_=0))},r.prototype.KeyOff=function(){this.keyon_&&(this.keyon_=!1,this.ShiftPhase(n.EGPhase.release))},r.prototype.IsOn=function(){return this.eg_phase_!==n.EGPhase.off},r.prototype.SetDT=function(t){this.detune_=32*t,this.param_changed_=!0},r.prototype.SetDT2=function(t){this.detune2_=3&t,this.param_changed_=!0},r.prototype.SetMULTI=function(t){this.multiple_=t,this.param_changed_=!0},r.prototype.SetTL=function(t,e){e||(this.tl_=t,this.param_changed_=!0),this.tl_latch_=t},r.prototype.SetAR=function(t){this.ar_=t,this.param_changed_=!0},r.prototype.SetDR=function(t){this.dr_=t,this.param_changed_=!0},r.prototype.SetSR=function(t){this.sr_=t,this.param_changed_=!0},r.prototype.SetSL=function(t){this.sl_=t,this.param_changed_=!0},r.prototype.SetRR=function(t){this.rr_=t,this.param_changed_=!0},r.prototype.SetKS=function(t){this.ks_=t,this.param_changed_=!0},r.prototype.SetAMON=function(t){this.amon_=t,this.param_changed_=!0},r.prototype.Mute=function(t){this.mute_=t,this.param_changed_=!0},r.prototype.SetMS=function(t){this.ms_=t,this.param_changed_=!0},r.prototype.Out=function(){return this.out_},r.prototype.Refresh=function(){this.param_changed_=!0},r.notetable=[0,0,0,0,0,0,0,1,2,3,3,3,3,3,3,3,4,4,4,4,4,4,4,5,6,7,7,7,7,7,7,7,8,8,8,8,8,8,8,9,10,11,11,11,11,11,11,11,12,12,12,12,12,12,12,13,14,15,15,15,15,15,15,15,16,16,16,16,16,16,16,17,18,19,19,19,19,19,19,19,20,20,20,20,20,20,20,21,22,23,23,23,23,23,23,23,24,24,24,24,24,24,24,25,26,27,27,27,27,27,27,27,28,28,28,28,28,28,28,29,30,31,31,31,31,31,31,31],r.dttable=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,2,2,2,2,2,2,2,4,4,4,4,4,6,6,6,8,8,8,10,10,12,12,14,16,16,16,16,2,2,2,2,4,4,4,4,4,6,6,6,8,8,8,10,10,12,12,14,16,16,18,20,22,24,26,28,32,32,32,32,4,4,4,4,4,6,6,6,8,8,8,10,10,12,12,14,16,16,18,20,22,24,26,28,32,34,38,40,44,44,44,44,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-2,-2,-2,-2,-2,-2,-2,-2,-4,-4,-4,-4,-4,-6,-6,-6,-8,-8,-8,-10,-10,-12,-12,-14,-16,-16,-16,-16,-2,-2,-2,-2,-4,-4,-4,-4,-4,-6,-6,-6,-8,-8,-8,-10,-10,-12,-12,-14,-16,-16,-18,-20,-22,-24,-26,-28,-32,-32,-32,-32,-4,-4,-4,-4,-4,-6,-6,-6,-8,-8,-8,-10,-10,-12,-12,-14,-16,-16,-18,-20,-22,-24,-26,-28,-32,-34,-38,-40,-44,-44,-44,-44],r.decaytable1=[[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[1,1,1,1,1,1,1,1],[1,1,1,1,1,1,1,1],[1,1,1,1,1,1,1,1],[1,1,1,1,1,1,1,1],[1,1,1,0,1,1,1,0],[1,1,1,0,1,1,1,0],[1,0,1,0,1,0,1,0],[1,1,1,0,1,0,1,0],[1,1,1,0,1,1,1,0],[1,1,1,1,1,1,1,0],[1,0,1,0,1,0,1,0],[1,1,1,0,1,0,1,0],[1,1,1,0,1,1,1,0],[1,1,1,1,1,1,1,0],[1,0,1,0,1,0,1,0],[1,1,1,0,1,0,1,0],[1,1,1,0,1,1,1,0],[1,1,1,1,1,1,1,0],[1,0,1,0,1,0,1,0],[1,1,1,0,1,0,1,0],[1,1,1,0,1,1,1,0],[1,1,1,1,1,1,1,0],[1,0,1,0,1,0,1,0],[1,1,1,0,1,0,1,0],[1,1,1,0,1,1,1,0],[1,1,1,1,1,1,1,0],[1,0,1,0,1,0,1,0],[1,1,1,0,1,0,1,0],[1,1,1,0,1,1,1,0],[1,1,1,1,1,1,1,0],[1,0,1,0,1,0,1,0],[1,1,1,0,1,0,1,0],[1,1,1,0,1,1,1,0],[1,1,1,1,1,1,1,0],[1,0,1,0,1,0,1,0],[1,1,1,0,1,0,1,0],[1,1,1,0,1,1,1,0],[1,1,1,1,1,1,1,0],[1,0,1,0,1,0,1,0],[1,1,1,0,1,0,1,0],[1,1,1,0,1,1,1,0],[1,1,1,1,1,1,1,0],[1,0,1,0,1,0,1,0],[1,1,1,0,1,0,1,0],[1,1,1,0,1,1,1,0],[1,1,1,1,1,1,1,0],[1,1,1,1,1,1,1,1],[2,1,1,1,2,1,1,1],[2,1,2,1,2,1,2,1],[2,2,2,1,2,2,2,1],[2,2,2,2,2,2,2,2],[4,2,2,2,4,2,2,2],[4,2,4,2,4,2,4,2],[4,4,4,2,4,4,4,2],[4,4,4,4,4,4,4,4],[8,4,4,4,8,4,4,4],[8,4,8,4,8,4,8,4],[8,8,8,4,8,8,8,4],[16,16,16,16,16,16,16,16],[16,16,16,16,16,16,16,16],[16,16,16,16,16,16,16,16],[16,16,16,16,16,16,16,16]],r.decaytable2=[1,2,4,8,16,32,64,128,256,512,1024,2047,2047,2047,2047,2047],r.attacktable=[[-1,-1,-1,-1,-1,-1,-1,-1],[-1,-1,-1,-1,-1,-1,-1,-1],[4,4,4,4,4,4,4,4],[4,4,4,4,4,4,4,4],[4,4,4,4,4,4,4,4],[4,4,4,4,4,4,4,4],[4,4,4,-1,4,4,4,-1],[4,4,4,-1,4,4,4,-1],[4,-1,4,-1,4,-1,4,-1],[4,4,4,-1,4,-1,4,-1],[4,4,4,-1,4,4,4,-1],[4,4,4,4,4,4,4,-1],[4,-1,4,-1,4,-1,4,-1],[4,4,4,-1,4,-1,4,-1],[4,4,4,-1,4,4,4,-1],[4,4,4,4,4,4,4,-1],[4,-1,4,-1,4,-1,4,-1],[4,4,4,-1,4,-1,4,-1],[4,4,4,-1,4,4,4,-1],[4,4,4,4,4,4,4,-1],[4,-1,4,-1,4,-1,4,-1],[4,4,4,-1,4,-1,4,-1],[4,4,4,-1,4,4,4,-1],[4,4,4,4,4,4,4,-1],[4,-1,4,-1,4,-1,4,-1],[4,4,4,-1,4,-1,4,-1],[4,4,4,-1,4,4,4,-1],[4,4,4,4,4,4,4,-1],[4,-1,4,-1,4,-1,4,-1],[4,4,4,-1,4,-1,4,-1],[4,4,4,-1,4,4,4,-1],[4,4,4,4,4,4,4,-1],[4,-1,4,-1,4,-1,4,-1],[4,4,4,-1,4,-1,4,-1],[4,4,4,-1,4,4,4,-1],[4,4,4,4,4,4,4,-1],[4,-1,4,-1,4,-1,4,-1],[4,4,4,-1,4,-1,4,-1],[4,4,4,-1,4,4,4,-1],[4,4,4,4,4,4,4,-1],[4,-1,4,-1,4,-1,4,-1],[4,4,4,-1,4,-1,4,-1],[4,4,4,-1,4,4,4,-1],[4,4,4,4,4,4,4,-1],[4,-1,4,-1,4,-1,4,-1],[4,4,4,-1,4,-1,4,-1],[4,4,4,-1,4,4,4,-1],[4,4,4,4,4,4,4,-1],[4,4,4,4,4,4,4,4],[3,4,4,4,3,4,4,4],[3,4,3,4,3,4,3,4],[3,3,3,4,3,3,3,4],[3,3,3,3,3,3,3,3],[2,3,3,3,2,3,3,3],[2,3,2,3,2,3,2,3],[2,2,2,3,2,2,2,3],[2,2,2,2,2,2,2,2],[1,2,2,2,1,2,2,2],[1,2,1,2,1,2,1,2],[1,1,1,2,1,1,1,2],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0]],r.ssgenvtable=[[[[1,1],[1,1],[1,1]],[[0,1],[1,1],[1,1]]],[[[0,1],[2,0],[2,0]],[[0,1],[2,0],[2,0]]],[[[1,-1],[0,1],[1,-1]],[[0,1],[1,-1],[0,1]]],[[[1,-1],[0,0],[0,0]],[[0,1],[0,0],[0,0]]],[[[2,-1],[2,-1],[2,-1]],[[1,-1],[2,-1],[2,-1]]],[[[1,-1],[0,0],[0,0]],[[1,-1],[0,0],[0,0]]],[[[0,1],[1,-1],[0,1]],[[1,-1],[0,1],[1,-1]]],[[[0,1],[2,0],[2,0]],[[1,-1],[2,0],[2,0]]]],r.sinetable=function(){for(var t=[],e=Math.log(2),s=0;s<512;s++){var i=(2*s+1)*Math.PI/1024,h=-256*Math.log(Math.sin(i))/e,o=Math.floor(h+.5)+1;t[s]=2*o,t[512+s|0]=2*o+1}return t}(),r.cltable=function(){var t,e,s=[];for(e=t=0;t<256;t++){var i=Math.floor(Math.pow(2,13-t/256));i=i+2&-4,s[e++]=i,s[e++]=-i}for(t=e;e<8192;)s[e++]=s[t++-512]/2|0;return s}(),r.amtable=function(){for(var t,e,s=n.JaggArray.I3(2,8,256),i=[[31,6,4,3],[31,2,1,0]],h=0;h<2;h++)for(t=0;t<4;t++)for(e=0;e<256;e++)s[h][t][e]=2*(4*e>>i[h][t])<<2;return s}(),r.IS2EC_SHIFT=16,r}();n.Operator=t}(fmgenAs||(fmgenAs={})),function(N){var t=function(s){function O(){var t=s.call(this)||this;t.amplevel=16384,t.lfo_step_=0,t.kc=new Array(8),t.kf=new Array(8),t.pan=new Array(8),t.chip=new N.Chip,t.buf=new Array(4),t.ch=[new N.Channel4,new N.Channel4,new N.Channel4,new N.Channel4,new N.Channel4,new N.Channel4,new N.Channel4,new N.Channel4],t.lfo_count_=0,t.lfo_count_prev_=-1,O.BuildLFOTable();for(var e=0;e<8;e++)t.ch[e].SetChip(t.chip),t.ch[e].SetType(N.OpType.typeM);return t.ix=t.ch[0].ix,t.ox=t.ch[0].ox,t}return __extends(O,s),O.BuildLFOTable=function(){if(!this.s_init){for(var t=0;t<4;t++)for(var e=0,s=0;s<512;s++){var i=0,h=0;switch(t){case 0:h=(s+256&511)/2-128,i=255-s/2;break;case 1:i=s<256?255:0,h=s<256?127:-128;break;case 2:h=(h=s+128&511)<256?h-128:383-h,i=s<256?255-s:s-256;break;case 3:0==(3&s)&&(e=(32768*Math.random()|0)/17&255),h=(i=e)-128}this.amtable[t][s]=i,this.pmtable[t][s]=-h-1}this.s_init=!0}},O.prototype.Init=function(t,e){return!!this.SetRate(t,e)&&(this.Reset(),this.SetVolume(0),this.SetChannelMask(0),!0)},O.prototype.SetRate=function(t,e){return this.clock=t,this.pcmrate=e,this.rate=e,this.RebuildTimeTable(),!0},O.prototype.SetChannelMask=function(t){for(var e=0;e<8;e++)this.ch[e].Mute(0!=(t&1<<e))},O.prototype.Reset=function(){var t;for(t=0;t<256;t++)this.SetReg(t,0);for(this.SetReg(25,128),s.prototype.Reset.call(this),this.status=0,this.noise=12345,t=this.noisecount=0;t<8;t++)this.ch[t].Reset()},O.prototype.RebuildTimeTable=function(){var t=this.clock/64|0;this.rateratio=((t<<7)+this.rate/2)/this.rate|0,this.SetTimerBase(t),this.chip.SetRatio(this.rateratio)},O.prototype.TimerA=function(){if(128&this.regtc)for(var t=0;t<8;t++)this.ch[t].KeyControl(0),this.ch[t].KeyControl(15)},O.prototype.SetVolume=function(t){t=Math.min(t,20),this.fmvolume=-192<t?16384*Math.pow(10,t/40)|0:0},O.prototype.SetExpression=function(t){this.amplevel=16384*t|0},O.prototype.ReadStatus=function(){return 3&this.status},O.prototype.SetStatus=function(t){0==(this.status&t)&&(this.status|=t,this.Intr(!0))},O.prototype.ResetStatus=function(t){this.status&t&&(this.status&=~t,0===this.status&&this.Intr(!1))},O.prototype.SetReg=function(t,e){if(!(256<=t)){var s=7&t;switch(255&t){case 1:2&e&&(this.lfo_count_=0,this.lfo_count_prev_=-1),this.reg01=e;break;case 8:0==(128&this.regtc)?this.ch[7&e].KeyControl(e>>3):(s=7&e,0==(8&e)&&this.ch[s].op[0].KeyOff(),0==(16&e)&&this.ch[s].op[1].KeyOff(),0==(32&e)&&this.ch[s].op[2].KeyOff(),0==(64&e)&&this.ch[s].op[3].KeyOff());break;case 16:case 17:this.SetTimerA(t,e);break;case 18:this.SetTimerB(e);break;case 20:this.SetTimerControl(e);break;case 24:this.lfofreq=e,this.lfo_count_diff_=this.rateratio*(16+(15&this.lfofreq)<<5)/(1<<15-(this.lfofreq>>4));break;case 25:128&e?this.pmd=127&e:this.amd=127&e;break;case 27:this.lfowaveform=3&e;break;case 32:case 33:case 34:case 35:case 36:case 37:case 38:case 39:this.ch[s].SetFB(e>>3&7),this.ch[s].SetAlgorithm(7&e),this.pan[s]=e>>6&3;break;case 40:case 41:case 42:case 43:case 44:case 45:case 46:case 47:this.kc[s]=e,this.ch[s].SetKCKF(this.kc[s],this.kf[s]);break;case 48:case 49:case 50:case 51:case 52:case 53:case 54:case 55:this.kf[s]=e>>2,this.ch[s].SetKCKF(this.kc[s],this.kf[s]);break;case 56:case 57:case 58:case 59:case 60:case 61:case 62:case 63:this.ch[s].SetMS(e<<4|e>>4);break;case 15:this.noisedelta=e,this.noisecount=0;break;default:64<=t&&this.SetParameter(t,e)}}},O.prototype.SetParameter=function(t,e){var s=O.slottable[t>>3&3],i=this.ch[7&t].op[s];switch(t>>5&7){case 2:i.SetDT(e>>4&7),i.SetMULTI(15&e);break;case 3:i.SetTL(127&e,0!=(128&this.regtc));break;case 4:i.SetKS(e>>6&3),i.SetAR(2*(31&e));break;case 5:i.SetDR(2*(31&e)),i.SetAMON(0!=(128&e));break;case 6:i.SetSR(2*(31&e)),i.SetDT2(e>>6&3);break;case 7:i.SetSL(O.sltable[e>>4&15]),i.SetRR(4*(15&e)+2)}},O.prototype.Mix=function(t,e,s){var i,h=0;for(i=0;i<8;i++)h=h<<2|this.ch[i].Prepare();if(21845&h){var o,_,r,n,a,m,c;2&this.reg01&&(h&=21845);this.ch[0].algo_;var p=this.ch[0].fb,l=this.ch[0].op[0],u=this.ch[0].op[1],f=this.ch[0].op[2],g=this.ch[0].op[3],S=this.buf,v=this.ix,y=this.ox,M=O.cltable,E=O.sinetable,P=O.attacktable,d=O.decaytable1;if(3!==this.lfowaveform)var b=O.pmtable,A=O.amtable;for(i=e;i<e+s;i++)3!==this.lfowaveform?(_=this.lfo_count_>>15&510,this.chip.pml_=b[this.lfowaveform][_]*this.pmd/128+128&255,this.chip.aml_=A[this.lfowaveform][_]*this.amd/128&255):-131072&(this.lfo_count_^this.lfo_count_prev_)&&(_=(32768*Math.random()|0)/17&255,this.chip.pml_=(_-128)*this.pmd/128+128&255,this.chip.aml_=_*this.amd/128&255),this.lfo_count_prev_=this.lfo_count_,this.lfo_step_++,0==(7&this.lfo_step_)&&(this.lfo_count_+=this.lfo_count_diff_),r=0,16384&h&&(r=(g.out_=(c=43690&h?(this.ch[0].chip_.pmv_=this.ch[0].pms[this.ch[0].chip_.pml_],S[1]=S[2]=S[3]=0,S[0]=l.out_,l.eg_count_-=l.eg_count_diff_,l.eg_count_<=0&&(l.eg_count_=786048,l.eg_phase_===N.EGPhase.attack?0<=(_=P[l.eg_rate_][7&l.eg_curve_count_])&&(l.eg_level_-=1+(l.eg_level_>>_),l.eg_level_<=0&&l.ShiftPhase(N.EGPhase.decay)):(l.eg_level_+=d[l.eg_rate_][7&l.eg_curve_count_],l.eg_level_>=l.eg_level_on_next_phase_&&l.ShiftPhase(l.eg_phase_+1)),o=l.tl_out_+l.eg_level_,l.eg_out_=o<1023?o<<3:8184,l.eg_curve_count_++),n=l.out_+l.out2_,l.out2_=l.out_,a=l.pg_count_,l.pg_count_+=l.pg_diff_+(l.pg_diff_lfo_*l.chip_.pmv_>>5),m=a>>19,p<31&&(m+=n<<1+N.Operator.IS2EC_SHIFT>>p>>19),c=l.eg_out_+E[1023&m]+l.ams_[l.chip_.aml_],l.out_=c<8192?M[c]:0,u.eg_count_-=u.eg_count_diff_,u.eg_count_<=0&&(u.eg_count_=786048,u.eg_phase_===N.EGPhase.attack?0<=(_=P[u.eg_rate_][7&u.eg_curve_count_])&&(u.eg_level_-=1+(u.eg_level_>>_),u.eg_level_<=0&&u.ShiftPhase(N.EGPhase.decay)):(u.eg_level_+=d[u.eg_rate_][7&u.eg_curve_count_],u.eg_level_>=u.eg_level_on_next_phase_&&u.ShiftPhase(u.eg_phase_+1)),o=u.tl_out_+u.eg_level_,u.eg_out_=o<1023?o<<3:8184,u.eg_curve_count_++),n=S[v[0]],u.out2_=u.out_,a=u.pg_count_,u.pg_count_+=u.pg_diff_+(u.pg_diff_lfo_*u.chip_.pmv_>>5),m=a>>19,m+=n>>19-(2+N.Operator.IS2EC_SHIFT),c=u.eg_out_+E[1023&m]+u.ams_[u.chip_.aml_],u.out_=c<8192?M[c]:0,S[y[0]]+=u.out_,f.eg_count_-=f.eg_count_diff_,f.eg_count_<=0&&(f.eg_count_=786048,f.eg_phase_===N.EGPhase.attack?0<=(_=P[f.eg_rate_][7&f.eg_curve_count_])&&(f.eg_level_-=1+(f.eg_level_>>_),f.eg_level_<=0&&f.ShiftPhase(N.EGPhase.decay)):(f.eg_level_+=d[f.eg_rate_][7&f.eg_curve_count_],f.eg_level_>=f.eg_level_on_next_phase_&&f.ShiftPhase(f.eg_phase_+1)),o=f.tl_out_+f.eg_level_,f.eg_out_=o<1023?o<<3:8184,f.eg_curve_count_++),n=S[v[1]],f.out2_=f.out_,a=f.pg_count_,f.pg_count_+=f.pg_diff_+(f.pg_diff_lfo_*f.chip_.pmv_>>5),m=a>>19,m+=n>>19-(2+N.Operator.IS2EC_SHIFT),c=f.eg_out_+E[1023&m]+f.ams_[f.chip_.aml_],f.out_=c<8192?M[c]:0,S[y[1]]+=f.out_,g.eg_count_-=g.eg_count_diff_,g.eg_count_<=0&&(g.eg_count_=786048,g.eg_phase_===N.EGPhase.attack?0<=(_=P[g.eg_rate_][7&g.eg_curve_count_])&&(g.eg_level_-=1+(g.eg_level_>>_),g.eg_level_<=0&&g.ShiftPhase(N.EGPhase.decay)):(g.eg_level_+=d[g.eg_rate_][7&g.eg_curve_count_],g.eg_level_>=g.eg_level_on_next_phase_&&g.ShiftPhase(g.eg_phase_+1)),o=g.tl_out_+g.eg_level_,g.eg_out_=o<1023?o<<3:8184,g.eg_curve_count_++),n=S[v[2]],g.out2_=g.out_,a=g.pg_count_,g.pg_count_+=g.pg_diff_+(g.pg_diff_lfo_*g.chip_.pmv_>>5),m=a>>19,m+=n>>19-(2+N.Operator.IS2EC_SHIFT),g.eg_out_+E[1023&m]+g.ams_[g.chip_.aml_]):(S[1]=S[2]=S[3]=0,S[0]=l.out_,l.eg_count_-=l.eg_count_diff_,l.eg_count_<=0&&(l.eg_count_=786048,l.eg_phase_===N.EGPhase.attack?0<=(_=P[l.eg_rate_][7&l.eg_curve_count_])&&(l.eg_level_-=1+(l.eg_level_>>_),l.eg_level_<=0&&l.ShiftPhase(N.EGPhase.decay)):(l.eg_level_+=d[l.eg_rate_][7&l.eg_curve_count_],l.eg_level_>=l.eg_level_on_next_phase_&&l.ShiftPhase(l.eg_phase_+1)),o=l.tl_out_+l.eg_level_,l.eg_out_=o<1023?o<<3:8184,l.eg_curve_count_++),n=l.out_+l.out2_,l.out2_=l.out_,a=l.pg_count_,l.pg_count_+=l.pg_diff_,m=a>>19,p<31&&(m+=n<<1+N.Operator.IS2EC_SHIFT>>p>>19),c=l.eg_out_+E[1023&m],l.out_=c<8192?M[c]:0,u.eg_count_-=u.eg_count_diff_,u.eg_count_<=0&&(u.eg_count_=786048,u.eg_phase_===N.EGPhase.attack?0<=(_=P[u.eg_rate_][7&u.eg_curve_count_])&&(u.eg_level_-=1+(u.eg_level_>>_),u.eg_level_<=0&&u.ShiftPhase(N.EGPhase.decay)):(u.eg_level_+=d[u.eg_rate_][7&u.eg_curve_count_],u.eg_level_>=u.eg_level_on_next_phase_&&u.ShiftPhase(u.eg_phase_+1)),o=u.tl_out_+u.eg_level_,u.eg_out_=o<1023?o<<3:8184,u.eg_curve_count_++),n=S[v[0]],u.out2_=u.out_,a=u.pg_count_,u.pg_count_+=u.pg_diff_,m=a>>19,m+=n>>19-(2+N.Operator.IS2EC_SHIFT),c=u.eg_out_+E[1023&m],u.out_=c<8192?M[c]:0,S[y[0]]+=u.out_,f.eg_count_-=f.eg_count_diff_,f.eg_count_<=0&&(f.eg_count_=786048,f.eg_phase_===N.EGPhase.attack?0<=(_=P[f.eg_rate_][7&f.eg_curve_count_])&&(f.eg_level_-=1+(f.eg_level_>>_),f.eg_level_<=0&&f.ShiftPhase(N.EGPhase.decay)):(f.eg_level_+=d[f.eg_rate_][7&f.eg_curve_count_],f.eg_level_>=f.eg_level_on_next_phase_&&f.ShiftPhase(f.eg_phase_+1)),o=f.tl_out_+f.eg_level_,f.eg_out_=o<1023?o<<3:8184,f.eg_curve_count_++),n=S[v[1]],f.out2_=f.out_,a=f.pg_count_,f.pg_count_+=f.pg_diff_,m=a>>19,m+=n>>19-(2+N.Operator.IS2EC_SHIFT),c=f.eg_out_+E[1023&m],f.out_=c<8192?M[c]:0,S[y[1]]+=f.out_,g.eg_count_-=g.eg_count_diff_,g.eg_count_<=0&&(g.eg_count_=786048,g.eg_phase_===N.EGPhase.attack?0<=(_=P[g.eg_rate_][7&g.eg_curve_count_])&&(g.eg_level_-=1+(g.eg_level_>>_),g.eg_level_<=0&&g.ShiftPhase(N.EGPhase.decay)):(g.eg_level_+=d[g.eg_rate_][7&g.eg_curve_count_],g.eg_level_>=g.eg_level_on_next_phase_&&g.ShiftPhase(g.eg_phase_+1)),o=g.tl_out_+g.eg_level_,g.eg_out_=o<1023?o<<3:8184,g.eg_curve_count_++),n=S[v[2]],g.out2_=g.out_,a=g.pg_count_,g.pg_count_+=g.pg_diff_,m=a>>19,m+=n>>19-(2+N.Operator.IS2EC_SHIFT),g.eg_out_+E[1023&m]))<8192?M[c]:0,S[y[2]]+g.out_),t[i]=((r*this.fmvolume>>14)*this.amplevel>>14)/8192)}else t.set(msgr.emptyBuffer.subarray(0,s),e)},O.prototype.Intr=function(t){},O.prototype.IsOn=function(t){var e=this.ch[7&t];switch(e.algo_){case 0:case 1:case 2:case 3:return e.op[3].eg_phase_!==N.EGPhase.off;case 4:return e.op[1].eg_phase_!==N.EGPhase.off||e.op[3].eg_phase_!==N.EGPhase.off;case 5:case 6:return e.op[1].eg_phase_!==N.EGPhase.off||e.op[2].eg_phase_!==N.EGPhase.off||e.op[3].eg_phase_!==N.EGPhase.off;case 7:return e.op[0].eg_phase_!==N.EGPhase.off||e.op[1].eg_phase_!==N.EGPhase.off||e.op[2].eg_phase_!==N.EGPhase.off||e.op[3].eg_phase_!==N.EGPhase.off}return!1},O.s_init=!1,O.amtable=N.JaggArray.I2(4,512),O.pmtable=N.JaggArray.I2(4,512),O.sltable=[0,4,8,12,16,20,24,28,32,36,40,44,48,52,56,124],O.slottable=[0,2,1,3],O.decaytable1=N.Operator.decaytable1,O.attacktable=N.Operator.attacktable,O.sinetable=N.Operator.sinetable,O.cltable=N.Operator.cltable,O}(N.Timer);N.OPM=t}(fmgenAs||(fmgenAs={})),function(e){var s=fmgenAs.OPM,t=function(o){function _(){var t=o.call(this)||this;return t.m_fm=new s,t.m_oneSample=new Float32Array(1),t.m_velocity=127,t.m_al=0,t.m_tl=new Array(4),_.boot(),t.m_fm.Init(_.OPM_CLOCK,e.MSequencer.SAMPLE_RATE),t.m_fm.Reset(),t.m_fm.SetVolume(_.s_comGain),t.setOpMask(15),t.setWaveNo(0),t}return __extends(_,o),_.boot=function(){0===this.s_init&&(this.s_table[0]=this.defTimbre,this.s_init=1)},_.clearTimber=function(){for(var t=0;t<this.s_table.length;t++)this.s_table[t]=0===t?this.defTimbre:null},_.trim=function(t){return t.replace(/^[,]*/m,"").replace(/[,]*$/m,"")},_.setTimber=function(t,e,s){if(!(t<0||this.MAX_WAVE<=t)){s=s.replace(/[,;\s\t\r\n]+/gm,",");var i,h,o,_=(s=this.trim(s)).split(","),r=new Array(this.TIMB_SZ_M);switch(e){case this.TYPE_OPM:if(_.length<46)return;break;case this.TYPE_OPN:if(_.length<42)return;break;default:return}switch(e){case this.TYPE_OPM:for(o=Math.min(this.TIMB_SZ_M,_.length),i=0;i<o;i++)r[i]=0|_[i];for(;i<this.TIMB_SZ_M;i++)r[i]=this.zeroTimbre[i];break;case this.TYPE_OPN:for(h=i=0;i<2;i++,h++)r[i]=0|_[h];for(;i<46;i++)r[i]=(i-2)%11==9?0:0|_[h++];for(o=Math.min(this.TIMB_SZ_N,_.length);h<o;i++,h++)r[i]=0|_[h];for(;i<this.TIMB_SZ_M;i++)r[i]=this.zeroTimbre[i]}this.s_table[t]=r}},_.prototype.loadTimbre=function(t){var e,s;this.SetFBAL(t[1],t[0]);var i=_.slottable;for(e=2,s=0;s<4;s++,e+=11)this.SetDT1ML(i[s],t[e+8],t[e+7]),this.m_tl[s]=t[e+5],this.SetTL(i[s],t[e+5]),this.SetKSAR(i[s],t[e+6],t[e+0]),this.SetDRAMS(i[s],t[e+1],t[e+10]),this.SetDT2SR(i[s],t[e+9],t[e+2]),this.SetSLRR(i[s],t[e+4],t[e+3]);this.setVelocity(this.m_velocity),this.setOpMask(t[e+0]),this.setWF(t[e+1]),this.setLFRQ(t[e+2]),this.setPMD(t[e+3]),this.setAMD(t[e+4]),this.setPMSAMS(t[e+5],t[e+6]),this.setNENFRQ(t[e+7],t[e+8])},_.setCommonGain=function(t){this.s_comGain=t},_.prototype.SetFBAL=function(t,e){this.m_al=7&e,this.m_fm.SetReg(32,192|(7&t)<<3|7&e)},_.prototype.SetDT1ML=function(t,e,s){this.m_fm.SetReg(64|(3&t)<<3,(7&e)<<4|15&s)},_.prototype.SetTL=function(t,e){e<0&&(e=0),127<e&&(e=127),this.m_fm.SetReg(96|(3&t)<<3,127&e)},_.prototype.SetKSAR=function(t,e,s){this.m_fm.SetReg(128|(3&t)<<3,(3&e)<<6|31&s)},_.prototype.SetDRAMS=function(t,e,s){this.m_fm.SetReg(160|(3&t)<<3,(1&s)<<7|31&e)},_.prototype.SetDT2SR=function(t,e,s){this.m_fm.SetReg(192|(3&t)<<3,(3&e)<<6|31&s)},_.prototype.SetSLRR=function(t,e,s){this.m_fm.SetReg(224|(3&t)<<3,(15&e)<<4|15&s)},_.prototype.setPMSAMS=function(t,e){this.m_fm.SetReg(56,(7&t)<<4|3&e)},_.prototype.setPMD=function(t){this.m_fm.SetReg(25,128|127&t)},_.prototype.setAMD=function(t){this.m_fm.SetReg(25,0|127&t)},_.prototype.setNENFRQ=function(t,e){this.m_fm.SetReg(15,(1&t)<<7|31&e)},_.prototype.setLFRQ=function(t){this.m_fm.SetReg(24,255&t)},_.prototype.setWF=function(t){this.m_fm.SetReg(27,3&t)},_.prototype.noteOn=function(){this.m_fm.SetReg(1,2),this.m_fm.SetReg(1,0),this.m_fm.SetReg(8,this.m_opMask<<3)},_.prototype.noteOff=function(){this.m_fm.SetReg(8,0)},_.prototype.setWaveNo=function(t){_.MAX_WAVE<=t&&(t=_.MAX_WAVE-1),null==_.s_table[t]&&(t=0),this.m_fm.SetVolume(_.s_comGain),this.loadTimbre(_.s_table[t])},_.prototype.setNoteNo=function(t){this.noteOn()},_.prototype.setOpMask=function(t){this.m_opMask=15&t},_.prototype.setVelocity=function(t){this.m_velocity=t;var e=this.m_al,s=this.m_tl,i=_.carrierop[e],h=_.slottable;this.SetTL(h[0],s[0]+(8&i?127-t:0)),this.SetTL(h[1],s[1]+(16&i?127-t:0)),this.SetTL(h[2],s[2]+(32&i?127-t:0)),this.SetTL(h[3],s[3]+(64&i?127-t:0))},_.prototype.setExpression=function(t){this.m_fm.SetExpression(t)},_.prototype.setFrequency=function(t){if(this.m_frequency!==t&&(o.prototype.setFrequency.call(this,t),this.m_fm)){var e=1200*Math.log(t/440)*Math.LOG2E+5700+_.OPM_RATIO+.5|0,s=e/100|0,i=64*(e%100)/100+.5|0,h=(s-1)/12<<4|_.kctable[(s+1200)%12];this.m_fm.SetReg(48,i<<2),this.m_fm.SetReg(40,h)}},_.prototype.getNextSample=function(){return this.m_fm.Mix(this.m_oneSample,0,1),this.m_oneSample[0]},_.prototype.getNextSampleOfs=function(t){return this.m_fm.Mix(this.m_oneSample,0,1),this.m_oneSample[0]},_.prototype.getSamples=function(t,e,s){this.m_fm.Mix(t,e,s-e)},_.prototype.IsPlaying=function(){return this.m_fm.IsOn(0)},_.MAX_WAVE=128,_.OPM_CLOCK=358e4,_.OPM_RATIO=0,_.TIMB_SZ_M=55,_.TIMB_SZ_N=51,_.TYPE_OPM=0,_.TYPE_OPN=1,_.s_init=0,_.s_table=new Array(_.MAX_WAVE),_.s_comGain=14.25,_.kctable=[14,0,1,2,4,5,6,8,9,10,12,13],_.slottable=[0,2,1,3],_.carrierop=[64,64,64,64,80,112,112,120],_.defTimbre=[4,5,31,5,0,0,0,23,1,1,3,0,0,20,10,3,7,8,0,1,1,3,0,0,31,3,0,0,0,25,1,1,7,0,0,31,12,3,7,10,2,1,1,7,0,0,15,0,0,0,0,0,0,0,0],_.zeroTimbre=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,15,0,0,0,0,0,0,0,0],_}(e.MOscMod);e.MOscOPM=t}(flmml||(flmml={})),function(t){var e=function(e){function o(){var t=this;return o.boot(),(t=e.call(this)||this).setPWM(.5),t.setMIX(0),t}return __extends(o,e),o.boot=function(){},o.prototype.getNextSample=function(){var t=this.m_phase<this.m_pwm?1:this.m_mix?this.m_modNoise.getNextSample():-1;return this.m_phase=this.m_phase+this.m_freqShift&o.PHASE_MSK,t},o.prototype.getNextSampleOfs=function(t){var e=(this.m_phase+t&o.PHASE_MSK)<this.m_pwm?1:this.m_mix?this.m_modNoise.getNextSampleOfs(t):-1;return this.m_phase=this.m_phase+this.m_freqShift&o.PHASE_MSK,e},o.prototype.getSamples=function(t,e,s){var i;if(this.m_mix)for(i=e;i<s;i++)t[i]=this.m_phase<this.m_pwm?1:this.m_modNoise.getNextSample(),this.m_phase=this.m_phase+this.m_freqShift&o.PHASE_MSK;else for(i=e;i<s;i++)t[i]=this.m_phase<this.m_pwm?1:-1,this.m_phase=this.m_phase+this.m_freqShift&o.PHASE_MSK},o.prototype.getSamplesWithSyncIn=function(t,e,s,i){var h;if(this.m_mix)for(h=s;h<i;h++)e[h]&&this.resetPhase(),t[h]=this.m_phase<this.m_pwm?1:this.m_modNoise.getNextSample(),this.m_phase=this.m_phase+this.m_freqShift&o.PHASE_MSK;else for(h=s;h<i;h++)e[h]&&this.resetPhase(),t[h]=this.m_phase<this.m_pwm?1:-1,this.m_phase=this.m_phase+this.m_freqShift&o.PHASE_MSK},o.prototype.getSamplesWithSyncOut=function(t,e,s,i){var h;if(this.m_mix)for(h=s;h<i;h++)t[h]=this.m_phase<this.m_pwm?1:this.m_modNoise.getNextSample(),this.m_phase+=this.m_freqShift,e[h]=this.m_phase>o.PHASE_MSK,this.m_phase&=o.PHASE_MSK;else for(h=s;h<i;h++)t[h]=this.m_phase<this.m_pwm?1:-1,this.m_phase+=this.m_freqShift,e[h]=this.m_phase>o.PHASE_MSK,this.m_phase&=o.PHASE_MSK},o.prototype.setPWM=function(t){this.m_pwm=t*o.PHASE_LEN},o.prototype.setMIX=function(t){this.m_mix=t},o.prototype.setNoise=function(t){this.m_modNoise=t},o}(t.MOscMod);t.MOscPulse=e}(flmml||(flmml={})),function(t){var e=function(e){function o(){var t=this;return o.boot(),(t=e.call(this)||this).setWaveNo(0),t}return __extends(o,e),o.boot=function(){if(!this.s_init){var t,e,s=1/this.TABLE_LEN;for(this.s_table=new Array(this.MAX_WAVE),e=0;e<this.MAX_WAVE;e++)this.s_table[e]=new Array(this.TABLE_LEN);for(t=e=0;e<this.TABLE_LEN;e++)this.s_table[0][e]=2*t-1,this.s_table[1][e]=t<.5?2*t:2*t-2,t+=s;this.s_init=1}},o.prototype.getNextSample=function(){var t=o.s_table[this.m_waveNo][this.m_phase>>o.PHASE_SFT];return this.m_phase=this.m_phase+this.m_freqShift&o.PHASE_MSK,t},o.prototype.getNextSampleOfs=function(t){var e=o.s_table[this.m_waveNo][(this.m_phase+t&o.PHASE_MSK)>>o.PHASE_SFT];return this.m_phase=this.m_phase+this.m_freqShift&o.PHASE_MSK,e},o.prototype.getSamples=function(t,e,s){var i;for(i=e;i<s;i++)t[i]=o.s_table[this.m_waveNo][this.m_phase>>o.PHASE_SFT],this.m_phase=this.m_phase+this.m_freqShift&o.PHASE_MSK},o.prototype.getSamplesWithSyncIn=function(t,e,s,i){var h;for(h=s;h<i;h++)e[h]&&this.resetPhase(),t[h]=o.s_table[this.m_waveNo][this.m_phase>>o.PHASE_SFT],this.m_phase=this.m_phase+this.m_freqShift&o.PHASE_MSK},o.prototype.getSamplesWithSyncOut=function(t,e,s,i){var h;for(h=s;h<i;h++)t[h]=o.s_table[this.m_waveNo][this.m_phase>>o.PHASE_SFT],this.m_phase+=this.m_freqShift,e[h]=this.m_phase>o.PHASE_MSK,this.m_phase&=o.PHASE_MSK},o.prototype.setWaveNo=function(t){this.m_waveNo=Math.min(t,o.MAX_WAVE-1)},o.MAX_WAVE=2,o.s_init=0,o}(t.MOscMod);t.MOscSaw=e}(flmml||(flmml={})),function(t){var e=function(e){function _(){var t=this;return _.boot(),(t=e.call(this)||this).setWaveNo(0),t}return __extends(_,e),_.boot=function(){if(!this.s_init){var t,e,s=2*Math.PI/this.TABLE_LEN;for(e=0;e<this.MAX_WAVE;e++)this.s_table[e]=new Array(this.TABLE_LEN);for(t=e=0;e<this.TABLE_LEN;e++)this.s_table[0][e]=Math.sin(t),this.s_table[1][e]=Math.max(0,this.s_table[0][e]),this.s_table[2][e]=0<=this.s_table[0][e]?this.s_table[0][e]:-1*this.s_table[0][e],t+=s;this.s_init=1}},_.prototype.getNextSample=function(){var t=_.s_table[this.m_waveNo][this.m_phase>>_.PHASE_SFT];return this.m_phase=this.m_phase+this.m_freqShift&_.PHASE_MSK,t},_.prototype.getNextSampleOfs=function(t){var e=_.s_table[this.m_waveNo][(this.m_phase+t&_.PHASE_MSK)>>_.PHASE_SFT];return this.m_phase=this.m_phase+this.m_freqShift&_.PHASE_MSK,e},_.prototype.getSamples=function(t,e,s){var i,h=_.s_table[this.m_waveNo];for(i=e;i<s;i++)t[i]=h[this.m_phase>>_.PHASE_SFT],this.m_phase=this.m_phase+this.m_freqShift&_.PHASE_MSK},_.prototype.getSamplesWithSyncIn=function(t,e,s,i){var h,o=_.s_table[this.m_waveNo];for(h=s;h<i;h++)e[h]&&this.resetPhase(),t[h]=o[this.m_phase>>_.PHASE_SFT],this.m_phase=this.m_phase+this.m_freqShift&_.PHASE_MSK},_.prototype.getSamplesWithSyncOut=function(t,e,s,i){var h,o=_.s_table[this.m_waveNo];for(h=s;h<i;h++)t[h]=o[this.m_phase>>_.PHASE_SFT],this.m_phase+=this.m_freqShift,e[h]=this.m_phase>_.PHASE_MSK,this.m_phase&=_.PHASE_MSK},_.prototype.setWaveNo=function(t){_.MAX_WAVE<=t&&(t=_.MAX_WAVE-1),_.s_table[t]||(t=0),this.m_waveNo=t},_.MAX_WAVE=3,_.s_init=0,_.s_table=new Array(_.MAX_WAVE),_}(t.MOscMod);t.MOscSine=e}(flmml||(flmml={})),function(t){var e=function(e){function o(){var t=this;return o.boot(),(t=e.call(this)||this).setWaveNo(0),t}return __extends(o,e),o.boot=function(){if(!this.s_init){var t,e,s=1/this.TABLE_LEN;for(this.s_table=new Array(this.MAX_WAVE),e=0;e<this.MAX_WAVE;e++)this.s_table[e]=new Array(this.TABLE_LEN);for(t=e=0;e<this.TABLE_LEN;e++)this.s_table[0][e]=t<.5?1-4*t:1-4*(1-t),this.s_table[1][e]=t<.25?0-4*t:t<.75?4*t-2:4-4*t,t+=s;this.s_init=1}},o.prototype.getNextSample=function(){var t=o.s_table[this.m_waveNo][this.m_phase>>o.PHASE_SFT];return this.m_phase=this.m_phase+this.m_freqShift&o.PHASE_MSK,t},o.prototype.getNextSampleOfs=function(t){var e=o.s_table[this.m_waveNo][(this.m_phase+t&o.PHASE_MSK)>>o.PHASE_SFT];return this.m_phase=this.m_phase+this.m_freqShift&o.PHASE_MSK,e},o.prototype.getSamples=function(t,e,s){var i;for(i=e;i<s;i++)t[i]=o.s_table[this.m_waveNo][this.m_phase>>o.PHASE_SFT],this.m_phase=this.m_phase+this.m_freqShift&o.PHASE_MSK},o.prototype.getSamplesWithSyncIn=function(t,e,s,i){var h;for(h=s;h<i;h++)e[h]&&this.resetPhase(),t[h]=o.s_table[this.m_waveNo][this.m_phase>>o.PHASE_SFT],this.m_phase=this.m_phase+this.m_freqShift&o.PHASE_MSK},o.prototype.getSamplesWithSyncOut=function(t,e,s,i){var h;for(h=s;h<i;h++)t[h]=o.s_table[this.m_waveNo][this.m_phase>>o.PHASE_SFT],this.m_phase+=this.m_freqShift,e[h]=this.m_phase>o.PHASE_MSK,this.m_phase&=o.PHASE_MSK},o.prototype.setWaveNo=function(t){this.m_waveNo=Math.min(t,o.MAX_WAVE-1)},o.MAX_WAVE=2,o.s_init=0,o}(t.MOscMod);t.MOscTriangle=e}(flmml||(flmml={})),function(t){var e=function(e){function o(){var t=this;return o.boot(),(t=e.call(this)||this).setWaveNo(0),t}return __extends(o,e),o.boot=function(){this.s_init||(this.s_table=new Array(this.MAX_WAVE),this.s_length=new Array(this.MAX_WAVE),this.setWave(0,"00112233445566778899AABBCCDDEEFFFFEEDDCCBBAA99887766554433221100"),this.s_init=1)},o.setWave=function(t,e){this.s_length[t]=0,this.s_table[t]=new Array(e.length/2|0);for(var s=this.s_table[t][0]=0,i=0,h=0;s<this.MAX_LENGTH&&s<e.length;s++,i++){var o=e.charCodeAt(s);48<=o&&o<58?o-=48:97<=o&&o<103?o-=87:o=0,1&i?(h+=o,this.s_table[t][this.s_length[t]]=(Number(h)-127.5)/127.5,this.s_length[t]++):h=o<<4}0===this.s_length[t]&&(this.s_length[t]=1),this.s_length[t]=(this.PHASE_MSK+1)/this.s_length[t]},o.prototype.setWaveNo=function(t){o.MAX_WAVE<=t&&(t=o.MAX_WAVE-1),o.s_table[t]||(t=0),this.m_waveNo=t},o.prototype.getNextSample=function(){var t=o.s_table[this.m_waveNo][Math.floor(this.m_phase/o.s_length[this.m_waveNo])];return this.m_phase=this.m_phase+this.m_freqShift&o.PHASE_MSK,t},o.prototype.getNextSampleOfs=function(t){var e=o.s_table[this.m_waveNo][Math.floor((this.m_phase+t&o.PHASE_MSK)/o.s_length[this.m_waveNo])];return this.m_phase=this.m_phase+this.m_freqShift&o.PHASE_MSK,e},o.prototype.getSamples=function(t,e,s){var i;for(i=e;i<s;i++)t[i]=o.s_table[this.m_waveNo][Math.floor(this.m_phase/o.s_length[this.m_waveNo])],this.m_phase=this.m_phase+this.m_freqShift&o.PHASE_MSK},o.prototype.getSamplesWithSyncIn=function(t,e,s,i){var h;for(h=s;h<i;h++)e[h]&&this.resetPhase(),t[h]=o.s_table[this.m_waveNo][Math.floor(this.m_phase/o.s_length[this.m_waveNo])],this.m_phase=this.m_phase+this.m_freqShift&o.PHASE_MSK},o.prototype.getSamplesWithSyncOut=function(t,e,s,i){var h;for(h=s;h<i;h++)t[h]=o.s_table[this.m_waveNo][Math.floor(this.m_phase/o.s_length[this.m_waveNo])],this.m_phase+=this.m_freqShift,e[h]=this.m_phase>o.PHASE_MSK,this.m_phase&=o.PHASE_MSK},o.MAX_WAVE=32,o.MAX_LENGTH=2048,o.s_init=0,o}(t.MOscMod);t.MOscWave=e}(flmml||(flmml={})),function(t){var e=function(){function s(){s.boot(),this.m_osc=new Array(s.MAX),this.m_osc[s.SINE]=new t.MOscSine,this.m_osc[s.SAW]=new t.MOscSaw,this.m_osc[s.TRIANGLE]=new t.MOscTriangle,this.m_osc[s.PULSE]=new t.MOscPulse,this.m_osc[s.NOISE]=new t.MOscNoise,this.m_osc[s.FC_PULSE]=new t.MOscPulse,this.m_osc[s.FC_TRI]=new t.MOscFcTri,this.m_osc[s.FC_NOISE]=new t.MOscFcNoise,this.m_osc[s.FC_S_NOISE]=null,this.m_osc[s.FC_DPCM]=new t.MOscFcDpcm,this.m_osc[s.GB_WAVE]=new t.MOscGbWave,this.m_osc[s.GB_NOISE]=new t.MOscGbLNoise,this.m_osc[s.GB_S_NOISE]=new t.MOscGbSNoise,this.m_osc[s.WAVE]=new t.MOscWave,this.m_osc[s.OPM]=new t.MOscOPM,this.setForm(s.PULSE),this.setNoiseToPulse()}return s.prototype.asLFO=function(){this.m_osc[s.NOISE]&&this.m_osc[s.NOISE].disableResetPhase()},s.boot=function(){this.s_init||(t.MOscSine.boot(),t.MOscSaw.boot(),t.MOscTriangle.boot(),t.MOscPulse.boot(),t.MOscNoise.boot(),t.MOscFcTri.boot(),t.MOscFcNoise.boot(),t.MOscFcDpcm.boot(),t.MOscGbWave.boot(),t.MOscGbLNoise.boot(),t.MOscGbSNoise.boot(),t.MOscWave.boot(),t.MOscOPM.boot(),this.s_init=1)},s.prototype.setForm=function(t){switch(s.MAX<=t&&(t=s.MAX-1),this.m_form=t){case s.NOISE:this.m_osc[s.NOISE].restoreFreq();break;case s.FC_NOISE:this.getMod(s.FC_NOISE).setLongMode();break;case s.FC_S_NOISE:this.getMod(s.FC_S_NOISE).setShortMode()}return this.getMod(t)},s.prototype.getForm=function(){return this.m_form},s.prototype.getCurrent=function(){return this.getMod(this.m_form)},s.prototype.getMod=function(t){return t!==s.FC_S_NOISE?this.m_osc[t]:this.m_osc[s.FC_NOISE]},s.prototype.setNoiseToPulse=function(){var t=this.getMod(s.PULSE),e=this.getMod(s.NOISE);t.setNoise(e)},s.SINE=0,s.SAW=1,s.TRIANGLE=2,s.PULSE=3,s.NOISE=4,s.FC_PULSE=5,s.FC_TRI=6,s.FC_NOISE=7,s.FC_S_NOISE=8,s.FC_DPCM=9,s.GB_WAVE=10,s.GB_NOISE=11,s.GB_S_NOISE=12,s.WAVE=13,s.OPM=14,s.MAX=15,s.s_init=0,s}();t.MOscillator=e}(flmml||(flmml={})),function(s){var t=function(){function t(t){this.m_voices=new Array(t);for(var e=0;e<this.m_voices.length;e++)this.m_voices[e]=new s.MChannel;this.m_form=s.MOscillator.FC_PULSE,this.m_subform=0,this.m_voiceId=0,this.m_volMode=0,this.m_voiceLimit=t,this.m_lastVoice=null,this.m_voiceLen=this.m_voices.length}return t.prototype.setExpression=function(t){for(var e=0;e<this.m_voiceLen;e++)this.m_voices[e].setExpression(t)},t.prototype.setVelocity=function(t){for(var e=0;e<this.m_voiceLen;e++)this.m_voices[e].setVelocity(t)},t.prototype.setNoteNo=function(t,e){void 0===e&&(e=!0),null!==this.m_lastVoice&&this.m_lastVoice.isPlaying()&&this.m_lastVoice.setNoteNo(t,e)},t.prototype.setDetune=function(t){for(var e=0;e<this.m_voiceLen;e++)this.m_voices[e].setDetune(t)},t.prototype.getVoiceCount=function(){var t,e=0;for(t=0;t<this.m_voiceLen;t++)e+=this.m_voices[t].getVoiceCount();return e},t.prototype.noteOn=function(t,e){var s,i=null;if(this.getVoiceCount()<=this.m_voiceLimit)for(s=0;s<this.m_voiceLen;s++)if(!1===this.m_voices[s].isPlaying()){i=this.m_voices[s];break}if(null==i){var h=Number.MAX_VALUE;for(s=0;s<this.m_voiceLen;s++)h>this.m_voices[s].getId()&&(h=this.m_voices[s].getId(),i=this.m_voices[s])}i.setForm(this.m_form,this.m_subform),i.setVolMode(this.m_volMode),i.noteOnWidthId(t,e,this.m_voiceId++),this.m_lastVoice=i},t.prototype.noteOff=function(t){for(var e=0;e<this.m_voiceLen;e++)this.m_voices[e].getNoteNo()===t&&this.m_voices[e].noteOff(t)},t.prototype.setSoundOff=function(){for(var t=0;t<this.m_voiceLen;t++)this.m_voices[t].setSoundOff()},t.prototype.close=function(){for(var t=0;t<this.m_voiceLen;t++)this.m_voices[t].close()},t.prototype.setNoiseFreq=function(t){for(var e=0;e<this.m_voiceLen;e++)this.m_voices[e].setNoiseFreq(t)},t.prototype.setForm=function(t,e){this.m_form=t,this.m_subform=e},t.prototype.setEnvelope1Atk=function(t){for(var e=0;e<this.m_voiceLen;e++)this.m_voices[e].setEnvelope1Atk(t)},t.prototype.setEnvelope1Point=function(t,e){for(var s=0;s<this.m_voiceLen;s++)this.m_voices[s].setEnvelope1Point(t,e)},t.prototype.setEnvelope1Rel=function(t){for(var e=0;e<this.m_voiceLen;e++)this.m_voices[e].setEnvelope1Rel(t)},t.prototype.setEnvelope2Atk=function(t){for(var e=0;e<this.m_voiceLen;e++)this.m_voices[e].setEnvelope2Atk(t)},t.prototype.setEnvelope2Point=function(t,e){for(var s=0;s<this.m_voiceLen;s++)this.m_voices[s].setEnvelope2Point(t,e)},t.prototype.setEnvelope2Rel=function(t){for(var e=0;e<this.m_voiceLen;e++)this.m_voices[e].setEnvelope2Rel(t)},t.prototype.setPWM=function(t){for(var e=0;e<this.m_voiceLen;e++)this.m_voices[e].setPWM(t)},t.prototype.setPan=function(t){for(var e=0;e<this.m_voiceLen;e++)this.m_voices[e].setPan(t)},t.prototype.setFormant=function(t){for(var e=0;e<this.m_voiceLen;e++)this.m_voices[e].setFormant(t)},t.prototype.setLFOFMSF=function(t,e){for(var s=0;s<this.m_voiceLen;s++)this.m_voices[s].setLFOFMSF(t,e)},t.prototype.setLFODPWD=function(t,e){for(var s=0;s<this.m_voiceLen;s++)this.m_voices[s].setLFODPWD(t,e)},t.prototype.setLFODLTM=function(t,e){for(var s=0;s<this.m_voiceLen;s++)this.m_voices[s].setLFODLTM(t,e)},t.prototype.setLFOTarget=function(t){for(var e=0;e<this.m_voiceLen;e++)this.m_voices[e].setLFOTarget(t)},t.prototype.setLpfSwtAmt=function(t,e){for(var s=0;s<this.m_voiceLen;s++)this.m_voices[s].setLpfSwtAmt(t,e)},t.prototype.setLpfFrqRes=function(t,e){for(var s=0;s<this.m_voiceLen;s++)this.m_voices[s].setLpfFrqRes(t,e)},t.prototype.setVolMode=function(t){this.m_volMode=t},t.prototype.setInput=function(t,e){for(var s=0;s<this.m_voiceLen;s++)this.m_voices[s].setInput(t,e)},t.prototype.setOutput=function(t,e){for(var s=0;s<this.m_voiceLen;s++)this.m_voices[s].setOutput(t,e)},t.prototype.setRing=function(t,e){for(var s=0;s<this.m_voiceLen;s++)this.m_voices[s].setRing(t,e)},t.prototype.setSync=function(t,e){for(var s=0;s<this.m_voiceLen;s++)this.m_voices[s].setSync(t,e)},t.prototype.setPortamento=function(t,e){for(var s=0;s<this.m_voiceLen;s++)this.m_voices[s].setPortamento(t,e)},t.prototype.setMidiPort=function(t){for(var e=0;e<this.m_voiceLen;e++)this.m_voices[e].setMidiPort(t)},t.prototype.setMidiPortRate=function(t){for(var e=0;e<this.m_voiceLen;e++)this.m_voices[e].setMidiPortRate(t)},t.prototype.setPortBase=function(t){for(var e=0;e<this.m_voiceLen;e++)this.m_voices[e].setPortBase(t)},t.prototype.setVoiceLimit=function(t){this.m_voiceLimit=Math.max(1,Math.min(t,this.m_voiceLen))},t.prototype.setHwLfo=function(t){for(var e=0;e<this.m_voiceLen;e++)this.m_voices[e].setHwLfo(t)},t.prototype.reset=function(){this.m_form=0,this.m_subform=0,this.m_voiceId=0;for(var t=this.m_volMode=0;t<this.m_voiceLen;t++)this.m_voices[t].reset()},t.prototype.getSamples=function(t,e,s,i){for(var h=!1,o=0;o<this.m_voiceLen;o++)this.m_voices[o].isPlaying()&&(this.m_voices[o].setSlaveVoice(h),this.m_voices[o].getSamples(t,e,s,i),h=!0);!1===h&&this.m_voices[0].clearOutPipe(e,s,i)},t}();s.MPolyChannel=t}(flmml||(flmml={})),function(c){var t=function(){function m(){this.m_isEnd=0,this.m_ch=new c.MChannel,this.m_needle=0,this.m_polyFound=!1,this.playTempo(m.DEFAULT_BPM),this.m_volume=100,this.recGate(.9375),this.recGate2(0),this.m_events=new Array,this.m_pointer=0,this.m_delta=0,this.m_globalTick=0,this.m_lfoWidth=0,this.m_totalMSec=0,this.m_chordBegin=0,this.m_chordEnd=0,this.m_chordMode=!1}return m.prototype.getNumEvents=function(){return this.m_events.length},m.prototype.onSampleData=function(t,e,s,i){if(void 0===i&&(i=!1),!this.isEnd())for(var h=e;h<s;){var o,_,r,n=0,a=this.m_events.length;do{if(n=0,this.m_pointer<a&&(_=(o=this.m_events[this.m_pointer]).getDelta()*this.m_spt,this.m_needle>=_)){switch(n=1,o.getStatus()){case 2:this.m_ch.noteOn(o.getNoteNo(),o.getVelocity());break;case 3:this.m_ch.noteOff(o.getNoteNo());break;case 6:this.m_ch.setNoteNo(o.getNoteNo());break;case 5:break;case 4:this.playTempo(o.getTempo());break;case 7:this.m_ch.setForm(o.getForm(),o.getSubForm());break;case 8:this.m_ch.setEnvelope1Atk(o.getEnvelopeA());break;case 9:this.m_ch.setEnvelope1Point(o.getEnvelopeT(),o.getEnvelopeL());break;case 10:this.m_ch.setEnvelope1Rel(o.getEnvelopeR());break;case 24:this.m_ch.setEnvelope2Atk(o.getEnvelopeA());break;case 25:this.m_ch.setEnvelope2Point(o.getEnvelopeT(),o.getEnvelopeL());break;case 26:this.m_ch.setEnvelope2Rel(o.getEnvelopeR());break;case 11:this.m_ch.setNoiseFreq(o.getNoiseFreq());break;case 12:this.m_ch.setPWM(o.getPWM());break;case 13:this.m_ch.setPan(o.getPan());break;case 14:this.m_ch.setFormant(o.getVowel());break;case 15:this.m_ch.setDetune(o.getDetune());break;case 16:this.m_ch.setLFOFMSF(o.getLFOForm(),o.getLFOSubForm());break;case 17:this.m_lfoWidth=o.getLFOWidth()*this.m_spt,this.m_ch.setLFODPWD(o.getLFODepth(),c.MSequencer.SAMPLE_RATE/this.m_lfoWidth);break;case 18:this.m_ch.setLFODLTM(o.getLFODelay()*this.m_spt,o.getLFOTime()*this.m_lfoWidth);break;case 19:this.m_ch.setLFOTarget(o.getLFOTarget());break;case 20:this.m_ch.setLpfSwtAmt(o.getLPFSwt(),o.getLPFAmt());break;case 21:this.m_ch.setLpfFrqRes(o.getLPFFrq(),o.getLPFRes());break;case 23:this.m_ch.setVolMode(o.getVolMode());break;case 27:this.m_ch.setInput(o.getInputSens(),o.getInputPipe());break;case 28:this.m_ch.setOutput(o.getOutputMode(),o.getOutputPipe());break;case 29:this.m_ch.setExpression(o.getExpression());break;case 30:this.m_ch.setRing(o.getRingSens(),o.getRingInput());break;case 31:this.m_ch.setSync(o.getSyncMode(),o.getSyncPipe());break;case 32:this.m_ch.setPortamento(100*o.getPorDepth(),o.getPorLen()*this.m_spt);break;case 33:this.m_ch.setMidiPort(o.getMidiPort());break;case 34:var m=o.getMidiPortRate();this.m_ch.setMidiPortRate((8-7.99*m/128)/m);break;case 35:this.m_ch.setPortBase(100*o.getPortBase());break;case 36:this.m_ch.setVoiceLimit(o.getVoiceCount());break;case 39:this.m_ch.setHwLfo(o.getHwLfoData());break;case 37:this.m_ch.setSoundOff();break;case 38:this.m_ch.reset();break;case 22:this.m_ch.close();break;case 0:this.m_isEnd=1}this.m_needle-=_,this.m_pointer++}}while(n);if(!(this.m_pointer<a))break;_=(o=this.m_events[this.m_pointer]).getDelta()*this.m_spt,s<=h+(r=Math.ceil(_-this.m_needle))&&(r=s-h),this.m_needle+=r,i||this.m_ch.getSamples(t,s,h,r),h+=r}},m.prototype.seek=function(t){this.m_delta+=t,this.m_globalTick+=t,this.m_chordEnd=Math.max(this.m_chordEnd,this.m_globalTick)},m.prototype.seekChordStart=function(){this.m_globalTick=this.m_chordBegin},m.prototype.recDelta=function(t){t.setDelta(this.m_delta),this.m_delta=0},m.prototype.recNote=function(t,e,s,i,h){void 0===i&&(i=1),void 0===h&&(h=1);var o,_=this.makeEvent();(i?_.setNoteOn(t,s):_.setNote(t),this.pushEvent(_),h)?((o=(e*this.m_gate|0)-this.m_gate2)<=0&&(o=0),this.seek(o),this.recNoteOff(t,s),this.seek(e-o),this.m_chordMode&&this.seekChordStart()):this.seek(e)},m.prototype.recNoteOff=function(t,e){var s=this.makeEvent();s.setNoteOff(t,e),this.pushEvent(s)},m.prototype.recRest=function(t){this.seek(t),this.m_chordMode&&(this.m_chordBegin+=t)},m.prototype.recChordStart=function(){!1===this.m_chordMode&&(this.m_chordMode=!0,this.m_chordBegin=this.m_globalTick)},m.prototype.recChordEnd=function(){this.m_chordMode&&(0<this.m_events.length?this.m_delta=this.m_chordEnd-this.m_events[this.m_events.length-1].getTick():this.m_delta=0,this.m_globalTick=this.m_chordEnd,this.m_chordMode=!1)},m.prototype.recRestMSec=function(t){var e=t*c.MSequencer.SAMPLE_RATE/(1e3*this.m_spt)|0;this.seek(e)},m.prototype.recVolume=function(t){var e=this.makeEvent();e.setVolume(t),this.pushEvent(e)},m.prototype.recGlobal=function(t,e){for(var s=this.m_events.length,i=0,h=0;h<s;h++){var o=this.m_events[h],_=i+o.getDelta();if(t<_||_===t&&4!==o.getStatus())return o.setDelta(_-t),e.setDelta(t-i),void this.m_events.splice(h,0,e);i=_}e.setDelta(t-i),this.m_events.push(e)},m.prototype.insertEvent=function(t){for(var e=this.m_events.length,s=0,i=t.getTick(),h=0;h<e;h++){var o=this.m_events[h],_=s+o.getDelta();if(i<_)return o.setDelta(_-i),t.setDelta(i-s),void this.m_events.splice(h,0,t);s=_}t.setDelta(i-s),this.m_events.push(t)},m.prototype.makeEvent=function(){var t=new c.MEvent(this.m_globalTick);return t.setDelta(this.m_delta),this.m_delta=0,t},m.prototype.pushEvent=function(t){!1===this.m_chordMode?this.m_events.push(t):this.insertEvent(t)},m.prototype.recTempo=function(t,e){var s=new c.MEvent(t);s.setTempo(e),this.recGlobal(t,s)},m.prototype.recEOT=function(){var t=this.makeEvent();t.setEOT(),this.pushEvent(t)},m.prototype.recGate=function(t){this.m_gate=t},m.prototype.recGate2=function(t){t<0&&(t=0),this.m_gate2=t},m.prototype.recForm=function(t,e){var s=this.makeEvent();s.setForm(t,e),this.pushEvent(s)},m.prototype.recEnvelope=function(t,e,s,i,h){var o=this.makeEvent();1===t?o.setEnvelope1Atk(e):o.setEnvelope2Atk(e),this.pushEvent(o);for(var _=0,r=s.length;_<r;_++)o=this.makeEvent(),1===t?o.setEnvelope1Point(s[_],i[_]):o.setEnvelope2Point(s[_],i[_]),this.pushEvent(o);o=this.makeEvent(),1===t?o.setEnvelope1Rel(h):o.setEnvelope2Rel(h),this.pushEvent(o)},m.prototype.recNoiseFreq=function(t){var e=this.makeEvent();e.setNoiseFreq(t),this.pushEvent(e)},m.prototype.recPWM=function(t){var e=this.makeEvent();e.setPWM(t),this.pushEvent(e)},m.prototype.recPan=function(t){var e=this.makeEvent();e.setPan(t),this.pushEvent(e)},m.prototype.recFormant=function(t){var e=this.makeEvent();e.setFormant(t),this.pushEvent(e)},m.prototype.recDetune=function(t){var e=this.makeEvent();e.setDetune(t),this.pushEvent(e)},m.prototype.recLFO=function(t,e,s,i,h,o,_){var r=this.makeEvent();r.setLFOFMSF(s,i),this.pushEvent(r),(r=this.makeEvent()).setLFODPWD(t,e),this.pushEvent(r),(r=this.makeEvent()).setLFODLTM(h,o),this.pushEvent(r),(r=this.makeEvent()).setLFOTarget(_),this.pushEvent(r)},m.prototype.recLPF=function(t,e,s,i){var h=this.makeEvent();h.setLPFSWTAMT(t,e),this.pushEvent(h),(h=this.makeEvent()).setLPFFRQRES(s,i),this.pushEvent(h)},m.prototype.recVolMode=function(t){var e=this.makeEvent();e.setVolMode(t),this.pushEvent(e)},m.prototype.recInput=function(t,e){var s=this.makeEvent();s.setInput(t,e),this.pushEvent(s)},m.prototype.recOutput=function(t,e){var s=this.makeEvent();s.setOutput(t,e),this.pushEvent(s)},m.prototype.recExpression=function(t){var e=this.makeEvent();e.setExpression(t),this.pushEvent(e)},m.prototype.recRing=function(t,e){var s=this.makeEvent();s.setRing(t,e),this.pushEvent(s)},m.prototype.recSync=function(t,e){var s=this.makeEvent();s.setSync(t,e),this.pushEvent(s)},m.prototype.recClose=function(){var t=this.makeEvent();t.setClose(),this.pushEvent(t)},m.prototype.recPortamento=function(t,e){var s=this.makeEvent();s.setPortamento(t,e),this.pushEvent(s)},m.prototype.recMidiPort=function(t){var e=this.makeEvent();e.setMidiPort(t),this.pushEvent(e)},m.prototype.recMidiPortRate=function(t){var e=this.makeEvent();e.setMidiPortRate(t),this.pushEvent(e)},m.prototype.recPortBase=function(t){var e=this.makeEvent();e.setPortBase(t),this.pushEvent(e)},m.prototype.recPoly=function(t){var e=this.makeEvent();e.setPoly(t),this.pushEvent(e),this.m_polyFound=!0},m.prototype.recHwLfo=function(t,e,s,i,h,o,_){var r=this.makeEvent();r.setHwLfo(t,e,s,i,h,o,_),this.pushEvent(r)},m.prototype.isEnd=function(){return this.m_isEnd},m.prototype.getRecGlobalTick=function(){return this.m_globalTick},m.prototype.seekTop=function(){this.m_globalTick=0},m.prototype.conduct=function(t){var e,s,i,h=this.m_events.length,o=t.length,_=0,r=0,n=this.calcSpt(m.DEFAULT_BPM);for(e=0;e<h;e++)switch(_+=(i=this.m_events[e]).getDelta(),r+=i.getDelta()*n,i.getStatus()){case 4:for(n=this.calcSpt(i.getTempo()),s=m.FIRST_TRACK;s<o;s++)t[s].recTempo(_,i.getTempo())}var a=0;for(s=m.FIRST_TRACK;s<o;s++)a<t[s].getRecGlobalTick()&&(a=t[s].getRecGlobalTick());(i=this.makeEvent()).setClose(),this.recGlobal(a,i),r+=(a-_)*n,this.recRestMSec(3e3),this.recEOT(),r+=3*c.MSequencer.SAMPLE_RATE,this.m_totalMSec=1e3*r/c.MSequencer.SAMPLE_RATE},m.prototype.calcSpt=function(t){var e=96*t/60;return c.MSequencer.SAMPLE_RATE/e},m.prototype.playTempo=function(t){this.m_bpm=t,this.m_spt=this.calcSpt(t)},m.prototype.getTotalMSec=function(){return this.m_totalMSec},m.prototype.getTotalTimeStr=function(){var t=Math.ceil(this.m_totalMSec/1e3),e="0"+Math.floor(t/60),s="0"+t%60;return e.substr(e.length-2,2)+":"+s.substr(s.length-2,2)},m.prototype.getVoiceCount=function(){return this.m_ch.getVoiceCount()},m.prototype.usingMono=function(){this.m_ch=new c.MChannel},m.prototype.usingPoly=function(t){this.m_ch=new c.MPolyChannel(t)},m.prototype.findPoly=function(){return this.m_polyFound},m.TEMPO_TRACK=0,m.FIRST_TRACK=1,m.DEFAULT_BPM=120,m}();c.MTrack=t}(flmml||(flmml={})),function(t){var e=function(){function t(){}return t.getString=function(t,e){return this.s_string[t].replace("%s",e)},t.UNKNOWN_COMMAND=0,t.UNCLOSED_REPEAT=1,t.UNOPENED_COMMENT=2,t.UNCLOSED_COMMENT=3,t.RECURSIVE_MACRO=4,t.UNCLOSED_ARGQUOTE=5,t.UNCLOSED_GROUPNOTES=6,t.UNOPENED_GROUPNOTES=7,t.INVALID_MACRO_NAME=8,t.s_string=["対応していないコマンド '%s' があります。","終わりが見つからない繰り返しがあります。","始まりが見つからないコメントがあります。","終わりが見つからないコメントがあります。","マクロが再帰的に呼び出されています。",'マクロ引数指定の "" が閉じられていません',"終りが見つからない連符があります","始まりが見つからない連符があります","マクロ名に使用できない文字が含まれています。'%s'"],t}();t.MWarning=e}(flmml||(flmml={})),function(r){var t=function(){function _(){this.buf=new Array(4),this.ix=new Array(3),this.ox=new Array(3),this.op=[new r.Operator,new r.Operator,new r.Operator,new r.Operator],this.SetAlgorithm(0),this.pms=_.pmtable[0][0]}return _.prototype.SetType=function(t){for(var e=0;e<4;e++)this.op[e].type_=t},_.prototype.SetFB=function(t){this.fb=_.fbtable[t]},_.prototype.SetMS=function(t){this.op[0].SetMS(t),this.op[1].SetMS(t),this.op[2].SetMS(t),this.op[3].SetMS(t)},_.prototype.Mute=function(t){for(var e=0;e<4;e++)this.op[e].Mute(t)},_.prototype.Refresh=function(){for(var t=0;t<4;t++)this.op[t].Refresh()},_.prototype.SetChip=function(t){this.chip_=t;for(var e=0;e<4;e++)this.op[e].SetChip(t)},_.prototype.Reset=function(){this.op[0].Reset(),this.op[1].Reset(),this.op[2].Reset(),this.op[3].Reset()},_.prototype.Prepare=function(){var t=this.op;return t[0].Prepare(),t[1].Prepare(),t[2].Prepare(),t[3].Prepare(),this.pms=_.pmtable[t[0].type_][7&t[0].ms_],(t[0].IsOn()||t[1].IsOn()||t[2].IsOn()||t[3].IsOn()?1:0)|(t[0].ms_&(t[0].amon_||t[1].amon_||t[2].amon_||t[3].amon_?55:7)?2:0)},_.prototype.SetFNum=function(t){for(var e=0;e<4;e++)this.op[e].SetFNum(t)},_.prototype.SetKCKF=function(t,e){var s=19-(t>>4&7),i=_.kctable[15&t],h=(i=4*((i+2)/4|0))*_.kftable[63&e];h>>=19,h<<=19,h>>=s;var o=t>>2&31;this.op[0].SetDPBN(h,o),this.op[1].SetDPBN(h,o),this.op[2].SetDPBN(h,o),this.op[3].SetDPBN(h,o)},_.prototype.KeyControl=function(t){var e=this.op;1&t?e[0].KeyOn():e[0].KeyOff(),2&t?e[1].KeyOn():e[1].KeyOff(),4&t?e[2].KeyOn():e[2].KeyOff(),8&t?e[3].KeyOn():e[3].KeyOff()},_.prototype.SetAlgorithm=function(t){var e=_.iotable;this.ix[0]=e[t][0],this.ox[0]=e[t][1],this.ix[1]=e[t][2],this.ox[1]=e[t][3],this.ix[2]=e[t][4],this.ox[2]=e[t][5],this.op[0].ResetFB(),this.algo_=t},_.prototype.GetAlgorithm=function(){return this.algo_},_.prototype.Calc=function(){var t=0;switch(this.algo_){case 0:this.op[2].Calc(this.op[1].Out()),this.op[1].Calc(this.op[0].Out()),t=this.op[3].Calc(this.op[2].Out()),this.op[0].CalcFB(this.fb);break;case 1:this.op[2].Calc(this.op[0].Out()+this.op[1].Out()),this.op[1].Calc(0),t=this.op[3].Calc(this.op[2].Out()),this.op[0].CalcFB(this.fb);break;case 2:this.op[2].Calc(this.op[1].Out()),this.op[1].Calc(0),t=this.op[3].Calc(this.op[0].Out()+this.op[2].Out()),this.op[0].CalcFB(this.fb);break;case 3:this.op[2].Calc(0),this.op[1].Calc(this.op[0].Out()),t=this.op[3].Calc(this.op[1].Out()+this.op[2].Out()),this.op[0].CalcFB(this.fb);break;case 4:this.op[2].Calc(0),t=this.op[1].Calc(this.op[0].Out()),t+=this.op[3].Calc(this.op[2].Out()),this.op[0].CalcFB(this.fb);break;case 5:t=this.op[2].Calc(this.op[0].Out()),t+=this.op[1].Calc(this.op[0].Out()),t+=this.op[3].Calc(this.op[0].Out()),this.op[0].CalcFB(this.fb);break;case 6:t=this.op[2].Calc(0),t+=this.op[1].Calc(this.op[0].Out()),t+=this.op[3].Calc(0),this.op[0].CalcFB(this.fb);break;case 7:t=this.op[2].Calc(0),t+=this.op[1].Calc(0),t+=this.op[3].Calc(0),t+=this.op[0].CalcFB(this.fb)}return t},_.prototype.CalcL=function(){this.chip_.SetPMV(this.pms[this.chip_.GetPML()]);var t=0;switch(this.algo_){case 0:this.op[2].CalcL(this.op[1].Out()),this.op[1].CalcL(this.op[0].Out()),t=this.op[3].CalcL(this.op[2].Out()),this.op[0].CalcFBL(this.fb);break;case 1:this.op[2].CalcL(this.op[0].Out()+this.op[1].Out()),this.op[1].CalcL(0),t=this.op[3].CalcL(this.op[2].Out()),this.op[0].CalcFBL(this.fb);break;case 2:this.op[2].CalcL(this.op[1].Out()),this.op[1].CalcL(0),t=this.op[3].CalcL(this.op[0].Out()+this.op[2].Out()),this.op[0].CalcFBL(this.fb);break;case 3:this.op[2].CalcL(0),this.op[1].CalcL(this.op[0].Out()),t=this.op[3].CalcL(this.op[1].Out()+this.op[2].Out()),this.op[0].CalcFBL(this.fb);break;case 4:this.op[2].CalcL(0),t=this.op[1].CalcL(this.op[0].Out()),t+=this.op[3].CalcL(this.op[2].Out()),this.op[0].CalcFBL(this.fb);break;case 5:t=this.op[2].CalcL(this.op[0].Out()),t+=this.op[1].CalcL(this.op[0].Out()),t+=this.op[3].CalcL(this.op[0].Out()),this.op[0].CalcFBL(this.fb);break;case 6:t=this.op[2].CalcL(0),t+=this.op[1].CalcL(this.op[0].Out()),t+=this.op[3].CalcL(0),this.op[0].CalcFBL(this.fb);break;case 7:t=this.op[2].CalcL(0),t+=this.op[1].CalcL(0),t+=this.op[3].CalcL(0),t+=this.op[0].CalcFBL(this.fb)}return t},_.prototype.CalcN=function(t){this.buf[1]=this.buf[2]=this.buf[3]=0,this.buf[0]=this.op[0].Out(),this.op[0].CalcFB(this.fb),this.buf[this.ox[0]]+=this.op[1].Calc(this.buf[this.ix[0]]),this.buf[this.ox[1]]+=this.op[2].Calc(this.buf[this.ix[1]]);var e=this.op[3].Out();return this.op[3].CalcN(t),this.buf[this.ox[2]]+e},_.prototype.CalcLN=function(t){this.chip_.SetPMV(this.pms[this.chip_.GetPML()]),this.buf[1]=this.buf[2]=this.buf[3]=0,this.buf[0]=this.op[0].Out(),this.op[0].CalcFBL(this.fb),this.buf[this.ox[0]]+=this.op[1].CalcL(this.buf[this.ix[0]]),this.buf[this.ox[1]]+=this.op[2].CalcL(this.buf[this.ix[1]]);var e=this.op[3].Out();return this.op[3].CalcN(t),this.buf[this.ox[2]]+e},_.fbtable=[31,7,6,5,4,3,2,1],_.kftable=[65536,65595,65654,65713,65773,65832,65891,65951,66010,66070,66130,66189,66249,66309,66369,66429,66489,66549,66609,66669,66729,66789,66850,66910,66971,67031,67092,67152,67213,67273,67334,67395,67456,67517,67578,67639,67700,67761,67822,67883,67945,68006,68067,68129,68190,68252,68314,68375,68437,68499,68561,68623,68685,68747,68809,68871,68933,68995,69057,69120,69182,69245,69307,69370],_.kctable=[5197,5506,5833,6180,6180,6547,6937,7349,7349,7786,8249,8740,8740,9259,9810,10394],_.iotable=[[0,1,1,2,2,3],[1,0,0,1,1,2],[1,1,1,0,0,2],[0,1,2,1,1,2],[0,1,2,2,2,1],[0,1,0,1,0,1],[0,1,2,1,2,1],[1,0,1,0,1,0]],_.pmtable=function(){for(var t,e,s=r.JaggArray.I3(2,8,256),i=[[0,1/360,2/360,3/360,4/360,6/360,12/360,24/360],[0,1/480,2/480,4/480,10/480,20/480,80/480,140/480]],h=0;h<2;h++)for(t=0;t<8;t++){var o=i[h][t];for(e=0;e<256;e++){Math.pow(2,o*(2*e-256+1)/255);var _=.6*o*Math.sin(2*e*Math.PI/256)+1;s[h][t][e]=65536*(_-1)|0}}return s}(),_}();r.Channel4=t}(fmgenAs||(fmgenAs={})),function(e){var h=[1,1.414,1.581,1.732],t=function(){function t(){this.ratio_=0,this.aml_=0,this.pml_=0,this.pmv_=0,this.multable_=e.JaggArray.I2(4,16)}return t.prototype.Chip=function(){this.MakeTable()},t.prototype.SetRatio=function(t){this.ratio_!==t&&(this.ratio_=t,this.MakeTable())},t.prototype.SetAML=function(t){this.aml_=255&t},t.prototype.SetPML=function(t){this.pml_=255&t},t.prototype.SetPMV=function(t){this.pmv_=t},t.prototype.GetMulValue=function(t,e){return this.multable_[t][e]},t.prototype.GetAML=function(){return this.aml_},t.prototype.GetPML=function(){return this.pml_},t.prototype.GetPMV=function(){return this.pmv_},t.prototype.GetRatio=function(){return this.ratio_},t.prototype.MakeTable=function(){var t,e;for(t=0;t<4;t++){var s=h[t]*this.ratio_/1;for(e=0;e<16;e++){var i=0!==e?2*e:1;this.multable_[t][e]=i*s|0}}},t}();e.Chip=t}(fmgenAs||(fmgenAs={})),function(t){var e=function(){function t(){}return t.next=0,t.attack=1,t.decay=2,t.sustain=3,t.release=4,t.off=5,t}();t.EGPhase=e}(fmgenAs||(fmgenAs={})),function(t){var e=function(){function t(){}return t.typeN=0,t.typeM=1,t}();t.OpType=e}(fmgenAs||(fmgenAs={})),function(t){var o=flmml.MML,e=function(){function h(){this.onstopsound=null,this.onrequestbuffer=null,this.onInfoTimerBinded=this.onInfoTimer.bind(this),addEventListener("message",this.onMessage.bind(this))}return h.prototype.onMessage=function(t){var e=t.data,s=e.type,i=this.mml;switch(s){case h.COM_BOOT:this.audioSampleRate=e.sampleRate,this.audioBufferSize=e.bufferSize,this.mml=new o;break;case h.COM_PLAY:i.play(e.mml);break;case h.COM_STOP:i.stop(),this.syncInfo();break;case h.COM_PAUSE:i.pause(),this.syncInfo();break;case h.COM_BUFFER:this.onrequestbuffer&&this.onrequestbuffer(e);break;case h.COM_SYNCINFO:"number"==typeof e.interval?(this.infoInterval=e.interval,clearInterval(this.tIDInfo),0<this.infoInterval&&this.mml.isPlaying()&&(this.tIDInfo=setInterval(this.onInfoTimerBinded,this.infoInterval))):this.syncInfo();break;case h.COM_STOPSOUND:this.onstopsound&&this.onstopsound()}},h.prototype.buffering=function(t){postMessage({type:h.COM_BUFRING,progress:t})},h.prototype.compileComplete=function(){var t=this.mml;postMessage({type:h.COM_COMPCOMP,info:{totalMSec:t.getTotalMSec(),totalTimeStr:t.getTotalTimeStr(),warnings:t.getWarnings(),metaTitle:t.getMetaTitle(),metaComment:t.getMetaComment(),metaArtist:t.getMetaArtist(),metaCoding:t.getMetaCoding()}})},h.prototype.playSound=function(){postMessage({type:h.COM_PLAYSOUND}),this.syncInfo()},h.prototype.stopSound=function(t){void 0===t&&(t=!1),postMessage({type:h.COM_STOPSOUND,isFlushBuf:t})},h.prototype.sendBuffer=function(t){postMessage({type:h.COM_BUFFER,buffer:t},[t[0].buffer,t[1].buffer])},h.prototype.complete=function(){postMessage({type:h.COM_COMPLETE}),this.syncInfo()},h.prototype.syncInfo=function(){var t=this.mml;this.lastInfoTime=self.performance?self.performance.now():(new Date).getTime(),postMessage({type:h.COM_SYNCINFO,info:{_isPlaying:t.isPlaying(),_isPaused:t.isPaused(),nowMSec:t.getNowMSec(),nowTimeStr:t.getNowTimeStr(),voiceCount:t.getVoiceCount()}})},h.prototype.onInfoTimer=function(){this.mml.isPlaying()?this.syncInfo():clearInterval(this.tIDInfo)},h.COM_BOOT=1,h.COM_PLAY=2,h.COM_STOP=3,h.COM_PAUSE=4,h.COM_BUFFER=5,h.COM_COMPCOMP=6,h.COM_BUFRING=7,h.COM_COMPLETE=8,h.COM_SYNCINFO=9,h.COM_PLAYSOUND=10,h.COM_STOPSOUND=11,h}();t.Messenger=e}(messenger||(messenger={}));var msgr=new messenger.Messenger;